<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesQR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .swipe-container {
            touch-action: pan-x;
            overflow-x: hidden;
        }
        .tab-content {
            transition: transform 0.3s ease-out;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
        }
        .corner.top-left {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .corner.top-right {
            top: 20px;
            right: 20px;
            border-left: none;
            border-bottom: none;
        }
        .corner.bottom-left {
            bottom: 20px;
            left: 20px;
            border-right: none;
            border-top: none;
        }
        .corner.bottom-right {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .progress-gradient {
            background: linear-gradient(90deg, #3b82f6, #10b981);
        }
        .offline-overlay {
            background: rgba(239, 68, 68, 0.9);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-blue-400 mb-2">üì± InvitesQR Scanner</h1>
                <p class="text-gray-300">Sistema de controle de convidados</p>
                <div id="configMessage" class="mt-4 p-3 bg-red-900 border border-red-600 rounded-lg text-left">
                    <p class="text-red-200 text-sm font-medium mb-2">‚ö†Ô∏è Configura√ß√£o Necess√°ria:</p>
                    <p class="text-red-100 text-xs mb-3">
                        Configure suas credenciais do Supabase no c√≥digo:<br>
                        ‚Ä¢ SUPABASE_URL: Sua URL do projeto<br>
                        ‚Ä¢ SUPABASE_KEY: Sua chave p√∫blica (anon key)
                    </p>
                    <p class="text-red-200 text-xs font-medium mb-2">üìã Estrutura do Banco:</p>
                    <p class="text-red-100 text-xs">
                        Crie as tabelas:<br>
                        ‚Ä¢ <strong>clientes</strong>: id, nome, token, validade, scans_usados, limite_scans<br>
                        ‚Ä¢ <strong>convidados</strong>: id, nome, codigo, token_cliente, status<br>
                        ‚Ä¢ <strong>logs</strong>: id, token, data, status, dispositivo, tentativas, modo_rapido
                    </p>
                </div>
                
                <div id="demoMessage" class="mt-4 p-3 bg-yellow-900 border border-yellow-600 rounded-lg text-left hidden">
                    <p class="text-yellow-200 text-sm font-medium mb-2">üé≠ Modo Demo Ativo:</p>
                    <p class="text-yellow-100 text-xs">
                        Sistema funcionando com dados de demonstra√ß√£o.<br>
                        ‚Ä¢ Token de teste: <strong>evt-demo123</strong><br>
                        ‚Ä¢ 8 convidados fict√≠cios dispon√≠veis
                    </p>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Token do Evento</label>
                    <input type="text" id="tokenInput" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="evt-xxxxxx">
                    <p class="text-xs text-gray-400 mt-1">Formato: evt-xxxxxx</p>
                </div>
                
                <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                    Entrar
                </button>
                
                <div id="loginError" class="text-red-500 text-sm text-center hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-blue-400">InvitesQR Scanner</h1>
                    <p id="eventName" class="text-sm text-gray-300"></p>
                    <p id="scanLimit" class="text-xs text-gray-400"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <button id="themeToggle" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
                        üåô
                    </button>
                </div>
            </div>
        </header>

        <!-- Welcome Message -->
        <div id="welcomeMessage" class="bg-gradient-to-r from-blue-600 to-green-600 p-4 text-center slide-up">
            <p id="welcomeText" class="font-medium"></p>
        </div>

        <!-- Progress Bar -->
        <div class="bg-gray-800 p-4">
            <div class="flex justify-between text-sm text-gray-300 mb-2">
                <span>Progresso da Sess√£o</span>
                <span id="progressText">0 scans</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div id="progressBar" class="progress-gradient h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="bg-gray-800 border-b border-gray-700">
            <div class="flex">
                <button class="tab-btn flex-1 py-3 px-4 text-center font-medium transition-colors bg-blue-600 text-white" data-tab="scanner">
                    üì∏ Scanner
                </button>
                <button class="tab-btn flex-1 py-3 px-4 text-center font-medium transition-colors text-gray-300 hover:text-white" data-tab="settings">
                    ‚öôÔ∏è Op√ß√µes
                </button>
            </div>
        </nav>

        <!-- Tab Contents -->
        <div class="swipe-container flex-1">
            <!-- Scanner Tab -->
            <div id="scannerTab" class="tab-content p-4">
                <div class="space-y-4">
                    <!-- Scanner Status -->
                    <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <div id="scannerStatus" class="text-lg font-medium text-gray-300 mb-2">
                            Scanner Inativo
                        </div>
                        <div id="scannerSubtext" class="text-sm text-gray-400">
                            Clique em "Ativar Scanner" para come√ßar
                        </div>
                    </div>

                    <!-- Scanner Container -->
                    <div class="relative bg-gray-800 rounded-lg overflow-hidden">
                        <div id="qr-reader" class="w-full" style="min-height: 300px;"></div>
                        <div id="scannerOverlay" class="scanner-overlay hidden">
                            <div class="corner top-left"></div>
                            <div class="corner top-right"></div>
                            <div class="corner bottom-left"></div>
                            <div class="corner bottom-right"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-black bg-opacity-50 text-white px-4 py-2 rounded-lg">
                                    <div id="scannerMessage">Posicione o QR code na √°rea destacada</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scanner Controls -->
                    <div class="space-y-3">
                        <button id="nextGuestBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-4 px-4 rounded-lg transition-colors min-h-[44px] text-lg">
                            üì∏ Ativar Scanner
                        </button>
                    </div>

                    <!-- Recent Scans -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">√öltimos Scans</h3>
                        <div id="recentScans" class="space-y-2">
                            <div class="text-gray-400 text-sm text-center py-4">
                                Nenhum scan realizado ainda
                            </div>
                        </div>
                    </div>


                </div>
            </div>



            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content p-4 hidden">
                <div class="space-y-4">
                    <!-- Convidados -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">üë• Convidados</h3>
                        
                        <!-- Search -->
                        <div class="relative mb-3">
                            <input type="text" id="guestSearch" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-10" placeholder="Buscar convidado...">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
                                <span class="text-gray-400">üîç</span>
                            </div>
                        </div>

                        <!-- Filter Buttons -->
                        <div class="flex space-x-2 overflow-x-auto pb-3 mb-3">
                            <button class="filter-btn bg-blue-600 text-white px-4 py-2 rounded-lg whitespace-nowrap min-h-[44px] text-sm" data-filter="all">
                                Todos
                            </button>
                            <button class="filter-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg whitespace-nowrap min-h-[44px] text-sm" data-filter="scanned">
                                Escaneados
                            </button>
                            <button class="filter-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg whitespace-nowrap min-h-[44px] text-sm" data-filter="pending">
                                Pendentes
                            </button>
                        </div>

                        <!-- Guest List -->
                        <div id="guestList" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Guests will be populated here -->
                        </div>
                    </div>

                    <!-- Relat√≥rios -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">üìä Relat√≥rios</h3>
                        
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-gray-700 rounded-lg p-3 text-center">
                                <div id="totalScans" class="text-xl font-bold text-green-500">0</div>
                                <div class="text-xs text-gray-400">Total Scans</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3 text-center">
                                <div id="sessionScansCount" class="text-xl font-bold text-blue-500">0</div>
                                <div class="text-xs text-gray-400">Sess√£o Atual</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3 text-center">
                                <div id="successRate" class="text-xl font-bold text-yellow-500">0%</div>
                                <div class="text-xs text-gray-400">Taxa Sucesso</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3 text-center">
                                <div id="avgScanTime" class="text-xl font-bold text-purple-500">0s</div>
                                <div class="text-xs text-gray-400">Tempo M√©dio</div>
                            </div>
                        </div>

                        <!-- Export Options -->
                        <div class="space-y-2">
                            <button id="exportPdfBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors min-h-[44px] text-sm">
                                üìÑ Exportar PDF
                            </button>
                            <button id="shareDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors min-h-[44px] text-sm">
                                üì§ Compartilhar Dados
                            </button>
                        </div>
                    </div>

                    <!-- Scanner Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">üì∏ Scanner</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">‚ö° Modo R√°pido</span>
                                <button id="quickScanToggle" class="w-12 h-6 bg-gray-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">üí° Flash</span>
                                <button id="flashToggle" class="w-12 h-6 bg-gray-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">
                                üì∑ C√¢mera: Sempre traseira (autom√°tico)
                            </div>
                        </div>
                    </div>

                    <!-- Sound Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">üîä Som e Vibra√ß√£o</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">Som de Feedback</span>
                                <button id="soundToggle" class="w-12 h-6 bg-green-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5 transition-transform"></div>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">Vibra√ß√£o</span>
                                <button id="vibrationToggle" class="w-12 h-6 bg-green-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5 transition-transform"></div>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">Mensagens Inteligentes</span>
                                <button id="smartMessagesToggle" class="w-12 h-6 bg-green-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5 transition-transform"></div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">üíæ Gerenciar Dados</h3>
                        <div class="space-y-3">
                            <button id="syncDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                                üîÑ Sincronizar Dados
                            </button>
                            <button id="clearDataBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                                üóëÔ∏è Limpar Dados Locais
                            </button>
                        </div>
                    </div>

                    <!-- Session Info -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">‚ÑπÔ∏è Informa√ß√µes da Sess√£o</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">In√≠cio da Sess√£o:</span>
                                <span id="sessionStart">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">√öltima Sincroniza√ß√£o:</span>
                                <span id="lastSync">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Dispositivo:</span>
                                <span id="deviceInfo">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Info -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="font-medium text-gray-300 mb-3">üîß Debug</h3>
                        <div class="text-xs text-gray-400 space-y-1">
                            <div>Vers√£o: 1.0.0</div>
                            <div id="debugInfo">Carregando...</div>
                        </div>
                    </div>

                    <!-- Logout -->
                    <button id="logoutBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                        üö™ Sair
                    </button>
                </div>
            </div>
        </div>

        <!-- Offline Overlay -->
        <div id="offlineOverlay" class="fixed inset-0 offline-overlay flex items-center justify-center z-50 hidden">
            <div class="bg-white text-gray-900 rounded-lg p-6 m-4 text-center">
                <div class="text-4xl mb-4">üì°</div>
                <h3 class="text-lg font-bold mb-2">Sem Conex√£o</h3>
                <p class="text-sm text-gray-600">Funcionando em modo offline. Os dados ser√£o sincronizados quando a conex√£o for restaurada.</p>
            </div>
        </div>

        <!-- Smart Message Toast -->
        <div id="smartMessageToast" class="fixed bottom-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg transform translate-y-full transition-transform z-40">
            <div id="smartMessageContent"></div>
        </div>

        <!-- Scan Result Toast -->
        <div id="scanResultToast" class="fixed top-20 left-4 right-4 p-4 rounded-lg shadow-lg transform -translate-y-full transition-transform z-40">
            <div id="scanResultContent" class="font-medium text-center"></div>
        </div>
    </div>

    <script>
        // Configuration - Credenciais do Supabase configuradas
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';

        // Storage Keys
        const STORAGE_KEYS = {
            SCANNED_GUESTS: 'invitesqr_scanned_guests',
            SCAN_ATTEMPTS: 'invitesqr_scan_attempts',
            SESSION_SCANS: 'invitesqr_session_scans',
            SCAN_HISTORY: 'invitesqr_scan_history',
            CLIENT_DATA: 'invitesqr_client_data',
            GUESTS_DATA: 'invitesqr_guests_data',
            LAST_SYNC: 'invitesqr_last_sync'
        };

        // Global Variables
        let currentClient = null;
        let guests = [];
        let scannedGuests = new Set();
        let sessionScans = 0;
        let html5QrCode = null;
        let isScanning = false;
        let canScan = false;
        let smartMessagesEnabled = true;
        let soundEnabled = true;
        let vibrationEnabled = true;
        let isDarkTheme = true;
        let currentTab = 'scanner';
        let sessionStartTime = Date.now();
        let scanTimeout = null;
        let isOnline = true;
        let tokenValidationInterval = null;
        let quickScanMode = false;
        let scanAttempts = new Map();
        let lastScanTime = 0;
        let scanHistory = [];
        let isAppInitialized = false;

        // Demo data for testing without Supabase
        const demoData = {
            clients: {
                'evt-demo123': {
                    id: 1,
                    nome: 'Evento Demo - Casamento Jo√£o & Maria',
                    token: 'evt-demo123',
                    validade: Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60), // 30 days from now
                    scans_usados: 0,
                    limite_scans: 100
                }
            },
            guests: [
                { id: 1, nome: 'Ana Silva', codigo: 'QR001', token_cliente: 'evt-demo123', status: 'PERMITIDO' },
                { id: 2, nome: 'Bruno Santos', codigo: 'QR002', token_cliente: 'evt-demo123', status: 'PERMITIDO' },
                { id: 3, nome: 'Carlos Oliveira', codigo: 'QR003', token_cliente: 'evt-demo123', status: 'PERMITIDO' },
                { id: 4, nome: 'Diana Costa', codigo: 'QR004', token_cliente: 'evt-demo123', status: 'PERMITIDO' },
                { id: 5, nome: 'Eduardo Lima', codigo: 'QR005', token_cliente: 'evt-demo123', status: 'PERMITIDO' },
                { id: 6, nome: 'Fernanda Rocha', codigo: 'QR006', token_cliente: 'evt-demo123', status: 'BLOQUEADO' },
                { id: 7, nome: 'Gabriel Alves', codigo: 'QR007', token_cliente: 'evt-demo123', status: 'PERMITIDO' },
                { id: 8, nome: 'Helena Martins', codigo: 'QR008', token_cliente: 'evt-demo123', status: 'PERMITIDO' }
            ],
            logs: []
        };

        // Demo Supabase-like functions
        const demoSupabase = {
            from: (table) => ({
                select: (columns) => ({
                    eq: (column, value) => ({
                        single: async () => {
                            if (table === 'clientes') {
                                const client = demoData.clients[value];
                                return client ? { data: client, error: null } : { data: null, error: { code: 'PGRST116' } };
                            }
                            return { data: null, error: { message: 'Table not found' } };
                        },
                        then: async (callback) => {
                            if (table === 'convidados') {
                                const guests = demoData.guests.filter(g => g.token_cliente === value);
                                return callback({ data: guests, error: null });
                            } else if (table === 'logs') {
                                const logs = demoData.logs.filter(l => l.token === value);
                                return callback({ data: logs, error: null });
                            }
                            return callback({ data: [], error: null });
                        }
                    }),
                    limit: (num) => ({
                        then: async (callback) => {
                            return callback({ data: [], error: null });
                        }
                    })
                }),
                insert: (data) => ({
                    then: async (callback) => {
                        if (table === 'logs') {
                            demoData.logs.push({ ...data, id: Date.now() });
                        }
                        return callback({ data: null, error: null });
                    }
                }),
                update: (data) => ({
                    eq: (column, value) => ({
                        then: async (callback) => {
                            if (table === 'clientes' && demoData.clients[value]) {
                                Object.assign(demoData.clients[value], data);
                            }
                            return callback({ data: null, error: null });
                        }
                    })
                })
            })
        };

        // Initialize Supabase
        let supabase = null;
        let isDemoMode = false;

        try {
            if (SUPABASE_URL !== 'https://seu-projeto.supabase.co' && SUPABASE_KEY !== 'sua-chave-publica-anon-key-aqui') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase conectado com sucesso');
            } else {
                throw new Error('Credenciais do Supabase n√£o configuradas');
            }
        } catch (error) {
            console.error('‚ùå Erro na configura√ß√£o do Supabase:', error);
            alert('‚ö†Ô∏è CONFIGURA√á√ÉO NECESS√ÅRIA:\n\nPor favor, configure suas credenciais do Supabase no c√≥digo:\n\n1. SUPABASE_URL: Sua URL do projeto\n2. SUPABASE_KEY: Sua chave p√∫blica (anon key)\n\nEncontre essas informa√ß√µes no painel do Supabase > Settings > API');
        }

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const tokenInput = document.getElementById('tokenInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            // Show configuration message if Supabase not configured
            if (!supabase) {
                document.getElementById('configMessage').classList.remove('hidden');
                document.getElementById('demoMessage').classList.add('hidden');
                document.getElementById('loginBtn').disabled = true;
                document.getElementById('loginBtn').textContent = 'Configure o Supabase';
                return;
            } else {
                document.getElementById('configMessage').classList.add('hidden');
                document.getElementById('demoMessage').classList.add('hidden');
            }
            
            // Initialize app only once
            if (!isAppInitialized) {
                loadSavedData();
                setupEventListeners();
                isAppInitialized = true;
            }
            
            // Always check for auto-login
            await checkAutoLogin();
        });

        // Load saved data from localStorage
        function loadSavedData() {
            try {
                const savedScannedGuests = localStorage.getItem(STORAGE_KEYS.SCANNED_GUESTS);
                if (savedScannedGuests) {
                    scannedGuests = new Set(JSON.parse(savedScannedGuests));
                }

                const savedSessionScans = localStorage.getItem(STORAGE_KEYS.SESSION_SCANS);
                if (savedSessionScans) {
                    sessionScans = parseInt(savedSessionScans);
                }

                const savedClientData = localStorage.getItem(STORAGE_KEYS.CLIENT_DATA);
                if (savedClientData) {
                    currentClient = JSON.parse(savedClientData);
                }

                const savedGuestsData = localStorage.getItem(STORAGE_KEYS.GUESTS_DATA);
                if (savedGuestsData) {
                    guests = JSON.parse(savedGuestsData);
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        // Check for auto-login
        async function checkAutoLogin() {
            if (!supabase) return;
            
            const savedToken = localStorage.getItem('invitesqr_token');
            if (!savedToken) return;

            // Show loading state
            loginBtn.textContent = 'Verificando token...';
            loginBtn.disabled = true;
            
            try {
                console.log('üîç Verificando token salvo:', savedToken);
                
                // Validate saved token
                const { data: clientData, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', savedToken)
                    .single();

                if (error || !clientData) {
                    console.log('‚ùå Token inv√°lido ou n√£o encontrado');
                    clearInvalidToken('Token n√£o encontrado ou inv√°lido');
                    return;
                }

                // Check if token expired
                if (clientData.validade && new Date(clientData.validade * 1000) < new Date()) {
                    console.log('‚ùå Token expirado');
                    clearInvalidToken('Token expirado');
                    return;
                }

                console.log('‚úÖ Token v√°lido, fazendo login autom√°tico');
                currentClient = clientData;
                
                // Load guests data efficiently
                const { data: guestsData } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', savedToken);
                
                guests = guestsData || [];
                await loadExistingScans();
                
                showMainApp();
                showWelcomeMessage();
                startTokenValidation();
                
            } catch (error) {
                console.error('‚ùå Erro no auto-login:', error);
                clearInvalidToken('Erro de conex√£o');
            }
        }

        // Clear invalid token and show login screen
        function clearInvalidToken(reason) {
            console.log('üßπ Limpando token inv√°lido:', reason);
            
            // Clear all stored data
            localStorage.removeItem('invitesqr_token');
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });

            // Reset app state
            currentClient = null;
            guests = [];
            scannedGuests.clear();
            sessionScans = 0;

            // Show login screen with message
            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            loginBtn.textContent = 'Entrar';
            loginBtn.disabled = false;
            
            if (reason !== 'Token n√£o encontrado ou inv√°lido') {
                showLoginError(reason + '. Por favor, fa√ßa login novamente.');
            }
        }

        // Start token validation interval (less frequent)
        function startTokenValidation() {
            if (tokenValidationInterval) {
                clearInterval(tokenValidationInterval);
            }

            // Check token validity every 2 minutes (less frequent)
            tokenValidationInterval = setInterval(async () => {
                await validateCurrentToken();
            }, 120000);
        }

        // Validate current token (simplified)
        async function validateCurrentToken() {
            if (!supabase || !currentClient?.token) return;

            try {
                const { data: clientData, error } = await supabase
                    .from('clientes')
                    .select('validade, scans_usados, limite_scans')
                    .eq('token', currentClient.token)
                    .single();

                if (error?.code === 'PGRST116' || !clientData) {
                    clearInvalidToken('Token removido do sistema');
                    return;
                }

                // Check if token expired
                if (clientData.validade && new Date(clientData.validade * 1000) < new Date()) {
                    clearInvalidToken('Token expirado');
                    return;
                }

                // Update only if scan count changed
                if (clientData.scans_usados !== currentClient.scans_usados) {
                    currentClient.scans_usados = clientData.scans_usados;
                    currentClient.limite_scans = clientData.limite_scans;
                    updateScanLimitDisplay();
                }

            } catch (error) {
                console.error('Erro na valida√ß√£o do token:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login
            loginBtn.addEventListener('click', handleLogin);
            tokenInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Scanner controls
            document.getElementById('nextGuestBtn').addEventListener('click', activateScanner);
            document.getElementById('quickScanToggle').addEventListener('click', toggleQuickScan);
            document.getElementById('flashToggle').addEventListener('click', toggleFlash);

            // Settings toggles
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            document.getElementById('vibrationToggle').addEventListener('click', toggleVibration);
            document.getElementById('smartMessagesToggle').addEventListener('click', toggleSmartMessages);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Data management
            document.getElementById('syncDataBtn').addEventListener('click', syncData);
            document.getElementById('clearDataBtn').addEventListener('click', clearData);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Export functions
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('shareDataBtn').addEventListener('click', shareData);



            // Guest search and filter (debounced)
            let searchTimeout;
            document.getElementById('guestSearch').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(filterGuests, 300); // Debounce search
            });
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setGuestFilter(this.dataset.filter);
                });
            });

            // Connection status - always online
            // Removed offline/online listeners
        }

        // Handle login
        async function handleLogin() {
            if (!supabase) {
                showLoginError('Configure o Supabase antes de fazer login');
                return;
            }

            const token = tokenInput.value.trim();
            if (!token) {
                showLoginError('Por favor, digite o token do evento');
                return;
            }

            // Validate token format
            if (!token.startsWith('evt-') || token.length < 10) {
                showLoginError('Formato de token inv√°lido. Use: evt-xxxxxx');
                return;
            }

            loginBtn.textContent = 'Conectando...';
            loginBtn.disabled = true;

            try {
                console.log('üîç Tentando conectar com token:', token);
                
                // Test Supabase connection first
                const { data: testData, error: testError } = await supabase
                    .from('clientes')
                    .select('count', { count: 'exact' });
                
                console.log('üìä Teste de conex√£o:', { testData, testError });
                
                if (testError) {
                    console.error('‚ùå Erro de conex√£o com Supabase:', testError);
                    showLoginError('Erro de conex√£o com o banco de dados. Verifique as configura√ß√µes.');
                    loginBtn.textContent = 'Entrar';
                    loginBtn.disabled = false;
                    return;
                }

                // Validate token
                console.log('üîé Buscando token na tabela clientes...');
                const { data: clientData, error: clientError } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();

                console.log('üìã Resultado da busca:', { clientData, clientError });

                if (clientError) {
                    console.error('‚ùå Erro na consulta:', clientError);
                    if (clientError.code === 'PGRST116') {
                        showLoginError('Token n√£o encontrado na base de dados');
                    } else {
                        showLoginError(`Erro na consulta: ${clientError.message}`);
                    }
                    loginBtn.textContent = 'Entrar';
                    loginBtn.disabled = false;
                    return;
                }

                if (!clientData) {
                    console.log('‚ö†Ô∏è Nenhum dado retornado para o token');
                    showLoginError('Token n√£o encontrado');
                    loginBtn.textContent = 'Entrar';
                    loginBtn.disabled = false;
                    return;
                }

                // Check if token is still valid (not expired)
                if (clientData.validade && new Date(clientData.validade * 1000) < new Date()) {
                    showLoginError('Token expirado. Entre em contato com o organizador.');
                    loginBtn.textContent = 'Entrar';
                    loginBtn.disabled = false;
                    return;
                }

                currentClient = clientData;

                // Load guests for this client
                const { data: guestsData, error: guestsError } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', token);

                if (guestsError) {
                    showLoginError('Erro ao carregar convidados');
                    loginBtn.textContent = 'Entrar';
                    loginBtn.disabled = false;
                    return;
                }

                guests = guestsData || [];

                // Load existing scans
                await loadExistingScans();

                // Save data
                localStorage.setItem('invitesqr_token', token);
                localStorage.setItem(STORAGE_KEYS.CLIENT_DATA, JSON.stringify(currentClient));
                localStorage.setItem(STORAGE_KEYS.GUESTS_DATA, JSON.stringify(guests));

                showMainApp();
                showWelcomeMessage();
                startTokenValidation();
                
                // Auto-activate scanner after login
                setTimeout(() => {
                    activateScanner();
                }, 1000);
                
                loginBtn.textContent = 'Entrar';
                loginBtn.disabled = false;

            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Erro de conex√£o. Verifique sua internet.');
                loginBtn.textContent = 'Entrar';
                loginBtn.disabled = false;
            }
        }

        // Load existing scans from Supabase
        async function loadExistingScans() {
            try {
                const { data: logsData, error } = await supabase
                    .from('logs')
                    .select('*')
                    .eq('token', currentClient.token)
                    .eq('status', 'PERMITIDO');

                if (!error && logsData) {
                    // Extract guest codes from logs
                    const scannedCodes = new Set();
                    logsData.forEach(log => {
                        // Find the guest that matches this log entry
                        const guest = guests.find(g => g.nome === log.dispositivo || g.codigo === log.dispositivo);
                        if (guest) {
                            scannedCodes.add(guest.codigo);
                        }
                    });
                    scannedGuests = scannedCodes;
                }
            } catch (error) {
                console.error('Error loading existing scans:', error);
            }
        }

        // Show login error
        function showLoginError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
            setTimeout(() => {
                loginError.classList.add('hidden');
            }, 5000);
        }

        // Show main app
        function showMainApp() {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            // Update UI
            document.getElementById('eventName').textContent = currentClient.nome;
            updateScanLimitDisplay();
            updateProgress();
            updateStats();
            renderGuestList();
            initializeScanner();
        }

        // Update scan limit display
        function updateScanLimitDisplay() {
            const scanLimitElement = document.getElementById('scanLimit');
            const currentScans = currentClient.scans_usados || 0;
            const scanLimit = currentClient.limite_scans || 0;
            
            if (scanLimit > 0) {
                const remaining = scanLimit - currentScans;
                scanLimitElement.textContent = `${currentScans}/${scanLimit} scans ‚Ä¢ ${remaining} restantes`;
                
                // Change color based on remaining scans
                if (remaining <= 0) {
                    scanLimitElement.className = 'text-xs text-red-400';
                } else if (remaining <= 10) {
                    scanLimitElement.className = 'text-xs text-yellow-400';
                } else {
                    scanLimitElement.className = 'text-xs text-gray-400';
                }
            } else {
                scanLimitElement.textContent = `${currentScans} scans ‚Ä¢ Ilimitado`;
                scanLimitElement.className = 'text-xs text-gray-400';
            }
        }

        // Show welcome message
        function showWelcomeMessage() {
            const hour = new Date().getHours();
            let greeting = 'Boa noite';
            if (hour < 12) greeting = 'Bom dia';
            else if (hour < 18) greeting = 'Boa tarde';

            const lastSync = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
            let syncMessage = '';
            if (lastSync) {
                const timeDiff = Date.now() - parseInt(lastSync);
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                if (hours > 0) {
                    syncMessage = ` ‚Ä¢ √öltima sync: ${hours}h atr√°s`;
                }
            }

            document.getElementById('welcomeText').textContent = `${greeting}! ${syncMessage}`;
            
            setTimeout(() => {
                document.getElementById('welcomeMessage').style.display = 'none';
            }, 5000);
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-blue-600', 'text-white');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-300');

            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');

            currentTab = tabName;

            // Update content based on tab
            if (tabName === 'reports') {
                updateStats();
            } else if (tabName === 'guests') {
                renderGuestList();
            }
        }

        // Initialize scanner
        function initializeScanner() {
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                updateScannerStatus('Scanner Inativo', 'Clique em "Pr√≥ximo Convidado" para ativar');
            } catch (error) {
                console.error('Error initializing scanner:', error);
                updateScannerStatus('Erro no Scanner', 'N√£o foi poss√≠vel inicializar a c√¢mera');
            }
        }

        // Activate scanner - now always active
        async function activateScanner() {
            if (isScanning) {
                // Scanner already active, just enable scanning
                canScan = true;
                updateScannerStatus('Scanner Ativo', 'Pronto para escanear - posicione o QR code');
                return;
            }

            canScan = true;
            isScanning = true;
            
            updateScannerStatus('Ativando Scanner...', 'Preparando c√¢mera');
            document.getElementById('scannerOverlay').classList.remove('hidden');
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            try {
                // Force back camera - try multiple methods
                const cameraConstraints = [
                    { facingMode: { exact: "environment" } }, // Prefer exact back camera
                    { facingMode: "environment" }, // Fallback to any back camera
                    { video: { facingMode: { exact: "environment" } } } // Alternative format
                ];

                let cameraStarted = false;
                for (const constraint of cameraConstraints) {
                    try {
                        await html5QrCode.start(
                            constraint,
                            config,
                            (decodedText, decodedResult) => {
                                // QR code successfully scanned
                                processQRScan(decodedText);
                            },
                            (errorMessage) => {
                                // Scanning error - can be ignored for continuous scanning
                            }
                        );
                        cameraStarted = true;
                        console.log('‚úÖ C√¢mera traseira ativada com sucesso');
                        break;
                    } catch (err) {
                        console.log('‚ö†Ô∏è Tentativa de c√¢mera falhou:', err.message);
                        continue;
                    }
                }

                if (!cameraStarted) {
                    throw new Error('N√£o foi poss√≠vel ativar a c√¢mera traseira');
                }

                updateScannerStatus('Scanner Ativo', 'C√¢mera traseira ativa - posicione o QR code');
                document.getElementById('scannerMessage').textContent = 'Scanner sempre ativo - aguardando QR code';

            } catch (error) {
                console.error('Error starting scanner:', error);
                updateScannerStatus('Erro na C√¢mera', 'N√£o foi poss√≠vel acessar a c√¢mera traseira');
                document.getElementById('scannerOverlay').classList.add('hidden');
                isScanning = false;
                canScan = false;
                
                // Show error message
                showScanResult('‚ùå ERRO', 'N√£o foi poss√≠vel acessar a c√¢mera traseira', 'bg-red-500');
            }
        }

        // Deactivate scanner - only used for manual stop or errors
        function deactivateScanner() {
            if (!isScanning) return;

            isScanning = false;
            canScan = false;
            
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }

            document.getElementById('scannerOverlay').classList.add('hidden');
            updateScannerStatus('Scanner Parado', 'Clique em "Ativar Scanner" para continuar');

            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(console.error);
            }
        }

        // Process QR scan
        async function processQRScan(qrCode) {
            if (!canScan) return;

            // Prevent rapid duplicate scans
            const now = Date.now();
            if (now - lastScanTime < 2000) return; // Increased to 2 seconds
            lastScanTime = now;

            // Track scan attempts
            const attempts = scanAttempts.get(qrCode) || 0;
            scanAttempts.set(qrCode, attempts + 1);

            // Temporarily disable scanning to prevent duplicates
            canScan = false;
            
            // Re-enable scanning after processing
            setTimeout(() => {
                canScan = true;
                updateScannerStatus('Scanner Ativo', 'Pronto para pr√≥ximo QR code');
            }, 3000);

            try {
                console.log('üîç Processando QR code:', qrCode);
                console.log('üë• Total de convidados:', guests.length);
                console.log('üìã C√≥digos dispon√≠veis:', guests.map(g => g.codigo));
                
                // Find guest in local data first
                const guest = guests.find(g => g.codigo === qrCode);
                
                if (!guest) {
                    console.log('‚ùå Convidado n√£o encontrado para c√≥digo:', qrCode);
                    showScanResult('‚ùå INV√ÅLIDO', `QR code "${qrCode}" n√£o encontrado`, 'bg-red-500');
                    playFeedback('error');
                    return;
                }
                
                console.log('‚úÖ Convidado encontrado:', guest);

                // Check if guest belongs to current client
                if (guest.token_cliente !== currentClient.token) {
                    showScanResult('‚ùå INV√ÅLIDO', 'QR code n√£o pertence a este evento', 'bg-red-500');
                    playFeedback('error');
                    return;
                }

                // Check if already scanned
                if (scannedGuests.has(qrCode)) {
                    showScanResult('‚ö†Ô∏è J√Å USADO', `${guest.nome} j√° foi escaneado`, 'bg-yellow-500');
                    playFeedback('warning');
                    return;
                }

                // Check guest status
                if (guest.status !== 'PERMITIDO') {
                    showScanResult('‚ùå BLOQUEADO', `${guest.nome} - acesso negado`, 'bg-red-500');
                    playFeedback('error');
                    return;
                }

                // Check scan limit
                const currentScans = currentClient.scans_usados || 0;
                const scanLimit = currentClient.limite_scans || 0;
                
                if (scanLimit > 0 && currentScans >= scanLimit) {
                    showScanResult('‚ùå LIMITE', 'Limite de scans atingido', 'bg-red-500');
                    playFeedback('error');
                    return;
                }

                // Record scan in logs table with detailed info
                const { error: logError } = await supabase
                    .from('logs')
                    .insert({
                        token: currentClient.token,
                        data: new Date().toISOString(),
                        status: 'PERMITIDO',
                        dispositivo: `${guest.nome} (${guest.codigo})`,
                        tentativas: attempts,
                        modo_rapido: quickScanMode
                    });

                if (logError) {
                    console.error('Error recording scan:', logError);
                    showScanResult('‚ö†Ô∏è ERRO', 'Falha ao registrar scan', 'bg-yellow-500');
                    playFeedback('warning');
                    return;
                }

                // Update client scan count
                const { error: updateError } = await supabase
                    .from('clientes')
                    .update({ 
                        scans_usados: (currentClient.scans_usados || 0) + 1 
                    })
                    .eq('token', currentClient.token);

                if (updateError) {
                    console.error('Error updating scan count:', updateError);
                }

                // Update local client data
                currentClient.scans_usados = (currentClient.scans_usados || 0) + 1;

                // Successful scan
                scannedGuests.add(qrCode);
                sessionScans++;
                
                showScanResult('‚úÖ PERMITIDO', guest.nome, 'bg-green-500');
                playFeedback('success');
                
                // Update UI
                updateScanLimitDisplay();
                updateProgress();
                updateStats();
                addRecentScan(guest);
                saveData();

                // Check for milestones
                checkMilestones();

            } catch (error) {
                console.error('Scan processing error:', error);
                showScanResult('‚ö†Ô∏è ERRO', 'Erro de conex√£o', 'bg-yellow-500');
                playFeedback('warning');
            }
        }

        // Show scan result
        function showScanResult(status, message, bgClass) {
            const toast = document.getElementById('scanResultToast');
            const content = document.getElementById('scanResultContent');
            
            toast.className = `fixed top-20 left-4 right-4 p-4 rounded-lg shadow-lg transform transition-transform z-40 ${bgClass} text-white`;
            content.innerHTML = `<div class="text-lg font-bold">${status}</div><div class="text-sm">${message}</div>`;
            
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(-100%)';
            }, 3000);
        }

        // Play feedback
        function playFeedback(type) {
            if (vibrationEnabled && navigator.vibrate) {
                const patterns = {
                    success: [100],
                    warning: [100, 100, 100],
                    error: [200, 100, 200]
                };
                navigator.vibrate(patterns[type] || [100]);
            }

            if (soundEnabled) {
                // Simulate sound feedback (would use Web Audio API in real implementation)
                console.log(`Playing ${type} sound`);
            }
        }

        // Update scanner status
        function updateScannerStatus(status, subtext) {
            document.getElementById('scannerStatus').textContent = status;
            document.getElementById('scannerSubtext').textContent = subtext;
        }

        // Update progress
        function updateProgress() {
            const totalGuests = guests.length;
            const scannedCount = scannedGuests.size;
            const percentage = totalGuests > 0 ? (scannedCount / totalGuests) * 100 : 0;
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${scannedCount}/${totalGuests} scans`;
        }

        // Update stats
        async function updateStats() {
            document.getElementById('totalScans').textContent = scannedGuests.size;
            document.getElementById('sessionScansCount').textContent = sessionScans;
            
            // Calculate success rate based on scan attempts
            const totalAttempts = Array.from(scanAttempts.values()).reduce((sum, attempts) => sum + attempts, 0);
            const successfulScans = scannedGuests.size;
            const successRate = totalAttempts > 0 ? Math.round((successfulScans / totalAttempts) * 100) : 100;
            document.getElementById('successRate').textContent = `${successRate}%`;
            
            // Calculate average scan time
            const successfulScanTimes = scanHistory.filter(scan => scan.success && scan.scanTime);
            const avgTime = successfulScanTimes.length > 0 
                ? (successfulScanTimes.reduce((sum, scan) => sum + scan.scanTime, 0) / successfulScanTimes.length / 1000).toFixed(1)
                : '0.0';
            document.getElementById('avgScanTime').textContent = `${avgTime}s`;
            
            // Session info
            document.getElementById('sessionStart').textContent = new Date(sessionStartTime).toLocaleTimeString();
            
            const lastSync = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
            document.getElementById('lastSync').textContent = lastSync 
                ? new Date(parseInt(lastSync)).toLocaleTimeString()
                : 'Nunca';
                
            document.getElementById('deviceInfo').textContent = navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop';
        }

        // Add recent scan
        function addRecentScan(guest) {
            const recentScans = document.getElementById('recentScans');
            const scanElement = document.createElement('div');
            scanElement.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg slide-up';
            scanElement.innerHTML = `
                <div>
                    <div class="font-medium text-green-400">${guest.nome}</div>
                    <div class="text-xs text-gray-400">${guest.codigo} ‚Ä¢ ${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="text-green-400">‚úÖ</div>
            `;
            
            if (recentScans.children.length === 1 && recentScans.children[0].textContent.includes('Nenhum scan')) {
                recentScans.innerHTML = '';
            }
            
            recentScans.insertBefore(scanElement, recentScans.firstChild);
            
            // Keep only last 5 scans
            while (recentScans.children.length > 5) {
                recentScans.removeChild(recentScans.lastChild);
            }
        }

        // Check milestones
        function checkMilestones() {
            if (!smartMessagesEnabled) return;

            const milestones = [10, 25, 50, 100];
            const currentCount = scannedGuests.size;
            
            if (milestones.includes(currentCount)) {
                const messages = {
                    10: 'üéâ Parab√©ns! Voc√™ escaneou 10 convidados!',
                    25: 'üöÄ Excelente trabalho! 25 convidados j√° entraram!',
                    50: '‚≠ê Meio caminho andado! 50 scans realizados!',
                    100: 'üèÜ Incr√≠vel! 100 convidados escaneados com sucesso!'
                };
                
                setTimeout(() => {
                    showSmartMessage(messages[currentCount]);
                }, 1000);
            }
        }

        // Show smart message
        function showSmartMessage(message) {
            const toast = document.getElementById('smartMessageToast');
            const content = document.getElementById('smartMessageContent');
            
            content.textContent = message;
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(100%)';
            }, 4000);
        }

        // Render guest list (optimized)
        function renderGuestList() {
            const guestList = document.getElementById('guestList');
            const searchTerm = document.getElementById('guestSearch')?.value?.toLowerCase() || '';
            const currentFilter = document.querySelector('.filter-btn.bg-blue-600')?.dataset?.filter || 'all';
            
            // Filter guests efficiently
            const filteredGuests = guests.filter(guest => {
                const matchesSearch = !searchTerm || 
                    guest.nome.toLowerCase().includes(searchTerm) || 
                    guest.codigo.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                const isScanned = scannedGuests.has(guest.codigo);
                if (currentFilter === 'scanned') return isScanned;
                if (currentFilter === 'pending') return !isScanned;
                return true;
            });
            
            // Clear and render
            guestList.innerHTML = '';
            
            if (filteredGuests.length === 0) {
                guestList.innerHTML = '<div class="text-gray-400 text-center py-4 text-sm">Nenhum convidado encontrado</div>';
                return;
            }
            
            // Limit rendering to first 50 guests for performance
            const guestsToRender = filteredGuests.slice(0, 50);
            
            const fragment = document.createDocumentFragment();
            guestsToRender.forEach(guest => {
                const isScanned = scannedGuests.has(guest.codigo);
                const guestElement = document.createElement('div');
                guestElement.className = `bg-gray-700 rounded-lg p-3 flex items-center justify-between ${isScanned ? 'opacity-75' : ''}`;
                guestElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-5 h-5 rounded-full border-2 ${isScanned ? 'border-green-500 bg-green-500' : 'border-gray-500 bg-gray-700'} flex items-center justify-center transition-all duration-300">
                            ${isScanned ? '<div class="w-2 h-2 bg-white rounded-full"></div>' : ''}
                        </div>
                        <div>
                            <div class="font-medium text-sm ${isScanned ? 'text-green-400' : 'text-white'}">${guest.nome}</div>
                            <div class="text-xs text-gray-400">${guest.codigo}</div>
                        </div>
                    </div>
                    <div class="text-lg">
                        ${isScanned ? '‚úÖ' : '‚è≥'}
                    </div>
                `;
                fragment.appendChild(guestElement);
            });
            
            guestList.appendChild(fragment);
            
            // Show count if limited
            if (filteredGuests.length > 50) {
                const moreElement = document.createElement('div');
                moreElement.className = 'text-gray-400 text-center py-2 text-xs';
                moreElement.textContent = `Mostrando 50 de ${filteredGuests.length} convidados`;
                guestList.appendChild(moreElement);
            }
        }

        // Filter guests
        function filterGuests() {
            renderGuestList();
        }

        // Set guest filter
        function setGuestFilter(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            document.querySelector(`[data-filter="${filter}"]`).classList.add('bg-blue-600', 'text-white');
            document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-gray-700', 'text-gray-300');
            
            renderGuestList();
        }

        // Toggle functions
        function toggleSound() {
            soundEnabled = !soundEnabled;
            updateToggleButton('soundToggle', soundEnabled);
        }

        function toggleVibration() {
            vibrationEnabled = !vibrationEnabled;
            updateToggleButton('vibrationToggle', vibrationEnabled);
        }

        function toggleSmartMessages() {
            smartMessagesEnabled = !smartMessagesEnabled;
            updateToggleButton('smartMessagesToggle', smartMessagesEnabled);
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.getElementById('themeToggle').textContent = isDarkTheme ? 'üåô' : '‚òÄÔ∏è';
            // Theme switching would be implemented here
        }

        function updateToggleButton(buttonId, enabled) {
            const button = document.getElementById(buttonId);
            const slider = button.querySelector('div');
            
            if (enabled) {
                button.classList.add('bg-green-600');
                button.classList.remove('bg-gray-600');
                slider.style.transform = 'translateX(0)';
            } else {
                button.classList.remove('bg-green-600');
                button.classList.add('bg-gray-600');
                slider.style.transform = 'translateX(-100%)';
            }
        }



        // Toggle quick scan mode
        function toggleQuickScan() {
            quickScanMode = !quickScanMode;
            const btn = document.getElementById('quickScanToggle');
            
            if (quickScanMode) {
                btn.classList.add('bg-green-600');
                btn.classList.remove('bg-gray-700');
                showSmartMessage('‚ö° Modo r√°pido ativado - scan cont√≠nuo!');
            } else {
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-gray-700');
                showSmartMessage('üéØ Modo normal ativado - pausa ap√≥s cada scan');
            }
        }

        // Toggle flash
        function toggleFlash() {
            showSmartMessage('üí° Flash alternado!');
        }

        // Data management
        async function syncData() {
            if (!supabase) {
                showSmartMessage('‚ùå Supabase n√£o configurado');
                return;
            }

            document.getElementById('syncDataBtn').textContent = 'Sincronizando...';
            
            try {
                // Sync guests data
                const { data: guestsData, error: guestsError } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token);

                if (guestsError) throw guestsError;

                guests = guestsData || [];
                localStorage.setItem(STORAGE_KEYS.GUESTS_DATA, JSON.stringify(guests));

                // Sync logs data
                const { data: logsData, error: logsError } = await supabase
                    .from('logs')
                    .select('*')
                    .eq('token', currentClient.token)
                    .eq('status', 'PERMITIDO');

                if (logsError) throw logsError;

                // Extract guest codes from logs
                const scannedCodes = new Set();
                logsData.forEach(log => {
                    // Find the guest that matches this log entry
                    const guest = guests.find(g => log.dispositivo.includes(g.nome));
                    if (guest) {
                        scannedCodes.add(guest.codigo);
                    }
                });
                scannedGuests = scannedCodes;
                localStorage.setItem(STORAGE_KEYS.SCANNED_GUESTS, JSON.stringify([...scannedGuests]));

                // Update last sync time
                localStorage.setItem(STORAGE_KEYS.LAST_SYNC, Date.now().toString());
                
                // Update UI
                updateProgress();
                updateStats();
                renderGuestList();
                
                document.getElementById('syncDataBtn').textContent = 'üîÑ Sincronizar Dados';
                showSmartMessage('‚úÖ Dados sincronizados com sucesso!');

            } catch (error) {
                console.error('Sync error:', error);
                document.getElementById('syncDataBtn').textContent = 'üîÑ Sincronizar Dados';
                showSmartMessage('‚ùå Erro na sincroniza√ß√£o. Verifique sua conex√£o.');
            }
        }

        function clearData() {
            if (confirm('Tem certeza que deseja limpar todos os dados locais? Esta a√ß√£o n√£o pode ser desfeita.')) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                scannedGuests.clear();
                sessionScans = 0;
                
                updateProgress();
                updateStats();
                renderGuestList();
                
                showSmartMessage('üóëÔ∏è Dados locais limpos com sucesso!');
            }
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('invitesqr_token');
                location.reload();
            }
        }

        // Export functions
        function exportToPDF() {
            document.getElementById('exportPdfBtn').textContent = 'Gerando PDF...';
            
            setTimeout(() => {
                // Simulate PDF generation
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text('Relat√≥rio de Scans - InvitesQR', 20, 20);
                doc.text(`Evento: ${currentClient.nome}`, 20, 40);
                doc.text(`Total de Scans: ${scannedGuests.size}`, 20, 60);
                doc.text(`Data: ${new Date().toLocaleDateString()}`, 20, 80);
                
                doc.save('relatorio-scans.pdf');
                
                document.getElementById('exportPdfBtn').textContent = 'üìÑ Exportar PDF';
                showSmartMessage('üìÑ PDF gerado com sucesso!');
            }, 2000);
        }

        function shareData() {
            const data = {
                evento: currentClient.nome,
                totalScans: scannedGuests.size,
                sessionScans: sessionScans,
                data: new Date().toLocaleDateString()
            };
            
            const text = `Relat√≥rio InvitesQR\nEvento: ${data.evento}\nTotal: ${data.totalScans} scans\nSess√£o: ${data.sessionScans} scans\nData: ${data.data}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Relat√≥rio InvitesQR',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    showSmartMessage('üìã Dados copiados para a √°rea de transfer√™ncia!');
                });
            }
        }

        // Check actual connectivity
        async function checkConnectivity() {
            if (!supabase) return false;
            
            try {
                // Test Supabase connection
                const { data, error } = await supabase
                    .from('clientes')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                return !error;
            } catch (error) {
                return false;
            }
        }

        // Update connection status with real checks
        async function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            const overlay = document.getElementById('offlineOverlay');
            
            if (!supabase) {
                status.className = 'w-3 h-3 rounded-full bg-gray-500';
                overlay.classList.add('hidden');
                isOnline = false;
                return;
            }
            
            const isConnected = navigator.onLine && await checkConnectivity();
            
            if (isConnected) {
                status.className = 'w-3 h-3 rounded-full bg-green-500';
                overlay.classList.add('hidden');
                isOnline = true;
            } else {
                status.className = 'w-3 h-3 rounded-full bg-red-500 pulse';
                overlay.classList.remove('hidden');
                isOnline = false;
                
                // Disable scanner when offline
                if (isScanning) {
                    deactivateScanner();
                    showSmartMessage('üì° Scanner desativado - sem conex√£o');
                }
            }
        }

        // Save data
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEYS.SCANNED_GUESTS, JSON.stringify([...scannedGuests]));
                localStorage.setItem(STORAGE_KEYS.SESSION_SCANS, sessionScans.toString());
                localStorage.setItem(STORAGE_KEYS.CLIENT_DATA, JSON.stringify(currentClient));
                localStorage.setItem(STORAGE_KEYS.GUESTS_DATA, JSON.stringify(guests));
                localStorage.setItem(STORAGE_KEYS.LAST_SYNC, Date.now().toString());
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Auto-save every 30 seconds
        function startAutoSave() {
            setInterval(saveData, 30000);
        }

        // Update debug info (simplified)
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.innerHTML = `
                    <div>Convidados: ${guests.length} | Escaneados: ${scannedGuests.size}</div>
                    <div>Sess√£o: ${sessionScans} | Token: ${currentClient?.token ? 'Ativo' : 'Inativo'}</div>
                `;
            }
        }

        // Update debug info less frequently
        setInterval(updateDebugInfo, 30000);
        updateDebugInfo();

        // Simplified background tasks (less frequent)
        if (supabase) {
            // Auto-sync only every 10 minutes
            setInterval(async () => {
                if (currentClient && document.visibilityState === 'visible') {
                    await syncData();
                }
            }, 10 * 60 * 1000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9683447ff6dcaa64',t:'MTc1NDAyOTYyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
