<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-title" content="InvitesQR Scanner">
    <meta name="application-name" content="InvitesQR Scanner">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSW52aXRlc1FSIFNjYW5uZXIiLCJzaG9ydF9uYW1lIjoiSW52aXRlc1FSIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJmdWxsc2NyZWVuIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiMxZjI5MzciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJak1URXhPREkzSWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4eVpXTjBJSGRwWkhSb1BTSXhNamdpSUdobGFXZG9kRDBpTVRJNElpQm1hV3hzUFNJak1URXhPREkzSWk4K1BIUmxlSFFnZUQwaU5qUWlJSGs5SWpZMElpQm1hV3hzUFNJalptWm1abVptSWlCbWIyNTBMWE5wZW1VOUlqSTBJaUJtYjI1MExYZGxhV2RvZEQwaVltOXNaQ0krVVVJOEwzUmxlSFErUEM5emRtYysiLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <title>InvitesQR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Normal page layout - allow browser UI */
        html {
            scroll-behavior: smooth;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            -webkit-overflow-scrolling: touch;
        }

        /* Allow normal text selection */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* Normal container - not fixed */
        .app-container {
            min-height: 100vh;
            width: 100%;
        }

        /* Theme variables */
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
        }

        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --border-color: #d1d5db;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .bg-gray-900 { background-color: var(--bg-primary) !important; }
        .bg-gray-800 { background-color: var(--bg-secondary) !important; }
        .bg-gray-700 { background-color: var(--bg-tertiary) !important; }
        .text-white { color: var(--text-primary) !important; }
        .text-gray-400 { color: var(--text-muted) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        .border-gray-700 { border-color: var(--border-color) !important; }
        .border-gray-600 { border-color: var(--border-color) !important; }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
        }
        .scanner-corner.top-left {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .scanner-corner.top-right {
            top: 20px;
            right: 20px;
            border-left: none;
            border-bottom: none;
        }
        .scanner-corner.bottom-left {
            bottom: 20px;
            left: 20px;
            border-right: none;
            border-top: none;
        }
        .scanner-corner.bottom-right {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .offline-overlay {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.7);
        }
        .success-flash {
            animation: successFlash 0.5s ease-out;
        }
        @keyframes successFlash {
            0% { background-color: rgba(16, 185, 129, 0); }
            50% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: rgba(16, 185, 129, 0); }
        }
        .error-flash {
            animation: errorFlash 0.5s ease-out;
        }
        @keyframes errorFlash {
            0% { background-color: rgba(239, 68, 68, 0); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: rgba(239, 68, 68, 0); }
        }
        .vip-flash {
            animation: vipFlash 0.8s ease-out;
        }
        @keyframes vipFlash {
            0% { background-color: rgba(251, 191, 36, 0); box-shadow: none; }
            25% { background-color: rgba(251, 191, 36, 0.4); box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }
            50% { background-color: rgba(251, 191, 36, 0.2); box-shadow: 0 0 30px rgba(251, 191, 36, 0.8); }
            75% { background-color: rgba(251, 191, 36, 0.4); box-shadow: 0 0 20px rgba(251, 191, 36, 0.6); }
            100% { background-color: rgba(251, 191, 36, 0); box-shadow: none; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .scanner-corner {
                width: 25px;
                height: 25px;
                border-width: 2px;
            }
            
            .scanner-corner.top-left,
            .scanner-corner.top-right {
                top: 15px;
            }
            
            .scanner-corner.bottom-left,
            .scanner-corner.bottom-right {
                bottom: 15px;
            }
            
            .scanner-corner.top-left,
            .scanner-corner.bottom-left {
                left: 15px;
            }
            
            .scanner-corner.top-right,
            .scanner-corner.bottom-right {
                right: 15px;
            }
        }
        
        /* Prevent text selection on buttons and improve mobile touch */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
            cursor: pointer;
        }
        
        /* Improve button touch targets for mobile */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Better mobile button states */
        button:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Swipe navigation */
        .swipe-container {
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            height: 100%;
        }

        .swipe-content {
            display: flex;
            transition: transform 0.3s ease;
            width: 200%;
            height: 100%;
        }

        .swipe-tab {
            width: 50%;
            flex-shrink: 0;
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            overscroll-behavior: contain;
            height: 100% !important;
            touch-action: pan-y !important;
        }

        /* Enable scrolling for all tab content */
        .tab-content {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            height: 100%;
        }

        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            space-x: 2px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        .swipe-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            margin: 0 2px;
            transition: background 0.3s ease;
        }

        .swipe-dot.active {
            background: #3b82f6;
        }

        /* Fullscreen scanner styles */
        .fullscreen-scanner-active {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        #fullscreen-scanner {
            touch-action: none;
            overscroll-behavior: none;
        }
        
        /* QR Scanner targeting frame animation */
        @keyframes scanLine {
            0% { transform: translateY(0); }
            100% { transform: translateY(256px); }
        }
        
        #scan-line {
            animation: scanLine 2s linear infinite;
        }
        
        @media (min-width: 768px) {
            #scan-line {
                animation: scanLine 2s linear infinite;
            }
            
            @keyframes scanLine {
                0% { transform: translateY(0); }
                100% { transform: translateY(320px); }
            }
        }
        
        /* Scanner status indicator animations */
        .scan-status-active #scan-status-dot {
            background-color: #10b981 !important;
            animation: pulse 1.5s infinite;
        }
        
        .scan-status-waiting #scan-status-dot {
            background-color: #f59e0b !important;
        }
        
        .scan-status-disabled #scan-status-dot {
            background-color: #6b7280 !important;
        }
        
        /* Enhanced button styles for fullscreen */
        #fullscreen-next-btn {
            backdrop-filter: blur(4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #close-scanner-btn {
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* QR targeting frame enhancements */
        .scanner-overlay .relative {
            border: 2px dashed rgba(16, 185, 129, 0.3);
            border-radius: 12px;
        }
        
        /* Smooth transitions for scanner elements */
        #scanner-instructions,
        #scan-result-display,
        #fullscreen-next-btn {
            transition: all 0.3s ease-in-out;
        }
        
        /* Hide elements smoothly */
        .fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Normal mobile behavior */
        @media screen and (max-width: 768px) {
            .app-container {
                min-height: 100vh;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="app-container">
        <!-- Offline Overlay -->
        <div id="offline-overlay" class="fixed inset-0 offline-overlay z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 mx-4 text-center text-gray-900 max-w-sm">
                <i class="fas fa-wifi-slash text-4xl text-red-500 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Sem Conexão</h3>
                <p class="text-gray-600 mb-4">Verifique sua conexão com a internet para continuar.</p>
                <button onclick="checkConnectivity()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sync-alt mr-2"></i>Tentar Novamente
                </button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="h-full flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
                <div class="text-center mb-8">
                    <i class="fas fa-qrcode text-5xl text-blue-500 mb-4"></i>
                    <h1 class="text-2xl font-bold mb-2">InvitesQR Scanner</h1>
                    <p class="text-gray-400">Validação de Convidados</p>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Token do Evento</label>
                        <input type="text" id="event-token" required 
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="evt-123456">
                    </div>

                    <button type="submit" id="login-btn" 
                            class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <div id="connection-status" class="flex items-center justify-center text-sm">
                        <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                        <span class="text-gray-400">Verificando conexão...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden h-full flex flex-col">
            <!-- Header -->
            <header class="bg-gray-800 shadow-lg flex-shrink-0">
                <div class="px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 id="event-name" class="text-lg font-bold">Carregando...</h1>
                            <p id="event-info" class="text-sm text-gray-400">Preparando scanner...</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div id="connection-indicator" class="flex items-center">
                                <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                            </div>
                            <button onclick="toggleTheme()" class="text-gray-400 hover:text-white" title="Alternar tema">
                                <i id="theme-icon" class="fas fa-moon text-xl"></i>
                            </button>
                            <button onclick="logout()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-sign-out-alt text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bg-gray-800 border-b border-gray-700 flex-shrink-0">
                <div class="flex">
                    <button id="tab-scanner" onclick="showTab('scanner')" class="flex-1 py-4 px-2 text-center bg-blue-600 text-white min-h-[60px] active:bg-blue-700">
                        <i class="fas fa-qrcode block mb-1 text-lg"></i>
                        <span class="text-xs">Scanner</span>
                    </button>
                    <button id="tab-options" onclick="showTab('options')" class="flex-1 py-4 px-2 text-center text-gray-400 hover:text-white min-h-[60px] active:bg-gray-700">
                        <i class="fas fa-ellipsis-h block mb-1 text-lg"></i>
                        <span class="text-xs">Opções</span>
                    </button>
                </div>
            </nav>

            <!-- Swipe Indicator -->
            <div id="swipe-indicator" class="swipe-indicator">
                <div class="swipe-dot active"></div>
                <div class="swipe-dot"></div>
            </div>

            <!-- Main Content with Swipe -->
            <div id="main-content" class="swipe-container flex-1 overflow-auto">
                <div id="swipe-content" class="swipe-content">
                    <!-- Scanner Tab -->
                    <div id="content-scanner" class="swipe-tab overflow-auto">
                        <!-- Progress Bar -->
                        <div class="bg-gray-800 p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium">Progresso do Evento</span>
                                <span id="scanner-progress-percentage" class="text-sm text-gray-400">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3">
                                <div id="scanner-progress-bar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                                <span id="scanner-validated-count">0 validados</span>
                                <span id="scanner-total-count">de 0 convidados</span>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="p-4 space-y-4">
                            <button id="scanner-toggle" onclick="toggleScanner(event)"
                                    class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]">
                                <i class="fas fa-play mr-2"></i>Iniciar Scanner
                            </button>
                        </div>

                        <!-- Inline Scanner Area -->
                        <div id="inline-scanner-container" class="hidden">
                            <div class="relative bg-black rounded-lg mx-4 mb-4" style="height: 300px; touch-action: none;">
                                <div id="qr-reader-inline" class="w-full h-full rounded-lg overflow-hidden" style="touch-action: none;"></div>
                                
                                <!-- Scanner Overlay -->
                                <div class="absolute inset-0 pointer-events-none">
                                    <!-- QR Code targeting frame - only show when scanning -->
                                    <div id="scanner-targeting-frame" class="absolute inset-0 flex items-center justify-center hidden">
                                        <div class="relative w-80 h-80">
                                            <!-- Corner brackets - larger and more visible -->
                                            <div class="absolute top-0 left-0 w-16 h-16 border-l-4 border-t-4 border-green-400"></div>
                                            <div class="absolute top-0 right-0 w-16 h-16 border-r-4 border-t-4 border-green-400"></div>
                                            <div class="absolute bottom-0 left-0 w-16 h-16 border-l-4 border-b-4 border-green-400"></div>
                                            <div class="absolute bottom-0 right-0 w-16 h-16 border-r-4 border-b-4 border-green-400"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Indicator -->
                                    <div class="absolute top-4 left-1/2 transform -translate-x-1/2">
                                        <div class="bg-black bg-opacity-70 rounded-full px-4 py-2 flex items-center">
                                            <div id="inline-scan-status-dot" class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                                            <span id="inline-scan-status-label" class="text-white text-sm font-medium">Aguardando...</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Instructions -->
                                    <div id="inline-scanner-instructions" class="absolute inset-0 flex items-center justify-center">
                                        <div class="bg-black bg-opacity-70 rounded-xl p-4 text-center max-w-xs">
                                            <i class="fas fa-qrcode text-2xl text-green-400 mb-2"></i>
                                            <p class="text-white text-sm font-medium mb-1">Posicione o QR code no centro</p>
                                            <p class="text-gray-300 text-xs">Alinhe com as bordas verdes</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Scan Result Display -->
                                    <div id="inline-scan-result-display" class="absolute inset-0 flex items-center justify-center hidden">
                                        <div class="bg-black bg-opacity-90 rounded-xl p-4 text-center max-w-xs">
                                            <div id="inline-scan-status-text" class="text-2xl font-bold mb-2"></div>
                                            <div id="inline-scan-guest-name-display" class="text-lg text-white mb-1"></div>
                                            <div id="inline-scan-time-display" class="text-xs text-gray-300"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Next Scan Button - Below Camera -->
                            <div class="px-4 pb-4">
                                <button id="next-scan-btn" onclick="enableNextScan(event)"
                                        class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px] hidden">
                                    <i class="fas fa-arrow-right mr-2"></i>Próximo Convidado
                                </button>
                            </div>
                        </div>

                        <!-- Debug Info -->
                        <div class="p-4">
                            <div id="debug-info" class="bg-gray-800 rounded-lg p-4 text-xs text-gray-400 hidden">
                                <h4 class="font-medium text-white mb-2">Debug Info:</h4>
                                <div id="debug-content">Clique em "Iniciar Scanner" para ver informações de debug</div>
                                <button onclick="toggleDebug()" class="mt-2 text-blue-400 hover:text-blue-300">
                                    <i class="fas fa-bug mr-1"></i>Toggle Debug
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Options Tab -->
                    <div id="content-options" class="swipe-tab overflow-auto">
                        <div class="p-4">
                            <!-- Stats Overview -->
                            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                                <h3 class="text-lg font-medium mb-4">Estatísticas</h3>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <div id="options-scanned-count" class="text-2xl font-bold text-green-500">0</div>
                                        <div class="text-xs text-gray-400">Validados</div>
                                    </div>
                                    <div>
                                        <div id="options-total-guests" class="text-2xl font-bold text-blue-500">0</div>
                                        <div class="text-xs text-gray-400">Total</div>
                                    </div>
                                    <div>
                                        <div id="options-session-scans" class="text-2xl font-bold text-purple-500">0</div>
                                        <div class="text-xs text-gray-400">Sessão</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Options Menu -->
                            <div class="space-y-3">
                                <button onclick="showSubTab('guests')" class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-users text-blue-500 mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Convidados</h3>
                                            <p class="text-sm text-gray-400">Ver lista de convidados</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>

                                <button onclick="showSubTab('reports')" class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-chart-bar text-green-500 mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Relatórios</h3>
                                            <p class="text-sm text-gray-400">Estatísticas e exportação</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>

                                <button onclick="showSubTab('settings')" class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-cog text-purple-500 mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Configurações</h3>
                                            <p class="text-sm text-gray-400">Ajustes do aplicativo</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>

                                <button onclick="clearAllScans()" class="w-full bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-undo text-white mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Desmarcar Scaneados</h3>
                                            <p class="text-sm text-orange-200">Limpar todas as validações</p>
                                        </div>
                                    </div>
                                    <span id="clear-scans-count" class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guests Sub-Tab -->
            <div id="content-guests" class="tab-content hidden h-full flex flex-col">
                <!-- Back Button -->
                <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700 flex-shrink-0">
                    <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Voltar</span>
                    </button>
                    <h2 class="ml-4 text-lg font-medium">Convidados</h2>
                </div>
                <div class="p-4 flex-1 overflow-y-auto">
                    <!-- Search -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="guest-search" placeholder="Buscar convidado..." 
                                   class="w-full bg-gray-800 border border-gray-600 rounded-lg pl-10 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="filterGuests()">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterGuestsByStatus('all')" id="filter-all" 
                                class="flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white text-sm min-h-[44px] active:bg-blue-700">
                            Todos
                        </button>
                        <button onclick="filterGuestsByStatus('scanned')" id="filter-scanned" 
                                class="flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600">
                            Validados
                        </button>
                        <button onclick="filterGuestsByStatus('pending')" id="filter-pending" 
                                class="flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600">
                            Pendentes
                        </button>
                    </div>

                    <!-- Guest List -->
                    <div id="guests-list" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>Carregando convidados...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="content-reports" class="tab-content hidden h-full flex flex-col">
                <!-- Back Button -->
                <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700 flex-shrink-0">
                    <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Voltar</span>
                    </button>
                    <h2 class="ml-4 text-lg font-medium">Relatórios</h2>
                </div>
                <div class="p-4 flex-1 overflow-y-auto">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div id="report-validated" class="text-2xl font-bold text-green-500">0</div>
                            <div class="text-sm text-gray-400">Validados</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div id="report-pending" class="text-2xl font-bold text-orange-500">0</div>
                            <div class="text-sm text-gray-400">Pendentes</div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="bg-gray-800 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium">Progresso do Evento</span>
                            <span id="progress-percentage" class="text-sm text-gray-400">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="space-y-3">
                        <button onclick="generatePDFReport()" 
                                class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                            <i class="fas fa-file-pdf mr-2"></i>Exportar Relatório PDF
                        </button>
                        
                        <button onclick="shareReport()" 
                                class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                            <i class="fas fa-share mr-2"></i>Partilhar Relatório
                        </button>
                    </div>

                    <!-- Recent Scans -->
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-4">Últimas Validações</h3>
                        <div id="recent-scans" class="space-y-3">
                            <div class="text-center py-4 text-gray-400">
                                <p>Nenhuma validação ainda</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="content-settings" class="tab-content hidden h-full flex flex-col">
                <!-- Back Button -->
                <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700 flex-shrink-0">
                    <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Voltar</span>
                    </button>
                    <h2 class="ml-4 text-lg font-medium">Configurações</h2>
                </div>
                <div class="p-4 space-y-6 flex-1 overflow-y-auto">
                    <!-- Sound Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Áudio</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Som de Sucesso</h4>
                                    <p class="text-sm text-gray-400">Reproduzir som ao validar</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="success-sound" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Som de Erro</h4>
                                    <p class="text-sm text-gray-400">Reproduzir som em caso de erro</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="error-sound" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Vibration Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Vibração</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Feedback Tátil</h4>
                                <p class="text-sm text-gray-400">Vibrar ao escanear</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="vibration" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Smart Messages Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Mensagens Inteligentes</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Dicas e Sugestões</h4>
                                <p class="text-sm text-gray-400">Mostrar mensagens de ajuda e progresso</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="smart-messages" class="sr-only peer" checked onchange="toggleSmartMessages()">
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Scanner Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Scanner</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Câmera</label>
                                <select id="camera-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="">Selecionar câmera...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- App Info -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Informações</h3>
                        <div class="space-y-2 text-sm text-gray-400">
                            <div class="flex justify-between">
                                <span>Versão:</span>
                                <span>1.0.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Dispositivo:</span>
                                <span id="device-info">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Evento:</span>
                                <span id="current-token">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Saved Token -->
                    <button onclick="clearSavedTokenAndNotify()" 
                            class="w-full bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px] mb-3">
                        <i class="fas fa-trash mr-2"></i>Limpar Token Guardado
                    </button>

                    <!-- Logout -->
                    <button onclick="logout()" 
                            class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                        <i class="fas fa-sign-out-alt mr-2"></i>Terminar Sessão
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 right-4 z-40 space-y-2"></div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables
        let currentClient = null;
        let guests = [];
        let scannedGuests = new Set();
        let sessionScans = 0;
        let html5QrCode = null;
        let isScanning = false;
        let fastMode = false;
        let isOnline = false;
        let lastScanTime = 0;
        let scanAttempts = new Map();
        let deviceName = '';
        let currentTheme = 'dark';
        let currentTab = 0;
        let canScan = false;
        let swipeStartX = 0;
        let swipeStartY = 0;

        // Data persistence keys
        const STORAGE_KEYS = {
            SCANNED_GUESTS: 'invitesqr_scanned_guests',
            SCAN_ATTEMPTS: 'invitesqr_scan_attempts',
            SESSION_SCANS: 'invitesqr_session_scans',
            SCAN_HISTORY: 'invitesqr_scan_history',
            CLIENT_DATA: 'invitesqr_client_data',
            GUESTS_DATA: 'invitesqr_guests_data',
            LAST_SYNC: 'invitesqr_last_sync'
        };

        // Intelligence variables
        let sessionStartTime = Date.now();
        let scanningPatterns = {
            successfulScans: [],
            failedAttempts: [],
            averageScanTime: 0,
            peakHours: new Map(),
            commonErrors: new Map()
        };
        let userBehavior = {
            tabSwitches: 0,
            scannerStarts: 0,
            averageSessionTime: 0,
            preferredCamera: null,
            lastActiveTime: Date.now()
        };
        let smartSuggestions = [];
        let communicationLevel = 'normal';
        let lastCommunication = 0;
        let helpShown = new Set();
        let performanceMetrics = {
            scanSpeed: [],
            errorRate: 0,
            efficiency: 100
        };
        let smartMessagesEnabled = true;
        let messageQueue = [];
        let isShowingMessage = false;

        // Simple toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 bg-gray-800 border-l-4 ${
                type === 'success' ? 'border-green-500' : 
                type === 'error' ? 'border-red-500' : 
                type === 'warning' ? 'border-yellow-500' :
                'border-blue-500'
            } p-4 shadow-lg rounded-r-lg max-w-sm slide-up`;
            
            toast.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-${
                        type === 'success' ? 'check-circle text-green-500' : 
                        type === 'error' ? 'exclamation-circle text-red-500' : 
                        type === 'warning' ? 'exclamation-triangle text-yellow-500' :
                        'info-circle text-blue-500'
                    } mr-3 mt-1"></i>
                    <div class="flex-1">
                        <span class="text-white text-sm">${message}</span>
                    </div>
                    <button onclick="this.closest('.slide-up').remove()" class="ml-2 text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Connectivity management
        async function checkConnectivity() {
            console.log('🔍 Checking connectivity...');
            try {
                // Test with a simple fetch to check internet connectivity
                const response = await fetch('https://rnvunprjvppbjavkaoek.supabase.co/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': SUPABASE_KEY
                    }
                });
                
                console.log('✅ Connection test successful:', response.status);
                isOnline = true;
                updateConnectionStatus(true);
                hideOfflineOverlay();
                
            } catch (error) {
                console.error('❌ Connection test failed:', error);
                isOnline = false;
                updateConnectionStatus(false);
                showOfflineOverlay();
                
                if (isScanning) {
                    stopScanner();
                }
            }
        }

        function updateConnectionStatus(online) {
            const indicators = ['connection-status', 'connection-indicator'];
            indicators.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = online ? 
                        '<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div><span class="text-green-400 text-sm">Online</span>' :
                        '<div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div><span class="text-red-400 text-sm">Offline</span>';
                }
            });
        }

        function showOfflineOverlay() {
            document.getElementById('offline-overlay').classList.remove('hidden');
        }

        function hideOfflineOverlay() {
            document.getElementById('offline-overlay').classList.add('hidden');
        }

        // Login functionality
        function setupLoginForm() {
            const form = document.getElementById('login-form');
            const loginBtn = document.getElementById('login-btn');
            
            console.log('🔧 Setting up login form...');
            
            if (!form || !loginBtn) {
                console.error('❌ Login form elements not found');
                return;
            }
            
            // Remove any existing event listeners
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            // Get the new elements
            const finalForm = document.getElementById('login-form');
            const finalLoginBtn = document.getElementById('login-btn');
            
            finalForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('📝 Login form submitted');
                
                const tokenInput = document.getElementById('event-token');
                const token = tokenInput.value.trim();
                console.log('🔑 Token entered:', token);
                
                if (!token) {
                    showToast('Por favor, insira o token do evento', 'error');
                    return;
                }
                
                if (!isOnline) {
                    showToast('Sem conexão com a internet. Verifique sua conexão.', 'error');
                    return;
                }
                
                finalLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';
                finalLoginBtn.disabled = true;

                try {
                    await performLogin(token);
                } catch (error) {
                    console.error('❌ Login error:', error);
                    showToast(error.message || 'Erro ao fazer login', 'error');
                } finally {
                    finalLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
                    finalLoginBtn.disabled = false;
                }
            });
            
            console.log('✅ Login form setup complete');
        }

        async function performLogin(token) {
            console.log('🔐 Performing login with token:', token);
            deviceName = `Scanner-${Date.now()}`;
            
            try {
                // Check if this is a different token than current one
                const isDifferentToken = !currentClient || currentClient.token !== token;
                
                if (isDifferentToken) {
                    // Clear ALL previous data when logging in with new token
                    console.log('🗑️ New token detected, clearing previous client data...');
                    clearAppData();
                    
                    // Reset all variables to ensure clean state
                    currentClient = null;
                    guests = [];
                    scannedGuests = new Set();
                    sessionScans = 0;
                    scanAttempts = new Map();
                }
                
                // Fetch client data
                console.log('📡 Fetching client data from Supabase...');
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();

                console.log('📊 Supabase response:', { data, error });

                if (error) {
                    console.error('❌ Supabase error:', error);
                    throw new Error('Token inválido ou erro de conexão');
                }
                
                if (!data) {
                    console.error('❌ No data returned for token:', token);
                    throw new Error('Token não encontrado ou inválido');
                }

                console.log('✅ Client data found:', data);

                // Check if event is still valid (CRITICAL FIX: multiply by 1000)
                const eventDate = new Date(data.validade * 1000);
                const now = new Date();
                
                console.log('📅 Event date:', eventDate, 'Current date:', now);
                
                if (eventDate < now) {
                    throw new Error('Evento expirado');
                }

                currentClient = data;
                console.log('👤 Current client set:', currentClient);
                
                // Save token for future use
                saveToken(token);
                
                // Log login
                try {
                    await supabase.from('logs').insert([{
                        token: token,
                        status: 'login',
                        dispositivo: deviceName
                    }]);
                    console.log('📝 Login logged successfully');
                } catch (logError) {
                    console.warn('⚠️ Failed to log login:', logError);
                }

                // Load guests and sync data (always reload for new or updated tokens)
                console.log('👥 Loading guests...');
                await loadGuests();
                
                // Additional sync to ensure we have latest data
                console.log('🔄 Final sync check...');
                await syncScannedGuestsFromDatabase();
                
                // Save data after successful login
                console.log('💾 Saving data after login...');
                saveAppData();
                
                // Switch to main app
                console.log('🔄 Switching to main app...');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                updateHeader();
                updateStats();
                
                const message = isDifferentToken ? 'Login realizado com sucesso!' : 'Dados atualizados com sucesso!';
                showToast(message, 'success');
                console.log('✅ Login completed successfully');
                
            } catch (error) {
                console.error('❌ Login failed:', error);
                throw error;
            }
        }

        // Load guests for current event
        async function loadGuests() {
            try {
                console.log('🔄 Loading guests for token:', currentClient.token);
                
                const { data, error } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo');

                if (error) {
                    console.error('❌ Error loading guests:', error);
                    throw error;
                }
                
                guests = data || [];
                
                // Add VIP status if not present (default to false)
                guests = guests.map(guest => ({
                    ...guest,
                    is_vip: guest.is_vip || false
                }));
                
                console.log(`✅ Loaded ${guests.length} guests for current client`);
                
                // Sync scanned guests from database
                await syncScannedGuestsFromDatabase();
                
                renderGuests();
                updateStats();
                
            } catch (error) {
                console.error('❌ Failed to load guests:', error);
                showToast('Erro ao carregar convidados', 'error');
            }
        }

        // Sync scanned guests from database across devices
        async function syncScannedGuestsFromDatabase() {
            try {
                console.log('🔄 Syncing scanned guests from database...');
                
                const { data, error } = await supabase
                    .from('logs')
                    .select('convidado_id, created_at')
                    .eq('token', currentClient.token)
                    .eq('status', 'scan_success')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ Error syncing scanned guests:', error);
                    return;
                }

                // Clear current scanned guests and rebuild from database
                const previousScannedCount = scannedGuests.size;
                scannedGuests.clear();
                
                // Add all scanned guests from database
                if (data && data.length > 0) {
                    data.forEach(log => {
                        if (log.convidado_id) {
                            scannedGuests.add(log.convidado_id.toString());
                        }
                    });
                }
                
                const newScannedCount = scannedGuests.size;
                console.log(`✅ Synced ${newScannedCount} scanned guests from database`);
                
                // Show sync notification if there were changes
                if (newScannedCount !== previousScannedCount) {
                    const difference = newScannedCount - previousScannedCount;
                    if (difference > 0) {
                        showToast(`Sincronizado: ${difference} novos convidados validados`, 'success');
                    } else if (difference < 0) {
                        showToast(`Sincronizado: ${Math.abs(difference)} validações removidas`, 'info');
                    }
                }
                
                // Save updated data
                saveAppData();
                
            } catch (error) {
                console.error('❌ Error syncing scanned guests:', error);
            }
        }

        // Update header information
        function updateHeader() {
            if (!currentClient) return;
            
            document.getElementById('event-name').textContent = currentClient.nome;
            
            // CRITICAL FIX: multiply by 1000 for correct date conversion
            const eventDate = new Date(currentClient.validade * 1000);
            const formattedDate = eventDate.toLocaleDateString('pt-PT');
            
            document.getElementById('event-info').textContent = 
                `Válido até ${formattedDate} • ${guests.length} convidados`;
            
            document.getElementById('device-info').textContent = deviceName;
            document.getElementById('current-token').textContent = currentClient.token;
        }

        // Update statistics
        function updateStats() {
            const scannedCount = scannedGuests.size;
            const totalGuests = guests.length;
            const progressPercentage = totalGuests > 0 ? Math.round((scannedCount / totalGuests) * 100) : 0;

            // Update scanner progress bar
            document.getElementById('scanner-progress-percentage').textContent = progressPercentage + '%';
            document.getElementById('scanner-progress-bar').style.width = progressPercentage + '%';
            document.getElementById('scanner-validated-count').textContent = scannedCount + ' validados';
            document.getElementById('scanner-total-count').textContent = `de ${totalGuests} convidados`;

            // Update options stats
            document.getElementById('options-scanned-count').textContent = scannedCount;
            document.getElementById('options-total-guests').textContent = totalGuests;
            document.getElementById('options-session-scans').textContent = sessionScans;
            
            // Update clear scans count
            const clearScansCount = document.getElementById('clear-scans-count');
            if (clearScansCount) {
                clearScansCount.textContent = scannedCount;
            }
            
            // Update reports
            const reportValidated = document.getElementById('report-validated');
            const reportPending = document.getElementById('report-pending');
            const progressPercentageEl = document.getElementById('progress-percentage');
            const progressBar = document.getElementById('progress-bar');
            
            if (reportValidated) reportValidated.textContent = scannedCount;
            if (reportPending) reportPending.textContent = totalGuests - scannedCount;
            if (progressPercentageEl) progressPercentageEl.textContent = progressPercentage + '%';
            if (progressBar) progressBar.style.width = progressPercentage + '%';
        }

        // Token validation system
        async function validateCurrentToken() {
            if (!currentClient || !isOnline) {
                return;
            }
            
            try {
                console.log('🔍 Validating current token:', currentClient.token);
                
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', currentClient.token)
                    .single();
                
                if (error || !data) {
                    console.log('❌ Token no longer exists in database');
                    await handleInvalidToken('Token removido do sistema');
                    return;
                }
                
                // Check if event is still valid
                const eventDate = new Date(data.validade * 1000);
                const now = new Date();
                
                if (eventDate < now) {
                    console.log('❌ Token expired');
                    await handleInvalidToken('Evento expirado');
                    return;
                }
                
                // Check if token data has changed and update if needed
                if (JSON.stringify(currentClient) !== JSON.stringify(data)) {
                    console.log('🔄 Token data changed, updating...');
                    currentClient = data;
                    await loadGuests(); // Reload guests for updated token
                    updateHeader();
                    updateStats();
                    saveAppData();
                    showToast('Dados do evento atualizados', 'info');
                }
                
                console.log('✅ Token still valid');
                
            } catch (error) {
                console.error('❌ Error validating token:', error);
            }
        }
        
        async function handleInvalidToken(reason) {
            console.log('🚨 Handling invalid token:', reason);
            
            // Stop scanner if running
            if (isScanning) {
                await stopScanner();
            }
            
            // Clear all data completely
            clearAppData();
            clearSavedToken();
            
            // Reset all variables
            currentClient = null;
            guests = [];
            scannedGuests = new Set();
            sessionScans = 0;
            scanAttempts = new Map();
            
            // Show login screen
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            // Reset form
            document.getElementById('login-form').reset();
            
            // Show error message
            showToast(`Sessão terminada: ${reason}`, 'error');
            
            console.log('🔄 App reset to login screen');
        }

        // Data persistence system
        function saveAppData() {
            try {
                console.log('💾 Saving app data to localStorage...');
                
                localStorage.setItem(STORAGE_KEYS.SCANNED_GUESTS, JSON.stringify(Array.from(scannedGuests)));
                
                const attemptsObj = {};
                scanAttempts.forEach((value, key) => {
                    attemptsObj[key] = value;
                });
                localStorage.setItem(STORAGE_KEYS.SCAN_ATTEMPTS, JSON.stringify(attemptsObj));
                
                localStorage.setItem(STORAGE_KEYS.SESSION_SCANS, sessionScans.toString());
                
                if (currentClient) {
                    localStorage.setItem(STORAGE_KEYS.CLIENT_DATA, JSON.stringify(currentClient));
                }
                
                localStorage.setItem(STORAGE_KEYS.GUESTS_DATA, JSON.stringify(guests));
                localStorage.setItem(STORAGE_KEYS.LAST_SYNC, Date.now().toString());
                
                console.log('✅ App data saved successfully');
                
            } catch (error) {
                console.error('❌ Error saving app data:', error);
            }
        }
        
        function loadAppData() {
            try {
                console.log('📂 Loading app data from localStorage...');
                
                const savedScannedGuests = localStorage.getItem(STORAGE_KEYS.SCANNED_GUESTS);
                if (savedScannedGuests) {
                    const scannedArray = JSON.parse(savedScannedGuests);
                    scannedGuests = new Set(scannedArray);
                    console.log(`📋 Loaded ${scannedGuests.size} scanned guests`);
                }
                
                const savedScanAttempts = localStorage.getItem(STORAGE_KEYS.SCAN_ATTEMPTS);
                if (savedScanAttempts) {
                    const attemptsObj = JSON.parse(savedScanAttempts);
                    scanAttempts = new Map(Object.entries(attemptsObj));
                    console.log(`🔄 Loaded ${scanAttempts.size} scan attempts`);
                }
                
                const savedSessionScans = localStorage.getItem(STORAGE_KEYS.SESSION_SCANS);
                if (savedSessionScans) {
                    sessionScans = parseInt(savedSessionScans) || 0;
                    console.log(`📈 Loaded session scans: ${sessionScans}`);
                }
                
                const savedClientData = localStorage.getItem(STORAGE_KEYS.CLIENT_DATA);
                if (savedClientData) {
                    currentClient = JSON.parse(savedClientData);
                    console.log(`👤 Loaded client: ${currentClient.nome}`);
                }
                
                const savedGuestsData = localStorage.getItem(STORAGE_KEYS.GUESTS_DATA);
                if (savedGuestsData) {
                    guests = JSON.parse(savedGuestsData);
                    console.log(`👥 Loaded ${guests.length} guests`);
                }
                
                console.log('✅ App data loaded successfully');
                return true;
                
            } catch (error) {
                console.error('❌ Error loading app data:', error);
                return false;
            }
        }
        
        function clearAppData() {
            try {
                console.log('🗑️ Clearing app data...');
                
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                scannedGuests = new Set();
                scanAttempts = new Map();
                sessionScans = 0;
                currentClient = null;
                guests = [];
                
                console.log('✅ App data cleared successfully');
                
            } catch (error) {
                console.error('❌ Error clearing app data:', error);
            }
        }

        // Token storage management
        function saveToken(token) {
            try {
                localStorage.setItem('invitesqr_token', token);
                localStorage.setItem('invitesqr_token_date', Date.now().toString());
            } catch (error) {
                console.error('Error saving token:', error);
            }
        }

        function getSavedToken() {
            try {
                const token = localStorage.getItem('invitesqr_token');
                const savedDate = localStorage.getItem('invitesqr_token_date');
                
                if (!token || !savedDate) return null;
                
                const daysSaved = (Date.now() - parseInt(savedDate)) / (1000 * 60 * 60 * 24);
                if (daysSaved > 30) {
                    clearSavedToken();
                    return null;
                }
                
                return token;
            } catch (error) {
                console.error('Error getting saved token:', error);
                return null;
            }
        }

        function clearSavedToken() {
            try {
                localStorage.removeItem('invitesqr_token');
                localStorage.removeItem('invitesqr_token_date');
            } catch (error) {
                console.error('Error clearing saved token:', error);
            }
        }

        function clearSavedTokenAndNotify() {
            clearSavedToken();
            showToast('Token guardado removido com sucesso', 'success');
        }

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('invitesqr_theme') || 'dark';
            currentTheme = savedTheme;
            applyTheme(currentTheme);
            
            const savedSmartMessages = localStorage.getItem('invitesqr_smart_messages');
            if (savedSmartMessages !== null) {
                smartMessagesEnabled = savedSmartMessages === 'true';
                const smartMessagesToggle = document.getElementById('smart-messages');
                if (smartMessagesToggle) {
                    smartMessagesToggle.checked = smartMessagesEnabled;
                }
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('invitesqr_theme', currentTheme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.className = theme === 'dark' ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
            }
        }

        // Tab management
        function showTab(tabName) {
            const tabIndex = tabName === 'scanner' ? 0 : 1;
            currentTab = tabIndex;
            
            userBehavior.tabSwitches++;
            userBehavior.lastActiveTime = Date.now();
            
            // Make sure main content is visible and sub-tabs are hidden
            document.getElementById('main-content').classList.remove('hidden');
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            const swipeContent = document.getElementById('swipe-content');
            if (swipeContent) {
                swipeContent.style.transform = `translateX(-${tabIndex * 50}%)`;
            }
            
            // Update tab button styles
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = btn.className.replace('bg-blue-600 text-white', 'text-gray-400 hover:text-white');
            });
            
            const activeBtn = document.getElementById(`tab-${tabName}`);
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('text-gray-400 hover:text-white', 'bg-blue-600 text-white');
            }

            // Update swipe dots
            const dots = document.querySelectorAll('.swipe-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === tabIndex);
            });
            
            // Initialize scanner if needed
            if (tabName === 'scanner' && !html5QrCode) {
                initializeScanner();
            }
        }

        function showSubTab(subTabName) {
            document.getElementById('main-content').classList.add('hidden');
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.getElementById(`content-${subTabName}`).classList.remove('hidden');
        }

        // Logout functionality
        async function logout() {
            try {
                if (currentClient) {
                    await supabase.from('logs').insert([{
                        token: currentClient.token,
                        status: 'logout',
                        dispositivo: deviceName
                    }]);
                }
            } catch (error) {
                console.warn('Failed to log logout:', error);
            }
            
            if (isScanning) {
                await stopScanner();
            }
            
            clearAppData();
            clearSavedToken();
            
            currentClient = null;
            guests = [];
            scannedGuests = new Set();
            sessionScans = 0;
            scanAttempts = new Map();
            
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            
            document.getElementById('login-form').reset();
            
            showToast('Sessão terminada com sucesso', 'success');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 App initializing...');
            
            console.log('📂 Loading saved data...');
            loadAppData();
            
            console.log('🎨 Initializing theme...');
            initializeTheme();
            
            console.log('🌐 Checking connectivity...');
            await checkConnectivity();
            
            console.log('📝 Setting up login form...');
            setupLoginForm();
            
            console.log('👆 Setting up swipe navigation...');
            setupSwipeNavigation();
            
            setTimeout(() => {
                console.log('🎯 Setting up event listeners...');
                setupEventListeners();
                loadCameras();
            }, 100);
            
            setTimeout(() => {
                console.log('🔑 Checking saved token...');
                checkSavedTokenWithData();
            }, 500);
            
            setTimeout(() => {
                console.log('🧠 Initializing intelligent system...');
                initializeIntelligentSystem();
            }, 1000);
            
            setInterval(saveAppData, 30000);
            setInterval(checkConnectivity, 30000);
            setInterval(validateCurrentToken, 1000); // Check token every second
            setInterval(syncScannedGuestsFromDatabase, 60000); // Sync every minute
            
            console.log('✅ App initialized successfully');
        });

        // QR Scanner functionality
        async function initializeScanner() {
            try {
                console.log('📷 Initializing QR scanner...');
                
                if (html5QrCode) {
                    console.log('Scanner already initialized');
                    return;
                }
                
                html5QrCode = new Html5Qrcode("qr-reader-inline");
                console.log('✅ QR scanner initialized');
                
            } catch (error) {
                console.error('❌ Error initializing scanner:', error);
                showToast('Erro ao inicializar scanner', 'error');
            }
        }

        async function toggleScanner(event) {
            // Prevent any navigation or form submission
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (isScanning) {
                await stopScanner();
            } else {
                await startScanner();
            }
        }

        async function startScanner() {
            try {
                if (!isOnline) {
                    showToast('Sem conexão com a internet', 'error');
                    return;
                }

                if (!html5QrCode) {
                    await initializeScanner();
                }

                console.log('🎬 Starting QR scanner...');
                
                const scannerToggle = document.getElementById('scanner-toggle');
                scannerToggle.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Iniciando...';
                scannerToggle.disabled = true;

                // Show scanner container
                document.getElementById('inline-scanner-container').classList.remove('hidden');
                
                // Configure scanner for faster detection with larger scan area
                const config = {
                    fps: 30, // Increased from 10 to 30 for faster scanning
                    qrbox: { width: 350, height: 350 }, // Much larger scan area
                    aspectRatio: 1.0,
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    },
                    rememberLastUsedCamera: true,
                    showTorchButtonIfSupported: true
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanFailure
                );

                isScanning = true;
                canScan = true;
                userBehavior.scannerStarts++;
                
                // Update UI
                scannerToggle.innerHTML = '<i class="fas fa-stop mr-2"></i>Parar Scanner';
                scannerToggle.className = 'w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
                scannerToggle.disabled = false;
                
                // Update status
                updateScanStatus('active', 'Escaneando...');
                
                // Show targeting frame when scanning starts
                const targetingFrame = document.getElementById('scanner-targeting-frame');
                if (targetingFrame) {
                    targetingFrame.classList.remove('hidden');
                }
                
                // Hide instructions after a moment
                setTimeout(() => {
                    const instructions = document.getElementById('inline-scanner-instructions');
                    if (instructions) {
                        instructions.classList.add('fade-out');
                    }
                }, 2000);

                console.log('✅ QR scanner started successfully');
                
            } catch (error) {
                console.error('❌ Error starting scanner:', error);
                showToast('Erro ao iniciar scanner: ' + error.message, 'error');
                
                const scannerToggle = document.getElementById('scanner-toggle');
                scannerToggle.innerHTML = '<i class="fas fa-play mr-2"></i>Iniciar Scanner';
                scannerToggle.className = 'w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
                scannerToggle.disabled = false;
            }
        }

        async function stopScanner() {
            try {
                if (html5QrCode && isScanning) {
                    console.log('⏹️ Stopping QR scanner...');
                    await html5QrCode.stop();
                }
                
                isScanning = false;
                canScan = false;
                
                // Update UI
                const scannerToggle = document.getElementById('scanner-toggle');
                scannerToggle.innerHTML = '<i class="fas fa-play mr-2"></i>Iniciar Scanner';
                scannerToggle.className = 'w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
                scannerToggle.disabled = false;
                
                // Hide scanner container
                document.getElementById('inline-scanner-container').classList.add('hidden');
                
                // Hide targeting frame
                const targetingFrame = document.getElementById('scanner-targeting-frame');
                if (targetingFrame) {
                    targetingFrame.classList.add('hidden');
                }
                
                // Reset status
                updateScanStatus('disabled', 'Scanner parado');
                
                console.log('✅ QR scanner stopped');
                
            } catch (error) {
                console.error('❌ Error stopping scanner:', error);
            }
        }

        function updateScanStatus(status, message) {
            const statusDot = document.getElementById('inline-scan-status-dot');
            const statusLabel = document.getElementById('inline-scan-status-label');
            
            if (statusDot && statusLabel) {
                statusLabel.textContent = message;
                
                // Remove all status classes
                statusDot.parentElement.className = statusDot.parentElement.className.replace(/scan-status-\w+/g, '');
                
                // Add new status class
                statusDot.parentElement.classList.add(`scan-status-${status}`);
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            if (!canScan) return;
            
            console.log('📱 QR Code scanned:', decodedText);
            console.log('📊 Total guests loaded:', guests.length);
            console.log('🔍 Sample QR codes from database:', guests.slice(0, 3).map(g => ({
                id: g.id,
                nome: g.nome,
                qr_code: g.qr_code,
                email: g.email
            })));
            
            canScan = false; // Prevent multiple scans
            
            const now = Date.now();
            if (now - lastScanTime < 300) {
                console.log('⚠️ Scan too fast, ignoring');
                setTimeout(() => canScan = true, 300);
                return;
            }
            lastScanTime = now;
            
            try {
                // Clean the scanned text - remove any whitespace and normalize
                const cleanScannedText = decodedText.toString().trim();
                console.log('🧹 Cleaned scanned text:', cleanScannedText);
                console.log('📊 Total guests loaded:', guests.length);
                
                let guest = null;
                
                // Method 1: Direct exact match with QR code
                guest = guests.find(g => g.qr_code && g.qr_code.toString().trim() === cleanScannedText);
                console.log('🔍 Method 1 (QR exact):', guest ? `Found: ${guest.nome}` : 'Not found');
                
                // Method 2: Try by ID if scanned text is numeric
                if (!guest && /^\d+$/.test(cleanScannedText)) {
                    guest = guests.find(g => g.id.toString() === cleanScannedText);
                    console.log('🔍 Method 2 (by ID):', guest ? `Found: ${guest.nome}` : 'Not found');
                }
                
                // Method 3: Case insensitive QR code match
                if (!guest) {
                    guest = guests.find(g => g.qr_code && 
                        g.qr_code.toString().trim().toLowerCase() === cleanScannedText.toLowerCase());
                    console.log('🔍 Method 3 (QR case insensitive):', guest ? `Found: ${guest.nome}` : 'Not found');
                }
                
                // Debug: Show what we're comparing against if not found
                if (!guest) {
                    console.log('❌ QR Code not found. Debugging info:');
                    console.log('Scanned text:', `"${cleanScannedText}"`);
                    console.log('Scanned text length:', cleanScannedText.length);
                    console.log('Scanned text type:', typeof cleanScannedText);
                    
                    // Show first 10 QR codes from database
                    const availableQRCodes = guests.map(g => ({
                        id: g.id,
                        nome: g.nome,
                        qr_code: g.qr_code,
                        qr_type: typeof g.qr_code,
                        qr_length: g.qr_code ? g.qr_code.toString().length : 0
                    })).slice(0, 10);
                    
                    console.log('Available QR codes (first 10):', availableQRCodes);
                    
                    // Check for exact matches manually
                    const exactMatches = guests.filter(g => g.qr_code && g.qr_code.toString().trim() === cleanScannedText);
                    console.log('Exact matches found:', exactMatches.length);
                    
                    // Check for case insensitive matches
                    const caseInsensitiveMatches = guests.filter(g => g.qr_code && 
                        g.qr_code.toString().trim().toLowerCase() === cleanScannedText.toLowerCase());
                    console.log('Case insensitive matches found:', caseInsensitiveMatches.length);
                }
                
                if (!guest) {
                    await handleScanError(`QR "${cleanScannedText}" não encontrado na lista de ${guests.length} convidados`);
                    return;
                }
                
                // Check if already scanned
                if (scannedGuests.has(guest.id.toString())) {
                    await handleScanError(`${guest.nome} já foi validado anteriormente`);
                    return;
                }
                
                console.log('✅ Guest found and will be validated:', guest.nome);
                
                // Validate guest
                await validateGuest(guest);
                
            } catch (error) {
                console.error('❌ Error processing scan:', error);
                await handleScanError('Erro ao processar QR code');
            }
        }

        function onScanFailure(error) {
            // Silent failure - this is normal when no QR code is visible
        }

        async function validateGuest(guest) {
            try {
                console.log('✅ Validating guest:', guest.nome);
                
                // Add to scanned guests
                scannedGuests.add(guest.id.toString());
                sessionScans++;
                
                // Log to database
                await supabase.from('logs').insert([{
                    token: currentClient.token,
                    convidado_id: guest.id,
                    status: 'scan_success',
                    dispositivo: deviceName
                }]);
                
                // Show success with VIP status
                const vipMessage = guest.is_vip ? '👑 VIP Validado!' : '✅ Validado com sucesso!';
                await showScanResult('success', guest.nome, vipMessage, guest.is_vip);
                
                // Update stats
                updateStats();
                renderGuests();
                updateRecentScans();
                
                // Save data
                saveAppData();
                
                // Play success sound and vibrate (different for VIP)
                if (guest.is_vip) {
                    playVIPSound();
                    vibrate([100, 50, 100, 50, 100]); // Special VIP vibration pattern
                } else {
                    playSuccessSound();
                    vibrate([100]);
                }
                
                console.log('✅ Guest validated successfully');
                
            } catch (error) {
                console.error('❌ Error validating guest:', error);
                await handleScanError('Erro ao validar convidado');
            }
        }

        async function handleScanError(message) {
            console.log('❌ Scan error:', message);
            
            await showScanResult('error', '', message);
            
            // Play error sound and vibrate
            playErrorSound();
            vibrate([200, 100, 200]);
            
            // Re-enable scanning after delay
            setTimeout(() => {
                canScan = true;
                updateScanStatus('active', 'Escaneando...');
            }, 2000);
        }

        async function showScanResult(type, guestName, message, isVip = false) {
            const resultDisplay = document.getElementById('inline-scan-result-display');
            const statusText = document.getElementById('inline-scan-status-text');
            const guestNameDisplay = document.getElementById('inline-scan-guest-name-display');
            const timeDisplay = document.getElementById('inline-scan-time-display');
            const nextBtn = document.getElementById('next-scan-btn');
            
            if (resultDisplay && statusText) {
                // Update content
                statusText.textContent = message;
                statusText.className = `text-2xl font-bold mb-2 ${
                    type === 'success' ? 
                        (isVip ? 'text-yellow-400' : 'text-green-400') : 
                        'text-red-400'
                }`;
                
                if (guestNameDisplay) {
                    guestNameDisplay.textContent = guestName;
                    guestNameDisplay.className = `text-lg mb-1 ${
                        isVip ? 'text-yellow-300 font-bold' : 'text-white'
                    }`;
                }
                
                if (timeDisplay) {
                    timeDisplay.textContent = new Date().toLocaleTimeString('pt-PT');
                }
                
                // Show result
                resultDisplay.classList.remove('hidden');
                
                // Show next button for success
                if (type === 'success' && nextBtn) {
                    nextBtn.classList.remove('hidden');
                    if (isVip) {
                        nextBtn.className = 'w-full bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
                        nextBtn.innerHTML = '<i class="fas fa-crown mr-2"></i>Próximo Convidado';
                    } else {
                        nextBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
                        nextBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>Próximo Convidado';
                    }
                }
                
                // Flash effect (golden for VIP)
                const scanner = document.getElementById('inline-scanner-container');
                if (scanner) {
                    if (type === 'success' && isVip) {
                        scanner.classList.add('vip-flash');
                        setTimeout(() => {
                            scanner.classList.remove('vip-flash');
                        }, 800);
                    } else {
                        scanner.classList.add(type === 'success' ? 'success-flash' : 'error-flash');
                        setTimeout(() => {
                            scanner.classList.remove('success-flash', 'error-flash');
                        }, 500);
                    }
                }
            }
        }

        function enableNextScan(event) {
            // Prevent any navigation
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const resultDisplay = document.getElementById('inline-scan-result-display');
            const nextBtn = document.getElementById('next-scan-btn');
            
            if (resultDisplay) resultDisplay.classList.add('hidden');
            if (nextBtn) nextBtn.classList.add('hidden');
            
            canScan = true;
            updateScanStatus('active', 'Escaneando...');
        }

        // Audio feedback
        function playSuccessSound() {
            if (!document.getElementById('success-sound').checked) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        function playVIPSound() {
            if (!document.getElementById('success-sound').checked) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create a more elaborate VIP sound with multiple tones
                const times = [0, 0.1, 0.2, 0.3];
                const frequencies = [800, 1000, 1200, 1000];
                
                times.forEach((time, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequencies[index], audioContext.currentTime + time);
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + time);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + 0.15);
                    
                    oscillator.start(audioContext.currentTime + time);
                    oscillator.stop(audioContext.currentTime + time + 0.15);
                });
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        function playErrorSound() {
            if (!document.getElementById('error-sound').checked) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio not supported');
            }
        }

        // Vibration feedback
        function vibrate(pattern) {
            if (!document.getElementById('vibration').checked) return;
            
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Guest management
        function renderGuests() {
            const guestsList = document.getElementById('guests-list');
            if (!guestsList) return;
            
            if (guests.length === 0) {
                guestsList.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-users text-3xl mb-2"></i>
                        <p>Nenhum convidado encontrado</p>
                    </div>
                `;
                return;
            }
            
            const guestsHtml = guests.map(guest => {
                const isScanned = scannedGuests.has(guest.id.toString());
                const isVip = guest.is_vip;
                return `
                    <div class="bg-gray-800 rounded-lg p-4 flex items-center justify-between ${isVip ? 'border-l-4 border-yellow-500' : ''}">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <h4 class="font-medium ${isVip ? 'text-yellow-300' : 'text-white'}">${guest.nome}</h4>
                                ${isVip ? '<i class="fas fa-crown text-yellow-500 ml-2"></i>' : ''}
                            </div>
                            <p class="text-sm text-gray-400">ID: ${guest.id} | QR: ${guest.qr_code || 'N/A'}</p>
                            ${isVip ? '<p class="text-xs text-yellow-400 font-medium">VIP</p>' : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            ${isScanned ? 
                                `<i class="fas fa-check-circle ${isVip ? 'text-yellow-500' : 'text-green-500'} text-xl"></i>` : 
                                '<i class="fas fa-clock text-gray-500 text-xl"></i>'
                            }
                            <button onclick="toggleVipStatus(${guest.id})" class="text-xs px-2 py-1 rounded ${isVip ? 'bg-yellow-600 text-white' : 'bg-gray-600 text-gray-300'} hover:opacity-80">
                                ${isVip ? 'VIP' : 'Normal'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            guestsList.innerHTML = guestsHtml;
        }

        function filterGuests() {
            const searchTerm = document.getElementById('guest-search').value.toLowerCase();
            const guestItems = document.querySelectorAll('#guests-list > div');
            
            guestItems.forEach(item => {
                const guestName = item.querySelector('h4').textContent.toLowerCase();
                const guestInfo = item.querySelector('p').textContent.toLowerCase();
                
                if (guestName.includes(searchTerm) || guestInfo.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function filterGuestsByStatus(status) {
            // Update filter buttons
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600';
            });
            
            document.getElementById(`filter-${status}`).className = 'flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white text-sm min-h-[44px] active:bg-blue-700';
            
            // Filter guests
            const guestItems = document.querySelectorAll('#guests-list > div');
            
            guestItems.forEach(item => {
                const hasCheckIcon = item.querySelector('.fa-check-circle');
                const isScanned = !!hasCheckIcon;
                
                if (status === 'all') {
                    item.style.display = 'block';
                } else if (status === 'scanned' && isScanned) {
                    item.style.display = 'block';
                } else if (status === 'pending' && !isScanned) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateRecentScans() {
            const recentScansContainer = document.getElementById('recent-scans');
            if (!recentScansContainer) return;
            
            const recentScans = Array.from(scannedGuests).slice(-5).map(guestId => {
                const guest = guests.find(g => g.id.toString() === guestId);
                return guest ? {
                    name: guest.nome,
                    time: new Date().toLocaleTimeString('pt-PT')
                } : null;
            }).filter(Boolean);
            
            if (recentScans.length === 0) {
                recentScansContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <p>Nenhuma validação ainda</p>
                    </div>
                `;
                return;
            }
            
            const scansHtml = recentScans.map(scan => `
                <div class="bg-gray-800 rounded-lg p-3 flex items-center justify-between">
                    <div>
                        <h4 class="font-medium text-white">${scan.name}</h4>
                        <p class="text-sm text-gray-400">${scan.time}</p>
                    </div>
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
            `).join('');
            
            recentScansContainer.innerHTML = scansHtml;
        }

        async function clearAllScans() {
            if (scannedGuests.size === 0) {
                showToast('Nenhuma validação para limpar', 'info');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja limpar ${scannedGuests.size} validações?`)) {
                return;
            }
            
            try {
                scannedGuests.clear();
                sessionScans = 0;
                
                updateStats();
                renderGuests();
                updateRecentScans();
                saveAppData();
                
                showToast('Todas as validações foram limpas', 'success');
                
            } catch (error) {
                console.error('Error clearing scans:', error);
                showToast('Erro ao limpar validações', 'error');
            }
        }

        // Report generation
        function generatePDFReport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(20);
                doc.text('Relatório do Evento', 20, 30);
                
                // Event info
                doc.setFontSize(12);
                doc.text(`Evento: ${currentClient.nome}`, 20, 50);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-PT')}`, 20, 60);
                doc.text(`Total de Convidados: ${guests.length}`, 20, 70);
                doc.text(`Validados: ${scannedGuests.size}`, 20, 80);
                doc.text(`Pendentes: ${guests.length - scannedGuests.size}`, 20, 90);
                
                // Progress
                const progress = guests.length > 0 ? Math.round((scannedGuests.size / guests.length) * 100) : 0;
                doc.text(`Progresso: ${progress}%`, 20, 100);
                
                // Save
                doc.save(`relatorio-${currentClient.token}-${Date.now()}.pdf`);
                
                showToast('Relatório PDF gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('Erro ao gerar relatório PDF', 'error');
            }
        }

        function shareReport() {
            const reportText = `
Relatório do Evento: ${currentClient.nome}
Data: ${new Date().toLocaleDateString('pt-PT')}
Total de Convidados: ${guests.length}
Validados: ${scannedGuests.size}
Pendentes: ${guests.length - scannedGuests.size}
Progresso: ${guests.length > 0 ? Math.round((scannedGuests.size / guests.length) * 100) : 0}%
            `.trim();
            
            if (navigator.share) {
                navigator.share({
                    title: 'Relatório do Evento',
                    text: reportText
                });
            } else {
                navigator.clipboard.writeText(reportText).then(() => {
                    showToast('Relatório copiado para a área de transferência', 'success');
                });
            }
        }

        // Utility functions
        function setupEventListeners() {
            // Add any additional event listeners here
        }

        function setupSwipeNavigation() {
            const swipeContent = document.getElementById('swipe-content');
            const mainContent = document.getElementById('main-content');
            
            if (!swipeContent || !mainContent) return;
            
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;
            let isDragging = false;
            let isHorizontalSwipe = false;
            
            mainContent.addEventListener('touchstart', (e) => {
                // Don't interfere with scanner area
                if (e.target.closest('#inline-scanner-container') || 
                    e.target.closest('#qr-reader-inline') ||
                    isScanning) {
                    return;
                }
                
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
                isHorizontalSwipe = false;
            }, { passive: true });
            
            mainContent.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                // Don't interfere with scanner area
                if (e.target.closest('#inline-scanner-container') || 
                    e.target.closest('#qr-reader-inline') ||
                    isScanning) {
                    return;
                }
                
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
                
                const diffX = Math.abs(currentX - startX);
                const diffY = Math.abs(currentY - startY);
                
                // Only start horizontal swipe if movement is more horizontal than vertical
                if (!isHorizontalSwipe && diffX > 10) {
                    if (diffX > diffY * 1.5) {
                        isHorizontalSwipe = true;
                        e.preventDefault(); // Prevent scrolling only for horizontal swipes
                    } else {
                        isDragging = false; // Cancel swipe if it's more vertical
                        return;
                    }
                }
                
                if (isHorizontalSwipe) {
                    const diffX = currentX - startX;
                    const translateX = -currentTab * 50 + (diffX / window.innerWidth) * 50;
                    swipeContent.style.transform = `translateX(${translateX}%)`;
                }
            }, { passive: false });
            
            mainContent.addEventListener('touchend', (e) => {
                if (!isDragging || !isHorizontalSwipe) {
                    isDragging = false;
                    isHorizontalSwipe = false;
                    return;
                }
                
                // Don't interfere with scanner area
                if (e.target.closest('#inline-scanner-container') || 
                    e.target.closest('#qr-reader-inline') ||
                    isScanning) {
                    isDragging = false;
                    isHorizontalSwipe = false;
                    return;
                }
                
                const diffX = currentX - startX;
                const threshold = window.innerWidth * 0.25; // Increased threshold
                
                if (Math.abs(diffX) > threshold) {
                    if (diffX > 0 && currentTab > 0) {
                        showTab('scanner');
                    } else if (diffX < 0 && currentTab < 1) {
                        showTab('options');
                    }
                } else {
                    // Snap back
                    swipeContent.style.transform = `translateX(-${currentTab * 50}%)`;
                }
                
                isDragging = false;
                isHorizontalSwipe = false;
            }, { passive: true });
        }

        function loadCameras() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                return;
            }
            
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    const cameraSelect = document.getElementById('camera-select');
                    
                    if (cameraSelect) {
                        cameraSelect.innerHTML = '<option value="">Câmera padrão</option>';
                        
                        videoDevices.forEach((device, index) => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.textContent = device.label || `Câmera ${index + 1}`;
                            cameraSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading cameras:', error);
                });
        }

        function checkSavedTokenWithData() {
            const savedToken = getSavedToken();
            if (savedToken && loadAppData() && currentClient) {
                document.getElementById('event-token').value = savedToken;
                
                // Auto-login if we have valid saved data
                if (isOnline) {
                    performLogin(savedToken).catch(error => {
                        console.error('Auto-login failed:', error);
                        clearAppData();
                    });
                }
            }
        }

        function initializeIntelligentSystem() {
            // Initialize intelligent features
            sessionStartTime = Date.now();
            
            // Set up periodic sync
            setInterval(async () => {
                if (currentClient && isOnline) {
                    await syncScannedGuestsFromDatabase();
                }
            }, 60000); // Sync every minute
        }

        function toggleDebug() { 
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) debugInfo.classList.toggle('hidden');
        }

        function toggleSmartMessages() {
            const checkbox = document.getElementById('smart-messages');
            if (checkbox) {
                smartMessagesEnabled = checkbox.checked;
                localStorage.setItem('invitesqr_smart_messages', smartMessagesEnabled.toString());
                showToast(smartMessagesEnabled ? 'Mensagens inteligentes ativadas' : 'Mensagens inteligentes desativadas', 'info');
            }
        }

        async function toggleVipStatus(guestId) {
            try {
                const guest = guests.find(g => g.id === guestId);
                if (!guest) return;
                
                // Toggle VIP status
                guest.is_vip = !guest.is_vip;
                
                // Update in database (if you want to persist VIP status)
                try {
                    await supabase
                        .from('convidados')
                        .update({ is_vip: guest.is_vip })
                        .eq('id', guestId);
                } catch (dbError) {
                    console.warn('Could not update VIP status in database:', dbError);
                }
                
                // Re-render guests list
                renderGuests();
                
                // Save data locally
                saveAppData();
                
                // Show notification
                const status = guest.is_vip ? 'VIP' : 'Normal';
                showToast(`${guest.nome} marcado como ${status}`, 'success');
                
            } catch (error) {
                console.error('Error toggling VIP status:', error);
                showToast('Erro ao alterar status VIP', 'error');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96827375024577d7',t:'MTc1NDAyMTA2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
