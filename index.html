<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>InvitesQR</title>
  <script src="https://unpkg.com/html5-qrcode@latest"></script>
  <style>
    :root {
      --primary: #6a5acd;
      --bg: #121212;
      --text: #ffffff;
      --button: #6a5acd;
      --button-hover: #5a4ccf;
      --input-bg: #1f1f1f;
      --used: #00e676;
      --not-used: #888;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    main {
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    button {
      background: var(--button);
      color: white;
      border: none;
      padding: 14px 18px;
      margin: 10px 0;
      border-radius: 12px;
      width: 100%;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background: var(--button-hover);
    }
    input[type="text"] {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      margin: 10px 0;
      background: var(--input-bg);
      color: white;
      text-align: center;
      font-size: 1em;
    }
    #guestContainer {
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
      margin-top: 20px;
      border-top: 1px solid #333;
    }
    .guest {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #333;
      padding: 10px 0;
    }
    .guest .status {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .guest .status.usado {
      background-color: var(--used);
    }
    .guest .status.novo {
      background-color: var(--not-used);
    }
    #qr-reader {
      margin: 20px auto;
      width: 100%;
      max-width: 400px;
      display: none;
    }
    progress {
      width: 100%;
      margin-top: 10px;
      height: 14px;
      border-radius: 8px;
      overflow: hidden;
      background: #444;
    }
    #doneMsg {
      color: #00e676;
      font-weight: bold;
      margin-top: 20px;
    }
    #loginMsg {
      font-size: 0.9em;
      color: #ccc;
      margin-bottom: 20px;
    }
    #errorMsg {
      color: #ff4d4d;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<main>
  <div id="login" style="display:none">
    <input id="tokenInput" type="text" placeholder="Digite o token do cliente" />
    <button onclick="iniciar(document.getElementById('tokenInput').value)">Entrar</button>
    <div id="loginMsg">Se gostaria de adquirir um teste, entre em contacto connosco pelo n√∫mero <b>959 823 409</b>.</div>
    <div id="errorMsg"></div>
  </div>

  <div id="app" style="display:none">
    <h2 id="clienteNome"></h2>
    <button onclick="startScanner()">üì∑ Escanear QR Code</button>
    <div id="result">Nenhum convidado validado ainda</div>
    <input id="searchInput" type="text" placeholder="üîç Pesquisar convidado" oninput="filtrarConvidados()" />
    <progress id="progressBar" max="100" value="0"></progress>
    <div id="guestContainer"></div>
    <div id="doneMsg" style="display:none">üéâ Todos os convidados foram validados!</div>
  </div>

  <div id="qr-reader"></div>

<div id="scanFeedback" style="display:none; position:fixed; top:40%; left:50%; transform:translate(-50%, -50%);
 background:#000000cc; color:white; font-size:2em; padding:20px 30px; border-radius:12px; text-align:center; z-index:9999;">
  <div id="scanStatusText">‚úÖ PERMITIDO</div>
  <div id="scanGuestName" style="font-size:0.8em; margin-top:10px;"></div>
</div>
</main>

<script>
const SUPABASE_URL = "https://rnvunprjvppbjavkaoek.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8";

let token = localStorage.getItem('token');
let deviceId = localStorage.getItem('device_id') || crypto.randomUUID();
localStorage.setItem('device_id', deviceId);
let client = null;
let convidados = [];

window.onload = () => {
  if (token) iniciar(token);
  else document.getElementById("login").style.display = "block";
};

async function iniciar(inputToken) {
  token = inputToken || token;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  const data = await res.json();
  client = data[0];
  if (!client) return mostrarErro("‚ùå Token inv√°lido.");

  if (client.dispositivos && client.dispositivos !== deviceId)
    return mostrarErro("‚ùå Este token j√° foi usado em outro dispositivo.");
  const now = Date.now();
  if (client.validade * 1000 < now)
    return mostrarErro("‚è∞ Token expirado.");
  if (client.scans_usados >= client.limite_scans)
    return mostrarErro("‚ö†Ô∏è Limite de valida√ß√µes atingido.");

  if (!client.dispositivos) {
    await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
      method: "PATCH",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ dispositivos: deviceId })
    });
  }

  localStorage.setItem('token', token);
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("clienteNome").innerText = `üéâ Ol√°, ${client.nome}`;
  await carregarConvidados();
}

function mostrarErro(msg) {
  document.getElementById("errorMsg").innerText = msg;
}

async function carregarConvidados() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/convidados?token_cliente=eq.${token}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  convidados = await res.json();
  renderConvidados();
}

function renderConvidados() {
  const container = document.getElementById("guestContainer");
  const query = document.getElementById("searchInput").value.toLowerCase();
  let usados = 0;
  container.innerHTML = "";

  let filtrados = convidados.filter(c => c.nome.toLowerCase().includes(query));
  filtrados.sort((a, b) => b.status === "usado" ? 1 : -1); // usados sobem

  filtrados.forEach(c => {
    if (c.status === "usado") usados++;
    const div = document.createElement("div");
    div.className = "guest";
    div.innerHTML = `
      <div style="display:flex;align-items:center;">
        <div class="status ${c.status === "usado" ? "usado" : "novo"}"></div>
        <span>${c.nome}</span>
      </div>
      <span>${c.status === "usado" ? "‚úÖ" : ""}</span>`;
    container.appendChild(div);
  });

  const pct = convidados.length ? (usados / convidados.length) * 100 : 0;
  document.getElementById("progressBar").value = pct;
  document.getElementById("result").innerText = `${usados}/${convidados.length} validados`;

  document.getElementById("doneMsg").style.display = usados === convidados.length ? "block" : "none";
}

function filtrarConvidados() {
  renderConvidados();
}

async function marcarComoUsado(id) {
  await fetch(`${SUPABASE_URL}/rest/v1/convidados?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ status: "usado" })
  });
}

async function incrementarScans() {
  await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ scans_usados: client.scans_usados + 1 })
  });
  client.scans_usados++;
}



function startScanner() {
  const qr = new Html5Qrcode("qr-reader");
  document.getElementById("qr-reader").style.display = "block";
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async content => {
      const match = convidados.find(c => c.id.toString() === content.trim());
      const feedbackBox = document.getElementById("scanFeedback");
      const statusText = document.getElementById("scanStatusText");
      const guestName = document.getElementById("scanGuestName");

      if (!match) {
        statusText.innerText = "‚ùå N√ÉO ENCONTRADO";
        feedbackBox.style.background = "#ff4444";
        guestName.innerText = "";
        feedbackBox.style.display = "block";
        setTimeout(() => { feedbackBox.style.display = "none"; }, 3000);
        return;
      }

      guestName.innerText = match.nome;

      if (match.status === "usado") {
        statusText.innerText = "‚ùå J√Å VALIDADO";
        feedbackBox.style.background = "#cc0000";
      } else {
        statusText.innerText = "‚úÖ PERMITIDO";
        feedbackBox.style.background = "#00c851";
        await marcarComoUsado(match.id);
        await incrementarScans();
      }

      feedbackBox.style.display = "block";
      await carregarConvidados();
      setTimeout(() => {
        feedbackBox.style.display = "none";
      }, 3000);
    },
    error => {
      console.warn("Erro ao iniciar leitura: ", error);
    }
  );
}
, { fps: 10, qrbox: 250 }, async content => {
    const match = convidados.find(c => c.id.toString() === content.trim());
    const feedbackBox = document.getElementById("scanFeedback");
    const statusText = document.getElementById("scanStatusText");
    const guestName = document.getElementById("scanGuestName");

    if (!match) {
      statusText.innerText = "‚ùå N√ÉO ENCONTRADO";
      feedbackBox.style.background = "#ff4444";
      guestName.innerText = "";
      feedbackBox.style.display = "block";
      setTimeout(() => { feedbackBox.style.display = "none"; }, 3000);
      return;
    }

    guestName.innerText = match.nome;

    if (match.status === "usado") {
      statusText.innerText = "‚ùå J√Å VALIDADO";
      feedbackBox.style.background = "#cc0000";
    } else {
      statusText.innerText = "‚úÖ PERMITIDO";
      feedbackBox.style.background = "#00c851";
      await marcarComoUsado(match.id);
      await incrementarScans();
    }

    feedbackBox.style.display = "block";
    await carregarConvidados();
    setTimeout(() => {
      feedbackBox.style.display = "none";
    }, 3000);
  }, () => {});
}
, { fps: 10, qrbox: 250 }, async content => {
    const match = convidados.find(c => c.id.toString() === content.trim());
    if (!match) return 
    statusText.innerText = "‚ùå N√ÉO ENCONTRADO";
    feedbackBox.style.background = "#ff4444";
    feedbackBox.style.display = "block";
    guestName.innerText = "";
    setTimeout(() => {
      feedbackBox.style.display = "none";
    }, 3000);
    
    if (match.status === "usado") return 
    statusText.innerText = "‚ùå J√Å VALIDADO";
    feedbackBox.style.background = "#cc0000";
    feedbackBox.style.display = "block";
    guestName.innerText = match.nome;
    setTimeout(() => {
      feedbackBox.style.display = "none";
    }, 3000);
    
    await marcarComoUsado(match.id);
    await incrementarScans();
    
    statusText.innerText = "‚úîÔ∏è PERMITIDO";
    feedbackBox.style.background = "#00c851";
    feedbackBox.style.display = "block";
    guestName.innerText = match.nome;
    setTimeout(() => {
      feedbackBox.style.display = "none";
    }, 3000);
    
    await carregarConvidados();
  }, () => {});
}

setInterval(() => {
  if (token) carregarConvidados();
}, 30000);
</script>
</body>
</html>
