<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InvitesQR</title>
  <script src="https://unpkg.com/html5-qrcode@latest"></script>
  <style>
    :root {
      --primary: #6a5acd;
      --bg: #121212;
      --text: #ffffff;
      --button: #6a5acd;
      --button-hover: #5a4ccf;
      --input-bg: #1f1f1f;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .tabs {
      display: flex;
      justify-content: center;
      background: #1a1a1a;
    }

    .tab {
      flex: 1;
      padding: 12px;
      cursor: pointer;
      background: #2a2a2a;
      color: #bbb;
      font-weight: bold;
      border: none;
    }

    .tab.active {
      background: var(--primary);
      color: white;
    }

    main {
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }

    button {
      background: var(--button);
      color: white;
      border: none;
      padding: 14px 18px;
      margin: 10px 0;
      border-radius: 12px;
      width: 100%;
      font-size: 1em;
      cursor: pointer;
    }

    button:hover {
      background: var(--button-hover);
    }

    input[type="text"] {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      margin: 10px 0;
      background: var(--input-bg);
      color: white;
      text-align: center;
      font-size: 1em;
    }

    #guestList {
      list-style: none;
      padding: 0;
      text-align: left;
      margin-top: 20px;
      border-top: 1px solid #333;
    }

    #guestList li {
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }

    #qr-reader {
      margin: 20px auto;
      width: 100%;
      max-width: 400px;
      display: none;
    }

    #footer {
      margin-top: 40px;
      font-size: 0.8em;
      color: #888;
    }

    #whatsapp {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #25d366;
      color: white;
      padding: 12px 14px;
      border-radius: 50%;
      font-size: 20px;
      text-decoration: none;
    }

    progress {
      width: 100%;
      margin-top: 10px;
      height: 14px;
      border-radius: 8px;
      overflow: hidden;
      background: #444;
    }

    progress::-webkit-progress-bar {
      background-color: #444;
    }

    progress::-webkit-progress-value {
      background-color: var(--primary);
    }

    #doneMsg {
      color: #00e676;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab active">Cliente</button>
  </div>
  <main>
    <div id="login">
      <input id="tokenInput" type="text" placeholder="Digite o token do cliente" />
      <button onclick="iniciar(document.getElementById('tokenInput').value)">Entrar</button>
    </div>

    <div id="app" style="display:none">
      <h2 id="clienteNome"></h2>
      <button onclick="startScanner()">üì∑ Escanear QR Code (Tela Cheia)</button>
      <div id="result">Nenhum convidado validado ainda</div>
      <input id="searchInput" type="text" placeholder="üîç Pesquisar convidado" oninput="filtrarConvidados()" />
      <progress id="progressBar" max="100" value="0"></progress>
      <ul id="guestList"></ul>
      <div id="doneMsg" style="display:none">üéâ Todos os convidados foram validados!</div>
    </div>

    <div id="qr-reader"></div>
    <div id="footer">Invites digitais ¬© 2025</div>
    <a id="whatsapp" href="https://wa.me/244959823409">üí¨</a>
<script>
const SUPABASE_URL = "https://rnvunprjvppbjavkaoek.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8";

let token = localStorage.getItem('token');
let deviceId = localStorage.getItem('device_id') || crypto.randomUUID();
localStorage.setItem('device_id', deviceId);

let client = null;
let convidados = [];

async function iniciar(inputToken) {
  token = inputToken || token;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  const data = await res.json();
  client = data[0];
  if (!client) return alert("‚ùå Token inv√°lido.");
  if (client.dispositivos && client.dispositivos !== deviceId)
    return alert("‚ùå Este token j√° foi usado em outro dispositivo.");
  const now = Date.now();
  if (client.validade * 1000 < now)
    return alert("‚è∞ Token expirado.");
  if (client.scans_usados >= client.limite_scans)
    return alert("‚ö†Ô∏è Limite de valida√ß√µes atingido.");

  if (!client.dispositivos) {
    await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
      method: "PATCH",
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ dispositivos: deviceId })
    });
  }

  localStorage.setItem('token', token);
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("clienteNome").innerText = `üéâ Ol√°, ${client.nome}`;
  await carregarConvidados();
}

async function carregarConvidados() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/convidados?token_cliente=eq.${token}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  convidados = await res.json();
  renderConvidados();
}

function renderConvidados() {
  const list = document.getElementById("guestList");
  const query = document.getElementById("searchInput").value.toLowerCase();
  let usados = 0;
  list.innerHTML = "";

  convidados.filter(c => c.nome.toLowerCase().includes(query)).forEach(c => {
    if (c.status === "usado") usados++;
    const li = document.createElement("li");
    li.textContent = `${c.nome} - ${c.status}`;
    list.appendChild(li);
  });

  const pct = convidados.length ? (usados / convidados.length) * 100 : 0;
  document.getElementById("progressBar").value = pct;
  document.getElementById("result").innerText = `${usados}/${convidados.length} validados`;

  if (usados === convidados.length && convidados.length > 0) {
    document.getElementById("doneMsg").style.display = "block";
  }
}

function filtrarConvidados() {
  renderConvidados();
}

async function marcarComoUsado(id) {
  await fetch(`${SUPABASE_URL}/rest/v1/convidados?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ status: "usado" })
  });
}

async function incrementarScans() {
  await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ scans_usados: client.scans_usados + 1 })
  });
  client.scans_usados++;
}

function startScanner() {
  const qr = new Html5Qrcode("qr-reader");
  document.getElementById("qr-reader").style.display = "block";
  qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async content => {
    const match = convidados.find(c => c.id.toString() === content.trim());
    if (!match) return alert("Convidado n√£o encontrado.");
    if (match.status === "usado") return alert("Convidado j√° validado.");
    await marcarComoUsado(match.id);
    await incrementarScans();
    alert("‚úîÔ∏è Presen√ßa confirmada para: " + match.nome);
    await carregarConvidados();
  }, () => {});
}

setInterval(() => {
  if (token) carregarConvidados();
}, 30000);
</script>
</body>
</html>
