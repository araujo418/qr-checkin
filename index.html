<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesQR - Scanner Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #667eea;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
        }
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            pointer-events: auto;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        .guest-item {
            transition: all 0.3s ease;
        }
        .guest-scanned {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .guest-pending {
            background: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üì±</div>
                <h1 class="text-2xl font-bold text-gray-800">InvitesQR Scanner</h1>
                <p class="text-gray-600">Insira o token do evento</p>
            </div>
            
            <form id="login-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token do Evento</label>
                    <input 
                        type="text" 
                        id="token-input" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="evt-123456"
                        required
                    >
                </div>
                
                <button 
                    type="submit" 
                    id="login-btn"
                    class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50"
                >
                    Entrar
                </button>
            </form>
            
            <div id="login-error" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm">
                Token inv√°lido ou evento expirado
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold" id="event-name">Carregando...</h1>
                        <p class="text-blue-100 text-sm" id="event-info">Scanner Mobile</p>
                    </div>
                    <button id="logout-btn" class="bg-white bg-opacity-20 px-3 py-1 rounded text-sm hover:bg-opacity-30">
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-white shadow-sm border-b sticky top-16 z-30">
            <div class="flex">
                <button class="tab-btn tab-active flex-1 py-3 px-4 font-medium transition-all" data-tab="scanner">
                    üì± Scanner
                </button>
                <button class="tab-btn flex-1 py-3 px-4 font-medium text-gray-600 hover:text-blue-600 transition-all" data-tab="relatorio">
                    üìä Relat√≥rio
                </button>
            </div>
        </nav>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content p-4">
            <!-- Progress Ring -->
            <div class="text-center mb-6">
                <div class="relative inline-block">
                    <svg class="progress-ring w-24 h-24" width="96" height="96">
                        <circle
                            class="progress-ring-circle stroke-gray-200"
                            stroke-width="4"
                            fill="transparent"
                            r="44"
                            cx="48"
                            cy="48"
                        />
                        <circle
                            id="progress-circle"
                            class="progress-ring-circle stroke-blue-600"
                            stroke-width="4"
                            fill="transparent"
                            r="44"
                            cx="48"
                            cy="48"
                            stroke-dasharray="276.46"
                            stroke-dashoffset="276.46"
                        />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="progress-text" class="text-lg font-bold text-gray-800">0%</span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    <span id="scanned-count">0</span> de <span id="total-count">0</span> convidados
                </p>
            </div>

            <!-- Scanner Controls -->
            <div class="mb-6">
                <button 
                    id="start-scanner-btn" 
                    class="w-full gradient-bg text-white py-4 rounded-lg font-medium text-lg hover:opacity-90 transition-opacity"
                >
                    üéØ Iniciar Scanner
                </button>
            </div>

            <!-- Scanner Area -->
            <div id="scanner-area" class="hidden mb-6">
                <div class="scanner-container">
                    <div id="qr-reader" class="rounded-lg overflow-hidden"></div>
                    <div class="scanner-overlay"></div>
                </div>
                <div class="text-center mt-4">
                    <button 
                        id="stop-scanner-btn" 
                        class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700"
                    >
                        Parar Scanner
                    </button>
                </div>
            </div>

            <!-- Guest List -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b">
                    <h3 class="font-semibold text-lg">Lista de Convidados</h3>
                </div>
                <div id="guests-list" class="max-h-96 overflow-y-auto">
                    <!-- Guest items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Relat√≥rio Tab -->
        <div id="relatorio" class="tab-content hidden p-4">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="text-2xl mb-2">‚úÖ</div>
                    <p class="text-2xl font-bold text-green-600" id="summary-scanned">0</p>
                    <p class="text-sm text-gray-600">Escaneados</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="text-2xl mb-2">‚è≥</div>
                    <p class="text-2xl font-bold text-orange-600" id="summary-pending">0</p>
                    <p class="text-sm text-gray-600">Pendentes</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-4 mb-6">
                <button 
                    id="clear-scans-btn" 
                    class="w-full bg-orange-600 text-white py-3 rounded-lg font-medium hover:bg-orange-700"
                >
                    üîÑ Desmarcar Todos os Escaneados
                </button>
                <button 
                    id="download-pdf-btn" 
                    class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700"
                >
                    üìÑ Baixar Relat√≥rio PDF
                </button>
            </div>

            <!-- Detailed List -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b">
                    <h3 class="font-semibold text-lg">Relat√≥rio Detalhado</h3>
                </div>
                <div id="detailed-list" class="max-h-96 overflow-y-auto">
                    <!-- Detailed items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast bg-white rounded-lg shadow-lg p-4 min-w-80 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="text-2xl mr-3"></div>
            <div class="flex-1">
                <p id="toast-title" class="font-medium"></p>
                <p id="toast-message" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Global variables
        let currentClient = null;
        let allGuests = [];
        let scannedGuests = new Set(); // Local tracking only
        let html5QrCode = null;
        let deviceId = null;

        // Generate unique device ID
        function generateDeviceId() {
            const stored = localStorage.getItem('scanner_device_id');
            if (stored) return stored;
            
            const newId = 'mobile-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('scanner_device_id', newId);
            return newId;
        }

        // Toast notification
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toastIcon.textContent = icons[type];
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Login functionality
        async function handleLogin(token) {
            try {
                // Validate token format
                if (!token.startsWith('evt-')) {
                    throw new Error('Formato de token inv√°lido');
                }

                // Check if client exists and is valid
                const { data: client, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();

                if (error || !client) {
                    throw new Error('Token n√£o encontrado');
                }

                // Check if event is still valid
                const now = Date.now();
                if (client.validade < now) {
                    throw new Error('Evento expirado');
                }

                // Store client data
                currentClient = client;
                deviceId = generateDeviceId();

                // Load guests for this client
                await loadGuests();

                // Show main app
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');

                // Update header
                document.getElementById('event-name').textContent = client.nome;
                updateHeaderInfo();

                showToast('success', 'Sucesso', 'Login realizado com sucesso!');

            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('login-error').classList.remove('hidden');
                showToast('error', 'Erro', error.message);
            }
        }

        // Load guests from Supabase
        async function loadGuests() {
            try {
                const { data: guests, error } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo');

                if (error) throw error;

                allGuests = guests || [];
                updateGuestsList();
                updateProgress();

            } catch (error) {
                console.error('Error loading guests:', error);
                showToast('error', 'Erro', 'Erro ao carregar convidados');
            }
        }

        // Update guests list display
        function updateGuestsList() {
            const guestsList = document.getElementById('guests-list');
            
            if (allGuests.length === 0) {
                guestsList.innerHTML = '<div class="p-4 text-center text-gray-500">Nenhum convidado encontrado</div>';
                return;
            }

            guestsList.innerHTML = allGuests.map(guest => {
                const isScanned = scannedGuests.has(guest.codigo);
                const itemClass = isScanned ? 'guest-scanned' : 'guest-pending';
                const icon = isScanned ? '‚úÖ' : '‚è≥';
                
                return `
                    <div class="guest-item ${itemClass} p-4 border-b last:border-b-0">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium">${guest.nome}</p>
                                <p class="text-sm opacity-75">${guest.codigo}</p>
                            </div>
                            <div class="text-xl">${icon}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update header info
        function updateHeaderInfo() {
            if (!currentClient) return;
            
            const validadeText = new Date(currentClient.validade).toLocaleDateString('pt-BR');
            const scanInfo = `${currentClient.scans_usados}/${currentClient.limite_scans} scans`;
            document.getElementById('event-info').textContent = `${validadeText} ‚Ä¢ ${scanInfo}`;
        }

        // Update progress display
        function updateProgress() {
            const total = allGuests.length;
            const scanned = scannedGuests.size;
            const percentage = total > 0 ? Math.round((scanned / total) * 100) : 0;
            
            // Update progress ring
            const circle = document.getElementById('progress-circle');
            const circumference = 2 * Math.PI * 44;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // Update text
            document.getElementById('progress-text').textContent = percentage + '%';
            document.getElementById('scanned-count').textContent = scanned;
            document.getElementById('total-count').textContent = total;
            
            // Update summary in report tab
            document.getElementById('summary-scanned').textContent = scanned;
            document.getElementById('summary-pending').textContent = total - scanned;
            
            // Update header info
            updateHeaderInfo();
        }

        // Scanner functionality
        function startScanner() {
            const scannerArea = document.getElementById('scanner-area');
            const startBtn = document.getElementById('start-scanner-btn');
            
            scannerArea.classList.remove('hidden');
            startBtn.classList.add('hidden');

            html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 200, height: 200 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error('Scanner start error:', err);
                showToast('error', 'Erro', 'Erro ao iniciar c√¢mara');
                stopScanner();
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                }).catch(err => {
                    console.error('Scanner stop error:', err);
                });
            }
            
            document.getElementById('scanner-area').classList.add('hidden');
            document.getElementById('start-scanner-btn').classList.remove('hidden');
        }

        // Handle successful QR scan
        async function onScanSuccess(decodedText, decodedResult) {
            try {
                // Validate QR code in Supabase
                const validationResult = await validateQRCode(decodedText);
                
                if (!validationResult.valid) {
                    showToast('error', 'C√≥digo Inv√°lido', validationResult.message);
                    return;
                }

                const guest = validationResult.guest;

                // Check if already scanned locally (for UI feedback)
                if (scannedGuests.has(guest.codigo)) {
                    showToast('warning', 'J√° Escaneado', guest.nome + ' j√° foi escaneado neste dispositivo');
                    return;
                }

                // Add to local scanned set
                scannedGuests.add(guest.codigo);

                // Update client scan count in Supabase
                await updateClientScanCount();

                // Log successful scan to Supabase
                await logScan(guest.codigo, 'scan_success');

                // Update displays
                updateGuestsList();
                updateProgress();
                updateDetailedList();

                // Show success with scan count
                showToast('success', 'Validado!', `${guest.nome} - Scan ${currentClient.scans_usados + 1}/${currentClient.limite_scans}`);

                // Brief pause before next scan
                setTimeout(() => {
                    // Scanner continues automatically
                }, 1000);

            } catch (error) {
                console.error('Scan processing error:', error);
                showToast('error', 'Erro', 'Erro ao processar scan: ' + error.message);
                
                // Log error to Supabase
                await logScan(decodedText, 'scan_error');
            }
        }

        function onScanFailure(error) {
            // Silent - scanning failures are normal
        }

        // Validate QR code against Supabase
        async function validateQRCode(codigo) {
            try {
                // Check if guest exists and is active
                const { data: guest, error: guestError } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('codigo', codigo)
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo')
                    .single();

                if (guestError || !guest) {
                    return {
                        valid: false,
                        message: 'Convidado n√£o encontrado ou inativo'
                    };
                }

                // Check if client has reached scan limit
                if (currentClient.scans_usados >= currentClient.limite_scans) {
                    return {
                        valid: false,
                        message: 'Limite de scans atingido para este evento'
                    };
                }

                // Check if event is still valid
                if (currentClient.validade < Date.now()) {
                    return {
                        valid: false,
                        message: 'Evento expirado'
                    };
                }

                // Check for duplicate scans in database (global check)
                const { data: existingScans, error: scanError } = await supabase
                    .from('logs')
                    .select('*')
                    .eq('token', codigo)
                    .eq('status', 'scan_success');

                if (scanError) {
                    console.error('Error checking existing scans:', scanError);
                }

                // Allow multiple scans but warn if already scanned globally
                if (existingScans && existingScans.length > 0) {
                    console.log(`‚ö†Ô∏è C√≥digo ${codigo} j√° foi escaneado ${existingScans.length} vez(es) anteriormente`);
                }

                return {
                    valid: true,
                    guest: guest,
                    previousScans: existingScans ? existingScans.length : 0
                };

            } catch (error) {
                console.error('QR validation error:', error);
                return {
                    valid: false,
                    message: 'Erro ao validar c√≥digo: ' + error.message
                };
            }
        }

        // Update client scan count
        async function updateClientScanCount() {
            try {
                const newScanCount = currentClient.scans_usados + 1;
                
                const { error } = await supabase
                    .from('clientes')
                    .update({ scans_usados: newScanCount })
                    .eq('id', currentClient.id);

                if (error) {
                    console.error('Error updating scan count:', error);
                    throw error;
                }

                // Update local client data
                currentClient.scans_usados = newScanCount;

            } catch (error) {
                console.error('Error updating client scan count:', error);
                throw error;
            }
        }

        // Log scan to Supabase
        async function logScan(codigo, status = 'scan') {
            try {
                const { error } = await supabase
                    .from('logs')
                    .insert([{
                        token: codigo,
                        status: status,
                        dispositivo: deviceId
                    }]);

                if (error) {
                    console.error('Log error:', error);
                    throw error;
                }
            } catch (error) {
                console.error('Log error:', error);
                throw error;
            }
        }

        // Clear all scanned (local only)
        function clearAllScans() {
            if (confirm('Desmarcar todos os convidados escaneados? (Apenas no dispositivo)')) {
                scannedGuests.clear();
                updateGuestsList();
                updateProgress();
                updateDetailedList();
                showToast('info', 'Limpo', 'Todos os scans foram desmarcados localmente');
            }
        }

        // Update detailed list for report
        function updateDetailedList() {
            const detailedList = document.getElementById('detailed-list');
            
            const scannedGuestsList = allGuests.filter(guest => scannedGuests.has(guest.codigo));
            const pendingGuestsList = allGuests.filter(guest => !scannedGuests.has(guest.codigo));
            
            let html = '';
            
            if (scannedGuestsList.length > 0) {
                html += '<div class="p-4 bg-green-50 border-b"><h4 class="font-medium text-green-800">‚úÖ Escaneados (' + scannedGuestsList.length + ')</h4></div>';
                html += scannedGuestsList.map(guest => `
                    <div class="p-3 border-b last:border-b-0 bg-green-50">
                        <p class="font-medium text-green-800">${guest.nome}</p>
                        <p class="text-sm text-green-600">${guest.codigo}</p>
                    </div>
                `).join('');
            }
            
            if (pendingGuestsList.length > 0) {
                html += '<div class="p-4 bg-orange-50 border-b"><h4 class="font-medium text-orange-800">‚è≥ Pendentes (' + pendingGuestsList.length + ')</h4></div>';
                html += pendingGuestsList.map(guest => `
                    <div class="p-3 border-b last:border-b-0">
                        <p class="font-medium">${guest.nome}</p>
                        <p class="text-sm text-gray-600">${guest.codigo}</p>
                    </div>
                `).join('');
            }
            
            if (html === '') {
                html = '<div class="p-4 text-center text-gray-500">Nenhum convidado encontrado</div>';
            }
            
            detailedList.innerHTML = html;
        }

        // Generate PDF report
        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Relat√≥rio de Valida√ß√£o', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Evento: ${currentClient.nome}`, 20, 45);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 55);
                doc.text(`Dispositivo: ${deviceId}`, 20, 65);
                
                // Summary
                doc.setFontSize(14);
                doc.text('Resumo:', 20, 85);
                doc.setFontSize(12);
                doc.text(`Total de Convidados: ${allGuests.length}`, 20, 95);
                doc.text(`Escaneados: ${scannedGuests.size}`, 20, 105);
                doc.text(`Pendentes: ${allGuests.length - scannedGuests.size}`, 20, 115);
                doc.text(`Taxa de Compar√™ncia: ${Math.round((scannedGuests.size / allGuests.length) * 100)}%`, 20, 125);
                
                // Scanned guests list
                let yPos = 145;
                doc.setFontSize(14);
                doc.text('Convidados Escaneados:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                const scannedList = allGuests.filter(guest => scannedGuests.has(guest.codigo));
                
                scannedList.forEach((guest, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`${index + 1}. ${guest.nome} (${guest.codigo})`, 20, yPos);
                    yPos += 8;
                });
                
                // Save PDF
                const fileName = `relatorio_${currentClient.token}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('success', 'PDF Gerado', 'Relat√≥rio baixado com sucesso');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('error', 'Erro', 'Erro ao gerar PDF');
            }
        }

        // Tab management
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Update tab buttons
                    tabBtns.forEach(b => {
                        b.classList.remove('tab-active');
                        b.classList.add('text-gray-600', 'hover:text-blue-600');
                    });
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-gray-600', 'hover:text-blue-600');

                    // Update tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab).classList.remove('hidden');

                    // Stop scanner when switching tabs
                    if (targetTab !== 'scanner' && html5QrCode) {
                        stopScanner();
                    }

                    // Update detailed list when switching to report
                    if (targetTab === 'relatorio') {
                        updateDetailedList();
                    }
                });
            });
        }

        // Logout functionality
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                // Stop scanner
                if (html5QrCode) {
                    stopScanner();
                }
                
                // Clear data
                currentClient = null;
                allGuests = [];
                scannedGuests.clear();
                
                // Show login screen
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('token-input').value = '';
                
                showToast('info', 'Logout', 'Sess√£o encerrada');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const token = document.getElementById('token-input').value.trim();
                if (token) {
                    document.getElementById('login-error').classList.add('hidden');
                    handleLogin(token);
                }
            });

            // Scanner controls
            document.getElementById('start-scanner-btn').addEventListener('click', startScanner);
            document.getElementById('stop-scanner-btn').addEventListener('click', stopScanner);

            // Report controls
            document.getElementById('clear-scans-btn').addEventListener('click', clearAllScans);
            document.getElementById('download-pdf-btn').addEventListener('click', generatePDF);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', logout);

            // Prevent accidental page refresh
            window.addEventListener('beforeunload', (e) => {
                if (currentClient && scannedGuests.size > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9672e49ee74477dd',t:'MTc1Mzg1NzkyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
