<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">
    <title>InvitesQR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
        }
        .scanner-corner.top-left {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .scanner-corner.top-right {
            top: 20px;
            right: 20px;
            border-left: none;
            border-bottom: none;
        }
        .scanner-corner.bottom-left {
            bottom: 20px;
            left: 20px;
            border-right: none;
            border-top: none;
        }
        .scanner-corner.bottom-right {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .offline-overlay {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.7);
        }
        .success-flash {
            animation: successFlash 0.5s ease-out;
        }
        @keyframes successFlash {
            0% { background-color: rgba(16, 185, 129, 0); }
            50% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: rgba(16, 185, 129, 0); }
        }
        .error-flash {
            animation: errorFlash 0.5s ease-out;
        }
        @keyframes errorFlash {
            0% { background-color: rgba(239, 68, 68, 0); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: rgba(239, 68, 68, 0); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .scanner-corner {
                width: 25px;
                height: 25px;
                border-width: 2px;
            }
            
            .scanner-corner.top-left,
            .scanner-corner.top-right {
                top: 15px;
            }
            
            .scanner-corner.bottom-left,
            .scanner-corner.bottom-right {
                bottom: 15px;
            }
            
            .scanner-corner.top-left,
            .scanner-corner.bottom-left {
                left: 15px;
            }
            
            .scanner-corner.top-right,
            .scanner-corner.bottom-right {
                right: 15px;
            }
        }
        
        /* Prevent text selection on buttons */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Offline Overlay -->
    <div id="offline-overlay" class="fixed inset-0 offline-overlay z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 mx-4 text-center text-gray-900 max-w-sm">
            <i class="fas fa-wifi-slash text-4xl text-red-500 mb-4"></i>
            <h3 class="text-lg font-bold mb-2">Sem Conexão</h3>
            <p class="text-gray-600 mb-4">Verifique sua conexão com a internet para continuar.</p>
            <button onclick="checkConnectivity()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-sync-alt mr-2"></i>Tentar Novamente
            </button>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-qrcode text-5xl text-blue-500 mb-4"></i>
                <h1 class="text-2xl font-bold mb-2">InvitesQR Scanner</h1>
                <p class="text-gray-400">Validação de Convidados</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Token do Evento</label>
                    <input type="text" id="event-token" required 
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="evt-123456">
                </div>

                <button type="submit" id="login-btn" 
                        class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]">
                    <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                </button>
            </form>

            <div class="mt-6 text-center">
                <div id="connection-status" class="flex items-center justify-center text-sm">
                    <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                    <span class="text-gray-400">Verificando conexão...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 id="event-name" class="text-lg font-bold">Carregando...</h1>
                        <p id="event-info" class="text-sm text-gray-400">Preparando scanner...</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div id="connection-indicator" class="flex items-center">
                            <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                        </div>
                        <button onclick="logout()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-sign-out-alt text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-800 border-t border-gray-700 fixed bottom-0 left-0 right-0 z-30">
            <div class="flex">
                <button onclick="showTab('scanner')" id="tab-scanner" class="flex-1 py-4 px-2 text-center bg-blue-600 text-white min-h-[60px] active:bg-blue-700">
                    <i class="fas fa-qrcode block mb-1 text-lg"></i>
                    <span class="text-xs">Scanner</span>
                </button>
                <button onclick="showTab('options')" id="tab-options" class="flex-1 py-4 px-2 text-center text-gray-400 hover:text-white min-h-[60px] active:bg-gray-700">
                    <i class="fas fa-ellipsis-h block mb-1 text-lg"></i>
                    <span class="text-xs">Opções</span>
                </button>
            </div>
        </nav>

        <!-- Scanner Tab -->
        <div id="content-scanner" class="tab-content pb-20">
            <!-- Progress Bar -->
            <div class="bg-gray-800 p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium">Progresso do Evento</span>
                    <span id="scanner-progress-percentage" class="text-sm text-gray-400">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                    <div id="scanner-progress-bar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                    <span id="scanner-validated-count">0 validados</span>
                    <span id="scanner-total-count">de 0 convidados</span>
                </div>
            </div>

            <!-- Scanner Container -->
            <div class="relative">
                <div id="qr-reader" class="w-full" style="height: 50vh; min-height: 300px;"></div>
                <div class="scanner-overlay">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                </div>
                
                <!-- Scanner Status -->
                <div id="scanner-status" class="absolute bottom-4 left-4 right-4 text-center">
                    <div class="bg-black bg-opacity-50 rounded-lg p-3">
                        <p class="text-sm text-white">Posicione o QR code na área de leitura</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="p-4 space-y-4">
                <div class="flex items-center justify-between bg-gray-800 rounded-lg p-4">
                    <div>
                        <h3 class="font-medium">Modo Rápido</h3>
                        <p class="text-sm text-gray-400">Scan contínuo sem pausas</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="fast-mode" class="sr-only peer" onchange="toggleFastMode()">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <button id="scanner-toggle" onclick="toggleScanner()" 
                        class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]">
                    <i class="fas fa-play mr-2"></i>Iniciar Scanner
                </button>
            </div>

            <!-- Last Scan Result -->
            <div id="last-scan-result" class="hidden mx-4 mb-4 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 id="scan-guest-name" class="font-medium"></h4>
                        <p id="scan-guest-code" class="text-sm text-gray-400"></p>
                    </div>
                    <div id="scan-status-icon" class="text-2xl"></div>
                </div>
            </div>
        </div>

        <!-- Options Tab -->
        <div id="content-options" class="tab-content hidden pb-20">
            <div class="p-4">
                <!-- Stats Overview -->
                <div class="bg-gray-800 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium mb-4">Estatísticas</h3>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div id="options-scanned-count" class="text-2xl font-bold text-green-500">0</div>
                            <div class="text-xs text-gray-400">Validados</div>
                        </div>
                        <div>
                            <div id="options-total-guests" class="text-2xl font-bold text-blue-500">0</div>
                            <div class="text-xs text-gray-400">Total</div>
                        </div>
                        <div>
                            <div id="options-session-scans" class="text-2xl font-bold text-purple-500">0</div>
                            <div class="text-xs text-gray-400">Sessão</div>
                        </div>
                    </div>
                </div>

                <!-- Options Menu -->
                <div class="space-y-3">
                    <button onclick="showSubTab('guests')" class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                        <div class="flex items-center">
                            <i class="fas fa-users text-blue-500 mr-4 text-xl"></i>
                            <div>
                                <h3 class="font-medium">Convidados</h3>
                                <p class="text-sm text-gray-400">Ver lista de convidados</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>

                    <button onclick="showSubTab('reports')" class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                        <div class="flex items-center">
                            <i class="fas fa-chart-bar text-green-500 mr-4 text-xl"></i>
                            <div>
                                <h3 class="font-medium">Relatórios</h3>
                                <p class="text-sm text-gray-400">Estatísticas e exportação</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>

                    <button onclick="showSubTab('settings')" class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                        <div class="flex items-center">
                            <i class="fas fa-cog text-purple-500 mr-4 text-xl"></i>
                            <div>
                                <h3 class="font-medium">Configurações</h3>
                                <p class="text-sm text-gray-400">Ajustes do aplicativo</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Guests Sub-Tab -->
        <div id="content-guests" class="tab-content hidden pb-20">
            <!-- Back Button -->
            <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700">
                <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span>Voltar</span>
                </button>
                <h2 class="ml-4 text-lg font-medium">Convidados</h2>
            </div>
            <div class="p-4">
                <!-- Search -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="guest-search" placeholder="Buscar convidado..." 
                               class="w-full bg-gray-800 border border-gray-600 rounded-lg pl-10 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="filterGuests()">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex space-x-2 mb-4">
                    <button onclick="filterGuestsByStatus('all')" id="filter-all" 
                            class="flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white text-sm min-h-[44px] active:bg-blue-700">
                        Todos
                    </button>
                    <button onclick="filterGuestsByStatus('scanned')" id="filter-scanned" 
                            class="flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600">
                        Validados
                    </button>
                    <button onclick="filterGuestsByStatus('pending')" id="filter-pending" 
                            class="flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600">
                        Pendentes
                    </button>
                </div>

                <!-- Guest List -->
                <div id="guests-list" class="space-y-3">
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-users text-3xl mb-2"></i>
                        <p>Carregando convidados...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="content-reports" class="tab-content hidden pb-20">
            <!-- Back Button -->
            <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700">
                <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span>Voltar</span>
                </button>
                <h2 class="ml-4 text-lg font-medium">Relatórios</h2>
            </div>
            <div class="p-4">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <div id="report-validated" class="text-2xl font-bold text-green-500">0</div>
                        <div class="text-sm text-gray-400">Validados</div>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-4 text-center">
                        <div id="report-pending" class="text-2xl font-bold text-orange-500">0</div>
                        <div class="text-sm text-gray-400">Pendentes</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="bg-gray-800 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Progresso do Evento</span>
                        <span id="progress-percentage" class="text-sm text-gray-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="space-y-3">
                    <button onclick="generatePDFReport()" 
                            class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                        <i class="fas fa-file-pdf mr-2"></i>Exportar Relatório PDF
                    </button>
                    
                    <button onclick="shareReport()" 
                            class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                        <i class="fas fa-share mr-2"></i>Partilhar Relatório
                    </button>
                </div>

                <!-- Recent Scans -->
                <div class="mt-6">
                    <h3 class="text-lg font-medium mb-4">Últimas Validações</h3>
                    <div id="recent-scans" class="space-y-3">
                        <div class="text-center py-4 text-gray-400">
                            <p>Nenhuma validação ainda</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="content-settings" class="tab-content hidden pb-20">
            <!-- Back Button -->
            <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700">
                <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span>Voltar</span>
                </button>
                <h2 class="ml-4 text-lg font-medium">Configurações</h2>
            </div>
            <div class="p-4 space-y-6">
                <!-- Sound Settings -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4">Áudio</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Som de Sucesso</h4>
                                <p class="text-sm text-gray-400">Reproduzir som ao validar</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="success-sound" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Som de Erro</h4>
                                <p class="text-sm text-gray-400">Reproduzir som em caso de erro</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="error-sound" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Vibration Settings -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4">Vibração</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium">Feedback Tátil</h4>
                            <p class="text-sm text-gray-400">Vibrar ao escanear</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="vibration" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>

                <!-- Scanner Settings -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4">Scanner</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Câmera</label>
                            <select id="camera-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                <option value="">Selecionar câmera...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- App Info -->
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="text-lg font-medium mb-4">Informações</h3>
                    <div class="space-y-2 text-sm text-gray-400">
                        <div class="flex justify-between">
                            <span>Versão:</span>
                            <span>1.0.0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Dispositivo:</span>
                            <span id="device-info">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Evento:</span>
                            <span id="current-token">-</span>
                        </div>
                    </div>
                </div>

                <!-- Clear Saved Token -->
                <button onclick="clearSavedTokenAndNotify()" 
                        class="w-full bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px] mb-3">
                    <i class="fas fa-trash mr-2"></i>Limpar Token Guardado
                </button>

                <!-- Logout -->
                <button onclick="logout()" 
                        class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                    <i class="fas fa-sign-out-alt mr-2"></i>Terminar Sessão
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables
        let currentClient = null;
        let guests = [];
        let scannedGuests = new Set();
        let sessionScans = 0;
        let html5QrCode = null;
        let isScanning = false;
        let fastMode = false;
        let isOnline = true;
        let lastScanTime = 0;
        let scanAttempts = new Map(); // Track scan attempts per code
        let deviceName = '';

        // Audio contexts for feedback
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkConnectivity();
            setupLoginForm();
            loadCameras();
            checkSavedToken(); // Check for saved token
            setInterval(checkConnectivity, 30000); // Check every 30 seconds
        });

        // Token storage management
        function saveToken(token) {
            try {
                localStorage.setItem('invitesqr_token', token);
                localStorage.setItem('invitesqr_token_date', Date.now().toString());
            } catch (error) {
                console.error('Error saving token:', error);
            }
        }

        function getSavedToken() {
            try {
                const token = localStorage.getItem('invitesqr_token');
                const savedDate = localStorage.getItem('invitesqr_token_date');
                
                if (!token || !savedDate) return null;
                
                // Check if token was saved more than 30 days ago
                const daysSaved = (Date.now() - parseInt(savedDate)) / (1000 * 60 * 60 * 24);
                if (daysSaved > 30) {
                    clearSavedToken();
                    return null;
                }
                
                return token;
            } catch (error) {
                console.error('Error getting saved token:', error);
                return null;
            }
        }

        function clearSavedToken() {
            try {
                localStorage.removeItem('invitesqr_token');
                localStorage.removeItem('invitesqr_token_date');
            } catch (error) {
                console.error('Error clearing saved token:', error);
            }
        }

        async function checkSavedToken() {
            const savedToken = getSavedToken();
            if (savedToken && isOnline) {
                document.getElementById('event-token').value = savedToken;
                
                // Show loading state
                const loginBtn = document.getElementById('login-btn');
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Entrando...';
                loginBtn.disabled = true;
                
                // Auto-login after a short delay
                setTimeout(async () => {
                    try {
                        await performLogin(savedToken);
                    } catch (error) {
                        // If auto-login fails, clear the saved token and show login form
                        clearSavedToken();
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
                        loginBtn.disabled = false;
                        showToast('Token expirado. Faça login novamente.', 'info');
                    }
                }, 1000);
            }
        }

        // Connectivity management
        async function checkConnectivity() {
            try {
                // Check internet connection
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                
                // Check Supabase connection
                const { data, error } = await supabase.from('clientes').select('count').limit(1);
                
                if (error) throw error;
                
                isOnline = true;
                updateConnectionStatus(true);
                hideOfflineOverlay();
            } catch (error) {
                isOnline = false;
                updateConnectionStatus(false);
                showOfflineOverlay();
                
                if (isScanning) {
                    stopScanner();
                }
            }
        }

        function updateConnectionStatus(online) {
            const indicators = ['connection-status', 'connection-indicator'];
            indicators.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = online ? 
                        '<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div><span class="text-green-400 text-sm">Online</span>' :
                        '<div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div><span class="text-red-400 text-sm">Offline</span>';
                }
            });
        }

        function showOfflineOverlay() {
            document.getElementById('offline-overlay').classList.remove('hidden');
        }

        function hideOfflineOverlay() {
            document.getElementById('offline-overlay').classList.add('hidden');
        }

        // Login functionality
        function setupLoginForm() {
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!isOnline) {
                    showToast('Sem conexão com a internet', 'error');
                    return;
                }

                const token = document.getElementById('event-token').value.trim();
                
                const loginBtn = document.getElementById('login-btn');
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';
                loginBtn.disabled = true;

                try {
                    await performLogin(token);
                } catch (error) {
                    showToast(error.message || 'Erro ao fazer login', 'error');
                } finally {
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
                    loginBtn.disabled = false;
                }
            });
        }

        async function performLogin(token) {
            deviceName = `Scanner-${Date.now()}`;
            
            // Fetch client data
            const { data, error } = await supabase
                .from('clientes')
                .select('*')
                .eq('token', token)
                .single();

            if (error || !data) {
                throw new Error('Token inválido');
            }

            // Check if event is still valid (CRITICAL FIX: multiply by 1000)
            const eventDate = new Date(data.validade * 1000);
            const now = new Date();
            
            if (eventDate < now) {
                throw new Error('Evento expirado');
            }

            currentClient = data;
            
            // Save token for future use
            saveToken(token);
            
            // Log login
            await supabase.from('logs').insert([{
                token: token,
                status: 'login',
                dispositivo: deviceName
            }]);

            // Load guests
            await loadGuests();
            
            // Switch to main app
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            updateHeader();
            updateStats();
            
            showToast('Login realizado com sucesso', 'success');
        }

        // Load guests for current event
        async function loadGuests() {
            try {
                const { data, error } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo');

                if (error) throw error;
                
                guests = data || [];
                renderGuests();
                updateStats();
                
            } catch (error) {
                showToast('Erro ao carregar convidados', 'error');
            }
        }

        // Update header information
        function updateHeader() {
            if (!currentClient) return;
            
            document.getElementById('event-name').textContent = currentClient.nome;
            
            // CRITICAL FIX: multiply by 1000 for correct date conversion
            const eventDate = new Date(currentClient.validade * 1000);
            const formattedDate = eventDate.toLocaleDateString('pt-PT');
            
            document.getElementById('event-info').textContent = 
                `Válido até ${formattedDate} • ${guests.length} convidados`;
            
            document.getElementById('device-info').textContent = deviceName;
            document.getElementById('current-token').textContent = currentClient.token;
        }

        // Update statistics
        function updateStats() {
            const scannedCount = scannedGuests.size;
            const totalGuests = guests.length;
            const progressPercentage = totalGuests > 0 ? Math.round((scannedCount / totalGuests) * 100) : 0;

            // Update scanner progress bar
            document.getElementById('scanner-progress-percentage').textContent = progressPercentage + '%';
            document.getElementById('scanner-progress-bar').style.width = progressPercentage + '%';
            document.getElementById('scanner-validated-count').textContent = scannedCount + ' validados';
            document.getElementById('scanner-total-count').textContent = 'de ' + totalGuests + ' convidados';

            // Update options stats
            document.getElementById('options-scanned-count').textContent = scannedCount;
            document.getElementById('options-total-guests').textContent = totalGuests;
            document.getElementById('options-session-scans').textContent = sessionScans;
            
            // Update reports
            document.getElementById('report-validated').textContent = scannedCount;
            document.getElementById('report-pending').textContent = totalGuests - scannedCount;
            document.getElementById('progress-percentage').textContent = progressPercentage + '%';
            document.getElementById('progress-bar').style.width = progressPercentage + '%';
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = btn.className.replace('bg-blue-600 text-white', 'text-gray-400 hover:text-white');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('text-gray-400 hover:text-white', 'bg-blue-600 text-white');
            }
            
            // Initialize scanner if needed
            if (tabName === 'scanner' && !html5QrCode) {
                initializeScanner();
            }
        }

        // Sub-tab management for options
        function showSubTab(subTabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected sub-tab
            document.getElementById(`content-${subTabName}`).classList.remove('hidden');
        }

        // Scanner functionality
        async function initializeScanner() {
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
            } catch (error) {
                showToast('Erro ao inicializar scanner', 'error');
            }
        }

        async function loadCameras() {
            try {
                const devices = await Html5Qrcode.getCameras();
                const select = document.getElementById('camera-select');
                
                select.innerHTML = '<option value="">Selecionar câmera...</option>';
                devices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.label || `Câmera ${index + 1}`;
                    select.appendChild(option);
                });
                
                // Auto-select back camera if available
                const backCamera = devices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('traseira')
                );
                if (backCamera) {
                    select.value = backCamera.id;
                }
            } catch (error) {
                console.error('Error loading cameras:', error);
            }
        }

        async function toggleScanner() {
            if (!isOnline) {
                showToast('Scanner requer conexão com a internet', 'error');
                return;
            }

            const button = document.getElementById('scanner-toggle');
            
            if (isScanning) {
                await stopScanner();
                button.innerHTML = '<i class="fas fa-play mr-2"></i>Iniciar Scanner';
                button.className = 'w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
            } else {
                await startScanner();
                button.innerHTML = '<i class="fas fa-stop mr-2"></i>Parar Scanner';
                button.className = 'w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]';
            }
        }

        async function startScanner() {
            if (!html5QrCode) {
                await initializeScanner();
            }

            const cameraId = document.getElementById('camera-select').value || { facingMode: "environment" };
            
            try {
                await html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanFailure
                );
                
                isScanning = true;
                updateScannerStatus('Scanner ativo - Posicione o QR code');
                
                // Add pulse animation to corners
                document.querySelectorAll('.scanner-corner').forEach(corner => {
                    corner.classList.add('pulse-animation');
                });
                
            } catch (error) {
                showToast('Erro ao iniciar scanner: ' + error.message, 'error');
            }
        }

        async function stopScanner() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                    updateScannerStatus('Scanner parado');
                    
                    // Remove pulse animation
                    document.querySelectorAll('.scanner-corner').forEach(corner => {
                        corner.classList.remove('pulse-animation');
                    });
                } catch (error) {
                    console.error('Error stopping scanner:', error);
                }
            }
        }

        function updateScannerStatus(message) {
            document.getElementById('scanner-status').innerHTML = `
                <div class="bg-black bg-opacity-50 rounded-lg p-3">
                    <p class="text-sm text-white">${message}</p>
                </div>
            `;
        }

        function toggleFastMode() {
            fastMode = document.getElementById('fast-mode').checked;
        }

        // QR Code scan handlers
        async function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();
            
            // Prevent rapid duplicate scans
            if (now - lastScanTime < 1000) {
                return;
            }
            lastScanTime = now;

            // Track scan attempts
            const attempts = scanAttempts.get(decodedText) || 0;
            scanAttempts.set(decodedText, attempts + 1);

            await processQRCode(decodedText);
            
            // In fast mode, continue scanning immediately
            if (!fastMode && isScanning) {
                await stopScanner();
                setTimeout(async () => {
                    if (!isScanning) {
                        await startScanner();
                    }
                }, 2000);
            }
        }

        function onScanFailure(error) {
            // Ignore scan failures in fast mode to reduce noise
            if (!fastMode) {
                console.log('Scan failed:', error);
            }
        }

        async function processQRCode(code) {
            try {
                // Find guest by code
                const guest = guests.find(g => g.codigo === code);
                
                if (!guest) {
                    await handleScanResult('invalid', null, code);
                    return;
                }

                if (scannedGuests.has(code)) {
                    await handleScanResult('duplicate', guest, code);
                    return;
                }

                // Valid scan
                scannedGuests.add(code);
                sessionScans++;
                
                // Log to Supabase
                if (isOnline) {
                    await supabase.from('logs').insert([{
                        token: code,
                        status: 'scan',
                        dispositivo: deviceName
                    }]);
                }

                await handleScanResult('success', guest, code);
                updateStats();
                renderGuests();
                updateRecentScans();
                
            } catch (error) {
                await handleScanResult('error', null, code);
            }
        }

        async function handleScanResult(type, guest, code) {
            const resultDiv = document.getElementById('last-scan-result');
            const nameEl = document.getElementById('scan-guest-name');
            const codeEl = document.getElementById('scan-guest-code');
            const iconEl = document.getElementById('scan-status-icon');

            let message, bgClass, iconClass, iconColor;

            switch (type) {
                case 'success':
                    message = guest.nome;
                    bgClass = 'bg-green-600';
                    iconClass = 'fas fa-check-circle';
                    iconColor = 'text-green-400';
                    playSuccessSound();
                    vibrate([100]);
                    flashScreen('success');
                    break;
                    
                case 'duplicate':
                    message = guest.nome + ' (Já validado)';
                    bgClass = 'bg-orange-600';
                    iconClass = 'fas fa-exclamation-triangle';
                    iconColor = 'text-orange-400';
                    playErrorSound();
                    vibrate([100, 100, 100]);
                    break;
                    
                case 'invalid':
                    message = 'Código inválido';
                    bgClass = 'bg-red-600';
                    iconClass = 'fas fa-times-circle';
                    iconColor = 'text-red-400';
                    playErrorSound();
                    vibrate([200]);
                    flashScreen('error');
                    break;
                    
                case 'error':
                    message = 'Erro ao processar';
                    bgClass = 'bg-red-600';
                    iconClass = 'fas fa-exclamation-circle';
                    iconColor = 'text-red-400';
                    playErrorSound();
                    vibrate([200]);
                    break;
            }

            nameEl.textContent = message;
            codeEl.textContent = code;
            iconEl.className = `${iconClass} ${iconColor}`;
            resultDiv.className = `mx-4 mb-4 p-4 rounded-lg ${bgClass} slide-up`;
            resultDiv.classList.remove('hidden');

            // Auto-hide after 3 seconds
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 3000);
        }

        // Audio feedback
        function playSuccessSound() {
            if (!document.getElementById('success-sound').checked) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        function playErrorSound() {
            if (!document.getElementById('error-sound').checked) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Haptic feedback
        function vibrate(pattern) {
            if (document.getElementById('vibration').checked && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // Visual feedback
        function flashScreen(type) {
            const body = document.body;
            const flashClass = type === 'success' ? 'success-flash' : 'error-flash';
            
            body.classList.add(flashClass);
            setTimeout(() => {
                body.classList.remove(flashClass);
            }, 500);
        }

        // Guest management
        function renderGuests() {
            const container = document.getElementById('guests-list');
            
            if (guests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-users text-3xl mb-2"></i>
                        <p>Nenhum convidado encontrado</p>
                    </div>
                `;
                return;
            }

            const guestsHtml = guests.map(guest => {
                const isScanned = scannedGuests.has(guest.codigo);
                const attempts = scanAttempts.get(guest.codigo) || 0;
                
                return `
                    <div class="bg-gray-800 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium ${isScanned ? 'text-green-400' : 'text-white'}">${guest.nome}</h4>
                            <p class="text-sm text-gray-400">${guest.codigo}</p>
                            ${attempts > 0 ? `<p class="text-xs text-orange-400">${attempts} tentativa(s)</p>` : ''}
                        </div>
                        <div class="flex items-center">
                            ${isScanned ? 
                                '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : 
                                '<i class="fas fa-clock text-gray-500 text-xl"></i>'
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = guestsHtml;
        }

        function filterGuests() {
            const searchTerm = document.getElementById('guest-search').value.toLowerCase();
            const filteredGuests = guests.filter(guest => 
                guest.nome.toLowerCase().includes(searchTerm) || 
                guest.codigo.toLowerCase().includes(searchTerm)
            );
            
            // Temporarily replace guests array for rendering
            const originalGuests = guests;
            guests = filteredGuests;
            renderGuests();
            guests = originalGuests;
        }

        function filterGuestsByStatus(status) {
            // Update filter buttons
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600';
            });
            document.getElementById(`filter-${status}`).className = 'flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white text-sm min-h-[44px] active:bg-blue-700';

            let filteredGuests;
            switch (status) {
                case 'scanned':
                    filteredGuests = guests.filter(guest => scannedGuests.has(guest.codigo));
                    break;
                case 'pending':
                    filteredGuests = guests.filter(guest => !scannedGuests.has(guest.codigo));
                    break;
                default:
                    filteredGuests = guests;
            }

            // Temporarily replace guests array for rendering
            const originalGuests = guests;
            guests = filteredGuests;
            renderGuests();
            guests = originalGuests;
        }

        // Reports
        function updateRecentScans() {
            const container = document.getElementById('recent-scans');
            const recentScans = Array.from(scannedGuests).slice(-5).reverse();
            
            if (recentScans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <p>Nenhuma validação ainda</p>
                    </div>
                `;
                return;
            }

            const scansHtml = recentScans.map(code => {
                const guest = guests.find(g => g.codigo === code);
                return `
                    <div class="bg-gray-800 rounded-lg p-3 flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-green-400">${guest ? guest.nome : 'Desconhecido'}</h4>
                            <p class="text-sm text-gray-400">${code}</p>
                        </div>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                `;
            }).join('');

            container.innerHTML = scansHtml;
        }

        async function generatePDFReport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Relatório InvitesQR', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Evento: ${currentClient.nome}`, 20, 50);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-PT')}`, 20, 60);
                doc.text(`Total de Convidados: ${guests.length}`, 20, 70);
                doc.text(`Validados: ${scannedGuests.size}`, 20, 80);
                doc.text(`Pendentes: ${guests.length - scannedGuests.size}`, 20, 90);
                
                // Scanned guests list
                doc.text('Convidados Validados:', 20, 110);
                
                let yPosition = 120;
                Array.from(scannedGuests).forEach((code, index) => {
                    const guest = guests.find(g => g.codigo === code);
                    if (guest && yPosition < 280) {
                        doc.text(`${index + 1}. ${guest.nome} (${code})`, 25, yPosition);
                        yPosition += 10;
                    }
                });
                
                // Save PDF
                doc.save(`relatorio-${currentClient.token}-${new Date().toISOString().split('T')[0]}.pdf`);
                
                showToast('Relatório PDF gerado com sucesso', 'success');
                
            } catch (error) {
                showToast('Erro ao gerar relatório PDF', 'error');
            }
        }

        async function shareReport() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Relatório InvitesQR',
                        text: `Evento: ${currentClient.nome}\nValidados: ${scannedGuests.size}/${guests.length}`,
                        url: window.location.href
                    });
                } catch (error) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                const reportText = `Relatório InvitesQR\nEvento: ${currentClient.nome}\nValidados: ${scannedGuests.size}/${guests.length}\nData: ${new Date().toLocaleDateString('pt-PT')}`;
                
                try {
                    await navigator.clipboard.writeText(reportText);
                    showToast('Relatório copiado para a área de transferência', 'success');
                } catch (error) {
                    showToast('Erro ao partilhar relatório', 'error');
                }
            }
        }

        // Clear saved token function
        function clearSavedTokenAndNotify() {
            if (confirm('Tem certeza que deseja limpar o token guardado? Terá que inserir novamente na próxima sessão.')) {
                clearSavedToken();
                showToast('Token guardado removido com sucesso', 'success');
            }
        }

        // Logout
        async function logout() {
            if (confirm('Tem certeza que deseja terminar a sessão?')) {
                if (isScanning) {
                    await stopScanner();
                }
                
                // Clear saved token
                clearSavedToken();
                
                // Reset state
                currentClient = null;
                guests = [];
                scannedGuests.clear();
                sessionScans = 0;
                scanAttempts.clear();
                
                // Show login screen
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                // Reset form
                document.getElementById('login-form').reset();
                
                showToast('Sessão terminada', 'info');
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `bg-gray-800 border-l-4 ${
                type === 'success' ? 'border-green-500' : 
                type === 'error' ? 'border-red-500' : 
                'border-blue-500'
            } p-4 shadow-lg rounded-r-lg max-w-sm slide-up`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${
                        type === 'success' ? 'check-circle text-green-500' : 
                        type === 'error' ? 'exclamation-circle text-red-500' : 
                        'info-circle text-blue-500'
                    } mr-3"></i>
                    <span class="text-white">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isScanning) {
                // Pause scanner when app goes to background
                stopScanner();
            }
        });

        // Handle online/offline events
        window.addEventListener('online', checkConnectivity);
        window.addEventListener('offline', checkConnectivity);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967aeb9c016177da',t:'MTc1Mzk0MjA5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
