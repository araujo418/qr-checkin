<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor QR Code - Controle de Convidados</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 20px);
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }
        
        .card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }
        
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            resize: vertical;
        }
        
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            color: white;
        }
        
        .scanner-container {
            background: #1a202c;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        #reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .scanner-status {
            color: white;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        .search-input {
            padding-left: 45px;
        }
        
        .guest-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
        }
        
        .guest-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .guest-item:last-child {
            border-bottom: none;
        }
        
        .guest-item.scanned {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
        }
        
        .guest-name {
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
        }
        
        .guest-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }
        
        .status-scanned {
            background: #c6f6d5;
            color: #2f855a;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .progress-container {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 15px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #a0aec0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ Leitor QR Code</h1>
            <p>Sistema de Controle de Convidados</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('scanner')">üì± Scanner</button>
            <button class="tab" onclick="switchTab('management')">‚öôÔ∏è Gest√£o</button>
        </div>
        
        <!-- ABA 1: SCANNER -->
        <div id="scanner-tab" class="tab-content active">
            <!-- Scanner -->
            <div class="scanner-container">
                <div id="reader"></div>
                <div class="scanner-status" id="scannerStatus">üì± Carregue primeiro uma lista de convidados</div>
            </div>
            <button class="btn btn-primary" id="scanBtn" onclick="toggleScanner()" disabled>üì± Iniciar Scanner</button>
            
            <!-- Carregar Lista -->
            <div class="card">
                <h3>üìã Carregar Lista de Convidados</h3>
                <div class="input-group">
                    <label for="fileInput">Selecione o arquivo da lista:</label>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileSelect()">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üìÅ Escolher Arquivo</button>
                    <button class="btn btn-warning" id="updateBtn" onclick="updateGuestList()" style="display: none;">üîÑ Atualizar Lista</button>
                </div>
                <div id="fileStatus" style="margin-top: 10px; padding: 10px; border-radius: 8px; font-size: 14px; display: none;"></div>
            </div>
            
            <!-- Pesquisa -->
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Pesquisar convidado..." oninput="searchGuests()">
            </div>
            
            <!-- Lista de Convidados -->
            <div class="guest-list" id="guestList">
                <div class="empty-state">
                    Carregue uma lista de convidados para come√ßar
                </div>
            </div>
        </div>
        
        <!-- ABA 2: GEST√ÉO -->
        <div id="management-tab" class="tab-content">
            <!-- Estat√≠sticas -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalGuests">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="scannedGuests">0</div>
                    <div class="stat-label">Escaneados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingGuests">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
            </div>
            
            <!-- Barra de Progresso -->
            <div class="progress-container">
                <h3>üìä Progresso do Evento</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0% conclu√≠do</div>
            </div>
            
            <!-- Controles -->
            <div class="card">
                <h3>‚öôÔ∏è Controles</h3>
                <button class="btn btn-danger" onclick="clearList()">üóëÔ∏è Eliminar Lista</button>
                <button class="btn btn-warning" onclick="resetScanned()">‚Ü©Ô∏è Desmarcar Todos</button>
            </div>
        </div>
    </div>
    
    <div id="alerts"></div>

    <script>
        let guests = [];
        let scannedGuests = new Set();
        let html5QrCode = null;
        let isScanning = false;
        let eventMetadata = null;
        
        // Chave de descriptografia
        const SECRET_KEY = 'Invites2025@!!QR';
        
        // Sistema de armazenamento offline
        const OfflineStorage = {
            save: function(key, data) {
                try {
                    localStorage.setItem('inviteApp_' + key, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Erro ao salvar offline:', e);
                    return false;
                }
            },
            
            load: function(key) {
                try {
                    const data = localStorage.getItem('inviteApp_' + key);
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error('Erro ao carregar offline:', e);
                    return null;
                }
            },
            
            remove: function(key) {
                try {
                    localStorage.removeItem('inviteApp_' + key);
                    return true;
                } catch (e) {
                    console.error('Erro ao remover offline:', e);
                    return false;
                }
            },
            
            clear: function() {
                try {
                    const keys = Object.keys(localStorage).filter(key => key.startsWith('inviteApp_'));
                    keys.forEach(key => localStorage.removeItem(key));
                    return true;
                } catch (e) {
                    console.error('Erro ao limpar offline:', e);
                    return false;
                }
            }
        };
        
        // Fun√ß√£o para mostrar alertas
        function showAlert(message, type = 'success') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '1000';
            alert.style.maxWidth = '90%';
            
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Alternar entre abas
        function switchTab(tabName) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativar aba selecionada
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // Fun√ß√£o para descriptografar dados
        function decryptData(encryptedData) {
            try {
                const decrypted = CryptoJS.AES.decrypt(encryptedData, SECRET_KEY);
                const jsonString = decrypted.toString(CryptoJS.enc.Utf8);
                if (!jsonString) {
                    throw new Error('Arquivo n√£o foi gerado pelo painel oficial');
                }
                
                const data = JSON.parse(jsonString);
                
                // Valida√ß√£o rigorosa - s√≥ aceita arquivos do painel
                if (!validatePanelFile(data)) {
                    throw new Error('Arquivo inv√°lido. Use apenas arquivos gerados pelo painel oficial');
                }
                
                return data;
            } catch (error) {
                if (error.message === 'EXPIRED_TOKEN') {
                    throw new Error('‚è∞ Token expirado! Por favor entre em contacto com a Invites para obter uma nova lista atualizada.');
                }
                if (error.message.includes('painel')) {
                    throw error;
                }
                throw new Error('Arquivo corrompido ou n√£o autorizado');
            }
        }
        
        // Valida√ß√£o rigorosa do arquivo do painel
        function validatePanelFile(data) {
            // Verificar estrutura obrigat√≥ria
            if (!data || typeof data !== 'object') return false;
            if (!data.guests || !Array.isArray(data.guests)) return false;
            if (!data.metadata || typeof data.metadata !== 'object') return false;
            
            // Verificar assinatura do painel
            if (data.metadata.source !== 'InvitePanel2025') return false;
            if (!data.metadata.version || !data.metadata.generated) return false;
            if (!data.metadata.signature) return false;
            if (!data.metadata.clientToken) return false;
            if (!data.metadata.expiresAt) return false;
            
            // Verificar se o token n√£o expirou
            const expirationDate = new Date(data.metadata.expiresAt);
            const currentDate = new Date();
            if (currentDate > expirationDate) {
                throw new Error('EXPIRED_TOKEN');
            }
            
            // Verificar estrutura dos convidados
            for (let guest of data.guests) {
                if (!guest.id || !guest.name) return false;
                if (typeof guest.id !== 'string' || typeof guest.name !== 'string') return false;
            }
            
            // Verificar assinatura de integridade (incluindo token)
            const expectedSignature = CryptoJS.SHA256(
                data.metadata.version + 
                data.metadata.generated + 
                data.metadata.clientToken +
                data.metadata.expiresAt +
                data.guests.length + 
                SECRET_KEY
            ).toString();
            
            return data.metadata.signature === expectedSignature;
        }
        
        // Manipular sele√ß√£o de arquivo
        function handleFileSelect(isUpdate = false) {
            const fileInput = document.getElementById('fileInput');
            const fileStatus = document.getElementById('fileStatus');
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            // Mostrar status de carregamento
            fileStatus.style.display = 'block';
            fileStatus.style.background = '#e6f3ff';
            fileStatus.style.color = '#0066cc';
            fileStatus.innerHTML = isUpdate ? 'üîÑ Atualizando lista...' : '‚è≥ Carregando arquivo...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const encryptedData = e.target.result;
                    loadGuestList(encryptedData, file.name, isUpdate);
                } catch (error) {
                    showFileError('Erro ao ler o arquivo. Verifique se √© um arquivo v√°lido.');
                }
            };
            
            reader.onerror = function() {
                showFileError('Erro ao ler o arquivo. Tente novamente.');
            };
            
            reader.readAsText(file);
            
            // Resetar o handler para carregamento normal
            if (isUpdate) {
                fileInput.onchange = function() {
                    handleFileSelect(false);
                };
            }
        }
        
        // Carregar lista de convidados
        function loadGuestList(encryptedData, fileName, isUpdate = false) {
            const fileStatus = document.getElementById('fileStatus');
            
            try {
                const data = decryptData(encryptedData);
                
                if (!data.guests || !Array.isArray(data.guests)) {
                    throw new Error('Arquivo n√£o cont√©m uma lista v√°lida de convidados');
                }
                
                // Verificar se √© o mesmo cliente (mesmo token) ou cliente diferente
                const currentToken = eventMetadata ? eventMetadata.clientToken : null;
                const newToken = data.metadata.clientToken;
                const isSameClient = currentToken === newToken;
                
                let addedGuests = 0;
                let preservedScans = 0;
                let isTokenUpdate = false;
                
                if (isUpdate && isSameClient) {
                    // ATUALIZA√á√ÉO DO MESMO CLIENTE - Preservar check-ins
                    isTokenUpdate = true;
                    const oldScannedGuests = new Set(scannedGuests);
                    const oldGuestCount = guests.length;
                    
                    guests = data.guests;
                    eventMetadata = data.metadata;
                    
                    // Recontar convidados que j√° fizeram check-in
                    scannedGuests.clear();
                    guests.forEach(guest => {
                        if (oldScannedGuests.has(guest.id)) {
                            scannedGuests.add(guest.id);
                            preservedScans++;
                        }
                    });
                    
                    addedGuests = guests.length - oldGuestCount;
                } else {
                    // NOVO CLIENTE OU CARREGAMENTO INICIAL - Limpar check-ins
                    if (isUpdate && !isSameClient) {
                        // Avisar que √© um cliente diferente
                        if (currentToken) {
                            showAlert('üîÑ Novo cliente detectado! Lista ser√° substitu√≠da completamente', 'error');
                        }
                    }
                    
                    guests = data.guests;
                    eventMetadata = data.metadata;
                    scannedGuests.clear();
                }
                
                // Salvar offline para funcionamento sem internet
                OfflineStorage.save('guests', guests);
                OfflineStorage.save('metadata', eventMetadata);
                OfflineStorage.save('scannedGuests', Array.from(scannedGuests));
                OfflineStorage.save('loadTime', new Date().toISOString());
                
                updateStats();
                renderGuestList();
                
                // Habilitar scanner e bot√£o de atualiza√ß√£o
                const scanBtn = document.getElementById('scanBtn');
                const scannerStatus = document.getElementById('scannerStatus');
                const updateBtn = document.getElementById('updateBtn');
                
                scanBtn.disabled = false;
                updateBtn.style.display = 'block';
                scannerStatus.textContent = '‚úÖ Pronto para escanear QR Codes';
                
                // Mostrar sucesso com info do evento
                fileStatus.style.background = '#d4edda';
                fileStatus.style.color = '#155724';
                
                if (isTokenUpdate) {
                    // Atualiza√ß√£o do mesmo cliente
                    fileStatus.innerHTML = `üîÑ Lista atualizada! ${guests.length} convidados total<br>
                        <small>‚úÖ ${preservedScans} check-ins preservados${addedGuests > 0 ? ` | üÜï ${addedGuests} novos convidados` : addedGuests < 0 ? ` | ‚ûñ ${Math.abs(addedGuests)} convidados removidos` : ''}</small><br>
                        <small>üîë Token: ${newToken.substring(0, 8)}... | üìÖ ${new Date(eventMetadata.generated).toLocaleString('pt-BR')}</small>`;
                    
                    showAlert(`üîÑ Lista atualizada! ${preservedScans} check-ins preservados${addedGuests > 0 ? `, ${addedGuests} novos convidados` : addedGuests < 0 ? `, ${Math.abs(addedGuests)} removidos` : ''}`);
                } else if (isUpdate && !isSameClient) {
                    // Novo cliente durante atualiza√ß√£o
                    fileStatus.innerHTML = `üîÑ Novo cliente carregado! ${guests.length} convidados<br>
                        <small>üîë Token: ${newToken.substring(0, 8)}... | üìÖ ${new Date(eventMetadata.generated).toLocaleString('pt-BR')}</small><br>
                        <small>‚ö†Ô∏è Check-ins anteriores foram limpos (cliente diferente)</small>`;
                    
                    showAlert(`üîÑ Novo cliente! ${guests.length} convidados carregados (check-ins anteriores limpos)`);
                } else {
                    // Carregamento inicial
                    fileStatus.innerHTML = `‚úÖ ${guests.length} convidados carregados de "${fileName}"<br>
                        <small>üîë Token: ${newToken.substring(0, 8)}... | üìÖ ${new Date(eventMetadata.generated).toLocaleString('pt-BR')}</small><br>
                        <small>‚è∞ Expira em: ${new Date(eventMetadata.expiresAt).toLocaleString('pt-BR')}</small>`;
                    
                    showAlert(`üéâ Lista carregada! ${guests.length} convidados prontos para check-in`);
                }
                
            } catch (error) {
                showFileError(error.message);
            }
        }
        
        // Atualizar lista de convidados
        function updateGuestList() {
            if (guests.length === 0) {
                showAlert('üìã Carregue uma lista primeiro antes de atualizar', 'error');
                return;
            }
            
            if (!confirm(`üîÑ Atualizar a lista de convidados?\n\n‚úÖ Todos os check-ins j√° realizados ser√£o preservados\nüÜï Novos convidados ser√£o adicionados se houver`)) {
                return;
            }
            
            // Simular clique no input de arquivo para atualiza√ß√£o
            const fileInput = document.getElementById('fileInput');
            fileInput.onchange = function() {
                handleFileSelect(true); // Passar flag de atualiza√ß√£o
            };
            fileInput.click();
        }
        
        // Mostrar erro no arquivo
        function showFileError(message) {
            const fileStatus = document.getElementById('fileStatus');
            fileStatus.style.display = 'block';
            fileStatus.style.background = '#f8d7da';
            fileStatus.style.color = '#721c24';
            fileStatus.innerHTML = `‚ùå ${message}`;
            showAlert(`Erro: ${message}`, 'error');
        }
        
        // Alternar scanner
        function toggleScanner() {
            if (!isScanning) {
                startScanner();
            } else {
                stopScanner();
            }
        }
        
        // Iniciar scanner
        function startScanner() {
            if (guests.length === 0) {
                showAlert('üö´ Carregue uma lista de convidados primeiro!', 'error');
                return;
            }
            
            const scanBtn = document.getElementById('scanBtn');
            const scannerStatus = document.getElementById('scannerStatus');
            
            // Mostrar status de inicializa√ß√£o
            scannerStatus.textContent = 'üîÑ Iniciando c√¢mera...';
            scanBtn.disabled = true;
            
            html5QrCode = new Html5Qrcode("reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 200, height: 200 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText, decodedResult) => {
                    handleQRCodeScan(decodedText);
                },
                (errorMessage) => {
                    // Ignora erros de scan cont√≠nuo
                }
            ).then(() => {
                isScanning = true;
                scanBtn.disabled = false;
                scanBtn.textContent = '‚èπÔ∏è Parar Scanner';
                scanBtn.className = 'btn btn-danger';
                scannerStatus.textContent = 'üì± Aponte a c√¢mera para o QR Code do convidado';
                showAlert('üì∑ Scanner ativo! Aponte para os QR Codes');
            }).catch((err) => {
                scanBtn.disabled = false;
                scannerStatus.textContent = '‚ùå Erro ao acessar c√¢mera. Verifique as permiss√µes.';
                showAlert(`Erro: N√£o foi poss√≠vel acessar a c√¢mera. ${err}`, 'error');
            });
        }
        
        // Parar scanner
        function stopScanner() {
            const scanBtn = document.getElementById('scanBtn');
            const scannerStatus = document.getElementById('scannerStatus');
            
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    scanBtn.textContent = 'üì± Iniciar Scanner';
                    scanBtn.className = 'btn btn-primary';
                    scannerStatus.textContent = 'Scanner desativado';
                    showAlert('Scanner parado');
                }).catch((err) => {
                    showAlert(`Erro ao parar scanner: ${err}`, 'error');
                });
            }
        }
        
        // Processar QR Code escaneado
        function handleQRCodeScan(qrData) {
            const guest = guests.find(g => g.id === qrData || g.name === qrData);
            
            if (guest) {
                if (scannedGuests.has(guest.id)) {
                    showAlert(`‚ö†Ô∏è ${guest.name} j√° fez check-in anteriormente!`, 'error');
                    // Vibrar se dispon√≠vel
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }
                } else {
                    scannedGuests.add(guest.id);
                    
                    // Salvar scan offline imediatamente
                    const scannedArray = Array.from(scannedGuests);
                    OfflineStorage.save('scannedGuests', scannedArray);
                    OfflineStorage.save('lastScan', {
                        guestId: guest.id,
                        guestName: guest.name,
                        timestamp: new Date().toISOString()
                    });
                    
                    updateStats();
                    renderGuestList();
                    showAlert(`üéâ ${guest.name} - Check-in realizado com sucesso!`);
                    // Vibrar sucesso
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    // Atualizar status do scanner
                    const scannerStatus = document.getElementById('scannerStatus');
                    const remaining = guests.length - scannedGuests.size;
                    if (remaining > 0) {
                        scannerStatus.textContent = `‚úÖ Check-in OK! ${remaining} convidados restantes`;
                    } else {
                        scannerStatus.textContent = 'üéä Todos os convidados fizeram check-in!';
                    }
                }
            } else {
                showAlert(`‚ùå QR Code n√£o reconhecido. Verifique se √© um convidado v√°lido.`, 'error');
                // Vibrar erro
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50, 50, 50]);
                }
            }
        }
        
        // Limpar lista
        function clearList() {
            if (guests.length === 0) {
                showAlert('üìã N√£o h√° lista para eliminar', 'error');
                return;
            }
            
            if (confirm(`üóëÔ∏è Tem certeza que deseja eliminar toda a lista de convidados?\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!\nüìä ${guests.length} convidados ser√£o removidos\n‚úÖ ${scannedGuests.size} check-ins ser√£o perdidos`)) {
                const totalGuests = guests.length;
                const totalScanned = scannedGuests.size;
                guests = [];
                scannedGuests.clear();
                
                // Limpar dados offline
                clearOfflineData();
                eventMetadata = null;
                
                // Resetar interface
                const scanBtn = document.getElementById('scanBtn');
                const scannerStatus = document.getElementById('scannerStatus');
                const fileStatus = document.getElementById('fileStatus');
                const updateBtn = document.getElementById('updateBtn');
                
                scanBtn.disabled = true;
                scanBtn.textContent = 'üì± Iniciar Scanner';
                scanBtn.className = 'btn btn-primary';
                scannerStatus.textContent = 'üì± Carregue primeiro uma lista de convidados';
                fileStatus.style.display = 'none';
                updateBtn.style.display = 'none';
                
                // Parar scanner se estiver ativo
                if (isScanning) {
                    stopScanner();
                }
                
                updateStats();
                renderGuestList();
                showAlert(`üóëÔ∏è Lista eliminada: ${totalGuests} convidados e ${totalScanned} check-ins removidos`);
            }
        }
        
        // Desmarcar todos os escaneados
        function resetScanned() {
            if (scannedGuests.size === 0) {
                showAlert('üìã N√£o h√° check-ins para desmarcar', 'error');
                return;
            }
            
            if (confirm(`‚Ü©Ô∏è Tem certeza que deseja desmarcar todos os check-ins?\n\nüìä ${scannedGuests.size} check-ins realizados ser√£o desmarcados\nüìã A lista de ${guests.length} convidados ser√° mantida\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`)) {
                const totalScanned = scannedGuests.size;
                scannedGuests.clear();
                
                // Atualizar dados offline
                OfflineStorage.save('scannedGuests', []);
                OfflineStorage.remove('lastScan');
                
                updateStats();
                renderGuestList();
                
                // Atualizar status do scanner
                const scannerStatus = document.getElementById('scannerStatus');
                if (isScanning) {
                    scannerStatus.textContent = 'üì± Aponte a c√¢mera para o QR Code do convidado';
                } else if (guests.length > 0) {
                    scannerStatus.textContent = '‚úÖ Pronto para escanear QR Codes';
                }
                
                showAlert(`‚Ü©Ô∏è ${totalScanned} check-ins foram desmarcados`);
            }
        }
        
        // Pesquisar convidados
        function searchGuests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            renderGuestList(searchTerm);
        }
        
        // Atualizar estat√≠sticas
        function updateStats() {
            const total = guests.length;
            const scanned = scannedGuests.size;
            const pending = total - scanned;
            const percentage = total > 0 ? Math.round((scanned / total) * 100) : 0;
            
            document.getElementById('totalGuests').textContent = total;
            document.getElementById('scannedGuests').textContent = scanned;
            document.getElementById('pendingGuests').textContent = pending;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${percentage}% conclu√≠do (${scanned}/${total})`;
        }
        
        // Renderizar lista de convidados
        function renderGuestList(searchTerm = '') {
            const guestList = document.getElementById('guestList');
            
            if (guests.length === 0) {
                guestList.innerHTML = '<div class="empty-state">üìÅ Carregue um arquivo com a lista de convidados para come√ßar</div>';
                return;
            }
            
            const filteredGuests = guests.filter(guest => 
                guest.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredGuests.length === 0) {
                if (searchTerm) {
                    guestList.innerHTML = '<div class="empty-state">üîç Nenhum convidado encontrado com esse nome</div>';
                } else {
                    guestList.innerHTML = '<div class="empty-state">üìã Lista vazia</div>';
                }
                return;
            }
            
            guestList.innerHTML = filteredGuests.map(guest => {
                const isScanned = scannedGuests.has(guest.id);
                return `
                    <div class="guest-item ${isScanned ? 'scanned' : ''}">
                        <div class="guest-name">${guest.name}</div>
                        <div class="guest-status ${isScanned ? 'status-scanned' : 'status-pending'}">
                            ${isScanned ? '‚úÖ Check-in OK' : '‚è≥ Aguardando'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fun√ß√£o para recuperar dados offline
        function loadOfflineData() {
            const offlineGuests = OfflineStorage.load('guests');
            const offlineMetadata = OfflineStorage.load('metadata');
            const offlineScanned = OfflineStorage.load('scannedGuests');
            const loadTime = OfflineStorage.load('loadTime');
            
            if (offlineGuests && offlineMetadata) {
                guests = offlineGuests;
                eventMetadata = offlineMetadata;
                
                if (offlineScanned && Array.isArray(offlineScanned)) {
                    scannedGuests = new Set(offlineScanned);
                }
                
                // Habilitar scanner e bot√£o de atualiza√ß√£o
                const scanBtn = document.getElementById('scanBtn');
                const scannerStatus = document.getElementById('scannerStatus');
                const fileStatus = document.getElementById('fileStatus');
                const updateBtn = document.getElementById('updateBtn');
                
                scanBtn.disabled = false;
                updateBtn.style.display = 'block';
                scannerStatus.textContent = '‚úÖ Dados recuperados - Pronto para escanear';
                
                // Mostrar status de recupera√ß√£o
                fileStatus.style.display = 'block';
                fileStatus.style.background = '#fff3cd';
                fileStatus.style.color = '#856404';
                fileStatus.innerHTML = `üîÑ ${guests.length} convidados recuperados do armazenamento offline<br>
                    <small>‚úÖ ${scannedGuests.size} check-ins preservados</small><br>
                    <small>üîë Token: ${eventMetadata.clientToken.substring(0, 8)}... | üìÖ ${new Date(loadTime).toLocaleString('pt-BR')}</small><br>
                    <small>‚è∞ Expira em: ${new Date(eventMetadata.expiresAt).toLocaleString('pt-BR')}</small>`;
                
                updateStats();
                renderGuestList();
                
                showAlert(`üîÑ Dados recuperados! ${guests.length} convidados e ${scannedGuests.size} check-ins`);
                return true;
            }
            return false;
        }
        
        // Limpar dados offline
        function clearOfflineData() {
            OfflineStorage.clear();
        }
        
        // Inicializar - tentar recuperar dados offline primeiro
        if (!loadOfflineData()) {
            updateStats();
            renderGuestList();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'964428d580f477d7',t:'MTc1MzM2Nzg4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
