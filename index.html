<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InvitesQR</title>
  <script src="https://unpkg.com/html5-qrcode@latest"></script>
</head>
<body style="font-family:sans-serif;text-align:center;padding:20px">
  <div id="login">
    <h2>Digite seu token:</h2>
    <input id="tokenInput" placeholder="ex: abcd-1234" />
    <br><br>
    <button onclick="iniciar(document.getElementById('tokenInput').value)">Entrar</button>
  </div>

  <div id="app" style="display:none">
    <h2 id="clienteNome"></h2>
    <button onclick="startScanner()">📷 Escanear QR Code</button>
    <br><br>
    <progress id="progress" max="100" value="0" style="width:80%"></progress>
    <div id="status"></div>
    <ul id="lista" style="text-align:left;max-width:500px;margin:auto"></ul>
    <div id="doneMsg" style="display:none;font-weight:bold;color:green;margin-top:20px">
      🎉 Todos os convidados foram validados!
    </div>
  </div>

  <!-- WhatsApp Flutuante -->
  <a href="https://wa.me/244959823409"
     style="position:fixed;bottom:20px;right:20px;background:#25d366;color:#fff;
     border-radius:50%;padding:15px 18px;font-size:20px;text-decoration:none;">
     💬
  </a>

  <div id="qr-reader" style="display:none;margin-top:20px"></div>

<script>
const SUPABASE_URL = "https://rnvunprjvppbjavkaoek.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFz..."; // use sua chave completa
let token = localStorage.getItem('token');
let deviceId = localStorage.getItem('device_id') || crypto.randomUUID();
localStorage.setItem('device_id', deviceId);
let client = null;
let convidados = [];

async function iniciar(inputToken) {
  token = inputToken || token;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  const data = await res.json();
  client = data[0];
  if (!client) return alert("Token inválido");
  if (client.dispositivos && client.dispositivos !== deviceId)
    return alert("Token já foi usado em outro dispositivo.");
  const now = Date.now();
  if (client.validade * 1000 < now)
    return alert("Token expirado.");
  if (client.scans_usados >= client.limite_scans)
    return alert("Limite de validações atingido.");
  if (!client.dispositivos) await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ dispositivos: deviceId })
  });
  localStorage.setItem('token', token);
  document.getElementById("login").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("clienteNome").innerText = `🎉 Bem-vindo, ${client.nome}`;
  await carregarConvidados();
}

async function carregarConvidados() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/convidados?token_cliente=eq.${token}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  convidados = await res.json();
  atualizarLista();
}

function atualizarLista() {
  const lista = document.getElementById("lista");
  lista.innerHTML = "";
  let usados = 0;
  convidados.forEach(c => {
    const li = document.createElement("li");
    li.textContent = `${c.nome} - ${c.status}`;
    if (c.status === "usado") usados++;
    lista.appendChild(li);
  });
  const pct = (usados / convidados.length) * 100;
  document.getElementById("progress").value = pct;
  document.getElementById("status").innerText = `${usados}/${convidados.length} validados`;
  if (usados === convidados.length) {
    document.getElementById("doneMsg").style.display = "block";
  }
}

async function marcarComoUsado(id) {
  await fetch(`${SUPABASE_URL}/rest/v1/convidados?id=eq.${id}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ status: "usado" })
  });
}

async function incrementarScans() {
  await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ scans_usados: client.scans_usados + 1 })
  });
  client.scans_usados++;
}

function startScanner() {
  document.getElementById("qr-reader").style.display = "block";
  const qr = new Html5Qrcode("qr-reader");
  qr.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async content => {
    const match = convidados.find(c => c.id.toString() === content.trim());
    if (!match) return alert("Convidado não encontrado.");
    if (match.status === "usado") return alert("Já validado.");
    await marcarComoUsado(match.id);
    await incrementarScans();
    alert("✔️ Validado: " + match.nome);
    await carregarConvidados();
  }, error => {});
}

setInterval(() => {
  if (token) carregarConvidados();
}, 30000);
</script>
</body>
</html>
