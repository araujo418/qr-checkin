<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Adkira â€“ ValidaÃ§Ã£o de Eventos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    #progressBar{transition:width .3s}
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <!-- LOGIN -->
  <section id="login" class="w-full max-w-sm bg-white rounded-xl shadow p-6 space-y-3">
    <h2 class="text-xl font-bold text-center">Login</h2>
    <input id="username" class="w-full border rounded p-2" placeholder="Utilizador" />
    <input id="password" type="password" class="w-full border rounded p-2" placeholder="Senha" />
    <button onclick="customLogin()" class="w-full bg-indigo-600 text-white rounded py-2">Entrar</button>
    <div id="loginError" class="text-red-600 text-center text-sm"></div>
  </section>

  <!-- CLIENTE -->
  <section id="cliente" class="hidden w-full max-w-md bg-white rounded-xl shadow p-4 space-y-4">
    <h2 class="text-lg font-semibold text-center">ValidaÃ§Ã£o de Convidados</h2>
    <div class="flex gap-2">
      <input id="codeInput" class="flex-1 border rounded p-2" placeholder="CÃ³digo ou QR" />
      <button onclick="verifyCode()" class="bg-indigo-600 text-white px-4 rounded">OK</button>
    </div>
    <button onclick="openScanner()" class="w-full bg-emerald-600 text-white py-2 rounded">ðŸ“· Ler QR Code</button>

    <div class="text-center text-sm">VÃ¡lidos: <span id="usedTxt">0</span>/<span id="limitTxt">0</span></div>
    <div class="w-full h-3 bg-gray-200 rounded"><div id="progressBar" class="h-full bg-indigo-600"></div></div>

    <ul id="guestList" class="mt-4 max-h-60 overflow-y-auto divide-y"></ul>

    <div id="qrDiv" class="hidden w-full max-w-xs mx-auto"></div>
  </section>

  <!-- ADMIN -->
  <section id="admin" class="hidden w-full max-w-md bg-white rounded-xl shadow p-4 space-y-4">
    <h2 class="text-lg font-semibold text-center">Painel Admin</h2>
    <form id="createForm" class="space-y-2">
      <input id="newUser"     class="w-full border rounded p-2" placeholder="Novo utilizador" />
      <input id="newPass"     class="w-full border rounded p-2" placeholder="Senha" />
      <input id="newEvent"    class="w-full border rounded p-2" placeholder="ID do evento" />
      <input id="newLimit"    type="number" class="w-full border rounded p-2" placeholder="Limite inicial" />
      <button type="button" onclick="createUserAndEvent()" class="w-full bg-indigo-600 text-white py-2 rounded">Criar utilizador & evento</button>
    </form>
    <hr/>
    <h3 class="font-semibold">Carregar convidados (ficheiro .txt)</h3>
    <input type="file" accept=".txt" onchange="uploadTxt(event)" />
    <p class="text-xs text-gray-500">Formato: cÃ³digo, nome (um por linha)</p>
  </section>

  <footer class="mt-8 text-xs text-gray-500">Adkira Media Â© 2025</footer>

  <script>
    /* =================== INIT DEFAULT ADMIN =================== */
    (function(){
      if(!localStorage.getItem('users')){
        const users = {
          "araujocataca116": {
            password: "Ki@ra1116.",
            event: "painel-admin",
            admin: true
          }
        };
        const events = {
          "painel-admin": { limit: 0, used: 0, guests: {} }
        };
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('events', JSON.stringify(events));
      }
    })();
    /* ========================================================= */

    let currentUser = null;
    let currentEventId = null;
    let guests = {}, totalGuests = 0, usedGuests = 0;

    function customLogin() {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      if (!u || !p) return document.getElementById('loginError').textContent = 'Preencha ambos os campos';
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      if (!users[u] || users[u].password !== p)
        return document.getElementById('loginError').textContent = 'Utilizador ou senha incorreta';

      currentUser = u;
      currentEventId = users[u].event;

      if (users[u].admin) {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('admin').classList.remove('hidden');
      } else {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('cliente').classList.remove('hidden');
        carregarEvento();
      }
    }

    function createUserAndEvent() {
      const u = document.getElementById('newUser').value.trim();
      const p = document.getElementById('newPass').value.trim();
      const e = document.getElementById('newEvent').value.trim();
      const l = parseInt(document.getElementById('newLimit').value.trim());
      if (!u || !p || !e || isNaN(l)) return alert('Preencha todos os campos');
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const events = JSON.parse(localStorage.getItem('events') || '{}');

      if(users[u]) return alert('Utilizador jÃ¡ existe');

      users[u] = { password: p, event: e, admin: false };
      events[e] = { limit: l, used: 0, guests: {} };

      localStorage.setItem('users', JSON.stringify(users));
      localStorage.setItem('events', JSON.stringify(events));
      alert('Utilizador e evento criados');
      document.getElementById('createForm').reset();
    }

    function uploadTxt(e) {
      const file = e.target.files[0];
      if (!file || !currentUser) return;
      const events = JSON.parse(localStorage.getItem('events') || '{}');
      const reader = new FileReader();
      reader.onload = function(evt) {
        const lines = evt.target.result.split(/\r?\n/).filter(Boolean);
        let count = 0;
        lines.forEach(line => {
          const [code, name] = line.split(/[,:;\t]+/);
          if (code) { events[currentEventId].guests[code.trim()] = { name: (name || 'Convidado').trim(), used: false }; count++; }
        });
        events[currentEventId].limit += count;
        localStorage.setItem('events', JSON.stringify(events));
        carregarEvento();
      };
      reader.readAsText(file);
    }

    function carregarEvento() {
      const events = JSON.parse(localStorage.getItem('events') || '{}');
      const ev = events[currentEventId];
      if (!ev) return;
      totalGuests = ev.limit;
      usedGuests = ev.used;
      document.getElementById('usedTxt').textContent = usedGuests;
      document.getElementById('limitTxt').textContent = totalGuests;
      document.getElementById('progressBar').style.width = totalGuests? Math.round((usedGuests / totalGuests) * 100) + '%' : '0%';
      document.getElementById('guestList').innerHTML = '';
      for (const [code, data] of Object.entries(ev.guests)) {
        const li = document.createElement('li');
        li.className = 'flex gap-2 p-2 border-b';
        li.innerHTML = `<span class="h-5 w-5 rounded-full border-2 ${data.used ? 'bg-green-500 border-green-500' : ''}"></span><span class="flex-1 truncate">${data.name}</span><span class="text-xs text-gray-500">${code}</span>`;
        document.getElementById('guestList').appendChild(li);
      }
    }

    function verifyCode() {
      const code = document.getElementById('codeInput').value.trim();
      if (!code) return;
      const events = JSON.parse
