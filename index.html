<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Invites digitais ‚Äì Valida√ß√£o</title>
  <script src="https://unpkg.com/html5-qrcode@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      color: #2d3748;
    }
    main {
      margin: 32px auto;
      max-width: 600px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    input[type="file"], button {
      width: 100%;
      padding: 12px;
      font-size: 1em;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #6a5acd;
      color: white;
      margin-bottom: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .output {
      margin-top: 14px;
      padding: 14px;
      text-align: center;
      border-radius: 10px;
      font-size: 1.1em;
    }
    #guestList {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
    }
    #guestList li {
      padding: 12px 16px;
      border-bottom: 1px solid #edf2f7;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .check {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #cbd5e0;
      flex-shrink: 0;
    }
    .checked {
      background: #38a169;
      border-color: #38a169;
    }
    #qrFullscreen {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #qrFullscreenClose {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #fff;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      z-index: 10000;
    }
    #qrViewFull { width: 100vw; height: 100vh; }
    #qrStatus, #qrGuestName {
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .footer-note {
      text-align: center;
      font-size: 0.8em;
      color: #a0aec0;
      margin: 32px 0;
    }
  </style>
</head>
<body>

  <div id="qrFullscreen">
    <button id="qrFullscreenClose" onclick="closeFullscreen()">Fechar</button>
    <div id="qrViewFull"></div>
    <div id="qrGuestName"></div>
    <div id="qrStatus"></div>
    <button id="nextBtn" onclick="enableNextScan()">‚û°Ô∏è Pr√≥ximo</button>
  </div>

  <main>
    <input type="file" id="jsonFileInput" accept=".json" onchange="handleFileUpload(event)" />
    <button onclick="startFullscreenScanner()">üì∑ Escanear QR Code</button>
    <div class="output" id="result">Nenhum c√≥digo validado ainda‚Ä¶</div>
    <ul id="guestList"></ul>
    <button onclick="clearGuestList()">üßπ Eliminar Lista</button>
    <button onclick="exportToCSV()">üì• Exportar CSV</button>
  </main>

  <div class="footer-note">Invites digitais ¬© 2025</div>

<script>
let guests = {};
const STORAGE_KEY = 'invitesDigitaisConvidados';
let fullscreenScanner = null;
let scannerLocked = false;

window.onload = () => {
  loadState();
};

function decryptJson(encryptedJson) {
  const decrypted = CryptoJS.AES.decrypt(encryptedJson, 'sua-chave-secreta');
  const json = decrypted.toString(CryptoJS.enc.Utf8);
  return JSON.parse(json);
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    try {
      const decryptedJson = decryptJson(content);
      if (decryptedJson.id !== 'meuApp2025') {
        alert("Este arquivo n√£o foi gerado pelo nosso sistema.");
        return;
      }
      decryptedJson.convidados.forEach(guest => {
        const key = guest.name.toUpperCase();
        if (!guests[key]) {
          guests[key] = { nome: guest.name, usado: false, usos: 0 };
        }
      });
      saveState();
      updateGuestList();
    } catch (err) {
      alert("Erro ao processar o ficheiro JSON.");
      console.error(err);
    }
  };
  reader.readAsText(file);
}

function updateGuestList() {
  const list = document.getElementById('guestList');
  list.innerHTML = '';
  Object.keys(guests).forEach(key => {
    const guest = guests[key];
    const li = document.createElement('li');
    li.dataset.key = key;
    li.innerHTML = `<span class="check ${guest.usado ? 'checked' : ''}"></span><span>${guest.nome}</span>`;
    list.appendChild(li);
  });
  saveState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(guests));
}

function loadState() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    guests = JSON.parse(saved);
    updateGuestList();
  }
}

function clearGuestList() {
  guests = {};
  localStorage.removeItem(STORAGE_KEY);
  updateGuestList();
  alert("Lista eliminada.");
}

function verify(code) {
  if (!code) return;
  try {
    const decryptedJson = decryptJson(code);
    if (!decryptedJson.convidados) return;

    decryptedJson.convidados.forEach(guest => {
      const key = guest.name.toUpperCase();
      if (guests[key] && guests[key].usado) {
        guests[key].usos = (guests[key].usos || 1) + 1;
        showScanStatus('USADO', guest.name, 'error');
      } else {
        if (!guests[key]) {
          guests[key] = { nome: guest.name, usado: true, usos: 1 };
        } else {
          guests[key].usado = true;
          guests[key].usos = (guests[key].usos || 0) + 1;
        }
        updateGuestList();
        showScanStatus('PERMITIDO', guest.name, 'success');
      }
    });

    if (fullscreenScanner) fullscreenScanner.pause();
  } catch (error) {
    console.error('Erro ao verificar:', error);
    showScanStatus('C√ìDIGO INV√ÅLIDO', '', 'error');
    if (fullscreenScanner) fullscreenScanner.pause();
  }
}

function startFullscreenScanner(){
  document.getElementById('qrFullscreen').style.display = 'flex';
  if (!fullscreenScanner) {
    fullscreenScanner = new Html5Qrcode('qrViewFull');
  }
  fullscreenScanner.start({facingMode: 'environment'}, {fps: 10, qrbox: 300},
    txt => { if (!scannerLocked) verify(txt); },
    () => {}
  );
}

function closeFullscreen(){
  if(fullscreenScanner){
    fullscreenScanner.stop().then(() => fullscreenScanner.clear()).then(() => fullscreenScanner = null);
  }
  document.getElementById('qrFullscreen').style.display = 'none';
  enableNextScan();
}

function showScanStatus(status, name, type){
  scannerLocked = true;
  const nameElem = document.getElementById('qrGuestName');
  const statusElem = document.getElementById('qrStatus');

  nameElem.textContent = name;
  nameElem.style.fontSize = '2em';
  nameElem.style.fontWeight = 'bold';
  nameElem.style.color = '#2d3748';

  statusElem.textContent = status;
  statusElem.style.fontSize = '1.8em';
  statusElem.style.fontWeight = 'bold';
  statusElem.style.color = type === 'success' ? '#38a169' : '#e53e3e';

  nameElem.style.opacity = '1';
  statusElem.style.opacity = '1';
  document.getElementById('nextBtn').style.display = 'block';
}

function enableNextScan(){
  document.getElementById('qrStatus').style.opacity = '0';
  document.getElementById('qrGuestName').style.opacity = '0';
  document.getElementById('nextBtn').style.display = 'none';
  scannerLocked = false;

  if (fullscreenScanner) fullscreenScanner.resume();
}

function exportToCSV() {
  const header = ['Nome', 'Status', 'Usos'];
  const rows = Object.values(guests).map(g => [
    `"${g.nome}"`,
    g.usado ? 'Validado' : 'N√£o validado',
    g.usos || 0
  ]);

  const csvContent = [header, ...rows].map(e => e.join(',')).join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'convidados_validacao.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
