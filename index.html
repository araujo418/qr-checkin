<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesQR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .swipe-container {
            touch-action: pan-x;
            overflow-x: hidden;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
        }
        .corner.top-left {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .corner.top-right {
            top: 20px;
            right: 20px;
            border-left: none;
            border-bottom: none;
        }
        .corner.bottom-left {
            bottom: 20px;
            left: 20px;
            border-right: none;
            border-top: none;
        }
        .corner.bottom-right {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-400 mb-2">InvitesQR</h1>
                <p class="text-gray-300">Scanner de Convidados</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Token do Evento</label>
                    <input type="text" id="eventToken" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white" placeholder="Digite o token do evento" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                    Entrar
                </button>
            </form>
            <div id="loginError" class="mt-4 text-red-500 text-sm hidden"></div>
            <div id="welcomeMessage" class="mt-4 text-green-500 text-sm hidden"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-blue-400">InvitesQR Scanner</h1>
                    <p id="eventName" class="text-sm text-gray-300"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-green-500"></div>
                    <button id="themeToggle" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
                        <span id="themeIcon">üåô</span>
                    </button>
                    <button id="logoutBtn" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors">
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-gray-800 border-t border-gray-700">
            <div class="flex">
                <button class="tab-btn flex-1 py-3 px-4 text-center border-b-2 border-blue-500 text-blue-400 font-medium" data-tab="scanner">
                    üì± Scanner
                </button>
                <button class="tab-btn flex-1 py-3 px-4 text-center border-b-2 border-transparent text-gray-400 hover:text-white transition-colors" data-tab="options">
                    ‚öôÔ∏è Op√ß√µes
                </button>
            </div>
        </nav>

        <!-- Tab Content -->
        <div class="swipe-container">
            <!-- Scanner Tab -->
            <div id="scannerTab" class="tab-content p-4">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-4">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold mb-2">Scanner QR</h2>
                    </div>

                    <!-- Scanner Container -->
                    <div class="relative bg-black rounded-lg overflow-hidden mb-4" style="height: 300px;">
                        <div id="qr-reader" class="w-full h-full"></div>
                        <div class="scanner-overlay">
                            <div class="corner top-left"></div>
                            <div class="corner top-right"></div>
                            <div class="corner bottom-left"></div>
                            <div class="corner bottom-right"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div id="scanStatus" class="bg-black bg-opacity-75 text-white px-4 py-2 rounded-lg text-sm hidden">
                                    Aguardando QR Code...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scanner Controls -->
                    <div class="text-center space-y-3">
                        <button id="nextGuestBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed">
                            üéØ Pr√≥ximo Convidado
                        </button>
                    </div>
                </div>

                <!-- Smart Messages -->
                <div id="smartMessage" class="bg-blue-900 border border-blue-700 rounded-lg p-4 mb-4 hidden slide-up">
                    <div class="flex items-start space-x-3">
                        <span class="text-blue-400 text-xl">üí°</span>
                        <div>
                            <h3 class="font-medium text-blue-300 mb-1">Dica Inteligente</h3>
                            <p id="smartMessageText" class="text-sm text-blue-200"></p>
                        </div>
                        <button id="dismissSmartMessage" class="text-blue-400 hover:text-blue-300 ml-auto">‚úï</button>
                    </div>
                </div>

                <!-- Recent Scans -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-4">
                    <h3 class="font-medium mb-3">√öltimos Escaneamentos</h3>
                    <div id="recentScans" class="space-y-2 max-h-40 overflow-y-auto">
                        <div class="text-gray-400 text-sm text-center py-4">Nenhum scan realizado ainda</div>
                    </div>
                </div>
            </div>

            <!-- Options Tab -->
            <div id="optionsTab" class="tab-content p-4 hidden">
                <div class="space-y-4">
                    <!-- Scanner QR Stats -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">üì± Scanner QR</h2>
                        <div class="flex justify-center items-center space-x-4 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-500" id="scannedCount">0</div>
                                <div class="text-sm text-gray-400">Escaneados</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400" id="totalGuests">0</div>
                                <div class="text-sm text-gray-400">Total</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-4">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="switchCameraBtn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded-lg transition-colors min-h-[44px]">
                                üîÑ C√¢mera
                            </button>
                            <button id="flashToggle" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded-lg transition-colors min-h-[44px]">
                                üí° Flash
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">Estat√≠sticas da Sess√£o</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-500" id="sessionScansCount">0</div>
                                <div class="text-sm text-gray-400">Scans desta sess√£o</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400" id="sessionTime">00:00</div>
                                <div class="text-sm text-gray-400">Tempo de sess√£o</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-500" id="scanRate">0%</div>
                                <div class="text-sm text-gray-400">Taxa de sucesso</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-500" id="errorCount">0</div>
                                <div class="text-sm text-gray-400">Erros</div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">Configura√ß√µes</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span>Som de feedback</span>
                                <button id="soundToggle" class="w-12 h-6 bg-blue-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5 transition-transform"></div>
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Vibra√ß√£o</span>
                                <button id="vibrationToggle" class="w-12 h-6 bg-blue-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5 transition-transform"></div>
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Mensagens inteligentes</span>
                                <button id="smartMessagesToggle" class="w-12 h-6 bg-blue-600 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 right-0.5 transition-transform"></div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Convidados -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">üë• Convidados</h2>
                        <div class="space-y-3">
                            <div class="flex space-x-2">
                                <select id="guestFilter" class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                                    <option value="all">Todos</option>
                                    <option value="scanned">Escaneados</option>
                                    <option value="pending">Pendentes</option>
                                </select>
                                <button id="viewGuestsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors">
                                    Ver Lista
                                </button>
                            </div>
                            <input type="text" id="guestSearch" placeholder="Buscar convidado..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white">
                            <div id="guestsList" class="space-y-2 max-h-40 overflow-y-auto bg-gray-700 rounded p-2">
                                <div class="text-gray-400 text-center py-2 text-sm">Clique em "Ver Lista" para mostrar convidados</div>
                            </div>
                        </div>
                    </div>

                    <!-- Relat√≥rios -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">üìä Relat√≥rios</h2>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div class="text-center p-3 bg-gray-700 rounded">
                                <div class="text-xl font-bold text-green-500" id="reportScanned">0</div>
                                <div class="text-xs text-gray-400">Presentes</div>
                            </div>
                            <div class="text-center p-3 bg-gray-700 rounded">
                                <div class="text-xl font-bold text-yellow-500" id="reportPending">0</div>
                                <div class="text-xs text-gray-400">Pendentes</div>
                            </div>
                            <div class="text-center p-3 bg-gray-700 rounded">
                                <div class="text-xl font-bold text-blue-400" id="reportTotal">0</div>
                                <div class="text-xs text-gray-400">Total</div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button id="generatePDFBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded transition-colors text-sm">
                                üìÑ Gerar PDF
                            </button>
                            <button id="shareReportBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors text-sm">
                                üì§ Compartilhar Relat√≥rio
                            </button>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">Gerenciar Dados</h2>
                        <div class="space-y-3">
                            <button id="syncDataBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                                üîÑ Sincronizar Dados
                            </button>
                            <button id="exportDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                                üì§ Exportar Dados
                            </button>
                            <button id="clearDataBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-colors min-h-[44px]">
                                üóëÔ∏è Limpar Dados
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Offline Overlay -->
    <div id="offlineOverlay" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg p-6 m-4 text-center">
            <div class="text-4xl mb-4">üì°</div>
            <h3 class="text-xl font-bold mb-2">Modo Offline</h3>
            <p class="text-gray-300 mb-4">Sem conex√£o com a internet. Os dados ser√£o sincronizados quando a conex√£o for restaurada.</p>
            <button id="dismissOffline" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors">
                Entendi
            </button>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-40 space-y-2"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzE0NzEsImV4cCI6MjA1MDU0NzQ3MX0.example';

        // Storage Keys
        const STORAGE_KEYS = {
            SCANNED_GUESTS: 'invitesqr_scanned_guests',
            SCAN_ATTEMPTS: 'invitesqr_scan_attempts',
            SESSION_SCANS: 'invitesqr_session_scans',
            SCAN_HISTORY: 'invitesqr_scan_history',
            CLIENT_DATA: 'invitesqr_client_data',
            GUESTS_DATA: 'invitesqr_guests_data',
            LAST_SYNC: 'invitesqr_last_sync'
        };

        // Global Variables
        let currentClient = null;
        let guests = [];
        let scannedGuests = new Set();
        let sessionScans = 0;
        let html5QrCode = null;
        let isScanning = false;
        let canScan = false;
        let smartMessagesEnabled = true;
        let sessionStartTime = Date.now();
        let scanAttempts = 0;
        let errorCount = 0;
        let isDarkTheme = true;
        let soundEnabled = true;
        let vibrationEnabled = true;

        // Initialize Supabase (mock for demo)
        const supabase = {
            from: (table) => ({
                select: () => ({
                    eq: () => ({
                        single: () => Promise.resolve({ data: null, error: null })
                    })
                }),
                insert: () => Promise.resolve({ data: null, error: null }),
                update: () => Promise.resolve({ data: null, error: null })
            })
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadSavedData();
            checkAutoLogin();
            startSessionTimer();
            monitorConnectivity();
        });

        function initializeApp() {
            // Setup tab navigation
            setupTabNavigation();
            
            // Initialize scanner
            initializeScanner();
            
            // Setup auto-save
            setInterval(autoSave, 30000); // Auto-save every 30 seconds
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Scanner controls
            document.getElementById('nextGuestBtn').addEventListener('click', activateScanner);
            document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
            document.getElementById('flashToggle').addEventListener('click', toggleFlash);
            
            // Settings toggles
            document.getElementById('soundToggle').addEventListener('click', () => toggleSetting('sound'));
            document.getElementById('vibrationToggle').addEventListener('click', () => toggleSetting('vibration'));
            document.getElementById('smartMessagesToggle').addEventListener('click', () => toggleSetting('smartMessages'));
            
            // Data management
            document.getElementById('syncDataBtn').addEventListener('click', syncData);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('clearDataBtn').addEventListener('click', clearData);
            
            // Reports
            document.getElementById('generatePDFBtn').addEventListener('click', generatePDF);
            document.getElementById('shareReportBtn').addEventListener('click', shareReport);
            
            // Guest search and filter
            document.getElementById('guestSearch').addEventListener('input', filterGuests);
            document.getElementById('guestFilter').addEventListener('change', filterGuests);
            document.getElementById('viewGuestsBtn').addEventListener('click', viewGuestsList);
            
            // Smart message dismiss
            document.getElementById('dismissSmartMessage').addEventListener('click', dismissSmartMessage);
            document.getElementById('dismissOffline').addEventListener('click', () => {
                document.getElementById('offlineOverlay').classList.add('hidden');
            });
        }

        function setupTabNavigation() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Update active tab button
                    tabBtns.forEach(b => {
                        b.classList.remove('border-blue-500', 'text-blue-400');
                        b.classList.add('border-transparent', 'text-gray-400');
                    });
                    btn.classList.add('border-blue-500', 'text-blue-400');
                    btn.classList.remove('border-transparent', 'text-gray-400');
                    
                    // Show target tab content
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab + 'Tab').classList.remove('hidden');
                });
            });
        }

        function initializeScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            updateScannerUI();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const token = document.getElementById('eventToken').value.trim();
            const errorDiv = document.getElementById('loginError');
            const welcomeDiv = document.getElementById('welcomeMessage');
            
            if (!token) {
                showError(errorDiv, 'Por favor, digite o token do evento');
                return;
            }
            
            try {
                // Mock authentication for demo
                const mockClient = {
                    token: token,
                    nome: 'Evento Demo',
                    validade: Date.now() + (24 * 60 * 60 * 1000) // 24 hours from now
                };
                
                currentClient = mockClient;
                
                // Save token for auto-login
                localStorage.setItem('eventToken', token);
                localStorage.setItem(STORAGE_KEYS.CLIENT_DATA, JSON.stringify(mockClient));
                
                // Load mock guests
                guests = generateMockGuests();
                localStorage.setItem(STORAGE_KEYS.GUESTS_DATA, JSON.stringify(guests));
                
                // Show welcome message
                const lastSync = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
                if (lastSync) {
                    const timeSince = formatTimeSince(new Date(lastSync));
                    welcomeDiv.textContent = `Bem-vindo de volta! √öltima sincroniza√ß√£o: ${timeSince}`;
                    welcomeDiv.classList.remove('hidden');
                } else {
                    welcomeDiv.textContent = 'Login realizado com sucesso!';
                    welcomeDiv.classList.remove('hidden');
                }
                
                setTimeout(() => {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('eventName').textContent = mockClient.nome;
                    updateUI();
                    showSmartMessage();
                }, 1500);
                
            } catch (error) {
                showError(errorDiv, 'Erro ao fazer login. Verifique o token.');
            }
        }

        function generateMockGuests() {
            const names = [
                'Jo√£o Silva', 'Maria Santos', 'Pedro Oliveira', 'Ana Costa', 'Carlos Ferreira',
                'Lucia Pereira', 'Rafael Lima', 'Fernanda Souza', 'Bruno Alves', 'Camila Rocha',
                'Diego Martins', 'Juliana Barbosa', 'Thiago Ribeiro', 'Patr√≠cia Gomes', 'Rodrigo Dias'
            ];
            
            return names.map((name, index) => ({
                codigo: `QR${String(index + 1).padStart(3, '0')}`,
                nome: name,
                token_cliente: currentClient.token,
                status: 'PERMITIDO'
            }));
        }

        function checkAutoLogin() {
            const savedToken = localStorage.getItem('eventToken');
            const savedClient = localStorage.getItem(STORAGE_KEYS.CLIENT_DATA);
            
            if (savedToken && savedClient) {
                try {
                    const clientData = JSON.parse(savedClient);
                    if (clientData.validade > Date.now()) {
                        document.getElementById('eventToken').value = savedToken;
                        // Auto-submit login form
                        setTimeout(() => {
                            document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error parsing saved client data:', error);
                }
            }
        }

        function loadSavedData() {
            // Load scanned guests
            const savedScanned = localStorage.getItem(STORAGE_KEYS.SCANNED_GUESTS);
            if (savedScanned) {
                scannedGuests = new Set(JSON.parse(savedScanned));
            }
            
            // Load session scans
            const savedSessionScans = localStorage.getItem(STORAGE_KEYS.SESSION_SCANS);
            if (savedSessionScans) {
                sessionScans = parseInt(savedSessionScans);
            }
            
            // Load guests data
            const savedGuests = localStorage.getItem(STORAGE_KEYS.GUESTS_DATA);
            if (savedGuests) {
                guests = JSON.parse(savedGuests);
            }
        }

        function activateScanner() {
            if (isScanning) return;
            
            canScan = true;
            isScanning = true;
            
            const btn = document.getElementById('nextGuestBtn');
            btn.textContent = '‚è≥ Aguardando QR...';
            btn.disabled = true;
            
            document.getElementById('scanStatus').textContent = 'Posicione o QR Code na c√¢mera';
            document.getElementById('scanStatus').classList.remove('hidden');
            
            // Start camera
            startCamera();
            
            // Auto timeout after 20 seconds
            setTimeout(() => {
                if (isScanning && canScan) {
                    deactivateScanner();
                    showMessage('Tempo esgotado. Clique em "Pr√≥ximo Convidado" para tentar novamente.', 'warning');
                }
            }, 20000);
        }

        function deactivateScanner() {
            canScan = false;
            isScanning = false;
            
            const btn = document.getElementById('nextGuestBtn');
            btn.textContent = 'üéØ Pr√≥ximo Convidado';
            btn.disabled = false;
            
            document.getElementById('scanStatus').classList.add('hidden');
        }

        async function startCamera() {
            try {
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onScanSuccess,
                    onScanFailure
                );
            } catch (err) {
                console.error('Error starting camera:', err);
                showMessage('Erro ao acessar a c√¢mera', 'error');
                deactivateScanner();
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (!canScan) return;
            
            scanAttempts++;
            processQRCode(decodedText);
            deactivateScanner();
            
            // Stop camera
            html5QrCode.stop().catch(err => console.error('Error stopping camera:', err));
        }

        function onScanFailure(error) {
            // Silent failure - normal behavior when no QR code is detected
        }

        function processQRCode(qrCode) {
            const guest = guests.find(g => g.codigo === qrCode);
            
            if (!guest) {
                handleScanResult('INV√ÅLIDO', null, qrCode);
                return;
            }
            
            if (scannedGuests.has(qrCode)) {
                handleScanResult('USADO', guest, qrCode);
                return;
            }
            
            // Valid scan
            scannedGuests.add(qrCode);
            sessionScans++;
            handleScanResult('PERMITIDO', guest, qrCode);
            
            // Save data
            autoSave();
            
            // Check for milestones
            checkMilestones();
        }

        function handleScanResult(status, guest, qrCode) {
            const statusColors = {
                'PERMITIDO': 'text-green-500',
                'USADO': 'text-yellow-500',
                'INV√ÅLIDO': 'text-red-500'
            };
            
            const statusEmojis = {
                'PERMITIDO': '‚úÖ',
                'USADO': '‚ö†Ô∏è',
                'INV√ÅLIDO': '‚ùå'
            };
            
            // Show result message
            const message = guest ? 
                `${statusEmojis[status]} ${guest.nome} - ${status}` : 
                `${statusEmojis[status]} C√≥digo inv√°lido - ${status}`;
            
            showMessage(message, status === 'PERMITIDO' ? 'success' : status === 'USADO' ? 'warning' : 'error');
            
            // Add to recent scans
            addToRecentScans(guest, status, qrCode);
            
            // Update UI
            updateUI();
            
            // Provide feedback
            if (soundEnabled) playSound(status);
            if (vibrationEnabled) vibrate(status);
        }

        function addToRecentScans(guest, status, qrCode) {
            const recentScansContainer = document.getElementById('recentScans');
            
            // Remove "no scans" message
            if (recentScansContainer.children.length === 1 && 
                recentScansContainer.children[0].textContent.includes('Nenhum scan')) {
                recentScansContainer.innerHTML = '';
            }
            
            const scanItem = document.createElement('div');
            scanItem.className = `flex justify-between items-center p-3 bg-gray-700 rounded-lg slide-up`;
            
            const statusColors = {
                'PERMITIDO': 'text-green-400',
                'USADO': 'text-yellow-400',
                'INV√ÅLIDO': 'text-red-400'
            };
            
            scanItem.innerHTML = `
                <div>
                    <div class="font-medium">${guest ? guest.nome : 'C√≥digo Inv√°lido'}</div>
                    <div class="text-sm text-gray-400">${qrCode}</div>
                </div>
                <div class="${statusColors[status]} font-medium">${status}</div>
            `;
            
            recentScansContainer.insertBefore(scanItem, recentScansContainer.firstChild);
            
            // Keep only last 5 scans
            while (recentScansContainer.children.length > 5) {
                recentScansContainer.removeChild(recentScansContainer.lastChild);
            }
        }

        function updateUI() {
            // Update counters
            document.getElementById('scannedCount').textContent = scannedGuests.size;
            document.getElementById('totalGuests').textContent = guests.length;
            document.getElementById('sessionScansCount').textContent = sessionScans;
            
            // Update reports
            const scannedCount = scannedGuests.size;
            const pendingCount = guests.length - scannedCount;
            document.getElementById('reportScanned').textContent = scannedCount;
            document.getElementById('reportPending').textContent = pendingCount;
            document.getElementById('reportTotal').textContent = guests.length;
            
            // Update progress bar
            const progress = guests.length > 0 ? (scannedGuests.size / guests.length) * 100 : 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Update scan rate
            const successRate = scanAttempts > 0 ? ((sessionScans / scanAttempts) * 100).toFixed(1) : 0;
            document.getElementById('scanRate').textContent = `${successRate}%`;
            document.getElementById('errorCount').textContent = errorCount;
        }



        function viewGuestsList() {
            updateGuestsList();
        }

        function updateGuestsList() {
            const container = document.getElementById('guestsList');
            const filter = document.getElementById('guestFilter').value;
            const search = document.getElementById('guestSearch').value.toLowerCase();
            
            let filteredGuests = guests.filter(guest => {
                const matchesSearch = guest.nome.toLowerCase().includes(search) || 
                                    guest.codigo.toLowerCase().includes(search);
                
                if (filter === 'all') return matchesSearch;
                if (filter === 'scanned') return matchesSearch && scannedGuests.has(guest.codigo);
                if (filter === 'pending') return matchesSearch && !scannedGuests.has(guest.codigo);
                
                return matchesSearch;
            });
            
            container.innerHTML = '';
            
            if (filteredGuests.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-2 text-sm">Nenhum convidado encontrado</div>';
                return;
            }
            
            filteredGuests.forEach(guest => {
                const isScanned = scannedGuests.has(guest.codigo);
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 bg-gray-600 rounded text-sm`;
                
                item.innerHTML = `
                    <div>
                        <div class="font-medium">${guest.nome}</div>
                        <div class="text-xs text-gray-400">${guest.codigo}</div>
                    </div>
                    <div class="${isScanned ? 'text-green-400' : 'text-gray-400'} text-xs">
                        ${isScanned ? '‚úÖ' : '‚è≥'}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function filterGuests() {
            updateGuestsList();
        }

        function checkMilestones() {
            const milestones = [10, 25, 50, 100];
            const currentCount = scannedGuests.size;
            
            milestones.forEach(milestone => {
                if (currentCount === milestone && smartMessagesEnabled) {
                    showSmartMessage(`üéâ Parab√©ns! Voc√™ escaneou ${milestone} convidados!`);
                }
            });
        }

        function showSmartMessage(customMessage = null) {
            if (!smartMessagesEnabled) return;
            
            const messages = [
                'Mantenha o QR Code bem centralizado na c√¢mera para melhor leitura.',
                'Dica: Use boa ilumina√ß√£o para scans mais r√°pidos.',
                'Lembre-se de clicar em "Pr√≥ximo Convidado" antes de cada scan.',
                'Os dados s√£o salvos automaticamente a cada 30 segundos.',
                customMessage
            ].filter(Boolean);
            
            const message = customMessage || messages[Math.floor(Math.random() * (messages.length - 1))];
            
            document.getElementById('smartMessageText').textContent = message;
            document.getElementById('smartMessage').classList.remove('hidden');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                dismissSmartMessage();
            }, 10000);
        }

        function dismissSmartMessage() {
            document.getElementById('smartMessage').classList.add('hidden');
        }

        function toggleSetting(setting) {
            const toggles = {
                sound: 'soundToggle',
                vibration: 'vibrationToggle',
                smartMessages: 'smartMessagesToggle'
            };
            
            const button = document.getElementById(toggles[setting]);
            const slider = button.querySelector('div');
            
            if (setting === 'sound') {
                soundEnabled = !soundEnabled;
                updateToggleUI(button, slider, soundEnabled);
            } else if (setting === 'vibration') {
                vibrationEnabled = !vibrationEnabled;
                updateToggleUI(button, slider, vibrationEnabled);
            } else if (setting === 'smartMessages') {
                smartMessagesEnabled = !smartMessagesEnabled;
                updateToggleUI(button, slider, smartMessagesEnabled);
                if (!smartMessagesEnabled) {
                    dismissSmartMessage();
                }
            }
        }

        function updateToggleUI(button, slider, enabled) {
            if (enabled) {
                button.classList.add('bg-blue-600');
                button.classList.remove('bg-gray-600');
                slider.classList.add('translate-x-6');
                slider.classList.remove('translate-x-0');
            } else {
                button.classList.remove('bg-blue-600');
                button.classList.add('bg-gray-600');
                slider.classList.remove('translate-x-6');
                slider.classList.add('translate-x-0');
            }
        }

        function playSound(status) {
            // Mock sound feedback
            console.log(`Playing ${status} sound`);
        }

        function vibrate(status) {
            if ('vibrate' in navigator) {
                const patterns = {
                    'PERMITIDO': [100],
                    'USADO': [100, 100, 100],
                    'INV√ÅLIDO': [200, 100, 200]
                };
                navigator.vibrate(patterns[status] || [100]);
            }
        }

        function autoSave() {
            localStorage.setItem(STORAGE_KEYS.SCANNED_GUESTS, JSON.stringify([...scannedGuests]));
            localStorage.setItem(STORAGE_KEYS.SESSION_SCANS, sessionScans.toString());
            localStorage.setItem(STORAGE_KEYS.LAST_SYNC, new Date().toISOString());
            
            console.log('Data auto-saved');
        }

        function syncData() {
            showMessage('Sincronizando dados...', 'info');
            
            // Mock sync
            setTimeout(() => {
                autoSave();
                showMessage('Dados sincronizados com sucesso!', 'success');
            }, 2000);
        }

        function exportData() {
            const data = {
                event: currentClient?.nome || 'Evento',
                scanned: [...scannedGuests],
                guests: guests,
                sessionScans: sessionScans,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invitesqr-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Dados exportados com sucesso!', 'success');
        }

        function clearData() {
            if (confirm('Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.')) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                scannedGuests.clear();
                sessionScans = 0;
                errorCount = 0;
                
                updateUI();
                showMessage('Dados limpos com sucesso!', 'success');
            }
        }

        function generatePDF() {
            showMessage('Gerando PDF...', 'info');
            
            // Mock PDF generation
            setTimeout(() => {
                showMessage('PDF gerado com sucesso!', 'success');
            }, 2000);
        }

        function shareReport() {
            const reportText = `Relat√≥rio do Evento: ${currentClient?.nome || 'Evento'}
Convidados Presentes: ${scannedGuests.size}
Total de Convidados: ${guests.length}
Taxa de Presen√ßa: ${guests.length > 0 ? ((scannedGuests.size / guests.length) * 100).toFixed(1) : 0}%`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Relat√≥rio InvitesQR',
                    text: reportText
                });
            } else {
                navigator.clipboard.writeText(reportText).then(() => {
                    showMessage('Relat√≥rio copiado para a √°rea de transfer√™ncia!', 'success');
                });
            }
        }

        function switchCamera() {
            showMessage('Alternando c√¢mera...', 'info');
            // Mock camera switch
        }

        function toggleFlash() {
            showMessage('Flash alternado', 'info');
            // Mock flash toggle
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = isDarkTheme ? 'üåô' : '‚òÄÔ∏è';
            
            // Theme switching would be implemented here
            showMessage(`Tema ${isDarkTheme ? 'escuro' : 'claro'} ativado`, 'info');
        }

        function handleLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('eventToken');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                // Reset form
                document.getElementById('eventToken').value = '';
                document.getElementById('loginError').classList.add('hidden');
                document.getElementById('welcomeMessage').classList.add('hidden');
                
                // Stop scanner
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop();
                }
                
                showMessage('Logout realizado com sucesso!', 'success');
            }
        }

        function startSessionTimer() {
            setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('sessionTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function monitorConnectivity() {
            const updateConnectionStatus = () => {
                const status = document.getElementById('connectionStatus');
                if (navigator.onLine) {
                    status.className = 'w-3 h-3 rounded-full bg-green-500';
                    document.getElementById('offlineOverlay').classList.add('hidden');
                } else {
                    status.className = 'w-3 h-3 rounded-full bg-red-500';
                    document.getElementById('offlineOverlay').classList.remove('hidden');
                }
            };
            
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            updateConnectionStatus();
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            const message = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            message.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg fade-in`;
            message.textContent = text;
            
            container.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        function showError(element, text) {
            element.textContent = text;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function formatTimeSince(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} dia${days > 1 ? 's' : ''} atr√°s`;
            if (hours > 0) return `${hours} hora${hours > 1 ? 's' : ''} atr√°s`;
            if (minutes > 0) return `${minutes} minuto${minutes > 1 ? 's' : ''} atr√°s`;
            return 'agora mesmo';
        }

        function updateScannerUI() {
            // Update scanner interface based on state
            const btn = document.getElementById('nextGuestBtn');
            if (isScanning) {
                btn.textContent = '‚è≥ Aguardando QR...';
                btn.disabled = true;
            } else {
                btn.textContent = 'üéØ Pr√≥ximo Convidado';
                btn.disabled = false;
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967ce1fad7be77da',t:'MTc1Mzk2MjY3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
