<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvitesQR - Scanner Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .dark-mode {
            background: #1a1a1a;
            color: #ffffff;
        }
        .dark-mode .bg-white {
            background: #2d2d2d !important;
            color: #ffffff !important;
        }
        .dark-mode .text-gray-800 {
            color: #ffffff !important;
        }
        .dark-mode .text-gray-600 {
            color: #cccccc !important;
        }
        .dark-mode .border-gray-300 {
            border-color: #444444 !important;
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #667eea;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
        }
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            pointer-events: auto;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        .guest-item {
            transition: all 0.3s ease;
        }
        .guest-scanned {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .guest-pending {
            background: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üì±</div>
                <h1 class="text-2xl font-bold text-gray-800">InvitesQR Scanner</h1>
                <p class="text-gray-600">Insira o token do evento</p>
            </div>
            
            <form id="login-form">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token do Evento</label>
                    <input 
                        type="text" 
                        id="token-input" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="evt-123456"
                        required
                    >
                </div>
                
                <button 
                    type="submit" 
                    id="login-btn"
                    class="w-full gradient-bg text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50"
                >
                    Entrar
                </button>
            </form>
            
            <div id="login-error" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm">
                Token inv√°lido ou evento expirado
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-xl font-bold" id="event-name">Carregando...</h1>
                        <p class="text-blue-100 text-sm" id="event-info">Scanner Mobile</p>
                    </div>
                    <button id="logout-btn" class="bg-white bg-opacity-20 px-3 py-1 rounded text-sm hover:bg-opacity-30">
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-white shadow-sm border-b sticky top-16 z-30">
            <div class="flex">
                <button class="tab-btn tab-active flex-1 py-3 px-4 font-medium transition-all" data-tab="scanner">
                    üì± Scanner
                </button>
                <button class="tab-btn flex-1 py-3 px-4 font-medium text-gray-600 hover:text-blue-600 transition-all" data-tab="opcoes">
                    ‚öôÔ∏è Op√ß√µes
                </button>
            </div>
        </nav>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content p-4">
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-800">Progresso do Evento</h3>
                    <span id="progress-text" class="text-lg font-bold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-3">
                    <div id="progress-bar" class="gradient-bg h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 text-center">
                    <span id="scanned-count">0</span> de <span id="total-count">0</span> convidados escaneados
                </p>
            </div>



            <!-- Scanner Controls -->
            <div class="mb-6">
                <button 
                    id="start-scanner-btn" 
                    class="w-full gradient-bg text-white py-4 rounded-lg font-medium text-lg hover:opacity-90 transition-opacity"
                >
                    üéØ Iniciar Scanner
                </button>
            </div>

            <!-- Scanner Area -->
            <div id="scanner-area" class="hidden fixed inset-0 bg-black z-50 flex flex-col">
                <!-- Scanner Header -->
                <div class="bg-black bg-opacity-50 text-white p-4 flex justify-between items-center relative z-60">
                    <div>
                        <h3 class="font-bold text-lg">Scanner QR</h3>
                        <p class="text-sm opacity-75" id="scanner-counter">0 escaneados nesta sess√£o</p>
                    </div>
                    <button 
                        id="close-scanner-btn" 
                        class="bg-red-600 text-white w-10 h-10 rounded-full hover:bg-red-700 flex items-center justify-center text-xl z-60 relative"
                    >
                        √ó
                    </button>
                </div>

                <!-- Scan Result Messages (Above Scanner) -->
                <div id="scan-result-overlay" class="hidden bg-black bg-opacity-90 text-center p-6 relative z-60">
                    <div id="result-status" class="text-5xl font-bold mb-3"></div>
                    <div id="result-name" class="text-xl text-white mb-2"></div>
                    <div id="result-time" class="text-sm text-gray-300 mb-1"></div>
                    <div id="result-timestamp" class="text-xs text-gray-400"></div>
                </div>

                <!-- Scanner Container -->
                <div class="flex-1 flex items-center justify-center p-4">
                    <div class="scanner-container relative">
                        <div id="qr-reader" class="rounded-lg overflow-hidden"></div>
                        <div class="scanner-overlay"></div>
                    </div>
                </div>

                <!-- Next Button (Below Scanner) -->
                <div id="next-button-area" class="hidden bg-black bg-opacity-75 p-4 relative z-60">
                    <button 
                        id="next-scan-btn" 
                        class="w-full bg-blue-600 text-white py-4 rounded-lg font-medium text-lg hover:bg-blue-700"
                    >
                        PR√ìXIMO
                    </button>
                </div>

                <!-- Scanner Instructions -->
                <div class="bg-black bg-opacity-50 text-white p-4 text-center">
                    <p class="text-sm">Aponte a c√¢mara para o c√≥digo QR</p>
                </div>
            </div>

            <!-- Guest List -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b">
                    <h3 class="font-semibold text-lg">Lista de Convidados</h3>
                </div>
                <div id="guests-list" class="max-h-96 overflow-y-auto">
                    <!-- Guest items will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Op√ß√µes Tab -->
        <div id="opcoes" class="tab-content hidden p-4">
            <!-- Scanner Settings -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <h3 class="font-semibold text-lg mb-4">Configura√ß√µes do Scanner</h3>
                
                <div class="space-y-4">
                    <!-- Fast Mode Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium">‚ö° Modo R√°pido</p>
                            <p class="text-sm text-gray-600">Scan cont√≠nuo sem parar</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="fast-mode-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium">üåô Modo Noturno</p>
                            <p class="text-sm text-gray-600">Interface escura</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Sound Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium">üîä Som</p>
                            <p class="text-sm text-gray-600">Feedback sonoro</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sound-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Vibration Toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium">üì≥ Vibra√ß√£o</p>
                            <p class="text-sm text-gray-600">Feedback t√°til</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="vibration-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="text-2xl mb-2">‚úÖ</div>
                    <p class="text-2xl font-bold text-green-600" id="summary-scanned">0</p>
                    <p class="text-sm text-gray-600">Escaneados</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 text-center">
                    <div class="text-2xl mb-2">‚è≥</div>
                    <p class="text-2xl font-bold text-orange-600" id="summary-pending">0</p>
                    <p class="text-sm text-gray-600">Pendentes</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-4 mb-6">
                <button 
                    id="clear-scans-btn" 
                    class="w-full bg-orange-600 text-white py-3 rounded-lg font-medium hover:bg-orange-700"
                >
                    üîÑ Desmarcar Todos os Escaneados
                </button>
                <button 
                    id="download-pdf-btn" 
                    class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700"
                >
                    üìÑ Baixar Relat√≥rio PDF
                </button>
            </div>

            <!-- Detailed List -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="p-4 border-b">
                    <h3 class="font-semibold text-lg">Relat√≥rio Detalhado</h3>
                </div>
                <div id="detailed-list" class="max-h-96 overflow-y-auto">
                    <!-- Detailed items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast bg-white rounded-lg shadow-lg p-4 min-w-80 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="text-2xl mr-3"></div>
            <div class="flex-1">
                <p id="toast-title" class="font-medium"></p>
                <p id="toast-message" class="text-sm text-gray-600"></p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Global variables
        let currentClient = null;
        let allGuests = [];
        let scannedGuests = new Set(); // Local tracking only
        let scanAttempts = new Map(); // Track scan attempts per code
        let html5QrCode = null;
        let deviceId = null;
        let fastMode = false;
        let soundEnabled = true;
        let vibrationEnabled = true;
        let darkMode = false;
        let isOnline = navigator.onLine;
        let connectivityCheckInterval = null;

        // Generate unique device ID
        function generateDeviceId() {
            const stored = localStorage.getItem('scanner_device_id');
            if (stored) return stored;
            
            const newId = 'mobile-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('scanner_device_id', newId);
            return newId;
        }

        // Check internet connectivity
        async function checkConnectivity() {
            try {
                // Try to fetch a small resource from Supabase
                const response = await fetch(SUPABASE_URL + '/rest/v1/', {
                    method: 'HEAD',
                    headers: {
                        'apikey': SUPABASE_KEY
                    },
                    timeout: 5000
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Handle connectivity changes
        function handleConnectivityChange(online) {
            isOnline = online;
            
            if (!online) {
                // Stop scanner if running
                if (html5QrCode) {
                    stopScanner();
                }
                
                // Show offline message
                showToast('error', 'Sem Internet', 'Conex√£o perdida. O app precisa de internet para funcionar.');
                
                // Disable all interactive elements
                disableApp();
            } else {
                // Re-enable app
                enableApp();
                showToast('success', 'Online', 'Conex√£o restaurada!');
            }
        }

        // Disable app when offline
        function disableApp() {
            // Disable all buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
            
            // Show offline overlay
            showOfflineOverlay();
        }

        // Enable app when online
        function enableApp() {
            // Enable all buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            // Hide offline overlay
            hideOfflineOverlay();
        }

        // Show offline overlay
        function showOfflineOverlay() {
            let overlay = document.getElementById('offline-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'offline-overlay';
                overlay.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                overlay.innerHTML = `
                    <div class="bg-white rounded-lg p-8 mx-4 text-center max-w-sm">
                        <div class="text-6xl mb-4">üì°</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Sem Conex√£o</h3>
                        <p class="text-gray-600 mb-4">Este app precisa de internet para funcionar. Verifique sua conex√£o.</p>
                        <div class="animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-2">Verificando conex√£o...</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.classList.remove('hidden');
        }

        // Hide offline overlay
        function hideOfflineOverlay() {
            const overlay = document.getElementById('offline-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Start connectivity monitoring
        function startConnectivityMonitoring() {
            // Listen for online/offline events
            window.addEventListener('online', () => handleConnectivityChange(true));
            window.addEventListener('offline', () => handleConnectivityChange(false));
            
            // Periodic connectivity check (every 10 seconds)
            connectivityCheckInterval = setInterval(async () => {
                const online = await checkConnectivity();
                if (online !== isOnline) {
                    handleConnectivityChange(online);
                }
            }, 10000);
            
            // Initial check
            checkConnectivity().then(online => {
                if (!online) {
                    handleConnectivityChange(false);
                }
            });
        }

        // Stop connectivity monitoring
        function stopConnectivityMonitoring() {
            if (connectivityCheckInterval) {
                clearInterval(connectivityCheckInterval);
                connectivityCheckInterval = null;
            }
        }

        // Sound feedback
        function playSound(type) {
            if (!soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'success') {
                // Higher pitch for success
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            } else if (type === 'error') {
                // Lower pitch for error
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.1);
            } else if (type === 'used') {
                // Medium pitch for already used
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
            }
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // Vibration feedback
        function vibrate(pattern) {
            if (!vibrationEnabled || !navigator.vibrate) return;
            
            if (pattern === 'success') {
                navigator.vibrate([100, 50, 100]); // Short-pause-short
            } else if (pattern === 'error') {
                navigator.vibrate([300]); // Long vibration
            } else if (pattern === 'used') {
                navigator.vibrate([100, 100, 100, 100, 100]); // Multiple short
            }
        }

        // Load saved token and auto-login
        async function loadSavedToken() {
            const savedToken = localStorage.getItem('saved_token');
            if (savedToken) {
                document.getElementById('token-input').value = savedToken;
                
                // Auto-login with saved token
                try {
                    await handleLogin(savedToken);
                } catch (error) {
                    // If auto-login fails, clear the saved token and show login screen
                    localStorage.removeItem('saved_token');
                    document.getElementById('token-input').value = '';
                    console.log('Auto-login failed, token may be expired');
                }
            }
        }

        // Save token
        function saveToken(token) {
            localStorage.setItem('saved_token', token);
        }

        // Load settings
        function loadSettings() {
            fastMode = localStorage.getItem('fast_mode') === 'true';
            soundEnabled = localStorage.getItem('sound_enabled') !== 'false';
            vibrationEnabled = localStorage.getItem('vibration_enabled') !== 'false';
            darkMode = localStorage.getItem('dark_mode') === 'true';
            
            document.getElementById('fast-mode-toggle').checked = fastMode;
            document.getElementById('sound-toggle').checked = soundEnabled;
            document.getElementById('vibration-toggle').checked = vibrationEnabled;
            document.getElementById('dark-mode-toggle').checked = darkMode;
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
        }

        // Save settings
        function saveSettings() {
            localStorage.setItem('fast_mode', fastMode);
            localStorage.setItem('sound_enabled', soundEnabled);
            localStorage.setItem('vibration_enabled', vibrationEnabled);
            localStorage.setItem('dark_mode', darkMode);
        }

        // Toast notification
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toastIcon.textContent = icons[type];
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Login functionality
        async function handleLogin(token) {
            try {
                // Check connectivity first
                if (!isOnline) {
                    throw new Error('Sem conex√£o com a internet');
                }

                // Validate token format
                if (!token.startsWith('evt-')) {
                    throw new Error('Formato de token inv√°lido');
                }

                // Check if client exists and is valid
                const { data: client, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();

                if (error || !client) {
                    throw new Error('Token n√£o encontrado');
                }

                // Check if event is still valid
                const now = Date.now();
                if (client.validade < now) {
                    throw new Error('Evento expirado');
                }

                // Store client data
                currentClient = client;
                deviceId = generateDeviceId();
                
                // Save token for future use
                saveToken(token);

                // Load guests for this client
                await loadGuests();

                // Show main app
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');

                // Update header
                document.getElementById('event-name').textContent = client.nome;
                updateHeaderInfo();

                // Start connectivity monitoring
                startConnectivityMonitoring();

                showToast('success', 'Sucesso', 'Login realizado com sucesso!');

            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('login-error').classList.remove('hidden');
                showToast('error', 'Erro', error.message);
            }
        }

        // Load guests from Supabase
        async function loadGuests() {
            try {
                const { data: guests, error } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo');

                if (error) throw error;

                allGuests = guests || [];
                updateGuestsList();
                updateProgress();

            } catch (error) {
                console.error('Error loading guests:', error);
                showToast('error', 'Erro', 'Erro ao carregar convidados');
            }
        }

        // Update guests list display
        function updateGuestsList() {
            const guestsList = document.getElementById('guests-list');
            
            if (allGuests.length === 0) {
                guestsList.innerHTML = '<div class="p-4 text-center text-gray-500">Nenhum convidado encontrado</div>';
                return;
            }

            guestsList.innerHTML = allGuests.map(guest => {
                const isScanned = scannedGuests.has(guest.codigo);
                const itemClass = isScanned ? 'guest-scanned' : 'guest-pending';
                const icon = isScanned ? '‚úÖ' : '‚è≥';
                
                return `
                    <div class="guest-item ${itemClass} p-4 border-b last:border-b-0">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium">${guest.nome}</p>
                                <p class="text-sm opacity-75">${guest.codigo}</p>
                            </div>
                            <div class="text-xl">${icon}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update header info
        function updateHeaderInfo() {
            if (!currentClient) return;
            
            const validadeText = new Date(currentClient.validade).toLocaleDateString('pt-BR');
            const scanInfo = `${currentClient.scans_usados}/${currentClient.limite_scans} scans`;
            document.getElementById('event-info').textContent = `${validadeText} ‚Ä¢ ${scanInfo}`;
        }

        // Update progress display
        function updateProgress() {
            const total = allGuests.length;
            const scanned = scannedGuests.size;
            const percentage = total > 0 ? Math.round((scanned / total) * 100) : 0;
            
            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            
            // Update text
            document.getElementById('progress-text').textContent = percentage + '%';
            document.getElementById('scanned-count').textContent = scanned;
            document.getElementById('total-count').textContent = total;
            
            // Update summary in report tab
            document.getElementById('summary-scanned').textContent = scanned;
            document.getElementById('summary-pending').textContent = total - scanned;
            
            // Update header info
            updateHeaderInfo();
        }

        // Scanner functionality
        let scannerSessionCount = 0;
        let scannerPaused = false;

        function startScanner() {
            // Check connectivity before starting scanner
            if (!isOnline) {
                showToast('error', 'Sem Internet', 'Precisa de conex√£o para usar o scanner');
                return;
            }

            const scannerArea = document.getElementById('scanner-area');
            const startBtn = document.getElementById('start-scanner-btn');
            
            scannerArea.classList.remove('hidden');
            startBtn.classList.add('hidden');
            scannerSessionCount = 0;
            scannerPaused = false;
            
            // Prevent body scroll when scanner is open
            document.body.style.overflow = 'hidden';
            
            updateScannerCounter();

            html5QrCode = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 200, height: 200 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error('Scanner start error:', err);
                showToast('error', 'Erro', 'Erro ao iniciar c√¢mara');
                stopScanner();
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null;
                }).catch(err => {
                    console.error('Scanner stop error:', err);
                });
            }
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
            
            document.getElementById('scanner-area').classList.add('hidden');
            document.getElementById('start-scanner-btn').classList.remove('hidden');
            document.getElementById('scan-result-overlay').classList.add('hidden');
            scannerPaused = false;
        }

        function updateScannerCounter() {
            document.getElementById('scanner-counter').textContent = `${scannerSessionCount} escaneados nesta sess√£o`;
        }

        function showScanResult(type, guestName, timestamp = null) {
            const overlay = document.getElementById('scan-result-overlay');
            const nextButtonArea = document.getElementById('next-button-area');
            const statusEl = document.getElementById('result-status');
            const nameEl = document.getElementById('result-name');
            const timeEl = document.getElementById('result-time');
            const timestampEl = document.getElementById('result-timestamp');
            
            // Set current timestamp
            const now = new Date();
            const currentTime = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            if (!fastMode) {
                scannerPaused = true;
            }
            
            if (type === 'success') {
                statusEl.textContent = 'PERMITIDO';
                statusEl.className = 'text-5xl font-bold mb-3 text-green-400';
                nameEl.textContent = guestName;
                nameEl.className = 'text-xl text-white mb-2';
                timeEl.textContent = '';
                timeEl.className = 'text-sm text-gray-300 mb-1';
                timestampEl.textContent = `Validado: ${currentTime}`;
                timestampEl.className = 'text-xs text-gray-400';
                
                playSound('success');
                vibrate('success');
                
            } else if (type === 'used') {
                statusEl.textContent = 'USADO';
                statusEl.className = 'text-5xl font-bold mb-3 text-red-400';
                nameEl.textContent = guestName;
                nameEl.className = 'text-xl text-white mb-2';
                timeEl.textContent = timestamp ? `Primeira entrada: ${timestamp}` : '';
                timeEl.className = 'text-sm text-gray-300 mb-1';
                timestampEl.textContent = `Tentativa: ${currentTime}`;
                timestampEl.className = 'text-xs text-gray-400';
                
                playSound('used');
                vibrate('used');
                
            } else if (type === 'invalid') {
                statusEl.textContent = 'C√ìDIGO INV√ÅLIDO';
                statusEl.className = 'text-4xl font-bold mb-3 text-red-400';
                nameEl.textContent = guestName || 'C√≥digo n√£o reconhecido';
                nameEl.className = 'text-xl text-red-300 mb-2';
                timeEl.textContent = '';
                timeEl.className = 'text-sm text-gray-300 mb-1';
                timestampEl.textContent = `Tentativa: ${currentTime}`;
                timestampEl.className = 'text-xs text-gray-400';
                
                playSound('error');
                vibrate('error');
            }
            
            // Show message above scanner
            overlay.classList.remove('hidden');
            
            // Show next button below scanner (only if not in fast mode)
            if (!fastMode) {
                nextButtonArea.classList.remove('hidden');
            }
            
            // Auto-hide in fast mode
            if (fastMode) {
                setTimeout(() => {
                    hideResultAndContinue();
                }, 1500);
            }
        }

        function hideResultAndContinue() {
            document.getElementById('scan-result-overlay').classList.add('hidden');
            document.getElementById('next-button-area').classList.add('hidden');
            scannerPaused = false;
        }

        // Handle successful QR scan
        async function onScanSuccess(decodedText, decodedResult) {
            // Ignore scans when paused (waiting for user to click "PR√ìXIMO")
            if (scannerPaused) {
                return;
            }

            // Check connectivity before processing scan
            if (!isOnline) {
                showScanResult('invalid', 'Sem conex√£o com a internet');
                stopScanner();
                return;
            }

            try {
                // Track scan attempt
                const currentAttempts = scanAttempts.get(decodedText) || 0;
                scanAttempts.set(decodedText, currentAttempts + 1);

                // Validate QR code in Supabase
                const validationResult = await validateQRCode(decodedText);
                
                if (!validationResult.valid) {
                    showScanResult('invalid', validationResult.message);
                    await logScan(decodedText, 'scan_error');
                    updateDetailedList(); // Update to show attempt count
                    return;
                }

                const guest = validationResult.guest;

                // Check if already scanned locally (for UI feedback)
                if (scannedGuests.has(guest.codigo)) {
                    // Get timestamp from logs for when it was first scanned
                    const timestamp = await getFirstScanTimestamp(guest.codigo);
                    showScanResult('used', guest.nome, timestamp);
                    await logScan(guest.codigo, 'scan_duplicate');
                    updateDetailedList(); // Update to show attempt count
                    return;
                }

                // Add to local scanned set
                scannedGuests.add(guest.codigo);
                scannerSessionCount++;

                // Update client scan count in Supabase
                await updateClientScanCount();

                // Log successful scan to Supabase
                await logScan(guest.codigo, 'scan_success');

                // Update displays
                updateGuestsList();
                updateProgress();
                updateDetailedList();
                updateScannerCounter();

                // Show success result
                showScanResult('success', guest.nome);

            } catch (error) {
                console.error('Scan processing error:', error);
                
                // Track failed attempt
                const currentAttempts = scanAttempts.get(decodedText) || 0;
                scanAttempts.set(decodedText, currentAttempts + 1);
                
                // Check if error is due to connectivity
                if (!isOnline) {
                    showScanResult('invalid', 'Conex√£o perdida durante o scan');
                    stopScanner();
                } else {
                    showScanResult('invalid', 'Erro ao processar: ' + error.message);
                }
                
                // Try to log error to Supabase if online
                if (isOnline) {
                    await logScan(decodedText, 'scan_error');
                }
                
                updateDetailedList(); // Update to show attempt count
            }
        }

        function onScanFailure(error) {
            // Silent - scanning failures are normal
        }

        // Validate QR code against Supabase
        async function validateQRCode(codigo) {
            try {
                // Check if guest exists and is active
                const { data: guest, error: guestError } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('codigo', codigo)
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo')
                    .single();

                if (guestError || !guest) {
                    return {
                        valid: false,
                        message: 'Convidado n√£o encontrado ou inativo'
                    };
                }

                // Check if client has reached scan limit
                if (currentClient.scans_usados >= currentClient.limite_scans) {
                    return {
                        valid: false,
                        message: 'Limite de scans atingido para este evento'
                    };
                }

                // Check if event is still valid
                if (currentClient.validade < Date.now()) {
                    return {
                        valid: false,
                        message: 'Evento expirado'
                    };
                }

                // Check for duplicate scans in database (global check)
                const { data: existingScans, error: scanError } = await supabase
                    .from('logs')
                    .select('*')
                    .eq('token', codigo)
                    .eq('status', 'scan_success');

                if (scanError) {
                    console.error('Error checking existing scans:', scanError);
                }

                // Allow multiple scans but warn if already scanned globally
                if (existingScans && existingScans.length > 0) {
                    console.log(`‚ö†Ô∏è C√≥digo ${codigo} j√° foi escaneado ${existingScans.length} vez(es) anteriormente`);
                }

                return {
                    valid: true,
                    guest: guest,
                    previousScans: existingScans ? existingScans.length : 0
                };

            } catch (error) {
                console.error('QR validation error:', error);
                return {
                    valid: false,
                    message: 'Erro ao validar c√≥digo: ' + error.message
                };
            }
        }

        // Update client scan count
        async function updateClientScanCount() {
            try {
                const newScanCount = currentClient.scans_usados + 1;
                
                const { error } = await supabase
                    .from('clientes')
                    .update({ scans_usados: newScanCount })
                    .eq('id', currentClient.id);

                if (error) {
                    console.error('Error updating scan count:', error);
                    throw error;
                }

                // Update local client data
                currentClient.scans_usados = newScanCount;

            } catch (error) {
                console.error('Error updating client scan count:', error);
                throw error;
            }
        }

        // Log scan to Supabase
        async function logScan(codigo, status = 'scan') {
            try {
                const { error } = await supabase
                    .from('logs')
                    .insert([{
                        token: codigo,
                        status: status,
                        dispositivo: deviceId
                    }]);

                if (error) {
                    console.error('Log error:', error);
                    throw error;
                }
            } catch (error) {
                console.error('Log error:', error);
                throw error;
            }
        }

        // Get first scan timestamp for a guest
        async function getFirstScanTimestamp(codigo) {
            try {
                const { data: logs, error } = await supabase
                    .from('logs')
                    .select('created_at')
                    .eq('token', codigo)
                    .eq('status', 'scan_success')
                    .order('created_at', { ascending: true })
                    .limit(1);

                if (error || !logs || logs.length === 0) {
                    return null;
                }

                const timestamp = new Date(logs[0].created_at);
                return timestamp.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

            } catch (error) {
                console.error('Error getting timestamp:', error);
                return null;
            }
        }

        // Clear all scanned (local only)
        function clearAllScans() {
            if (confirm('Desmarcar todos os convidados escaneados? (Apenas no dispositivo)')) {
                scannedGuests.clear();
                scanAttempts.clear();
                updateGuestsList();
                updateProgress();
                updateDetailedList();
                showToast('info', 'Limpo', 'Todos os scans foram desmarcados localmente');
            }
        }

        // Update detailed list for report
        function updateDetailedList() {
            const detailedList = document.getElementById('detailed-list');
            
            const scannedGuestsList = allGuests.filter(guest => scannedGuests.has(guest.codigo));
            const pendingGuestsList = allGuests.filter(guest => !scannedGuests.has(guest.codigo));
            
            // Get all codes that have been attempted (including invalid ones)
            const attemptedCodes = Array.from(scanAttempts.keys());
            const invalidAttempts = attemptedCodes.filter(code => 
                !allGuests.some(guest => guest.codigo === code)
            );
            
            let html = '';
            
            if (scannedGuestsList.length > 0) {
                html += '<div class="p-4 bg-green-50 border-b"><h4 class="font-medium text-green-800">‚úÖ Escaneados (' + scannedGuestsList.length + ')</h4></div>';
                html += scannedGuestsList.map(guest => {
                    const attempts = scanAttempts.get(guest.codigo) || 1;
                    const attemptsText = attempts > 1 ? ` (${attempts}x tentativas)` : '';
                    return `
                        <div class="p-3 border-b last:border-b-0 bg-green-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-green-800">${guest.nome}</p>
                                    <p class="text-sm text-green-600">${guest.codigo}</p>
                                </div>
                                ${attempts > 1 ? `<span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">${attempts}x</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            if (pendingGuestsList.length > 0) {
                html += '<div class="p-4 bg-orange-50 border-b"><h4 class="font-medium text-orange-800">‚è≥ Pendentes (' + pendingGuestsList.length + ')</h4></div>';
                html += pendingGuestsList.map(guest => {
                    const attempts = scanAttempts.get(guest.codigo) || 0;
                    return `
                        <div class="p-3 border-b last:border-b-0">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium">${guest.nome}</p>
                                    <p class="text-sm text-gray-600">${guest.codigo}</p>
                                </div>
                                ${attempts > 0 ? `<span class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded">${attempts}x tentativas</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Show invalid attempts
            if (invalidAttempts.length > 0) {
                html += '<div class="p-4 bg-red-50 border-b"><h4 class="font-medium text-red-800">‚ùå C√≥digos Inv√°lidos (' + invalidAttempts.length + ')</h4></div>';
                html += invalidAttempts.map(code => {
                    const attempts = scanAttempts.get(code);
                    return `
                        <div class="p-3 border-b last:border-b-0 bg-red-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-red-800">C√≥digo Inv√°lido</p>
                                    <p class="text-sm text-red-600">${code}</p>
                                </div>
                                <span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">${attempts}x tentativas</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            if (html === '') {
                html = '<div class="p-4 text-center text-gray-500">Nenhum convidado encontrado</div>';
            }
            
            detailedList.innerHTML = html;
        }

        // Generate PDF report
        function generatePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Relat√≥rio de Valida√ß√£o', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Evento: ${currentClient.nome}`, 20, 45);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 55);
                doc.text(`Dispositivo: ${deviceId}`, 20, 65);
                
                // Summary
                doc.setFontSize(14);
                doc.text('Resumo:', 20, 85);
                doc.setFontSize(12);
                doc.text(`Total de Convidados: ${allGuests.length}`, 20, 95);
                doc.text(`Escaneados: ${scannedGuests.size}`, 20, 105);
                doc.text(`Pendentes: ${allGuests.length - scannedGuests.size}`, 20, 115);
                doc.text(`Taxa de Compar√™ncia: ${Math.round((scannedGuests.size / allGuests.length) * 100)}%`, 20, 125);
                
                // Calculate total attempts
                const totalAttempts = Array.from(scanAttempts.values()).reduce((sum, attempts) => sum + attempts, 0);
                const invalidCodes = Array.from(scanAttempts.keys()).filter(code => 
                    !allGuests.some(guest => guest.codigo === code)
                ).length;
                
                doc.text(`Total de Tentativas de Scan: ${totalAttempts}`, 20, 135);
                doc.text(`C√≥digos Inv√°lidos Tentados: ${invalidCodes}`, 20, 145);
                
                // Scanned guests list
                let yPos = 165;
                doc.setFontSize(14);
                doc.text('Convidados Escaneados:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                const scannedList = allGuests.filter(guest => scannedGuests.has(guest.codigo));
                
                scannedList.forEach((guest, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    const attempts = scanAttempts.get(guest.codigo) || 1;
                    const attemptsText = attempts > 1 ? ` [${attempts}x tentativas]` : '';
                    doc.text(`${index + 1}. ${guest.nome} (${guest.codigo})${attemptsText}`, 20, yPos);
                    yPos += 8;
                });
                
                // Add invalid attempts section if any
                const invalidAttempts = Array.from(scanAttempts.keys()).filter(code => 
                    !allGuests.some(guest => guest.codigo === code)
                );
                
                if (invalidAttempts.length > 0) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    yPos += 10;
                    doc.setFontSize(14);
                    doc.text('C√≥digos Inv√°lidos Tentados:', 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    invalidAttempts.forEach((code, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        const attempts = scanAttempts.get(code);
                        doc.text(`${index + 1}. ${code} [${attempts}x tentativas]`, 20, yPos);
                        yPos += 8;
                    });
                }
                
                // Save PDF
                const fileName = `relatorio_${currentClient.token}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showToast('success', 'PDF Gerado', 'Relat√≥rio baixado com sucesso');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('error', 'Erro', 'Erro ao gerar PDF');
            }
        }

        // Tab management
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Update tab buttons
                    tabBtns.forEach(b => {
                        b.classList.remove('tab-active');
                        b.classList.add('text-gray-600', 'hover:text-blue-600');
                    });
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-gray-600', 'hover:text-blue-600');

                    // Update tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab).classList.remove('hidden');

                    // Stop scanner when switching tabs
                    if (targetTab !== 'scanner' && html5QrCode) {
                        stopScanner();
                    }

                    // Update detailed list when switching to options
                    if (targetTab === 'opcoes') {
                        updateDetailedList();
                    }
                });
            });
        }

        // Logout functionality
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                // Stop scanner
                if (html5QrCode) {
                    stopScanner();
                }
                
                // Stop connectivity monitoring
                stopConnectivityMonitoring();
                
                // Clear data
                currentClient = null;
                allGuests = [];
                scannedGuests.clear();
                scanAttempts.clear();
                
                // Hide offline overlay if visible
                hideOfflineOverlay();
                
                // Show login screen
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('token-input').value = '';
                
                showToast('info', 'Logout', 'Sess√£o encerrada');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            initTabs();
            await loadSavedToken();
            loadSettings();
            
            // Initial connectivity check
            checkConnectivity().then(online => {
                isOnline = online;
                if (!online) {
                    showToast('error', 'Sem Internet', 'Este app precisa de conex√£o com a internet');
                }
            });
            
            // Settings toggles
            document.getElementById('fast-mode-toggle').addEventListener('change', (e) => {
                fastMode = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('sound-toggle').addEventListener('change', (e) => {
                soundEnabled = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('vibration-toggle').addEventListener('change', (e) => {
                vibrationEnabled = e.target.checked;
                saveSettings();
            });
            
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
                darkMode = e.target.checked;
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                saveSettings();
            });
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = document.getElementById('token-input').value.trim();
                if (token) {
                    document.getElementById('login-error').classList.add('hidden');
                    const loginBtn = document.getElementById('login-btn');
                    loginBtn.textContent = 'Entrando...';
                    loginBtn.disabled = true;
                    
                    try {
                        await handleLogin(token);
                    } finally {
                        loginBtn.textContent = 'Entrar';
                        loginBtn.disabled = false;
                    }
                }
            });

            // Scanner controls
            document.getElementById('start-scanner-btn').addEventListener('click', startScanner);
            document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
            document.getElementById('next-scan-btn').addEventListener('click', hideResultAndContinue);

            // Report controls
            document.getElementById('clear-scans-btn').addEventListener('click', clearAllScans);
            document.getElementById('download-pdf-btn').addEventListener('click', generatePDF);

            // Logout
            document.getElementById('logout-btn').addEventListener('click', logout);

            // Prevent accidental page refresh
            window.addEventListener('beforeunload', (e) => {
                if (currentClient && scannedGuests.size > 0) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96732430569177d9',t:'MTc1Mzg2MDUyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
