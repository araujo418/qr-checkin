<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>InvitesQR</title>
  <script src="https://unpkg.com/html5-qrcode@latest"></script>
  <style>
    :root{
      --primary:#5aa189;
      --primary-dark:#4b8c76;
      --bg:#121212;
      --surface:#1a1a1a;
      --text:#ffffff;
      --muted:#cccccc;
    }
    *,*:before,*:after{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:sans-serif;text-align:center;}
    #logo{width:96px;height:96px;border-radius:50%;object-fit:cover;margin:20px auto 10px;display:block;}
    input, button {padding:14px;border:none;border-radius:10px;margin:10px auto;width:90%;max-width:440px;font-size:1em;display:block;}
    input {background:var(--surface);color:var(--text);}
    button {background:var(--primary);color:var(--text);cursor:pointer;transition:background .2s;}
    button:hover {background:var(--primary-dark);}
    #app{display:none;}
    #guestList{max-height:40vh;overflow-y:auto;background:var(--surface);border-radius:12px;padding:10px;margin:20px auto 0;max-width:440px;box-shadow:inset 0 0 4px rgba(0,0,0,.3);}
    ul{list-style:none;padding:0;margin:0;text-align:left;}
    li{padding:10px;border-bottom:1px solid #333;font-size:1em;}
    #scannerContainer{display:none;position:fixed;inset:0;background:#000;z-index:10000;}
    #qr-reader{width:100%;height:80%;}
    #scanFeedback{height:20%;color:#fff;font-size:1.4em;display:flex;align-items:center;justify-content:center;}
  </style>
</head>
<body>
  <img id="logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAMzklEQVR42u1dW2wc1Rn+zmV2Yzt2SB" alt="Logo Invites">
  <h1 id="clienteNome">InvitesQR</h1>
  <input id="tokenInput" type="text" placeholder="Digite o token do cliente">
  <button id="entrarBtn">Entrar</button>

  <div id="app">
    <div id="validadeMsg"></div>
    <button onclick="startScanner()">üì∑ Scanear</button>
    <div id="scannerContainer">
      <div id="qr-reader"></div>
      <div id="scanFeedback"></div>
      <button onclick="fecharScanner()" style="position:absolute;top:10px;right:10px;background:red;color:white;padding:10px;border-radius:8px;">‚ùå Fechar</button>
    </div>
    <input id="searchInput" type="text" placeholder="üîç Pesquisar convidado" oninput="filtrarConvidados()">
    <ul id="guestList"></ul>
  </div>

<script>
  const SUPABASE_URL = "https://rnvunprjvppbjavkaoek.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8";

  let scanner = null;
  let token = localStorage.getItem('token');
  const deviceId = localStorage.getItem('device_id') || crypto.randomUUID();
  localStorage.setItem('device_id', deviceId);
  let client = null, convidados = [];

  document.getElementById('entrarBtn').addEventListener('click', () => iniciar(document.getElementById('tokenInput').value));

  async function iniciar(inputToken) {
    token = inputToken || token;
    if (!token) return alert("Digite o token.");
    const res = await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();
    client = data[0];
    if (!client) return alert("‚ùå Token inv√°lido.");
    if (client.dispositivos && client.dispositivos !== deviceId) return alert("‚ùå Token j√° usado noutro dispositivo.");
    if (!client.dispositivos) {
      await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
        method: "PATCH",
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
        body: JSON.stringify({ dispositivos: deviceId })
      });
    }
    localStorage.setItem('token', token);
    document.getElementById('tokenInput').style.display = 'none';
    document.getElementById('entrarBtn').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('clienteNome').innerText = `üéâ Ol√°, ${client.nome}`;
    document.getElementById('validadeMsg').innerText = `‚è≥ V√°lido at√©: ${new Date(client.validade * 1000).toLocaleDateString()}`;
    await carregarConvidados();
  }

  async function carregarConvidados() {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/convidados?token_cliente=eq.${token}`, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    convidados = await res.json();
    renderConvidados();
  }

  function renderConvidados() {
    const list = document.getElementById("guestList");
    const query = document.getElementById("searchInput").value.toLowerCase();
    list.innerHTML = "";
    convidados.filter(c => c.nome.toLowerCase().includes(query)).forEach(c => {
      const li = document.createElement("li");
      li.textContent = `${c.status === 'usado' ? '‚úÖ' : 'üü¢'} ${c.nome}`;
      list.appendChild(li);
    });
  }

  function filtrarConvidados() { renderConvidados(); }

  async function startScanner() {
    document.getElementById("scannerContainer").style.display = "block";
    await new Promise(r => setTimeout(r, 300));
    if (!scanner) scanner = new Html5Qrcode("qr-reader");
    scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async content => {
      const match = convidados.find(c => c.id.toString() === content.trim());
      if (!match) return;
      if (match.status === "usado") return;
      await fetch(`${SUPABASE_URL}/rest/v1/convidados?id=eq.${match.id}`, {
        method: "PATCH",
        headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
        body: JSON.stringify({ status: "usado" })
      });
      await carregarConvidados();
    }, () => {});
  }

  function fecharScanner() {
    document.getElementById("scannerContainer").style.display = "none";
    if (scanner) scanner.stop();
  }
</script>
</body>
</html>
