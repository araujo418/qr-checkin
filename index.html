<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-title" content="InvitesQR Scanner">
    <meta name="application-name" content="InvitesQR Scanner">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSW52aXRlc1FSIFNjYW5uZXIiLCJzaG9ydF9uYW1lIjoiSW52aXRlc1FSIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJmdWxsc2NyZWVuIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiMxZjI5MzciLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJak1URXhPREkzSWlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpUGp4eVpXTjBJSGRwWkhSb1BTSXhNamdpSUdobGFXZG9kRDBpTVRJNElpQm1hV3hzUFNJak1URXhPREkzSWk4K1BIUmxlSFFnZUQwaU5qUWlJSGs5SWpZMElpQm1hV3hzUFNJalptWm1abVptSWlCbWIyNTBMWE5wZW1VOUlqSTBJaUJtYjI1MExYZGxhV2RvZEQwaVltOXNaQ0krVVVJOEwzUmxlSFErUEM5emRtYysiLCJzaXplcyI6IjEyOHgxMjgiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <title>InvitesQR Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Hide browser UI elements */
        html {
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            width: 100vw;
            height: 100vh;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* Prevent zoom and scroll */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide scrollbars completely */
        ::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        /* Firefox */
        html {
            scrollbar-width: none;
        }

        /* Prevent context menu */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Prevent text selection on all elements */
        *, *:before, *:after {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Allow text selection only in input fields */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Fullscreen styles */
        .app-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* Theme variables */
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
        }

        [data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --border-color: #d1d5db;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .bg-gray-900 { background-color: var(--bg-primary) !important; }
        .bg-gray-800 { background-color: var(--bg-secondary) !important; }
        .bg-gray-700 { background-color: var(--bg-tertiary) !important; }
        .text-white { color: var(--text-primary) !important; }
        .text-gray-400 { color: var(--text-muted) !important; }
        .text-gray-300 { color: var(--text-secondary) !important; }
        .border-gray-700 { border-color: var(--border-color) !important; }
        .border-gray-600 { border-color: var(--border-color) !important; }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #10b981;
        }
        .scanner-corner.top-left {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .scanner-corner.top-right {
            top: 20px;
            right: 20px;
            border-left: none;
            border-bottom: none;
        }
        .scanner-corner.bottom-left {
            bottom: 20px;
            left: 20px;
            border-right: none;
            border-top: none;
        }
        .scanner-corner.bottom-right {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .offline-overlay {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.7);
        }
        .success-flash {
            animation: successFlash 0.5s ease-out;
        }
        @keyframes successFlash {
            0% { background-color: rgba(16, 185, 129, 0); }
            50% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: rgba(16, 185, 129, 0); }
        }
        .error-flash {
            animation: errorFlash 0.5s ease-out;
        }
        @keyframes errorFlash {
            0% { background-color: rgba(239, 68, 68, 0); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
            100% { background-color: rgba(239, 68, 68, 0); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .scanner-corner {
                width: 25px;
                height: 25px;
                border-width: 2px;
            }
            
            .scanner-corner.top-left,
            .scanner-corner.top-right {
                top: 15px;
            }
            
            .scanner-corner.bottom-left,
            .scanner-corner.bottom-right {
                bottom: 15px;
            }
            
            .scanner-corner.top-left,
            .scanner-corner.bottom-left {
                left: 15px;
            }
            
            .scanner-corner.top-right,
            .scanner-corner.bottom-right {
                right: 15px;
            }
        }
        
        /* Prevent text selection on buttons and improve mobile touch */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
            cursor: pointer;
        }
        
        /* Improve button touch targets for mobile */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Better mobile button states */
        button:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Swipe navigation */
        .swipe-container {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            height: 100%;
        }

        .swipe-content {
            display: flex;
            transition: transform 0.3s ease;
            width: 200%;
            height: 100%;
        }

        .swipe-tab {
            width: 50%;
            flex-shrink: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            space-x: 2px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        .swipe-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            margin: 0 2px;
            transition: background 0.3s ease;
        }

        .swipe-dot.active {
            background: #3b82f6;
        }

        /* Fullscreen scanner styles */
        .fullscreen-scanner-active {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        #fullscreen-scanner {
            touch-action: none;
            overscroll-behavior: none;
        }
        
        /* QR Scanner targeting frame animation */
        @keyframes scanLine {
            0% { transform: translateY(0); }
            100% { transform: translateY(256px); }
        }
        
        #scan-line {
            animation: scanLine 2s linear infinite;
        }
        
        @media (min-width: 768px) {
            #scan-line {
                animation: scanLine 2s linear infinite;
            }
            
            @keyframes scanLine {
                0% { transform: translateY(0); }
                100% { transform: translateY(320px); }
            }
        }
        
        /* Scanner status indicator animations */
        .scan-status-active #scan-status-dot {
            background-color: #10b981 !important;
            animation: pulse 1.5s infinite;
        }
        
        .scan-status-waiting #scan-status-dot {
            background-color: #f59e0b !important;
        }
        
        .scan-status-disabled #scan-status-dot {
            background-color: #6b7280 !important;
        }
        
        /* Enhanced button styles for fullscreen */
        #fullscreen-next-btn {
            backdrop-filter: blur(4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #close-scanner-btn {
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* QR targeting frame enhancements */
        .scanner-overlay .relative {
            border: 2px dashed rgba(16, 185, 129, 0.3);
            border-radius: 12px;
        }
        
        /* Smooth transitions for scanner elements */
        #scanner-instructions,
        #scan-result-display,
        #fullscreen-next-btn {
            transition: all 0.3s ease-in-out;
        }
        
        /* Hide elements smoothly */
        .fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        .fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Hide address bar on mobile */
        @media screen and (max-width: 768px) {
            body {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .app-container {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }

        /* Prevent pull-to-refresh */
        body {
            overscroll-behavior-y: contain;
        }

        /* Hide any browser chrome */
        @media all and (display-mode: standalone) {
            body {
                -webkit-app-region: drag;
            }
            
            button, input, select, textarea {
                -webkit-app-region: no-drag;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="app-container">
        <!-- Offline Overlay -->
        <div id="offline-overlay" class="fixed inset-0 offline-overlay z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 mx-4 text-center text-gray-900 max-w-sm">
                <i class="fas fa-wifi-slash text-4xl text-red-500 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Sem Conexão</h3>
                <p class="text-gray-600 mb-4">Verifique sua conexão com a internet para continuar.</p>
                <button onclick="checkConnectivity()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-sync-alt mr-2"></i>Tentar Novamente
                </button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="h-full flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
                <div class="text-center mb-8">
                    <i class="fas fa-qrcode text-5xl text-blue-500 mb-4"></i>
                    <h1 class="text-2xl font-bold mb-2">InvitesQR Scanner</h1>
                    <p class="text-gray-400">Validação de Convidados</p>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Token do Evento</label>
                        <input type="text" id="event-token" required 
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="evt-123456">
                    </div>

                    <button type="submit" id="login-btn" 
                            class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <div id="connection-status" class="flex items-center justify-center text-sm">
                        <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                        <span class="text-gray-400">Verificando conexão...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden h-full flex flex-col">
            <!-- Header -->
            <header class="bg-gray-800 shadow-lg flex-shrink-0">
                <div class="px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 id="event-name" class="text-lg font-bold">Carregando...</h1>
                            <p id="event-info" class="text-sm text-gray-400">Preparando scanner...</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div id="connection-indicator" class="flex items-center">
                                <div class="w-2 h-2 bg-gray-500 rounded-full mr-2"></div>
                            </div>
                            <button class="text-gray-400 hover:text-white" title="Alternar tema">
                                <i id="theme-icon" class="fas fa-moon text-xl"></i>
                            </button>
                            <button class="text-gray-400 hover:text-white">
                                <i class="fas fa-sign-out-alt text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bg-gray-800 border-b border-gray-700 flex-shrink-0">
                <div class="flex">
                    <button id="tab-scanner" class="flex-1 py-4 px-2 text-center bg-blue-600 text-white min-h-[60px] active:bg-blue-700">
                        <i class="fas fa-qrcode block mb-1 text-lg"></i>
                        <span class="text-xs">Scanner</span>
                    </button>
                    <button id="tab-options" class="flex-1 py-4 px-2 text-center text-gray-400 hover:text-white min-h-[60px] active:bg-gray-700">
                        <i class="fas fa-ellipsis-h block mb-1 text-lg"></i>
                        <span class="text-xs">Opções</span>
                    </button>
                </div>
            </nav>

            <!-- Swipe Indicator -->
            <div id="swipe-indicator" class="swipe-indicator">
                <div class="swipe-dot active"></div>
                <div class="swipe-dot"></div>
            </div>

            <!-- Main Content with Swipe -->
            <div id="main-content" class="swipe-container flex-1">
                <div id="swipe-content" class="swipe-content">
                    <!-- Scanner Tab -->
                    <div id="content-scanner" class="swipe-tab">
                <!-- Progress Bar -->
                <div class="bg-gray-800 p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium">Progresso do Evento</span>
                        <span id="scanner-progress-percentage" class="text-sm text-gray-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div id="scanner-progress-bar" class="bg-green-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                        <span id="scanner-validated-count">0 validados</span>
                        <span id="scanner-total-count">de 0 convidados</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="p-4 space-y-4">
                    <button id="scanner-toggle" 
                            class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px]">
                        <i class="fas fa-play mr-2"></i>Iniciar Scanner
                    </button>

                    <button id="next-scan-btn" 
                            class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-lg min-h-[56px] hidden">
                        <i class="fas fa-arrow-right mr-2"></i>Próximo Convidado
                    </button>

                    <div id="scan-status-info" class="bg-gray-800 rounded-lg p-4 text-center hidden">
                        <p class="text-gray-400 text-sm mb-2">Scanner ativo - aguardando próximo comando</p>
                        <p class="text-xs text-gray-500">Clique em "Próximo Convidado" para escanear</p>
                    </div>

                    <!-- Debug Info -->
                    <div id="debug-info" class="bg-gray-800 rounded-lg p-4 text-xs text-gray-400 hidden">
                        <h4 class="font-medium text-white mb-2">Debug Info:</h4>
                        <div id="debug-content">Clique em "Iniciar Scanner" para ver informações de debug</div>
                        <button onclick="toggleDebug()" class="mt-2 text-blue-400 hover:text-blue-300">
                            <i class="fas fa-bug mr-1"></i>Toggle Debug
                        </button>
                    </div>
                </div>
                    </div>

                    <!-- Options Tab -->
                    <div id="content-options" class="swipe-tab">
                        <div class="p-4">
                            <!-- Stats Overview -->
                            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                                <h3 class="text-lg font-medium mb-4">Estatísticas</h3>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <div id="options-scanned-count" class="text-2xl font-bold text-green-500">0</div>
                                        <div class="text-xs text-gray-400">Validados</div>
                                    </div>
                                    <div>
                                        <div id="options-total-guests" class="text-2xl font-bold text-blue-500">0</div>
                                        <div class="text-xs text-gray-400">Total</div>
                                    </div>
                                    <div>
                                        <div id="options-session-scans" class="text-2xl font-bold text-purple-500">0</div>
                                        <div class="text-xs text-gray-400">Sessão</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Options Menu -->
                            <div class="space-y-3">
                                <button class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-users text-blue-500 mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Convidados</h3>
                                            <p class="text-sm text-gray-400">Ver lista de convidados</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>

                                <button class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-chart-bar text-green-500 mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Relatórios</h3>
                                            <p class="text-sm text-gray-400">Estatísticas e exportação</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>

                                <button class="w-full bg-gray-800 hover:bg-gray-700 active:bg-gray-600 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-cog text-purple-500 mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Configurações</h3>
                                            <p class="text-sm text-gray-400">Ajustes do aplicativo</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </button>

                                <button class="w-full bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white font-medium py-4 px-6 rounded-lg transition-colors text-left flex items-center justify-between min-h-[56px]">
                                    <div class="flex items-center">
                                        <i class="fas fa-undo text-white mr-4 text-xl"></i>
                                        <div>
                                            <h3 class="font-medium">Desmarcar Scaneados</h3>
                                            <p class="text-sm text-orange-200">Limpar todas as validações</p>
                                        </div>
                                    </div>
                                    <span id="clear-scans-count" class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fullscreen Scanner -->
            <div id="fullscreen-scanner" class="fixed inset-0 bg-black z-50 hidden">
                <!-- Close Button -->
                <button id="close-scanner-btn" class="absolute top-6 right-6 z-60 bg-red-600 hover:bg-red-700 active:bg-red-800 text-white p-4 rounded-full shadow-lg transition-colors min-w-[56px] min-h-[56px] flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>

                <!-- Scanner Container -->
                <div class="relative w-full h-full">
                    <div id="qr-reader-fullscreen" class="w-full h-full"></div>
                    
                    <!-- Enhanced Scanner Overlay with QR-optimized corners -->
                    <div class="scanner-overlay">
                        <!-- QR Code targeting frame -->
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="relative w-64 h-64 md:w-80 md:h-80">
                                <!-- Corner brackets for QR code alignment -->
                                <div class="absolute top-0 left-0 w-8 h-8 border-l-4 border-t-4 border-green-400"></div>
                                <div class="absolute top-0 right-0 w-8 h-8 border-r-4 border-t-4 border-green-400"></div>
                                <div class="absolute bottom-0 left-0 w-8 h-8 border-l-4 border-b-4 border-green-400"></div>
                                <div class="absolute bottom-0 right-0 w-8 h-8 border-r-4 border-b-4 border-green-400"></div>
                                
                                <!-- Center crosshair for precise alignment -->
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-6 h-6">
                                    <div class="absolute top-1/2 left-0 right-0 h-0.5 bg-green-400 transform -translate-y-1/2"></div>
                                    <div class="absolute left-1/2 top-0 bottom-0 w-0.5 bg-green-400 transform -translate-x-1/2"></div>
                                </div>
                                
                                <!-- Scanning line animation -->
                                <div id="scan-line" class="absolute top-0 left-0 right-0 h-0.5 bg-green-400 opacity-80 animate-pulse"></div>
                            </div>
                        </div>
                        
                        <!-- Semi-transparent overlay to darken areas outside scan zone -->
                        <div class="absolute inset-0 bg-black bg-opacity-40 pointer-events-none">
                            <!-- Transparent center area for QR scanning -->
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 md:w-80 md:h-80 bg-transparent border border-green-400 border-opacity-30 rounded-lg"></div>
                        </div>
                    </div>
                    
                    <!-- Scan Result Display -->
                    <div id="scan-result-display" class="absolute top-1/4 left-4 right-4 text-center hidden z-40">
                        <div class="bg-black bg-opacity-90 rounded-xl p-6 shadow-2xl border border-gray-600">
                            <div id="scan-status-text" class="text-4xl font-bold mb-3"></div>
                            <div id="scan-guest-name-display" class="text-2xl text-white mb-2"></div>
                            <div id="scan-time-display" class="text-sm text-gray-300"></div>
                        </div>
                    </div>
                    
                    <!-- Scanner Instructions -->
                    <div id="scanner-instructions" class="absolute top-1/4 left-4 right-4 text-center z-30">
                        <div class="bg-black bg-opacity-70 rounded-xl p-6 shadow-lg">
                            <i class="fas fa-qrcode text-4xl text-green-400 mb-4"></i>
                            <p class="text-white text-xl font-medium mb-2">Posicione o QR code no centro</p>
                            <p class="text-gray-300 text-sm">Alinhe com as bordas verdes para melhor leitura</p>
                        </div>
                    </div>
                    
                    <!-- Next Scan Button - Bottom Center -->
                    <div class="absolute bottom-8 left-4 right-4 flex justify-center z-40">
                        <button id="fullscreen-next-btn" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-4 px-8 rounded-full shadow-lg transition-colors min-h-[64px] flex items-center justify-center text-lg hidden">
                            <i class="fas fa-arrow-right mr-3 text-xl"></i>
                            <span>Próximo Convidado</span>
                        </button>
                    </div>
                    
                    <!-- Scan Status Indicator -->
                    <div id="scan-status-indicator" class="absolute top-20 left-1/2 transform -translate-x-1/2 z-30">
                        <div class="bg-black bg-opacity-70 rounded-full px-6 py-3 flex items-center">
                            <div id="scan-status-dot" class="w-3 h-3 bg-gray-500 rounded-full mr-3"></div>
                            <span id="scan-status-label" class="text-white text-sm font-medium">Aguardando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guests Sub-Tab -->
            <div id="content-guests" class="tab-content hidden h-full flex flex-col">
                <!-- Back Button -->
                <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700 flex-shrink-0">
                    <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Voltar</span>
                    </button>
                    <h2 class="ml-4 text-lg font-medium">Convidados</h2>
                </div>
                <div class="p-4 flex-1 overflow-y-auto">
                    <!-- Search -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="guest-search" placeholder="Buscar convidado..." 
                                   class="w-full bg-gray-800 border border-gray-600 rounded-lg pl-10 pr-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="filterGuests()">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="flex space-x-2 mb-4">
                        <button onclick="filterGuestsByStatus('all')" id="filter-all" 
                                class="flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white text-sm min-h-[44px] active:bg-blue-700">
                            Todos
                        </button>
                        <button onclick="filterGuestsByStatus('scanned')" id="filter-scanned" 
                                class="flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600">
                            Validados
                        </button>
                        <button onclick="filterGuestsByStatus('pending')" id="filter-pending" 
                                class="flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600">
                            Pendentes
                        </button>
                    </div>

                    <!-- Guest List -->
                    <div id="guests-list" class="space-y-3">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-users text-3xl mb-2"></i>
                            <p>Carregando convidados...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="content-reports" class="tab-content hidden h-full flex flex-col">
                <!-- Back Button -->
                <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700 flex-shrink-0">
                    <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Voltar</span>
                    </button>
                    <h2 class="ml-4 text-lg font-medium">Relatórios</h2>
                </div>
                <div class="p-4 flex-1 overflow-y-auto">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div id="report-validated" class="text-2xl font-bold text-green-500">0</div>
                            <div class="text-sm text-gray-400">Validados</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 text-center">
                            <div id="report-pending" class="text-2xl font-bold text-orange-500">0</div>
                            <div class="text-sm text-gray-400">Pendentes</div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="bg-gray-800 rounded-lg p-4 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium">Progresso do Evento</span>
                            <span id="progress-percentage" class="text-sm text-gray-400">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="space-y-3">
                        <button onclick="generatePDFReport()" 
                                class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                            <i class="fas fa-file-pdf mr-2"></i>Exportar Relatório PDF
                        </button>
                        
                        <button onclick="shareReport()" 
                                class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                            <i class="fas fa-share mr-2"></i>Partilhar Relatório
                        </button>
                    </div>

                    <!-- Recent Scans -->
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-4">Últimas Validações</h3>
                        <div id="recent-scans" class="space-y-3">
                            <div class="text-center py-4 text-gray-400">
                                <p>Nenhuma validação ainda</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="content-settings" class="tab-content hidden h-full flex flex-col">
                <!-- Back Button -->
                <div class="bg-gray-800 p-4 flex items-center border-b border-gray-700 flex-shrink-0">
                    <button onclick="showTab('options')" class="flex items-center text-blue-500 hover:text-blue-400">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Voltar</span>
                    </button>
                    <h2 class="ml-4 text-lg font-medium">Configurações</h2>
                </div>
                <div class="p-4 space-y-6 flex-1 overflow-y-auto">
                    <!-- Sound Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Áudio</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Som de Sucesso</h4>
                                    <p class="text-sm text-gray-400">Reproduzir som ao validar</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="success-sound" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-medium">Som de Erro</h4>
                                    <p class="text-sm text-gray-400">Reproduzir som em caso de erro</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="error-sound" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Vibration Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Vibração</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Feedback Tátil</h4>
                                <p class="text-sm text-gray-400">Vibrar ao escanear</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="vibration" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Scanner Settings -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Scanner</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Câmera</label>
                                <select id="camera-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                                    <option value="">Selecionar câmera...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- App Info -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-lg font-medium mb-4">Informações</h3>
                        <div class="space-y-2 text-sm text-gray-400">
                            <div class="flex justify-between">
                                <span>Versão:</span>
                                <span>1.0.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Dispositivo:</span>
                                <span id="device-info">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Evento:</span>
                                <span id="current-token">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Saved Token -->
                    <button onclick="clearSavedTokenAndNotify()" 
                            class="w-full bg-orange-600 hover:bg-orange-700 active:bg-orange-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px] mb-3">
                        <i class="fas fa-trash mr-2"></i>Limpar Token Guardado
                    </button>

                    <!-- Logout -->
                    <button onclick="logout()" 
                            class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-4 px-6 rounded-lg transition-colors min-h-[56px]">
                        <i class="fas fa-sign-out-alt mr-2"></i>Terminar Sessão
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 right-4 z-40 space-y-2"></div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables
        let currentClient = null;
        let guests = [];
        let scannedGuests = new Set();
        let sessionScans = 0;
        let html5QrCode = null;
        let isScanning = false;
        let fastMode = false;
        let isOnline = true;
        let lastScanTime = 0;
        let scanAttempts = new Map(); // Track scan attempts per code
        let deviceName = '';
        let currentTheme = 'dark';
        let currentTab = 0; // 0 = scanner, 1 = options
        let canScan = false; // Control when scanning is allowed
        let swipeStartX = 0;
        let swipeStartY = 0;

        // Audio contexts for feedback
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Initialize app with mobile-friendly delays
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            
            // Force fullscreen mode
            enterFullscreenMode();
            
            // Prevent browser UI
            preventBrowserUI();
            
            // Initialize all components with delays for mobile
            setTimeout(() => {
                checkConnectivity();
                setupLoginForm();
                initializeTheme();
                setupSwipeNavigation();
            }, 100);
            
            // Setup event listeners after DOM is fully ready
            setTimeout(() => {
                setupEventListeners();
                loadCameras();
            }, 300);
            
            // Check saved token last
            setTimeout(() => {
                checkSavedToken();
            }, 500);
            
            setInterval(checkConnectivity, 30000); // Check every 30 seconds
            
            console.log('App initialized successfully');
        });

        // Setup all event listeners with mobile-friendly approach
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Use both click and touchend for better mobile support
            function addMobileClickListener(element, handler) {
                if (!element) {
                    console.log('Element not found for mobile click listener');
                    return;
                }
                
                console.log('Adding mobile click listener to:', element.id || element.className);
                
                // Remove any existing onclick attributes
                element.removeAttribute('onclick');
                
                // Add touchstart for immediate feedback
                element.addEventListener('touchstart', function(e) {
                    console.log('Touch start on:', element.id || element.className);
                    element.style.opacity = '0.7';
                }, { passive: true });
                
                // Add touchend for actual action
                element.addEventListener('touchend', function(e) {
                    console.log('Touch end on:', element.id || element.className);
                    e.preventDefault();
                    e.stopPropagation();
                    element.style.opacity = '1';
                    
                    // Small delay to ensure touch is processed
                    setTimeout(() => {
                        console.log('Executing handler for:', element.id || element.className);
                        handler();
                    }, 50);
                }, { passive: false });
                
                // Fallback click event for desktop
                element.addEventListener('click', function(e) {
                    console.log('Click on:', element.id || element.className);
                    // Only execute if not a touch device or if touchend didn't fire
                    if (!('ontouchstart' in window)) {
                        handler();
                    }
                }, { passive: true });
                
                // Reset opacity on touch cancel
                element.addEventListener('touchcancel', function(e) {
                    element.style.opacity = '1';
                }, { passive: true });
            }
            
            // Scanner toggle button
            addMobileClickListener(document.getElementById('scanner-toggle'), toggleScanner);
            
            // Next scan button
            addMobileClickListener(document.getElementById('next-scan-btn'), enableNextScan);
            
            // Tab buttons
            addMobileClickListener(document.getElementById('tab-scanner'), () => showTab('scanner'));
            addMobileClickListener(document.getElementById('tab-options'), () => showTab('options'));
            
            // Theme and logout buttons in header
            const headerButtons = document.querySelectorAll('header .flex.items-center.space-x-3 button');
            if (headerButtons.length >= 2) {
                addMobileClickListener(headerButtons[0], toggleTheme);
                addMobileClickListener(headerButtons[1], logout);
            }
            
            // Options menu buttons
            const optionsButtons = document.querySelectorAll('#content-options .space-y-3 button');
            if (optionsButtons.length >= 4) {
                addMobileClickListener(optionsButtons[0], () => showSubTab('guests'));
                addMobileClickListener(optionsButtons[1], () => showSubTab('reports'));
                addMobileClickListener(optionsButtons[2], () => showSubTab('settings'));
                addMobileClickListener(optionsButtons[3], clearAllScans);
            }
            
            // Back buttons - find all buttons with back functionality
            document.querySelectorAll('button').forEach(btn => {
                const text = btn.textContent.toLowerCase();
                if (text.includes('voltar') || text.includes('back')) {
                    addMobileClickListener(btn, () => showTab('options'));
                }
            });
            
            // Filter buttons
            addMobileClickListener(document.getElementById('filter-all'), () => filterGuestsByStatus('all'));
            addMobileClickListener(document.getElementById('filter-scanned'), () => filterGuestsByStatus('scanned'));
            addMobileClickListener(document.getElementById('filter-pending'), () => filterGuestsByStatus('pending'));
            
            // Search input
            const guestSearch = document.getElementById('guest-search');
            if (guestSearch) {
                guestSearch.addEventListener('input', filterGuests);
                guestSearch.addEventListener('keyup', filterGuests);
            }
            
            // Report buttons
            document.querySelectorAll('button').forEach(btn => {
                const text = btn.textContent.toLowerCase();
                if (text.includes('exportar relatório pdf')) {
                    addMobileClickListener(btn, generatePDFReport);
                } else if (text.includes('partilhar relatório')) {
                    addMobileClickListener(btn, shareReport);
                } else if (text.includes('limpar token guardado')) {
                    addMobileClickListener(btn, clearSavedTokenAndNotify);
                } else if (text.includes('terminar sessão')) {
                    addMobileClickListener(btn, logout);
                }
            });
            
            // Fullscreen scanner buttons
            addMobileClickListener(document.getElementById('close-scanner-btn'), closeFullscreenScanner);
            addMobileClickListener(document.getElementById('fullscreen-next-btn'), enableNextScan);
            
            // Debug toggle
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.includes('Toggle Debug')) {
                    addMobileClickListener(btn, toggleDebug);
                }
            });
            
            // Connectivity check button
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.includes('Tentar Novamente')) {
                    addMobileClickListener(btn, checkConnectivity);
                }
            });
            
            console.log('Event listeners setup complete with mobile support');
        }

        // Fullscreen and browser UI prevention
        function enterFullscreenMode() {
            // Try to enter fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen().catch(() => {});
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen().catch(() => {});
            }
        }

        function preventBrowserUI() {
            // Prevent context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            // Prevent text selection
            document.addEventListener('selectstart', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    return false;
                }
            });

            // Prevent drag
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });

            // Prevent zoom with keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Prevent Ctrl+/Cmd+ zoom shortcuts
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '0')) {
                    e.preventDefault();
                    return false;
                }
                
                // Prevent F11 fullscreen toggle
                if (e.key === 'F11') {
                    e.preventDefault();
                    return false;
                }
                
                // Prevent F12 developer tools
                if (e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
                
                // Prevent Ctrl+Shift+I developer tools
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'I') {
                    e.preventDefault();
                    return false;
                }
            });

            // Prevent pinch zoom on touch devices
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Hide address bar on mobile
            window.addEventListener('load', function() {
                setTimeout(function() {
                    window.scrollTo(0, 1);
                }, 100);
            });

            // Prevent pull-to-refresh
            document.body.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1 && window.scrollY === 0) {
                    e.preventDefault();
                }
            }, { passive: false });

            document.body.addEventListener('touchmove', function(e) {
                if (e.touches.length === 1 && window.scrollY === 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Re-enter fullscreen if user exits
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                setTimeout(enterFullscreenMode, 1000);
            }
        });

        document.addEventListener('webkitfullscreenchange', function() {
            if (!document.webkitFullscreenElement) {
                setTimeout(enterFullscreenMode, 1000);
            }
        });

        // Token storage management
        function saveToken(token) {
            try {
                localStorage.setItem('invitesqr_token', token);
                localStorage.setItem('invitesqr_token_date', Date.now().toString());
            } catch (error) {
                console.error('Error saving token:', error);
            }
        }

        function getSavedToken() {
            try {
                const token = localStorage.getItem('invitesqr_token');
                const savedDate = localStorage.getItem('invitesqr_token_date');
                
                if (!token || !savedDate) return null;
                
                // Check if token was saved more than 30 days ago
                const daysSaved = (Date.now() - parseInt(savedDate)) / (1000 * 60 * 60 * 24);
                if (daysSaved > 30) {
                    clearSavedToken();
                    return null;
                }
                
                return token;
            } catch (error) {
                console.error('Error getting saved token:', error);
                return null;
            }
        }

        function clearSavedToken() {
            try {
                localStorage.removeItem('invitesqr_token');
                localStorage.removeItem('invitesqr_token_date');
            } catch (error) {
                console.error('Error clearing saved token:', error);
            }
        }

        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('invitesqr_theme') || 'dark';
            currentTheme = savedTheme;
            applyTheme(currentTheme);
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('invitesqr_theme', currentTheme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                themeIcon.className = theme === 'dark' ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
            }
        }

        async function checkSavedToken() {
            const savedToken = getSavedToken();
            if (savedToken && isOnline) {
                document.getElementById('event-token').value = savedToken;
                
                // Show loading state
                const loginBtn = document.getElementById('login-btn');
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Entrando...';
                loginBtn.disabled = true;
                
                // Auto-login after a short delay
                setTimeout(async () => {
                    try {
                        await performLogin(savedToken);
                    } catch (error) {
                        // If auto-login fails, clear the saved token and show login form
                        clearSavedToken();
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
                        loginBtn.disabled = false;
                        showToast('Token expirado. Faça login novamente.', 'info');
                    }
                }, 1000);
            }
        }

        // Connectivity management
        async function checkConnectivity() {
            try {
                // Check internet connection
                const response = await fetch('https://www.google.com/favicon.ico', { 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                
                // Check Supabase connection
                const { data, error } = await supabase.from('clientes').select('count').limit(1);
                
                if (error) throw error;
                
                isOnline = true;
                updateConnectionStatus(true);
                hideOfflineOverlay();
            } catch (error) {
                isOnline = false;
                updateConnectionStatus(false);
                showOfflineOverlay();
                
                if (isScanning) {
                    stopScanner();
                }
            }
        }

        function updateConnectionStatus(online) {
            const indicators = ['connection-status', 'connection-indicator'];
            indicators.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = online ? 
                        '<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div><span class="text-green-400 text-sm">Online</span>' :
                        '<div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div><span class="text-red-400 text-sm">Offline</span>';
                }
            });
        }

        function showOfflineOverlay() {
            document.getElementById('offline-overlay').classList.remove('hidden');
        }

        function hideOfflineOverlay() {
            document.getElementById('offline-overlay').classList.add('hidden');
        }

        // Login functionality
        function setupLoginForm() {
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!isOnline) {
                    showToast('Sem conexão com a internet', 'error');
                    return;
                }

                const token = document.getElementById('event-token').value.trim();
                
                const loginBtn = document.getElementById('login-btn');
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';
                loginBtn.disabled = true;

                try {
                    await performLogin(token);
                } catch (error) {
                    showToast(error.message || 'Erro ao fazer login', 'error');
                } finally {
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
                    loginBtn.disabled = false;
                }
            });
        }

        async function performLogin(token) {
            deviceName = `Scanner-${Date.now()}`;
            
            // Fetch client data
            const { data, error } = await supabase
                .from('clientes')
                .select('*')
                .eq('token', token)
                .single();

            if (error || !data) {
                throw new Error('Token inválido');
            }

            // Check if event is still valid (CRITICAL FIX: multiply by 1000)
            const eventDate = new Date(data.validade * 1000);
            const now = new Date();
            
            if (eventDate < now) {
                throw new Error('Evento expirado');
            }

            currentClient = data;
            
            // Save token for future use
            saveToken(token);
            
            // Log login
            await supabase.from('logs').insert([{
                token: token,
                status: 'login',
                dispositivo: deviceName
            }]);

            // Load guests
            await loadGuests();
            
            // Switch to main app
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            updateHeader();
            updateStats();
            
            showToast('Login realizado com sucesso', 'success');
        }

        // Load guests for current event
        async function loadGuests() {
            try {
                const { data, error } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token)
                    .eq('status', 'ativo');

                if (error) throw error;
                
                guests = data || [];
                renderGuests();
                updateStats();
                
            } catch (error) {
                showToast('Erro ao carregar convidados', 'error');
            }
        }

        // Update header information
        function updateHeader() {
            if (!currentClient) return;
            
            document.getElementById('event-name').textContent = currentClient.nome;
            
            // CRITICAL FIX: multiply by 1000 for correct date conversion
            const eventDate = new Date(currentClient.validade * 1000);
            const formattedDate = eventDate.toLocaleDateString('pt-PT');
            
            document.getElementById('event-info').textContent = 
                `Válido até ${formattedDate} • ${guests.length} convidados`;
            
            document.getElementById('device-info').textContent = deviceName;
            document.getElementById('current-token').textContent = currentClient.token;
        }

        // Update statistics
        function updateStats() {
            const scannedCount = scannedGuests.size;
            const totalGuests = guests.length;
            const progressPercentage = totalGuests > 0 ? Math.round((scannedCount / totalGuests) * 100) : 0;

            // Update scanner progress bar
            document.getElementById('scanner-progress-percentage').textContent = progressPercentage + '%';
            document.getElementById('scanner-progress-bar').style.width = progressPercentage + '%';
            document.getElementById('scanner-validated-count').textContent = scannedCount + ' validados';
            document.getElementById('scanner-total-count').textContent = 'de ' + totalGuests + ' convidados';

            // Update options stats
            document.getElementById('options-scanned-count').textContent = scannedCount;
            document.getElementById('options-total-guests').textContent = totalGuests;
            document.getElementById('options-session-scans').textContent = sessionScans;
            
            // Update clear scans count
            const clearScansCount = document.getElementById('clear-scans-count');
            if (clearScansCount) {
                clearScansCount.textContent = scannedCount;
            }
            
            // Update reports
            const reportValidated = document.getElementById('report-validated');
            const reportPending = document.getElementById('report-pending');
            const progressPercentageEl = document.getElementById('progress-percentage');
            const progressBar = document.getElementById('progress-bar');
            
            if (reportValidated) reportValidated.textContent = scannedCount;
            if (reportPending) reportPending.textContent = totalGuests - scannedCount;
            if (progressPercentageEl) progressPercentageEl.textContent = progressPercentage + '%';
            if (progressBar) progressBar.style.width = progressPercentage + '%';
        }

        // Swipe navigation setup
        function setupSwipeNavigation() {
            const swipeContent = document.getElementById('swipe-content');
            const mainContent = document.getElementById('main-content');
            
            if (!swipeContent || !mainContent) return;

            // Touch events
            mainContent.addEventListener('touchstart', handleTouchStart, { passive: true });
            mainContent.addEventListener('touchmove', handleTouchMove, { passive: false });
            mainContent.addEventListener('touchend', handleTouchEnd, { passive: true });

            // Mouse events for desktop testing
            mainContent.addEventListener('mousedown', handleMouseStart);
            mainContent.addEventListener('mousemove', handleMouseMove);
            mainContent.addEventListener('mouseup', handleMouseEnd);
        }

        function handleTouchStart(e) {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
        }

        function handleTouchMove(e) {
            if (!swipeStartX || !swipeStartY) return;

            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = swipeStartX - currentX;
            const diffY = swipeStartY - currentY;

            // Prevent vertical scrolling during horizontal swipe
            if (Math.abs(diffX) > Math.abs(diffY)) {
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            if (!swipeStartX || !swipeStartY) return;

            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = swipeStartX - endX;
            const diffY = swipeStartY - endY;

            // Check if it's a horizontal swipe
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0 && currentTab === 0) {
                    // Swipe left: scanner to options
                    showTab('options');
                } else if (diffX < 0 && currentTab === 1) {
                    // Swipe right: options to scanner
                    showTab('scanner');
                }
            }

            swipeStartX = 0;
            swipeStartY = 0;
        }

        // Mouse events for desktop
        function handleMouseStart(e) {
            swipeStartX = e.clientX;
            swipeStartY = e.clientY;
        }

        function handleMouseMove(e) {
            if (!swipeStartX) return;
            e.preventDefault();
        }

        function handleMouseEnd(e) {
            if (!swipeStartX) return;

            const diffX = swipeStartX - e.clientX;
            const diffY = swipeStartY - e.clientY;

            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0 && currentTab === 0) {
                    showTab('options');
                } else if (diffX < 0 && currentTab === 1) {
                    showTab('scanner');
                }
            }

            swipeStartX = 0;
            swipeStartY = 0;
        }

        // Tab management with swipe support
        function showTab(tabName) {
            const tabIndex = tabName === 'scanner' ? 0 : 1;
            currentTab = tabIndex;
            
            // Show main content container and hide all sub-tabs
            document.getElementById('main-content').classList.remove('hidden');
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Update swipe content position
            const swipeContent = document.getElementById('swipe-content');
            if (swipeContent) {
                swipeContent.style.transform = `translateX(-${tabIndex * 50}%)`;
            }
            
            // Update navigation buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = btn.className.replace('bg-blue-600 text-white', 'text-gray-400 hover:text-white');
            });
            
            const activeBtn = document.getElementById(`tab-${tabName}`);
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('text-gray-400 hover:text-white', 'bg-blue-600 text-white');
            }

            // Update swipe indicators
            const dots = document.querySelectorAll('.swipe-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === tabIndex);
            });
            
            // Initialize scanner if needed
            if (tabName === 'scanner' && !html5QrCode) {
                initializeScanner();
            }
        }

        // Sub-tab management for options
        function showSubTab(subTabName) {
            // Hide main swipe container
            document.getElementById('main-content').classList.add('hidden');
            
            // Hide all sub-tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected sub-tab
            document.getElementById(`content-${subTabName}`).classList.remove('hidden');
        }

        // Scanner functionality
        async function initializeScanner() {
            try {
                if (html5QrCode) {
                    return; // Already initialized
                }
                html5QrCode = new Html5Qrcode("qr-reader-fullscreen");
                console.log('Scanner initialized successfully');
            } catch (error) {
                console.error('Scanner initialization error:', error);
                showToast('Erro ao inicializar scanner: ' + error.message, 'error');
                throw error;
            }
        }

        async function loadCameras() {
            try {
                const devices = await Html5Qrcode.getCameras();
                const select = document.getElementById('camera-select');
                
                select.innerHTML = '<option value="">Selecionar câmera...</option>';
                devices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.label || `Câmera ${index + 1}`;
                    select.appendChild(option);
                });
                
                // Auto-select back camera if available
                const backCamera = devices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('traseira')
                );
                if (backCamera) {
                    select.value = backCamera.id;
                }
            } catch (error) {
                console.error('Error loading cameras:', error);
            }
        }

        async function toggleScanner() {
            if (!isOnline) {
                showToast('Scanner requer conexão com a internet', 'error');
                return;
            }

            if (!isScanning) {
                await startScanner();
            } else {
                await stopScanner();
            }
        }

        function enableNextScan() {
            canScan = true;
            
            // Update main tab button
            const nextBtn = document.getElementById('next-scan-btn');
            nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Aguardando QR Code...';
            nextBtn.disabled = true;
            
            // Update fullscreen button
            const fullscreenBtn = document.getElementById('fullscreen-next-btn');
            fullscreenBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3 text-xl"></i><span>Aguardando QR Code...</span>';
            fullscreenBtn.disabled = true;
            fullscreenBtn.classList.remove('hidden');
            
            // Update status
            updateScanStatus('active', 'Pronto para escanear');
            
            // Hide instructions, show scanning area clearly
            document.getElementById('scanner-instructions').classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('scanner-instructions').classList.add('hidden');
            }, 300);
            
            // Auto-disable after 15 seconds if no scan
            setTimeout(() => {
                if (canScan) {
                    canScan = false;
                    
                    // Reset main button
                    nextBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>Próximo Convidado';
                    nextBtn.disabled = false;
                    
                    // Reset fullscreen button
                    fullscreenBtn.innerHTML = '<i class="fas fa-arrow-right mr-3 text-xl"></i><span>Próximo Convidado</span>';
                    fullscreenBtn.disabled = false;
                    
                    // Update status
                    updateScanStatus('waiting', 'Clique para escanear');
                    
                    // Show instructions again
                    document.getElementById('scanner-instructions').classList.remove('hidden', 'fade-out');
                    document.getElementById('scanner-instructions').classList.add('fade-in');
                }
            }, 15000);
        }

        function openFullscreenScanner() {
            document.getElementById('fullscreen-scanner').classList.remove('hidden');
            document.body.classList.add('fullscreen-scanner-active');
            
            // Show scanner instructions initially
            document.getElementById('scanner-instructions').classList.remove('hidden');
            document.getElementById('scan-result-display').classList.add('hidden');
            document.getElementById('fullscreen-next-btn').classList.add('hidden');
            
            // Set initial status
            updateScanStatus('disabled', 'Scanner iniciando...');
        }

        function closeFullscreenScanner() {
            document.getElementById('fullscreen-scanner').classList.add('hidden');
            document.body.classList.remove('fullscreen-scanner-active');
            
            if (isScanning) {
                stopScanner();
            }
        }
        
        function updateScanStatus(status, message) {
            const indicator = document.getElementById('scan-status-indicator');
            const label = document.getElementById('scan-status-label');
            
            // Remove all status classes
            indicator.classList.remove('scan-status-active', 'scan-status-waiting', 'scan-status-disabled');
            
            // Add current status class
            indicator.classList.add(`scan-status-${status}`);
            
            // Update label
            if (label) {
                label.textContent = message;
            }
        }

        async function startScanner() {
            console.log('Starting scanner...');
            
            try {
                // Check camera permissions first
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Câmera não suportada neste dispositivo');
                }

                // Request camera permission
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop()); // Stop the test stream
                    console.log('Camera permission granted');
                } catch (permError) {
                    throw new Error('Permissão de câmera negada. Ative a câmera nas configurações do browser.');
                }

                // Initialize scanner if needed
                if (!html5QrCode) {
                    await initializeScanner();
                }

                // Open fullscreen scanner
                openFullscreenScanner();

                // Get camera configuration
                const cameraSelect = document.getElementById('camera-select');
                const cameraId = cameraSelect.value || { facingMode: "environment" };
                
                console.log('Using camera:', cameraId);
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };

                await html5QrCode.start(
                    cameraId,
                    config,
                    onScanSuccess,
                    onScanFailure
                );
                
                isScanning = true;
                canScan = false; // Start with scanning disabled
                
                console.log('Scanner started successfully');
                
                // Update UI
                document.getElementById('scanner-toggle').innerHTML = '<i class="fas fa-stop mr-2"></i>Parar Scanner';
                document.getElementById('next-scan-btn').classList.remove('hidden');
                document.getElementById('scan-status-info').classList.remove('hidden');
                document.getElementById('fullscreen-next-btn').classList.remove('hidden');
                
                // Update status
                updateScanStatus('waiting', 'Clique para escanear');
                
                showToast('Scanner iniciado com sucesso', 'success');
                
            } catch (error) {
                console.error('Scanner start error:', error);
                showToast('Erro ao iniciar scanner: ' + error.message, 'error');
                closeFullscreenScanner();
                
                // Reset button state
                document.getElementById('scanner-toggle').innerHTML = '<i class="fas fa-play mr-2"></i>Iniciar Scanner';
            }
        }

        async function stopScanner() {
            if (html5QrCode && isScanning) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                    canScan = false;
                    
                    // Update UI
                    document.getElementById('scanner-toggle').innerHTML = '<i class="fas fa-play mr-2"></i>Iniciar Scanner';
                    document.getElementById('next-scan-btn').classList.add('hidden');
                    document.getElementById('scan-status-info').classList.add('hidden');
                    
                    // Reset next button
                    const nextBtn = document.getElementById('next-scan-btn');
                    nextBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>Próximo Convidado';
                    nextBtn.disabled = false;
                    
                    // Reset fullscreen button
                    const fullscreenBtn = document.getElementById('fullscreen-next-btn');
                    fullscreenBtn.innerHTML = '<i class="fas fa-arrow-right mr-3 text-xl"></i><span>Próximo Convidado</span>';
                    fullscreenBtn.disabled = false;
                    fullscreenBtn.classList.add('hidden');
                    
                    closeFullscreenScanner();
                } catch (error) {
                    console.error('Error stopping scanner:', error);
                }
            }
        }

        function toggleFastMode() {
            fastMode = document.getElementById('fast-mode').checked;
        }

        // QR Code scan handlers
        async function onScanSuccess(decodedText, decodedResult) {
            // Only process if scanning is enabled
            if (!canScan) {
                return;
            }

            const now = Date.now();
            
            // Prevent rapid duplicate scans
            if (now - lastScanTime < 1000) {
                return;
            }
            lastScanTime = now;

            // Disable scanning after successful read
            canScan = false;

            // Track scan attempts
            const attempts = scanAttempts.get(decodedText) || 0;
            scanAttempts.set(decodedText, attempts + 1);

            await processQRCode(decodedText);
            
            // Reset buttons
            const nextBtn = document.getElementById('next-scan-btn');
            nextBtn.innerHTML = '<i class="fas fa-arrow-right mr-2"></i>Próximo Convidado';
            nextBtn.disabled = false;
            
            const fullscreenBtn = document.getElementById('fullscreen-next-btn');
            fullscreenBtn.innerHTML = '<i class="fas fa-arrow-right mr-3 text-xl"></i><span>Próximo Convidado</span>';
            fullscreenBtn.disabled = false;
            
            // Update status
            updateScanStatus('waiting', 'Clique para escanear');
        }

        function onScanFailure(error) {
            // Ignore scan failures in fast mode to reduce noise
            if (!fastMode) {
                console.log('Scan failed:', error);
            }
        }

        async function processQRCode(code) {
            try {
                // Find guest by code
                const guest = guests.find(g => g.codigo === code);
                
                if (!guest) {
                    await handleScanResult('invalid', null, code);
                    return;
                }

                if (scannedGuests.has(code)) {
                    await handleScanResult('duplicate', guest, code);
                    return;
                }

                // Valid scan
                scannedGuests.add(code);
                sessionScans++;
                
                // Log to Supabase
                if (isOnline) {
                    await supabase.from('logs').insert([{
                        token: code,
                        status: 'scan',
                        dispositivo: deviceName
                    }]);
                }

                await handleScanResult('success', guest, code);
                updateStats();
                renderGuests();
                updateRecentScans();
                
            } catch (error) {
                await handleScanResult('error', null, code);
            }
        }

        async function handleScanResult(type, guest, code) {
            const statusTextEl = document.getElementById('scan-status-text');
            const guestNameEl = document.getElementById('scan-guest-name-display');
            const timeEl = document.getElementById('scan-time-display');
            const resultDisplay = document.getElementById('scan-result-display');
            const instructions = document.getElementById('scanner-instructions');

            let statusText, statusColor, guestName, timeText;
            const currentTime = new Date().toLocaleTimeString('pt-PT', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            switch (type) {
                case 'success':
                    statusText = 'PERMITIDO';
                    statusColor = 'text-green-400';
                    guestName = guest.nome;
                    timeText = `Entrada: ${currentTime}`;
                    playSuccessSound();
                    vibrate([100]);
                    flashScreen('success');
                    break;
                    
                case 'duplicate':
                    statusText = 'USADO';
                    statusColor = 'text-red-400';
                    guestName = guest.nome;
                    timeText = `Já validado anteriormente`;
                    playErrorSound();
                    vibrate([100, 100, 100]);
                    break;
                    
                case 'invalid':
                    statusText = 'INVÁLIDO';
                    statusColor = 'text-red-400';
                    guestName = 'Código não encontrado';
                    timeText = `Verificado: ${currentTime}`;
                    playErrorSound();
                    vibrate([200]);
                    flashScreen('error');
                    break;
                    
                case 'error':
                    statusText = 'ERRO';
                    statusColor = 'text-red-400';
                    guestName = 'Erro ao processar';
                    timeText = `Tentativa: ${currentTime}`;
                    playErrorSound();
                    vibrate([200]);
                    break;
            }

            statusTextEl.textContent = statusText;
            statusTextEl.className = `text-4xl font-bold mb-2 ${statusColor}`;
            guestNameEl.textContent = guestName;
            timeEl.textContent = timeText;

            // Hide instructions and show result with smooth transition
            instructions.classList.add('fade-out');
            setTimeout(() => {
                instructions.classList.add('hidden');
                resultDisplay.classList.remove('hidden');
                resultDisplay.classList.add('fade-in');
            }, 300);

            // Auto-hide after 4 seconds and show instructions again
            setTimeout(() => {
                resultDisplay.classList.add('fade-out');
                setTimeout(() => {
                    resultDisplay.classList.add('hidden');
                    resultDisplay.classList.remove('fade-out', 'fade-in');
                    instructions.classList.remove('hidden', 'fade-out');
                    instructions.classList.add('fade-in');
                    setTimeout(() => {
                        instructions.classList.remove('fade-in');
                    }, 300);
                }, 300);
            }, 4000);
        }

        // Audio feedback
        function playSuccessSound() {
            if (!document.getElementById('success-sound').checked) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        function playErrorSound() {
            if (!document.getElementById('error-sound').checked) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Haptic feedback
        function vibrate(pattern) {
            if (document.getElementById('vibration').checked && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // Visual feedback
        function flashScreen(type) {
            const body = document.body;
            const flashClass = type === 'success' ? 'success-flash' : 'error-flash';
            
            body.classList.add(flashClass);
            setTimeout(() => {
                body.classList.remove(flashClass);
            }, 500);
        }

        // Guest management
        function renderGuests() {
            const container = document.getElementById('guests-list');
            
            if (guests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-users text-3xl mb-2"></i>
                        <p>Nenhum convidado encontrado</p>
                    </div>
                `;
                return;
            }

            const guestsHtml = guests.map(guest => {
                const isScanned = scannedGuests.has(guest.codigo);
                const attempts = scanAttempts.get(guest.codigo) || 0;
                
                return `
                    <div class="bg-gray-800 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium ${isScanned ? 'text-green-400' : 'text-white'}">${guest.nome}</h4>
                            <p class="text-sm text-gray-400">${guest.codigo}</p>
                            ${attempts > 0 ? `<p class="text-xs text-orange-400">${attempts} tentativa(s)</p>` : ''}
                        </div>
                        <div class="flex items-center">
                            ${isScanned ? 
                                '<i class="fas fa-check-circle text-green-500 text-xl"></i>' : 
                                '<i class="fas fa-clock text-gray-500 text-xl"></i>'
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = guestsHtml;
        }

        function filterGuests() {
            const searchTerm = document.getElementById('guest-search').value.toLowerCase();
            const filteredGuests = guests.filter(guest => 
                guest.nome.toLowerCase().includes(searchTerm) || 
                guest.codigo.toLowerCase().includes(searchTerm)
            );
            
            // Temporarily replace guests array for rendering
            const originalGuests = guests;
            guests = filteredGuests;
            renderGuests();
            guests = originalGuests;
        }

        function filterGuestsByStatus(status) {
            // Update filter buttons
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'flex-1 py-3 px-4 rounded-lg bg-gray-700 text-gray-300 text-sm min-h-[44px] active:bg-gray-600';
            });
            document.getElementById(`filter-${status}`).className = 'flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white text-sm min-h-[44px] active:bg-blue-700';

            let filteredGuests;
            switch (status) {
                case 'scanned':
                    filteredGuests = guests.filter(guest => scannedGuests.has(guest.codigo));
                    break;
                case 'pending':
                    filteredGuests = guests.filter(guest => !scannedGuests.has(guest.codigo));
                    break;
                default:
                    filteredGuests = guests;
            }

            // Temporarily replace guests array for rendering
            const originalGuests = guests;
            guests = filteredGuests;
            renderGuests();
            guests = originalGuests;
        }

        // Reports
        function updateRecentScans() {
            const container = document.getElementById('recent-scans');
            const recentScans = Array.from(scannedGuests).slice(-5).reverse();
            
            if (recentScans.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <p>Nenhuma validação ainda</p>
                    </div>
                `;
                return;
            }

            const scansHtml = recentScans.map(code => {
                const guest = guests.find(g => g.codigo === code);
                return `
                    <div class="bg-gray-800 rounded-lg p-3 flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-green-400">${guest ? guest.nome : 'Desconhecido'}</h4>
                            <p class="text-sm text-gray-400">${code}</p>
                        </div>
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                `;
            }).join('');

            container.innerHTML = scansHtml;
        }

        async function generatePDFReport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Relatório InvitesQR', 20, 30);
                
                doc.setFontSize(12);
                doc.text(`Evento: ${currentClient.nome}`, 20, 50);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-PT')}`, 20, 60);
                doc.text(`Total de Convidados: ${guests.length}`, 20, 70);
                doc.text(`Validados: ${scannedGuests.size}`, 20, 80);
                doc.text(`Pendentes: ${guests.length - scannedGuests.size}`, 20, 90);
                
                // Scanned guests list
                doc.text('Convidados Validados:', 20, 110);
                
                let yPosition = 120;
                Array.from(scannedGuests).forEach((code, index) => {
                    const guest = guests.find(g => g.codigo === code);
                    if (guest && yPosition < 280) {
                        doc.text(`${index + 1}. ${guest.nome} (${code})`, 25, yPosition);
                        yPosition += 10;
                    }
                });
                
                // Save PDF
                doc.save(`relatorio-${currentClient.token}-${new Date().toISOString().split('T')[0]}.pdf`);
                
                showToast('Relatório PDF gerado com sucesso', 'success');
                
            } catch (error) {
                showToast('Erro ao gerar relatório PDF', 'error');
            }
        }

        async function shareReport() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Relatório InvitesQR',
                        text: `Evento: ${currentClient.nome}\nValidados: ${scannedGuests.size}/${guests.length}`,
                        url: window.location.href
                    });
                } catch (error) {
                    console.log('Share cancelled');
                }
            } else {
                // Fallback: copy to clipboard
                const reportText = `Relatório InvitesQR\nEvento: ${currentClient.nome}\nValidados: ${scannedGuests.size}/${guests.length}\nData: ${new Date().toLocaleDateString('pt-PT')}`;
                
                try {
                    await navigator.clipboard.writeText(reportText);
                    showToast('Relatório copiado para a área de transferência', 'success');
                } catch (error) {
                    showToast('Erro ao partilhar relatório', 'error');
                }
            }
        }

        // Clear saved token function
        function clearSavedTokenAndNotify() {
            if (confirm('Tem certeza que deseja limpar o token guardado? Terá que inserir novamente na próxima sessão.')) {
                clearSavedToken();
                showToast('Token guardado removido com sucesso', 'success');
            }
        }

        // Clear all scans function
        async function clearAllScans() {
            if (scannedGuests.size === 0) {
                showToast('Não há validações para limpar', 'info');
                return;
            }

            const confirmMessage = `Tem certeza que deseja desmarcar todas as ${scannedGuests.size} validações?\n\nEsta ação não pode ser desfeita.`;
            
            if (confirm(confirmMessage)) {
                try {
                    // Log the clear action
                    if (isOnline && currentClient) {
                        await supabase.from('logs').insert([{
                            token: currentClient.token,
                            status: 'clear_scans',
                            dispositivo: deviceName,
                            detalhes: `Cleared ${scannedGuests.size} scans`
                        }]);
                    }

                    // Clear all scanned guests
                    const clearedCount = scannedGuests.size;
                    scannedGuests.clear();
                    scanAttempts.clear();
                    
                    // Update UI
                    updateStats();
                    renderGuests();
                    updateRecentScans();
                    
                    showToast(`${clearedCount} validações foram desmarcadas`, 'success');
                    
                } catch (error) {
                    showToast('Erro ao desmarcar validações', 'error');
                }
            }
        }

        // Logout
        async function logout() {
            if (confirm('Tem certeza que deseja terminar a sessão?')) {
                if (isScanning) {
                    await stopScanner();
                }
                
                // Clear saved token
                clearSavedToken();
                
                // Reset state
                currentClient = null;
                guests = [];
                scannedGuests.clear();
                sessionScans = 0;
                scanAttempts.clear();
                
                // Show login screen
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                // Reset form
                document.getElementById('login-form').reset();
                
                showToast('Sessão terminada', 'info');
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `bg-gray-800 border-l-4 ${
                type === 'success' ? 'border-green-500' : 
                type === 'error' ? 'border-red-500' : 
                'border-blue-500'
            } p-4 shadow-lg rounded-r-lg max-w-sm slide-up`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${
                        type === 'success' ? 'check-circle text-green-500' : 
                        type === 'error' ? 'exclamation-circle text-red-500' : 
                        'info-circle text-blue-500'
                    } mr-3"></i>
                    <span class="text-white">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.getElementById('toast-container').appendChild(toast);

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }

        // Debug functionality
        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.classList.toggle('hidden');
            
            if (!debugInfo.classList.contains('hidden')) {
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            const debugContent = document.getElementById('debug-content');
            const info = [
                `User Agent: ${navigator.userAgent}`,
                `Screen: ${screen.width}x${screen.height}`,
                `Viewport: ${window.innerWidth}x${window.innerHeight}`,
                `Online: ${navigator.onLine}`,
                `HTTPS: ${location.protocol === 'https:'}`,
                `MediaDevices: ${!!navigator.mediaDevices}`,
                `getUserMedia: ${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}`,
                `Scanner State: ${isScanning ? 'Active' : 'Stopped'}`,
                `Can Scan: ${canScan}`,
                `HTML5QrCode: ${!!html5QrCode}`,
                `Cameras Available: ${document.getElementById('camera-select').options.length - 1}`,
                `Current Client: ${currentClient ? currentClient.nome : 'None'}`,
                `Guests Loaded: ${guests.length}`,
                `Scanned Count: ${scannedGuests.size}`
            ];
            
            debugContent.innerHTML = info.join('<br>');
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isScanning) {
                // Pause scanner when app goes to background
                stopScanner();
            }
        });

        // Handle online/offline events
        window.addEventListener('online', checkConnectivity);
        window.addEventListener('offline', checkConnectivity);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'967b330df61177d7',t:'MTc1Mzk0NTAyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
