<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Invites Digitais – Validação</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .main-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .upload-area {
      border: 2px dashed #e1e5e9;
      border-radius: 15px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 25px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .upload-area.dragover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .upload-area input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #667eea;
    }
    
    .upload-text {
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 5px;
    }
    
    .upload-subtext {
      font-size: 0.9rem;
      color: #999;
    }
    
    .btn {
      width: 100%;
      padding: 15px 20px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      font-size: 1.2rem;
      padding: 18px;
    }
    
    .btn-success:hover {
      box-shadow: 0 10px 25px rgba(17, 153, 142, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
    }
    
    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      color: #2d3436;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .result-message {
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    
    .result-success {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .result-error {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .result-info {
      background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .guest-list {
      background: #f8f9fa;
      border-radius: 15px;
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
    }
    
    .guest-list:empty::before {
      content: "📋 Nenhum convidado carregado ainda...";
      display: block;
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
      font-style: italic;
    }
    
    .guest-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      transition: background 0.2s ease;
    }
    
    .guest-item:hover {
      background: #e9ecef;
    }
    
    .guest-item:last-child {
      border-bottom: none;
    }
    
    .guest-status {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .status-pending {
      background: #ffc107;
      color: #856404;
    }
    
    .status-validated {
      background: #28a745;
      color: white;
    }
    
    .guest-info {
      flex: 1;
    }
    
    .guest-name {
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 1.1rem;
    }
    
    .guest-time {
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 25px;
    }
    
    .scanner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .scanner-container {
      background: white;
      border-radius: 20px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    
    .scanner-header {
      margin-bottom: 20px;
    }
    
    .scanner-header h2 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .scanner-area {
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .scan-result {
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      display: none;
    }
    
    .scan-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .scan-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .scan-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .scanner-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .btn-close {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-next {
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .footer {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 30px;
      font-size: 0.9rem;
    }
    
    /* Mobile-first design */
    .container {
      padding: 10px;
    }
    
    .header h1 {
      font-size: 2rem;
    }
    
    .main-card {
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .upload-area {
      padding: 30px 15px;
    }
    
    .upload-icon {
      font-size: 2.5rem;
    }
    
    .btn {
      padding: 18px 20px;
      font-size: 1.2rem;
      min-height: 60px;
    }
    
    .btn-success {
      font-size: 1.3rem;
      padding: 22px;
      min-height: 70px;
    }
    
    .stats-container {
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .stat-card {
      padding: 15px 10px;
    }
    
    .stat-number {
      font-size: 2rem;
    }
    
    .stat-label {
      font-size: 0.8rem;
    }
    
    .guest-item {
      padding: 18px 15px;
    }
    
    .guest-name {
      font-size: 1rem;
    }
    
    .guest-time {
      font-size: 0.8rem;
    }
    
    .action-grid {
      grid-template-columns: 1fr;
      gap: 10px;
    }
    
    .scanner-overlay {
      padding: 10px;
    }
    
    .scanner-container {
      padding: 15px;
      max-width: 95%;
    }
    
    .scanner-controls {
      flex-direction: column;
      gap: 15px;
    }
    
    .btn-close, .btn-next {
      padding: 15px 20px;
      font-size: 1.1rem;
      min-height: 50px;
      width: 100%;
    }
    
    /* Larger touch targets for mobile */
    .upload-area {
      min-height: 120px;
    }
    
    .guest-status {
      width: 35px;
      height: 35px;
      font-size: 1.1rem;
    }
    
    /* Better spacing for mobile */
    .result-message {
      margin: 15px 0;
      padding: 18px;
      font-size: 1rem;
    }
    
    /* Desktop adjustments */
    @media (min-width: 769px) {
      .container {
        padding: 20px;
      }
      
      .header h1 {
        font-size: 2.5rem;
      }
      
      .main-card {
        padding: 30px;
      }
      
      .stats-container {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
      }
      
      .action-grid {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      
      .btn {
        padding: 15px 20px;
        font-size: 1.1rem;
        min-height: auto;
      }
      
      .btn-success {
        font-size: 1.2rem;
        padding: 18px;
        min-height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Invites Digitais</h1>
      <p>Sistema Profissional de Validação</p>
    </div>

    <div class="main-card">
      <div class="upload-area">
        <input type="file" id="fileInput" accept=".json" onchange="handleFileUpload(event)" style="display: none;">
        <div class="upload-icon">📁</div>
        <div class="upload-text">Carregar Lista de Convidados</div>
        <div class="upload-subtext">Clique no botão abaixo ou arraste o arquivo aqui</div>
      </div>
      
      <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
        📂 Selecionar Arquivo JSON
      </button>

      <button class="btn btn-success" onclick="startScanner()">
        📷 Iniciar Scanner QR Code
      </button>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-number" id="totalCount">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="validatedCount">0</div>
          <div class="stat-label">Validados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingCount">0</div>
          <div class="stat-label">Pendentes</div>
        </div>
      </div>

      <div id="resultMessage" class="result-message"></div>

      <div id="guestList" class="guest-list"></div>

      <div class="action-grid">
        <button class="btn btn-danger" onclick="clearAllData()">
          🗑️ Limpar Tudo
        </button>
        <button class="btn btn-info" onclick="exportData()">
          📊 Exportar CSV
        </button>
      </div>
    </div>

    <div class="footer">
      © 2025 Invites Digitais - Sistema de Validação Profissional
    </div>
  </div>

  <div id="scannerOverlay" class="scanner-overlay">
    <div class="scanner-container">
      <div class="scanner-header">
        <h2>🔍 Scanner QR Code</h2>
        <p>Aponte a câmera para o código QR</p>
      </div>
      
      <div id="scannerArea" class="scanner-area"></div>
      
      <div id="scanResult" class="scan-result"></div>
      
      <div class="scanner-controls">
        <button class="btn-close" onclick="closeScanner()">Fechar</button>
        <button id="nextBtn" class="btn-next" onclick="nextScan()" style="display: none;">Próximo</button>
      </div>
    </div>
  </div>

  <script>
    let guestData = {};
    let scanner = null;
    let scanLocked = false;
    const STORAGE_KEY = 'invitesDigitaisData';

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadStoredData();
      updateDisplay();
      setupDragAndDrop();
    });

    function setupDragAndDrop() {
      const uploadArea = document.querySelector('.upload-area');
      
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });
    }

    function decryptJson(encryptedData) {
      try {
        const decrypted = CryptoJS.AES.decrypt(encryptedData, 'sua-chave-secreta');
        const jsonString = decrypted.toString(CryptoJS.enc.Utf8);
        return JSON.parse(jsonString);
      } catch (error) {
        throw new Error('Falha na descriptografia');
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
      // Clear the input value to prevent reopening
      event.target.value = '';
    }

    function handleFile(file) {
      if (!file.name.endsWith('.json')) {
        showMessage('Por favor, selecione um arquivo .json válido', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const fileContent = e.target.result;
          console.log('Raw file content:', fileContent.substring(0, 200)); // Debug log
          
          // Try to decrypt first
          let decryptedData;
          try {
            decryptedData = decryptJson(fileContent);
            console.log('Decrypted data:', decryptedData); // Debug log
          } catch (decryptError) {
            console.log('Decryption failed, trying plain JSON...'); // Debug log
            // If decryption fails, try to parse as plain JSON
            try {
              decryptedData = JSON.parse(fileContent);
              console.log('Plain JSON data:', decryptedData); // Debug log
            } catch (jsonError) {
              console.error('JSON parsing failed:', jsonError);
              showMessage('Erro ao processar arquivo. Verifique se é um arquivo válido.', 'error');
              return;
            }
          }
          
          // Check if it's our format (make this check more flexible)
          if (!decryptedData || (decryptedData.id && decryptedData.id !== 'meuApp2025')) {
            console.log('ID check failed. Found ID:', decryptedData?.id);
            showMessage('Arquivo não foi gerado pelo sistema correto', 'error');
            return;
          }

          // Process guest data - handle different possible structures
          guestData = {};
          let guestArray = [];
          
          // Try different possible structures
          if (decryptedData.guests && Array.isArray(decryptedData.guests)) {
            guestArray = decryptedData.guests;
          } else if (Array.isArray(decryptedData)) {
            guestArray = decryptedData;
          } else if (decryptedData.convidados && Array.isArray(decryptedData.convidados)) {
            guestArray = decryptedData.convidados;
          }
          
          console.log('Guest array found:', guestArray); // Debug log
          
          if (guestArray.length > 0) {
            guestArray.forEach((guest, index) => {
              console.log(`Processing guest ${index}:`, guest); // Debug log
              
              // Handle different possible field names
              const name = guest.name || guest.nome || guest.guest || `Convidado ${index + 1}`;
              const code = guest.code || guest.codigo || guest.id || `code_${index}`;
              
              if (name && code) {
                guestData[code] = {
                  name: name,
                  code: code,
                  validated: false,
                  validatedAt: null
                };
              }
            });
          }

          console.log('Final processed guests:', guestData); // Debug log
          
          if (Object.keys(guestData).length === 0) {
            showMessage('Nenhum convidado válido encontrado no arquivo', 'error');
            return;
          }
          
          saveData();
          updateDisplay();
          showMessage(`✅ ${Object.keys(guestData).length} convidados carregados com sucesso!`, 'success');
          
        } catch (error) {
          console.error('File processing error:', error);
          showMessage('Erro ao processar arquivo. Verifique se é um arquivo válido.', 'error');
        }
      };
      reader.readAsText(file);
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('resultMessage');
      messageEl.textContent = text;
      messageEl.className = `result-message result-${type}`;
      messageEl.style.display = 'block';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }

    function updateDisplay() {
      updateStats();
      updateGuestList();
    }

    function updateStats() {
      const total = Object.keys(guestData).length;
      const validated = Object.values(guestData).filter(g => g.validated).length;
      const pending = total - validated;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('validatedCount').textContent = validated;
      document.getElementById('pendingCount').textContent = pending;
    }

    function updateGuestList() {
      const listEl = document.getElementById('guestList');
      listEl.innerHTML = '';

      console.log('Updating guest list with data:', guestData); // Debug log

      if (Object.keys(guestData).length === 0) {
        return; // Let CSS handle empty state
      }

      const sortedGuests = Object.values(guestData).sort((a, b) => {
        if (a.validated && !b.validated) return -1;
        if (!a.validated && b.validated) return 1;
        if (a.validated && b.validated) {
          return new Date(b.validatedAt) - new Date(a.validatedAt);
        }
        return a.name.localeCompare(b.name);
      });

      sortedGuests.forEach(guest => {
        const item = document.createElement('div');
        item.className = 'guest-item';
        
        const statusIcon = guest.validated ? '✓' : '⏳';
        const statusClass = guest.validated ? 'status-validated' : 'status-pending';
        const timeInfo = guest.validated ? 
          `Validado: ${new Date(guest.validatedAt).toLocaleString('pt-PT')}` : 
          'Aguardando validação';

        item.innerHTML = `
          <div class="guest-status ${statusClass}">${statusIcon}</div>
          <div class="guest-info">
            <div class="guest-name">${guest.name || 'Nome não disponível'}</div>
            <div class="guest-time">${timeInfo}</div>
          </div>
        `;
        
        listEl.appendChild(item);
      });
    }

    async function startScanner() {
      if (Object.keys(guestData).length === 0) {
        showMessage('Carregue primeiro a lista de convidados', 'error');
        return;
      }

      document.getElementById('scannerOverlay').style.display = 'flex';
      
      // Clear any previous content
      document.getElementById('scannerArea').innerHTML = '';
      
      try {
        // First check if we have camera permissions
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop()); // Stop the test stream
        
        // Now initialize the scanner
        scanner = new Html5Qrcode("scannerArea");
        
        // Try different camera configurations
        try {
          // First try with environment facing mode (back camera)
          await scanner.start(
            { facingMode: "environment" },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              aspectRatio: 1.0
            },
            onScanSuccess,
            onScanError
          );
          console.log('Started with back camera');
        } catch (backCameraError) {
          console.log('Back camera failed, trying front camera...', backCameraError);
          try {
            // If back camera fails, try front camera
            await scanner.start(
              { facingMode: "user" },
              {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
              },
              onScanSuccess,
              onScanError
            );
            console.log('Started with front camera');
          } catch (frontCameraError) {
            console.log('Front camera failed, trying camera list...', frontCameraError);
            // If both fail, try with camera list
            const cameras = await Html5Qrcode.getCameras();
            console.log('Available cameras:', cameras);
            
            if (cameras && cameras.length > 0) {
              const camera = cameras[0];
              console.log('Using camera:', camera);
              
              await scanner.start(
                camera.id,
                {
                  fps: 10,
                  qrbox: { width: 250, height: 250 },
                  aspectRatio: 1.0
                },
                onScanSuccess,
                onScanError
              );
              console.log('Started with camera ID:', camera.id);
            } else {
              throw new Error('Nenhuma câmara disponível');
            }
          }
        }
        
      } catch (error) {
        console.error('Scanner error:', error);
        let errorMessage = 'Erro ao aceder à câmara';
        
        if (error.name === 'NotAllowedError') {
          errorMessage = 'Permissão da câmara negada. Permita o acesso e tente novamente.';
        } else if (error.name === 'NotFoundError') {
          errorMessage = 'Nenhuma câmara encontrada no dispositivo.';
        } else if (error.name === 'NotSupportedError') {
          errorMessage = 'Câmara não suportada neste navegador.';
        }
        
        showMessage(errorMessage, 'error');
        closeScanner();
      }
    }

    function onScanSuccess(decodedText) {
      if (scanLocked) return;
      scanLocked = true;

      const resultEl = document.getElementById('scanResult');
      const nextBtn = document.getElementById('nextBtn');

      if (guestData[decodedText]) {
        const guest = guestData[decodedText];
        
        if (guest.validated) {
          resultEl.innerHTML = `
            <strong>⚠️ ${guest.name}</strong><br>
            Já validado em: ${new Date(guest.validatedAt).toLocaleString('pt-PT')}
          `;
          resultEl.className = 'scan-result scan-warning';
        } else {
          guest.validated = true;
          guest.validatedAt = new Date().toISOString();
          
          resultEl.innerHTML = `
            <strong>✅ ${guest.name}</strong><br>
            Validado com sucesso!
          `;
          resultEl.className = 'scan-result scan-success';
          
          saveData();
          updateDisplay();
        }
      } else {
        resultEl.innerHTML = `
          <strong>❌ Código não encontrado</strong><br>
          Este QR code não está na lista de convidados
        `;
        resultEl.className = 'scan-result scan-error';
      }

      resultEl.style.display = 'block';
      nextBtn.style.display = 'inline-block';
    }

    function onScanError(error) {
      // Silently handle scan errors
    }

    function nextScan() {
      scanLocked = false;
      document.getElementById('scanResult').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';
    }

    async function closeScanner() {
      document.getElementById('scannerOverlay').style.display = 'none';
      if (scanner) {
        try {
          await scanner.stop();
          scanner.clear();
        } catch (err) {
          console.log('Error stopping scanner:', err);
          // Force clear even if stop fails
          try {
            scanner.clear();
          } catch (clearErr) {
            console.log('Error clearing scanner:', clearErr);
          }
        } finally {
          scanner = null;
        }
      }
      scanLocked = false;
      document.getElementById('scanResult').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';
    }

    function clearAllData() {
      if (confirm('Tem certeza que deseja limpar todos os dados? Esta ação não pode ser desfeita.')) {
        guestData = {};
        saveData();
        updateDisplay();
        showMessage('Todos os dados foram limpos', 'info');
      }
    }

    function exportData() {
      if (Object.keys(guestData).length === 0) {
        showMessage('Não há dados para exportar', 'error');
        return;
      }

      let csvContent = 'Nome,Código,Status,Data de Validação\n';
      
      Object.values(guestData).forEach(guest => {
        const status = guest.validated ? 'Validado' : 'Pendente';
        const date = guest.validated ? new Date(guest.validatedAt).toLocaleString('pt-PT') : '';
        csvContent += `"${guest.name}","${guest.code}","${status}","${date}"\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `validacao_convidados_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showMessage('Dados exportados com sucesso!', 'success');
    }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(guestData));
    }

    function loadStoredData() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          guestData = JSON.parse(stored);
        } catch (error) {
          guestData = {};
        }
      }
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'963becafa17977d7',t:'MTc1MzI4MTUzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
