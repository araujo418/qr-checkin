<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor QR Code - Controle de Convidados</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .scanner-container { position: relative; border-radius: 12px; overflow: hidden; }
        .guest-card { transition: all 0.3s ease; }
        .guest-card:hover { transform: translateY(-2px); }
        .scanned { background: linear-gradient(135deg, #10b981, #059669); }
        .pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .denied { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { 
            background-color: #eff6ff; 
            color: #2563eb; 
            border-bottom-color: #2563eb; 
        }
        .tab-content { display: block; }
        .tab-content.hidden { display: none; }
        
        /* Dark Theme */
        .dark {
            background-color: #111827;
            color: #f9fafb;
        }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-50 { background-color: #374151; }
        .dark .bg-gray-100 { background-color: #4b5563; }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-600 { color: #d1d5db; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .text-gray-700 { color: #e5e7eb; }
        .dark .border-gray-300 { border-color: #6b7280; }
        .dark .border-b { border-color: #4b5563; }
        .dark .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3); }
        .dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        .dark .tab-button.active { 
            background-color: #1e3a8a; 
            color: #93c5fd; 
        }
        .dark .hover\:bg-gray-200:hover { background-color: #6b7280; }
        .dark .hover\:text-gray-700:hover { color: #d1d5db; }
        .dark .hover\:border-gray-300:hover { border-color: #9ca3af; }

        /* Dark Gray Theme */
        .dark-gray {
            background-color: #1f2937;
            color: #f3f4f6;
        }
        .dark-gray .bg-white { background-color: #374151; }
        .dark-gray .bg-gray-50 { background-color: #4b5563; }
        .dark-gray .bg-gray-100 { background-color: #6b7280; }
        .dark-gray .text-gray-800 { color: #f3f4f6; }
        .dark-gray .text-gray-600 { color: #d1d5db; }
        .dark-gray .text-gray-500 { color: #9ca3af; }
        .dark-gray .text-gray-700 { color: #e5e7eb; }
        .dark-gray .border-gray-300 { border-color: #6b7280; }
        .dark-gray .border-b { border-color: #4b5563; }
        .dark-gray .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.25); }
        .dark-gray .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.25), 0 10px 10px -5px rgba(0, 0, 0, 0.15); }
        .dark-gray .tab-button.active { 
            background-color: #1e40af; 
            color: #93c5fd; 
        }
        .dark-gray .hover\:bg-gray-200:hover { background-color: #6b7280; }
        .dark-gray .hover\:text-gray-700:hover { color: #d1d5db; }
        .dark-gray .hover\:border-gray-300:hover { border-color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6">
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-sm sm:max-w-md">
            <div class="text-center mb-6 sm:mb-8">
                <div class="bg-blue-100 w-14 h-14 sm:w-16 sm:h-16 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                    <i class="fas fa-qrcode text-blue-600 text-xl sm:text-2xl"></i>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Leitor de Código QR</h1>
                <p class="text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base">Controlo de Convidados</p>
            </div>
            
            <form id="loginForm" class="space-y-4 sm:space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token do Evento</label>
                    <input type="text" id="tokenInput" 
                           class="w-full px-3 sm:px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Introduza o token do evento" required>
                </div>
                
                <button type="submit" id="loginBtn"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors text-base">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Entrar
                </button>
            </form>
            
            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 rounded-lg text-red-700 text-sm"></div>
        </div>
        
        <!-- Créditos sutis -->
        <div class="text-center mt-8 text-xs text-gray-400">
            Created By Invites <span id="currentYear"></span>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8">
                <div class="flex justify-between items-center h-14 sm:h-16">
                    <div class="flex items-center min-w-0 flex-1">
                        <h1 class="text-lg sm:text-xl font-semibold text-gray-800 truncate" id="eventTitle">Evento</h1>
                        <span class="ml-2 sm:ml-3 px-2 sm:px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs sm:text-sm font-medium" id="statusBadge">
                            Online
                        </span>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <div class="text-xs sm:text-sm text-gray-600 hidden sm:block">
                            <span id="scannedCount">0</span> / <span id="totalGuests">0</span> digitalizados
                        </div>
                        <button id="logoutBtn" class="text-gray-500 hover:text-gray-700 p-2">
                            <i class="fas fa-sign-out-alt text-sm sm:text-base"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8">
            <div class="bg-white border-b">
                <div class="flex space-x-0">
                    <button id="scannerTab" class="tab-button active flex-1 px-4 py-3 text-sm sm:text-base font-medium border-b-2 border-blue-500 text-blue-600 bg-blue-50 rounded-t-lg">
                        <i class="fas fa-qrcode mr-1 sm:mr-2"></i>
                        Scanner
                    </button>
                    <button id="optionsTab" class="tab-button flex-1 px-4 py-3 text-sm sm:text-base font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-t-lg">
                        <i class="fas fa-cog mr-1 sm:mr-2"></i>
                        Opções
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4">
            <!-- Scanner Tab -->
            <div id="scannerTabContent" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Scanner Principal -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="text-center mb-4">
                                <button id="toggleScanner" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors text-lg font-medium shadow-lg">
                                    <i class="fas fa-qrcode mr-2"></i>
                                    <i class="fas fa-play mr-2"></i>
                                    Iniciar Scanner
                                </button>
                            </div>
                            
                            <div id="scannerContainer" class="scanner-container bg-gray-900 rounded-2xl h-[350px] flex items-center justify-center mx-auto border-4 border-gray-300 shadow-2xl">
                                <div class="text-center text-gray-400 px-6">
                                    <i class="fas fa-qrcode text-5xl mb-4 text-gray-500"></i>
                                    <p class="text-lg font-medium">Clique em "Iniciar Scanner"</p>
                                    <p class="text-sm mt-2 text-gray-500">Posicione o QR na área de scan</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Painel Lateral -->
                    <div class="lg:col-span-1">
                        <!-- Resultado do Scan -->
                        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-clipboard-check mr-2 text-blue-600"></i>
                                Resultado
                            </h3>
                            <div id="scanResult" class="hidden p-4 rounded-lg text-center border-l-4 transform transition-all duration-300"></div>
                            <div id="scanResultPlaceholder" class="text-center text-gray-400 py-8">
                                <i class="fas fa-qrcode text-3xl mb-2"></i>
                                <p class="text-sm">Aguardando scan...</p>
                            </div>
                            
                            <!-- Botão próximo -->
                            <div id="nextScanContainer" class="hidden mt-4 text-center">
                                <button id="nextScanBtn" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition-colors shadow-lg">
                                    <i class="fas fa-arrow-right mr-2"></i>
                                    Próximo Scan
                                </button>
                            </div>
                        </div>

                        <!-- Progresso Rápido -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-chart-line mr-2 text-green-600"></i>
                                Progresso
                            </h3>
                            <div class="text-center mb-4">
                                <div class="text-3xl font-bold text-blue-600" id="scannerProgressText">0%</div>
                                <div class="text-sm text-gray-600">Concluído</div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                                <div id="scannerProgressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <div class="text-xl font-bold text-green-600" id="scannerScannedCount">0</div>
                                    <div class="text-xs text-green-700">Escaneados</div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="text-xl font-bold text-blue-600" id="scannerTotalGuestCount">0</div>
                                    <div class="text-xs text-blue-700">Total</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options Tab -->
            <div id="optionsTabContent" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Estatísticas do Evento -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-chart-bar mr-3 text-blue-600"></i>
                            Estatísticas do Evento
                        </h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg text-center border border-green-200">
                                <div class="text-3xl font-bold text-green-600" id="confirmedCount">0</div>
                                <div class="text-sm text-green-700 mt-1">Confirmados</div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg text-center border border-yellow-200">
                                <div class="text-3xl font-bold text-yellow-600" id="pendingCount">0</div>
                                <div class="text-sm text-yellow-700 mt-1">Pendentes</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg text-center border border-blue-200">
                                <div class="text-3xl font-bold text-blue-600" id="scanUsed">0</div>
                                <div class="text-sm text-blue-700 mt-1">Scans Usados</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center border border-purple-200">
                                <div class="text-3xl font-bold text-purple-600" id="scanLimit">∞</div>
                                <div class="text-sm text-purple-700 mt-1">Limite</div>
                            </div>
                        </div>
                        
                        <!-- Progresso -->
                        <div class="p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border border-blue-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                                    Progresso do Evento
                                </h3>
                                <span id="connectionStatus" class="flex items-center text-sm">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                    Online
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-3">
                                <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <span id="progressText" class="text-lg font-medium text-gray-700">0% dos convidados digitalizados</span>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Convidados -->
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-6 border-b bg-gradient-to-r from-blue-50 to-purple-50">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-users mr-3 text-blue-600"></i>
                                    Lista de Convidados
                                </h2>
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <input type="text" id="searchInput" placeholder="Procurar convidado..."
                                           class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <select id="filterSelect" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="all">Todos</option>
                                        <option value="scanned">Digitalizados</option>
                                        <option value="pending">Pendentes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="guestList" class="p-6">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-users text-3xl mb-2"></i>
                                <p>A carregar lista de convidados...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações do Scanner -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-qrcode mr-3 text-blue-600"></i>
                            Configurações do Scanner
                        </h2>
                        <div class="space-y-6">
                            <!-- Modo Rápido -->
                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-bolt mr-2 text-blue-600"></i>
                                        Modo Rápido
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Digitalização contínua sem pausas</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="quickModeToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <!-- Flash da Câmara -->
                            <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-flashlight mr-2 text-yellow-600"></i>
                                        Flash da Câmara
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Ativar luz para ambientes escuros</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="flashModeToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Configurações de Feedback -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-volume-up mr-3 text-green-600"></i>
                            Configurações de Feedback
                        </h2>
                        <div class="space-y-6">
                            <!-- Som -->
                            <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg border border-green-200">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-volume-up mr-2 text-green-600"></i>
                                        Som
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Feedback sonoro nos scans</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="soundToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                </label>
                            </div>

                            <!-- Vibração -->
                            <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg border border-purple-200">
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-800 flex items-center">
                                        <i class="fas fa-mobile-alt mr-2 text-purple-600"></i>
                                        Vibração
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Feedback tátil nos scans</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="vibrationToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Aparência -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-palette mr-3 text-indigo-600"></i>
                            Aparência
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Tema da Interface</label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="theme" value="light" class="sr-only peer" checked>
                                        <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all">
                                            <div class="flex items-center justify-center mb-2">
                                                <i class="fas fa-sun text-2xl text-yellow-500"></i>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-medium text-gray-800">Claro</div>
                                                <div class="text-sm text-gray-600">Tema padrão</div>
                                            </div>
                                        </div>
                                    </label>
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="theme" value="dark" class="sr-only peer">
                                        <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all">
                                            <div class="flex items-center justify-center mb-2">
                                                <i class="fas fa-moon text-2xl text-blue-600"></i>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-medium text-gray-800">Escuro</div>
                                                <div class="text-sm text-gray-600">Modo noturno</div>
                                            </div>
                                        </div>
                                    </label>
                                    <label class="relative cursor-pointer">
                                        <input type="radio" name="theme" value="darkGray" class="sr-only peer">
                                        <div class="p-4 border-2 border-gray-200 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all">
                                            <div class="flex items-center justify-center mb-2">
                                                <i class="fas fa-adjust text-2xl text-gray-600"></i>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-medium text-gray-800">Cinza Escuro</div>
                                                <div class="text-sm text-gray-600">Contraste médio</div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Ações Rápidas -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-bolt mr-3 text-yellow-600"></i>
                            Ações Rápidas
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button id="refreshDataBtn" class="bg-gray-600 text-white py-4 px-6 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center text-lg font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-refresh mr-3"></i>
                                Atualizar
                            </button>
                            <button id="syncBtn" class="bg-green-600 text-white py-4 px-6 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center text-lg font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-sync-alt mr-3"></i>
                                Sincronizar
                            </button>
                            <button id="exportBtn" class="bg-purple-600 text-white py-4 px-6 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center text-lg font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-download mr-3"></i>
                                Exportar
                            </button>
                            <button id="quickScanBtn" class="bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center text-lg font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                <i class="fas fa-qrcode mr-3"></i>
                                Voltar ao Scanner
                            </button>
                        </div>
                    </div>


                </div>
            </div>

            </div>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        // Aguardar carregamento da biblioteca Supabase
        let supabaseClient = null;
        
        // Inicializar Supabase quando a página carregar
        window.addEventListener('load', () => {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase inicializado com sucesso');
            } else {
                console.error('Biblioteca Supabase não carregada');
            }
        });

        // Estado da aplicação
        let currentClient = null;
        let guests = [];
        let scannedGuests = new Set();
        let html5QrCode = null;
        let isScanning = false;
        let scanPaused = false;
        let lastScanResult = null;
        let connectionCheckInterval = null;
        let tokenCheckInterval = null;
        
        // Configurações
        let settings = {
            quickMode: false,
            flashMode: false,
            soundEnabled: true,
            vibrationEnabled: true,
            theme: 'light' // 'light', 'dark', 'darkGray'
        };

        // Elementos DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm');
        const tokenInput = document.getElementById('tokenInput');
        const loginError = document.getElementById('loginError');
        const eventTitle = document.getElementById('eventTitle');
        const scannedCount = document.getElementById('scannedCount');
        const totalGuests = document.getElementById('totalGuests');
        const toggleScanner = document.getElementById('toggleScanner');
        const scannerContainer = document.getElementById('scannerContainer');
        const scanResult = document.getElementById('scanResult');
        const nextScanContainer = document.getElementById('nextScanContainer');
        const nextScanBtn = document.getElementById('nextScanBtn');
        const guestList = document.getElementById('guestList');
        const searchInput = document.getElementById('searchInput');
        const filterSelect = document.getElementById('filterSelect');
        const confirmedCount = document.getElementById('confirmedCount');
        const pendingCount = document.getElementById('pendingCount');
        const scanLimit = document.getElementById('scanLimit');
        const scanUsed = document.getElementById('scanUsed');
        const connectionStatus = document.getElementById('connectionStatus');
        const logoutBtn = document.getElementById('logoutBtn');
        const syncBtn = document.getElementById('syncBtn');
        const exportBtn = document.getElementById('exportBtn');
        
        // Elementos das abas
        const scannerTab = document.getElementById('scannerTab');
        const scannerTabContent = document.getElementById('scannerTabContent');
        const quickScanBtn = document.getElementById('quickScanBtn');
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        // Elementos da barra de progresso do scanner
        const scannerProgressBar = document.getElementById('scannerProgressBar');
        const scannerProgressText = document.getElementById('scannerProgressText');
        const scannerScannedCount = document.getElementById('scannerScannedCount');
        const scannerTotalGuestCount = document.getElementById('scannerTotalGuestCount');
        
        // Elementos das abas
        const optionsTab = document.getElementById('optionsTab');
        const optionsTabContent = document.getElementById('optionsTabContent');

        // Estado da conexão
        let isOnline = true;
        let wasOffline = false;

        // Verificar conexão real com internet (não só status do navegador)
        async function checkRealConnection() {
            if (!navigator.onLine) {
                return false;
            }
            
            try {
                // Tentar fazer uma requisição real para verificar conectividade
                const response = await fetch('https://www.google.com/favicon.ico', {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    timeout: 5000
                });
                return true;
            } catch (error) {
                return false;
            }
        }

        // Verificar se token ainda é válido
        async function checkTokenValidity() {
            if (!currentClient || !supabaseClient || !isOnline) return false;
            
            try {
                const { data, error } = await supabaseClient
                    .from('clientes')
                    .select('*')
                    .eq('token', currentClient.token)
                    .single();
                
                // Verificar se token não expirou (validade em timestamp)
                if (data && data.validade) {
                    const now = Math.floor(Date.now() / 1000);
                    if (now > data.validade) {
                        return false; // Token expirado
                    }
                }
                
                return !error && data;
            } catch (error) {
                return false;
            }
        }

        // Atualizar status de conexão e interface
        function updateConnectionStatus(online) {
            const statusElement = connectionStatus;
            const statusBadge = document.getElementById('statusBadge');
            
            if (online) {
                statusElement.innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>Online';
                statusElement.className = 'flex items-center text-sm text-green-700';
                statusBadge.innerHTML = 'Online';
                statusBadge.className = 'ml-2 sm:ml-3 px-2 sm:px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs sm:text-sm font-medium';
                
                // Reativar botões que precisam de internet
                enableOnlineFeatures();
                
                // Se estava offline e agora está online, sincronizar dados
                if (wasOffline) {
                    wasOffline = false;
                    autoSyncAfterReconnection();
                }
            } else {
                statusElement.innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>Sem Internet';
                statusElement.className = 'flex items-center text-sm text-red-700';
                statusBadge.innerHTML = 'Sem Internet';
                statusBadge.className = 'ml-2 sm:ml-3 px-2 sm:px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs sm:text-sm font-medium';
                
                // Desativar funcionalidades que precisam de internet
                disableOnlineFeatures();
                wasOffline = true;
                
                // Parar scanner se estiver ativo
                if (isScanning) {
                    stopScanner();
                }
            }
            
            isOnline = online;
        }

        // Ativar funcionalidades online
        function enableOnlineFeatures() {
            // Reativar botões
            const onlineButtons = [
                document.getElementById('syncBtn'),
                document.getElementById('refreshDataBtn'),
                document.getElementById('toggleScanner')
            ];
            
            onlineButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // Desativar funcionalidades que precisam de internet
        function disableOnlineFeatures() {
            // Desativar botões que precisam de internet
            const onlineButtons = [
                document.getElementById('syncBtn'),
                document.getElementById('refreshDataBtn'),
                document.getElementById('toggleScanner')
            ];
            
            onlineButtons.forEach(btn => {
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // Sincronização automática após reconexão
        async function autoSyncAfterReconnection() {
            try {
                console.log('Reconectado! Sincronizando dados...');
                await loadSession();
                console.log('Dados sincronizados automaticamente após reconexão');
            } catch (error) {
                console.error('Erro na sincronização automática:', error);
            }
        }

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Usar token real se estiver mascarado, senão usar o valor digitado
            const token = (tokenInput.value === '********' && realToken) ? realToken : tokenInput.value.trim();
            
            if (!token) return;
            
            const connectionStatus = await checkRealConnection();
            if (!connectionStatus) {
                loginError.textContent = 'Sem conexão com a internet';
                loginError.classList.remove('hidden');
                return;
            }
            
            try {
                loginError.classList.add('hidden');
                document.getElementById('loginBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Entrando...';
                
                // Verificar se Supabase está inicializado
                if (!supabaseClient) {
                    throw new Error('Sistema não inicializado. Recarregue a página.');
                }
                
                // Validar token no Supabase
                const { data: client, error } = await supabaseClient
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();
                
                if (error || !client) {
                    // Para teste, criar dados fictícios se token for "TESTE"
                    if (token === 'TESTE') {
                        currentClient = {
                            id: 1,
                            nome: 'Evento de Teste',
                            token: 'TESTE',
                            validade: null,
                            limite_scans: null,
                            scans_usados: 0,
                            dispositivos: 'teste'
                        };
                        
                        // Dados de convidados fictícios
                        guests = [
                            { id: 1, nome: 'João Silva', token_cliente: 'TESTE', status: 'pendente', codigo: 'QR001' },
                            { id: 2, nome: 'Maria Santos', token_cliente: 'TESTE', status: 'pendente', codigo: 'QR002' },
                            { id: 3, nome: 'Pedro Costa', token_cliente: 'TESTE', status: 'pendente', codigo: 'QR003' },
                            { id: 4, nome: 'Ana Oliveira', token_cliente: 'TESTE', status: 'pendente', codigo: 'QR004' },
                            { id: 5, nome: 'Carlos Lima', token_cliente: 'TESTE', status: 'pendente', codigo: 'QR005' }
                        ];
                        
                        // Guardar token para próximas sessões
                        localStorage.setItem('eventToken', token);
                        
                        scannedGuests = new Set();
                        showMainApp();
                        startMonitoring();
                        updateUI();
                        return;
                    }
                    throw new Error('Token inválido ou expirado');
                }
                
                currentClient = client;
                
                // Guardar token para próximas sessões
                localStorage.setItem('eventToken', token);
                
                await loadSession();
                showMainApp();
                startMonitoring();
                
            } catch (error) {
                loginError.textContent = error.message;
                loginError.classList.remove('hidden');
            } finally {
                document.getElementById('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
            }
        });

        // Iniciar monitoramento
        function startMonitoring() {
            // Verificar conexão real a cada 3 segundos
            connectionCheckInterval = setInterval(async () => {
                const currentConnectionStatus = await checkRealConnection();
                
                // Só atualizar se o status mudou
                if (currentConnectionStatus !== isOnline) {
                    updateConnectionStatus(currentConnectionStatus);
                }
            }, 3000);
            
            // Verificar validade do token a cada 30 segundos (só se online)
            tokenCheckInterval = setInterval(async () => {
                if (isOnline) {
                    const isValid = await checkTokenValidity();
                    if (!isValid) {
                        showNotification('Token expirado! A redireccionar para o login...', 'error');
                        setTimeout(() => {
                            logout();
                        }, 2000);
                    }
                }
            }, 30000);
            
            // Listeners para eventos de conexão do navegador
            window.addEventListener('online', async () => {
                // Verificar conexão real quando navegador diz que está online
                const realConnection = await checkRealConnection();
                if (realConnection && !isOnline) {
                    updateConnectionStatus(true);
                }
            });
            
            window.addEventListener('offline', () => {
                // Quando navegador detecta offline, atualizar imediatamente
                if (isOnline) {
                    updateConnectionStatus(false);
                }
            });
        }

        // Parar monitoramento
        function stopMonitoring() {
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            if (tokenCheckInterval) clearInterval(tokenCheckInterval);
        }

        // Carregar sessão
        async function loadSession() {
            try {
                if (!supabaseClient) {
                    throw new Error('Cliente Supabase não inicializado');
                }
                
                // Carregar convidados usando token_cliente
                const { data: guestData, error: guestError } = await supabaseClient
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentClient.token);
                
                if (guestError) throw guestError;
                
                guests = guestData || [];
                
                // Carregar histórico de scans usando token
                const { data: scanData, error: scanError } = await supabaseClient
                    .from('logs')
                    .select('*')
                    .eq('token', currentClient.token);
                
                if (scanError) throw scanError;
                
                // Criar set de códigos já escaneados
                scannedGuests = new Set(scanData
                    .filter(log => log.status === 'escaneado')
                    .map(log => {
                        // Encontrar convidado pelo código no log
                        const guest = guests.find(g => g.codigo === log.dispositivo);
                        return guest ? guest.id : null;
                    })
                    .filter(id => id !== null)
                );
                
                updateUI();
                checkMilestones();
                
            } catch (error) {
                console.error('Erro ao carregar sessão:', error);
                showNotification('Erro ao carregar dados', 'error');
            }
        }

        // Mostrar app principal
        function showMainApp() {
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            eventTitle.textContent = currentClient.nome || 'Evento';
        }

        // Controle das abas
        function switchTab(tabName) {
            // Remover classe active de todas as abas
            scannerTab.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-blue-500');
            scannerTab.classList.add('text-gray-500', 'border-transparent');
            
            optionsTab.classList.remove('active', 'bg-blue-50', 'text-blue-600', 'border-blue-500');
            optionsTab.classList.add('text-gray-500', 'border-transparent');
            
            // Esconder todo o conteúdo das abas
            scannerTabContent.classList.add('hidden');
            optionsTabContent.classList.add('hidden');
            
            // Ativar aba selecionada
            if (tabName === 'scanner') {
                scannerTab.classList.add('active', 'bg-blue-50', 'text-blue-600', 'border-blue-500');
                scannerTab.classList.remove('text-gray-500', 'border-transparent');
                scannerTabContent.classList.remove('hidden');
            } else if (tabName === 'options') {
                optionsTab.classList.add('active', 'bg-blue-50', 'text-blue-600', 'border-blue-500');
                optionsTab.classList.remove('text-gray-500', 'border-transparent');
                optionsTabContent.classList.remove('hidden');
            }
        }

        // Atualizar interface
        function updateUI() {
            totalGuests.textContent = guests.length;
            scannedCount.textContent = scannedGuests.size;
            
            const confirmed = guests.filter(g => scannedGuests.has(g.id)).length;
            const pending = guests.length - confirmed;
            
            // Atualizar estatísticas principais
            confirmedCount.textContent = confirmed;
            pendingCount.textContent = pending;
            
            // Atualizar barra de progresso (dashboard)
            const progressPercentage = guests.length > 0 ? Math.round((confirmed / guests.length) * 100) : 0;
            progressBar.style.width = `${progressPercentage}%`;
            progressText.textContent = `${progressPercentage}% dos convidados digitalizados`;
            
            // Atualizar barra de progresso do scanner
            scannerProgressBar.style.width = `${progressPercentage}%`;
            scannerProgressText.textContent = `${progressPercentage}%`;
            scannerScannedCount.textContent = confirmed;
            scannerTotalGuestCount.textContent = guests.length;
            
            // Atualizar limites usando os campos corretos
            const limit = currentClient?.limite_scans || '∞';
            scanLimit.textContent = limit;
            scanUsed.textContent = currentClient?.scans_usados || scannedGuests.size;
            
            renderGuestList();
        }

        // Verificar marcos e notificações
        function checkMilestones() {
            const scannedCount = scannedGuests.size;
            const totalCount = guests.length;
            
            // Marcos de quantidade
            if (scannedCount === 10) {
                showNotification('🎉 10 convidados digitalizados!', 'success');
            } else if (scannedCount === 50) {
                showNotification('🚀 50 convidados digitalizados!', 'success');
            } else if (scannedCount === 100) {
                showNotification('💯 100 convidados digitalizados!', 'success');
            }
            
            // Capacidade do evento (80%)
            if (totalCount > 0 && (scannedCount / totalCount) >= 0.8) {
                showNotification(⚠️ 80% da capacidade atingida!', 'warning');
            }
        }

        // Sistema de notificações
        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${colors[type]}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Remover após duração
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, duration);
        }

        // Renderizar lista de convidados
        function renderGuestList() {
            const searchTerm = searchInput.value.toLowerCase();
            const filter = filterSelect.value;
            
            let filteredGuests = guests.filter(guest => {
                const matchesSearch = guest.nome.toLowerCase().includes(searchTerm) ||
                                    (guest.codigo && guest.codigo.toLowerCase().includes(searchTerm));
                
                if (filter === 'scanned') return matchesSearch && scannedGuests.has(guest.id);
                if (filter === 'pending') return matchesSearch && !scannedGuests.has(guest.id);
                return matchesSearch;
            });
            
            if (filteredGuests.length === 0) {
                guestList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-search text-3xl mb-2"></i>
                        <p>Nenhum convidado encontrado</p>
                    </div>
                `;
                return;
            }
            
            guestList.innerHTML = filteredGuests.map(guest => {
                const isScanned = scannedGuests.has(guest.id);
                const statusClass = isScanned ? 'scanned' : 'pending';
                const statusIcon = isScanned ? 'fa-check-circle' : 'fa-clock';
                const statusText = isScanned ? 'Escaneado' : 'Pendente';
                
                return `
                    <div class="guest-card ${statusClass} text-white p-4 rounded-lg mb-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${guest.nome}</h3>

                            </div>
                            <div class="text-right">
                                <i class="fas ${statusIcon} text-xl mb-1"></i>
                                <p class="text-sm">${statusText}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Scanner QR Code
        toggleScanner.addEventListener('click', () => {
            if (isScanning) {
                stopScanner();
            } else {
                startScanner();
            }
        });

        async function startScanner() {
            try {
                html5QrCode = new Html5Qrcode("scannerContainer");
                
                await html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 350, height: 350 }
                    },
                    onScanSuccess,
                    onScanFailure
                );
                
                isScanning = true;
                toggleScanner.innerHTML = '<i class="fas fa-stop mr-2"></i>Parar Scanner';
                toggleScanner.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                toggleScanner.classList.add('bg-red-600', 'hover:bg-red-700');
                
            } catch (error) {
                console.error('Erro ao iniciar scanner:', error);
                showScanResult('Erro ao acessar câmera', 'error');
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    scannerContainer.innerHTML = `
                        <div class="text-center text-gray-400 px-6">
                            <i class="fas fa-qrcode text-6xl sm:text-7xl mb-6 text-gray-500"></i>
                            <p class="text-lg sm:text-xl font-medium">Scanner parado</p>
                            <p class="text-sm sm:text-base mt-2 text-gray-500">Clique em "Iniciar Scanner" para recomeçar</p>
                        </div>
                    `;
                });
            }
            
            isScanning = false;
            toggleScanner.innerHTML = '<i class="fas fa-qrcode mr-2"></i><i class="fas fa-play mr-2"></i>Iniciar Scanner';
            toggleScanner.classList.remove('bg-red-600', 'hover:bg-red-700');
            toggleScanner.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        async function onScanSuccess(decodedText) {
            // Se já processou um scan e não está no modo rápido, pausar
            if (scanPaused && !settings.quickMode) {
                return;
            }
            
            try {
                // Pausar scanner após primeiro scan (se não estiver no modo rápido)
                if (!settings.quickMode) {
                    scanPaused = true;
                }
                
                // Verificar conexão
                if (!isOnline) {
                    showScanResult('Sem conexão com internet', 'error');
                    showNextScanButton();
                    return;
                }
                
                // Procurar convidado pelo código (busca exata e segura)
                const guest = guests.find(g => {
                    // Verificar se o código escaneado corresponde exatamente ao código do convidado
                    return g.codigo && g.codigo.trim().toLowerCase() === decodedText.trim().toLowerCase();
                });
                
                if (!guest) {
                    showScanResult('INVÁLIDO', '', 'error');
                    playFeedback('error');
                    showNextScanButton();
                    return;
                }
                
                if (scannedGuests.has(guest.id)) {
                    showScanResult('USADO', guest.nome, 'warning');
                    playFeedback('warning');
                    showNextScanButton();
                    return;
                }
                
                // Verificar limite de scans
                const limit = currentClient?.limite_scans;
                const usedScans = currentClient?.scans_usados || 0;
                if (limit && usedScans >= limit) {
                    showScanResult('LIMITE ATINGIDO', '', 'error');
                    playFeedback('error');
                    showNextScanButton();
                    return;
                }
                
                // Registrar scan no Supabase
                const { error: logError } = await supabaseClient
                    .from('logs')
                    .insert({
                        token: currentClient.token,
                        data: new Date().toISOString(),
                        status: 'escaneado',
                        dispositivo: guest.codigo
                    });
                
                if (logError) throw logError;
                
                // Atualizar contador de scans usados no cliente
                const { error: updateError } = await supabaseClient
                    .from('clientes')
                    .update({ 
                        scans_usados: (currentClient.scans_usados || 0) + 1 
                    })
                    .eq('token', currentClient.token);
                
                if (updateError) throw updateError;
                
                // Atualizar status do convidado
                const { error: guestError } = await supabaseClient
                    .from('convidados')
                    .update({ status: 'escaneado' })
                    .eq('id', guest.id);
                
                if (guestError) throw guestError;
                
                // Atualizar estado local
                currentClient.scans_usados = (currentClient.scans_usados || 0) + 1;
                scannedGuests.add(guest.id);
                lastScanResult = { guest, success: true };
                updateUI();
                checkMilestones();
                
                showScanResult('PERMITIDO', guest.nome, 'success');
                playFeedback('success');
                
                // Mostrar botão próximo se não estiver no modo rápido
                if (!settings.quickMode) {
                    showNextScanButton();
                }
                
            } catch (error) {
                console.error('Erro ao processar scan:', error);
                showScanResult('ERRO', '', 'error');
                playFeedback('error');
                showNextScanButton();
            }
        }

        // Mostrar botão próximo
        function showNextScanButton() {
            if (!settings.quickMode) {
                nextScanContainer.classList.remove('hidden');
            }
        }

        // Feedback sonoro e vibração
        function playFeedback(type) {
            // Vibração
            if (settings.vibrationEnabled && navigator.vibrate) {
                const patterns = {
                    success: [200],
                    warning: [100, 100, 100],
                    error: [300, 100, 300]
                };
                navigator.vibrate(patterns[type] || [200]);
            }
            
            // Som (simulado com Web Audio API)
            if (settings.soundEnabled) {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    const frequencies = {
                        success: 800,
                        warning: 600,
                        error: 400
                    };
                    
                    oscillator.frequency.setValueAtTime(frequencies[type] || 600, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    // Ignorar erros de áudio
                }
            }
        }

        function onScanFailure(error) {
            // Ignorar erros de scan (muito verboso)
        }

        function showScanResult(status, guestName, type) {
            const styles = {
                success: {
                    bg: 'bg-gradient-to-r from-green-50 to-emerald-50',
                    border: 'border-l-green-500',
                    text: 'text-green-800',
                    icon: 'fas fa-check-circle text-green-500',
                    shadow: 'shadow-green-200'
                },
                error: {
                    bg: 'bg-gradient-to-r from-red-50 to-rose-50',
                    border: 'border-l-red-500',
                    text: 'text-red-800',
                    icon: 'fas fa-times-circle text-red-500',
                    shadow: 'shadow-red-200'
                },
                warning: {
                    bg: 'bg-gradient-to-r from-yellow-50 to-amber-50',
                    border: 'border-l-yellow-500',
                    text: 'text-yellow-800',
                    icon: 'fas fa-exclamation-triangle text-yellow-500',
                    shadow: 'shadow-yellow-200'
                }
            };
            
            const style = styles[type];
            const scanResultPlaceholder = document.getElementById('scanResultPlaceholder');
            
            // Esconder placeholder
            scanResultPlaceholder.classList.add('hidden');
            
            scanResult.className = `p-4 rounded-lg text-center border-l-4 transform transition-all duration-300 ${style.bg} ${style.border} ${style.text} ${style.shadow}`;
            
            if (guestName) {
                scanResult.innerHTML = `
                    <div class="flex items-center justify-center mb-3">
                        <i class="${style.icon} text-3xl"></i>
                    </div>
                    <div class="text-xl font-bold mb-1">${status}</div>
                    <div class="text-sm font-medium opacity-80">${guestName}</div>
                `;
            } else {
                scanResult.innerHTML = `
                    <div class="flex items-center justify-center mb-3">
                        <i class="${style.icon} text-3xl"></i>
                    </div>
                    <div class="text-xl font-bold">${status}</div>
                `;
            }
            
            scanResult.classList.remove('hidden');
            
            // Auto-hide após 5 segundos se estiver no modo rápido
            if (settings.quickMode) {
                setTimeout(() => {
                    scanResult.classList.add('hidden');
                    scanResultPlaceholder.classList.remove('hidden');
                }, 5000);
            }
        }

        // Busca e filtros
        searchInput.addEventListener('input', renderGuestList);
        filterSelect.addEventListener('change', renderGuestList);

        // Sincronizar dados
        syncBtn.addEventListener('click', async () => {
            if (!isOnline) {
                showNotification('Sem conexão para sincronizar', 'error');
                return;
            }
            
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...';
            try {
                await loadSession();
                showNotification('Dados sincronizados com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao sincronizar dados', 'error');
            } finally {
                syncBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Sincronizar Dados';
            }
        });

        // Exportar relatório
        exportBtn.addEventListener('click', () => {
            const data = {
                evento: currentClient.nome,
                total_convidados: guests.length,
                total_escaneados: scannedGuests.size,
                data_exportacao: new Date().toLocaleString('pt-BR'),
                convidados: guests.map(guest => ({
                    nome: guest.nome,
                    email: guest.email,
                    status: scannedGuests.has(guest.id) ? 'Escaneado' : 'Pendente'
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_${currentClient.nome}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Botão próximo scan
        nextScanBtn.addEventListener('click', () => {
            scanPaused = false;
            nextScanContainer.classList.add('hidden');
            scanResult.classList.add('hidden');
            document.getElementById('scanResultPlaceholder').classList.remove('hidden');
        });

        // Event listeners para configurações
        document.getElementById('quickModeToggle').addEventListener('change', (e) => {
            settings.quickMode = e.target.checked;
            localStorage.setItem('scannerSettings', JSON.stringify(settings));
            showNotification(settings.quickMode ? 'Modo rápido ativado' : 'Modo rápido desativado', 'info');
        });

        document.getElementById('flashModeToggle').addEventListener('change', (e) => {
            settings.flashMode = e.target.checked;
            localStorage.setItem('scannerSettings', JSON.stringify(settings));
            showNotification(settings.flashMode ? 'Flash ativado' : 'Flash desativado', 'info');
        });

        document.getElementById('soundToggle').addEventListener('change', (e) => {
            settings.soundEnabled = e.target.checked;
            localStorage.setItem('scannerSettings', JSON.stringify(settings));
            showNotification(settings.soundEnabled ? 'Som ativado' : 'Som desativado', 'info');
        });

        document.getElementById('vibrationToggle').addEventListener('change', (e) => {
            settings.vibrationEnabled = e.target.checked;
            localStorage.setItem('scannerSettings', JSON.stringify(settings));
            showNotification(settings.vibrationEnabled ? 'Vibração ativada' : 'Vibração desativada', 'info');
        });

        // Event listeners para temas
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    settings.theme = e.target.value;
                    localStorage.setItem('scannerSettings', JSON.stringify(settings));
                    applyTheme(settings.theme);
                    showNotification('Tema alterado com sucesso', 'success');
                }
            });
        });



        // Função para aplicar tema
        function applyTheme(theme) {
            document.body.classList.remove('dark', 'dark-gray');
            if (theme === 'dark') {
                document.body.classList.add('dark');
            } else if (theme === 'darkGray') {
                document.body.classList.add('dark-gray');
            }
        }

        // Função para resetar configurações
        function resetSettings() {
            settings = {
                quickMode: false,
                flashMode: false,
                soundEnabled: true,
                vibrationEnabled: true,
                theme: 'light'
            };
            
            // Atualizar interface
            document.getElementById('quickModeToggle').checked = settings.quickMode;
            document.getElementById('flashModeToggle').checked = settings.flashMode;
            document.getElementById('soundToggle').checked = settings.soundEnabled;
            document.getElementById('vibrationToggle').checked = settings.vibrationEnabled;
            document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
            
            // Aplicar tema
            applyTheme(settings.theme);
            
            // Salvar
            localStorage.setItem('scannerSettings', JSON.stringify(settings));
        }

        // Função para carregar configurações salvas
        function loadSettings() {
            const savedSettings = localStorage.getItem('scannerSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
                
                // Atualizar interface
                document.getElementById('quickModeToggle').checked = settings.quickMode;
                document.getElementById('flashModeToggle').checked = settings.flashMode;
                document.getElementById('soundToggle').checked = settings.soundEnabled;
                document.getElementById('vibrationToggle').checked = settings.vibrationEnabled;
                document.querySelector(`input[name="theme"][value="${settings.theme}"]`).checked = true;
                
                // Aplicar tema
                applyTheme(settings.theme);
            }
        }

        // Logout
        function logout() {
            if (isScanning) stopScanner();
            stopMonitoring();
            currentClient = null;
            guests = [];
            scannedGuests.clear();
            scanPaused = false;
            
            // Manter token mascarado após logout
            const savedToken = localStorage.getItem('eventToken');
            if (savedToken) {
                realToken = savedToken;
                tokenInput.value = '********';
                tokenInput.style.color = '#6b7280';
                tokenInput.style.fontFamily = 'monospace';
                
                // Adicionar texto de ajuda se não existir
                let helpText = document.getElementById('tokenHelp');
                if (!helpText) {
                    helpText = document.createElement('p');
                    helpText.id = 'tokenHelp';
                    helpText.className = 'text-xs text-gray-500 mt-1';
                    helpText.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Token guardado - clique em Entrar';
                    tokenInput.parentNode.appendChild(helpText);
                }
            }
            
            loginScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }

        logoutBtn.addEventListener('click', logout);

        // Função para alternar seções colapsáveis
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        // Event listeners das abas
        scannerTab.addEventListener('click', () => switchTab('scanner'));
        optionsTab.addEventListener('click', () => switchTab('options'));
        
        // Botão de ação rápida para ir ao scanner
        quickScanBtn.addEventListener('click', () => switchTab('scanner'));
        
        // Botão de atualizar dados
        refreshDataBtn.addEventListener('click', async () => {
            if (!isOnline) {
                return; // Não fazer nada se offline, botão já está desabilitado
            }
            
            refreshDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
            try {
                await loadSession();
                showNotification('Dados atualizados com sucesso!', 'success');
            } catch (error) {
                showNotification('Erro ao atualizar dados', 'error');
            } finally {
                refreshDataBtn.innerHTML = '<i class="fas fa-refresh mr-2"></i>Atualizar';
            }
        });

        // Variável para armazenar o token real
        let realToken = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Atualizar ano automaticamente
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Carregar token salvo automaticamente
            const savedToken = localStorage.getItem('eventToken');
            if (savedToken) {
                realToken = savedToken;
                tokenInput.value = '********';
                tokenInput.style.color = '#6b7280';
                tokenInput.style.fontFamily = 'monospace';
                
                // Adicionar texto de ajuda
                const helpText = document.createElement('p');
                helpText.id = 'tokenHelp';
                helpText.className = 'text-xs text-gray-500 mt-1';
                helpText.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Token guardado - clique em Entrar';
                tokenInput.parentNode.appendChild(helpText);
            }
            
            // Controlar comportamento do campo de token
            tokenInput.addEventListener('focus', () => {
                if (tokenInput.value === '********' && realToken) {
                    tokenInput.value = '';
                    tokenInput.style.color = '#374151';
                    tokenInput.style.fontFamily = 'Inter, sans-serif';
                    realToken = null; // Limpar token salvo se usuário começar a digitar
                    
                    // Remover texto de ajuda
                    const helpText = document.getElementById('tokenHelp');
                    if (helpText) helpText.remove();
                }
            });
            
            tokenInput.addEventListener('input', () => {
                if (realToken && tokenInput.value !== '********') {
                    realToken = null; // Limpar token salvo se usuário digitar algo
                    
                    // Remover texto de ajuda
                    const helpText = document.getElementById('tokenHelp');
                    if (helpText) helpText.remove();
                }
            });
            
            // Carregar configurações salvas
            loadSettings();
            
            // Inicializar na aba do scanner
            switchTab('scanner');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96afa807f48c77e3',t:'MTc1NDQ5NTA3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
