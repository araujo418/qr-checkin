<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invites Digitais</title>
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDah3W_j437Ute0WvLaAo1MdoM8XSZrkPU",
      authDomain: "invites-digitais.firebaseapp.com",
      projectId: "invites-digitais",
      storageBucket: "invites-digitais.firebasestorage.app",
      messagingSenderId: "493623104477",
      appId: "1:493623104477:web:ac1ba84fce18da6f78dc34"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.login = async () => {
      const username = document.getElementById("username").value.trim();
      const senha = document.getElementById("senha").value.trim();
      if (!username || !senha) return alert("Preencha ambos os campos.");

      const userRef = doc(db, "usuarios", username);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) return alert("Utilizador não encontrado.");
      const userData = userSnap.data();

      if (userData.senha !== senha) return alert("Palavra-passe inválida.");

      const eventDate = new Date(userData.dataEvento);
      const now = new Date();
      if (eventDate < now) return alert("Acesso expirado. Contacte o organizador.");

      document.getElementById("inicio").style.display = "none";
      document.getElementById("app").style.display = "block";

      startCountdown(eventDate);
      loadGuestList(username);
    };

    function startCountdown(targetDate) {
      const el = document.getElementById("contador");
      function updateCountdown() {
        const now = new Date();
        const diff = targetDate - now;
        if (diff <= 0) {
          el.textContent = "Evento iniciado";
          return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        el.textContent = `${d}d ${h}h ${m}m ${s}s`;
        requestAnimationFrame(updateCountdown);
      }
      updateCountdown();
    }

    async function loadGuestList(username) {
      const listRef = collection(db, "convidados", username, "lista");
      const snapshot = await getDocs(listRef);
      const ul = document.getElementById("guestList");
      ul.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.nome} (${data.codigo}) ${data.usado ? '✔️' : ''}`;
        ul.appendChild(li);
      });
    }
  </script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    header, section, main { padding: 20px; }
    header { background: #6a5acd; color: white; text-align: center; }
    nav button { margin: 5px; padding: 10px; cursor: pointer; }
    #loginForm input { display: block; margin: 10px 0; padding: 10px; width: 100%; }
    #app { display: none; background: white; padding: 20px; }
  </style>
</head>
<body>
  <div id="inicio">
    <header>
      <h1>Invites Digitais</h1>
      <nav>
        <button onclick="document.getElementById('info').textContent='Somos uma empresa pioneira na criação de convites digitais, estamos activos desde 2022 e somos uma das melhores empresas em Angola.'">Quem somos</button>
        <button onclick="document.getElementById('info').innerHTML='WhatsApp: 959 823 409<br>Localização: Viana; Luanda Sul'">Contactos</button>
        <button onclick="document.getElementById('loginBox').style.display='block'">Entrar</button>
      </nav>
    </header>
    <section id="info" style="min-height: 60px;"></section>
    <section id="loginBox" style="display:none">
      <h2>Login</h2>
      <div id="loginForm">
        <input id="username" placeholder="Nome de utilizador" />
        <input id="senha" type="password" placeholder="Palavra-passe" />
        <button onclick="login()">Entrar</button>
      </div>
    </section>
  </div>

  <main id="app">
    <h2>Área do Cliente</h2>
    <p>Contagem regressiva até ao evento: <strong id="contador"></strong></p>
    <h3>Lista de Convidados</h3>
    <ul id="guestList"></ul>
    <!-- Aqui virão os botões de scan e verificar, posteriormente -->
  </main>
</body>
</html>
