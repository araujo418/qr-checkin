<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>InvitesQR - Leitor de Convites</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .fullscreen-scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }
        .scanner-video {
            flex: 1;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid #fff;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
        .scanner-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        .scanner-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10001;
        }
        .result-allowed {
            background: #10b981;
            color: white;
        }
        .result-used {
            background: #ef4444;
            color: white;
        }
        .result-invalid {
            background: #ef4444;
            color: white;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        .guest-item {
            transition: all 0.3s ease;
        }
        .guest-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .guest-scanned {
            background: #f0fdf4;
            border-color: #22c55e;
        }
        .guest-not-scanned {
            background: #fefefe;
            border-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Token Input Modal -->
    <div id="tokenModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üîê Acesso ao Sistema</h3>
                <p class="text-sm text-gray-600 mt-1">Digite o token do cliente para continuar</p>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Token do Cliente</label>
                        <input type="text" id="tokenInput" class="w-full border border-gray-300 rounded-lg px-4 py-3" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    </div>
                    <div id="tokenError" class="text-red-600 text-sm hidden"></div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button id="validateTokenBtn" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90">
                    ‚úÖ Validar Token
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                            <span class="text-xl">üì±</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">InvitesQR Reader</h1>
                            <p class="text-sm opacity-90" id="clientName">Carregando...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm opacity-90">Scans realizados</p>
                            <p class="text-lg font-semibold" id="scanCount">0</p>
                        </div>
                        <button id="logoutBtn" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30">
                            <span class="text-sm">üö™</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-6">
                <div class="flex space-x-8">
                    <button class="tab-btn py-4 px-2 border-b-2 font-medium text-sm tab-active" data-tab="scanner">
                        üì± Scanner
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-tab="guests">
                        üë• Convidados
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8">
            <!-- Scanner Tab -->
            <div id="scanner" class="tab-content">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-md p-8 text-center">
                        <div class="mb-8">
                            <div class="w-24 h-24 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-4xl text-white">üì±</span>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Scanner de QR Codes</h2>
                            <p class="text-gray-600">Clique no bot√£o abaixo para iniciar o scanner</p>
                        </div>

                        <button id="startScanBtn" class="gradient-bg text-white px-8 py-4 rounded-lg text-lg font-semibold hover:opacity-90 mb-6">
                            üéØ Iniciar Scanner
                        </button>
                        
                        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h3 class="font-semibold text-yellow-800 mb-2">üß™ Teste do Scanner</h3>
                            <p class="text-sm text-yellow-700 mb-3">Use este QR code para testar o scanner:</p>
                            <div id="testQR" class="flex justify-center mb-3"></div>
                            <button id="generateTestQR" class="bg-yellow-600 text-white px-4 py-2 rounded text-sm hover:bg-yellow-700">
                                Gerar QR de Teste
                            </button>
                        </div>

                        <!-- Progress Ring -->
                        <div class="flex justify-center mb-6">
                            <div class="relative">
                                <svg class="progress-ring w-32 h-32" width="120" height="120">
                                    <circle class="progress-ring-circle stroke-gray-200" stroke-width="8" fill="transparent" r="52" cx="60" cy="60"/>
                                    <circle id="progressCircle" class="progress-ring-circle stroke-blue-600" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="327" stroke-dashoffset="327"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="progressText" class="text-2xl font-bold text-gray-700">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-2xl font-bold text-green-600" id="allowedCount">0</p>
                                <p class="text-sm text-green-700">Permitidos</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-4">
                                <p class="text-2xl font-bold text-red-600" id="usedCount">0</p>
                                <p class="text-sm text-red-700">J√° Usados</p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4">
                                <p class="text-2xl font-bold text-orange-600" id="invalidCount">0</p>
                                <p class="text-sm text-orange-700">Inv√°lidos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Guests Tab -->
            <div id="guests" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Lista de Convidados</h2>
                    <div class="flex space-x-4">
                        <input type="text" id="guestSearch" placeholder="Buscar convidado..." class="border border-gray-300 rounded-lg px-4 py-2">
                        <select id="statusFilter" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todos</option>
                            <option value="scanned">Escaneados</option>
                            <option value="not-scanned">N√£o Escaneados</option>
                        </select>
                    </div>
                </div>

                <!-- Guest Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <span class="text-2xl">üë•</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total</p>
                                <p class="text-2xl font-semibold text-gray-900" id="totalGuests">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Escaneados</p>
                                <p class="text-2xl font-semibold text-gray-900" id="scannedGuests">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                                <span class="text-2xl">‚è≥</span>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Pendentes</p>
                                <p class="text-2xl font-semibold text-gray-900" id="pendingGuests">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guests List -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6">
                        <div id="guestsList" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <span class="text-4xl">üë•</span>
                                <p class="mt-2">Carregando convidados...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Fullscreen Scanner -->
    <div id="fullscreenScanner" class="fullscreen-scanner hidden">
        <div class="scanner-controls">
            <button id="closeScannerBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 mr-2">
                ‚ùå Fechar
            </button>
            <button id="toggleDebugBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                üîç Debug
            </button>
        </div>
        <video id="scannerVideo" class="scanner-video" autoplay playsinline></video>
        <div class="scanner-overlay"></div>
        <canvas id="scannerCanvas" style="display: none;"></canvas>
        <div id="scanResult" class="scanner-result hidden"></div>
        <div id="debugInfo" style="position: absolute; top: 80px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 10002; display: none;">
            <div>Status: <span id="debugStatus">Iniciando...</span></div>
            <div>Video: <span id="debugVideo">-</span></div>
            <div>Canvas: <span id="debugCanvas">-</span></div>
            <div>Scans: <span id="debugScans">0</span></div>
            <div>√öltimo QR: <span id="debugLastQR">Nenhum</span></div>
            <div>QRs Detectados: <span id="debugQRCount">0</span></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables
        let currentToken = null;
        let clientData = null;
        let guests = [];
        let scanHistory = {};
        let scanStats = {
            allowed: 0,
            used: 0,
            invalid: 0
        };
        let isScanning = false;
        let scannerStream = null;

        // Mobile detection
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Block desktop access
            if (!isMobileDevice()) {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gray-100">
                        <div class="text-center p-8">
                            <div class="text-6xl mb-4">üì±</div>
                            <h1 class="text-2xl font-bold text-gray-900 mb-2">Acesso Restrito</h1>
                            <p class="text-gray-600">Este sistema √© exclusivo para dispositivos m√≥veis.</p>
                            <p class="text-sm text-gray-500 mt-4">Acesse atrav√©s do seu smartphone ou tablet.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            // Security: Disable developer tools
            disableDevTools();
            
            // Check for saved token
            const savedToken = localStorage.getItem('invitesqr_token');
            const savedTokenTime = localStorage.getItem('invitesqr_token_time');
            const savedHistory = localStorage.getItem('invitesqr_scan_history');
            const savedStats = localStorage.getItem('invitesqr_scan_stats');

            // Security: Check token age (24 hours max)
            if (savedToken && savedTokenTime) {
                const tokenAge = Date.now() - parseInt(savedTokenTime);
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                
                if (tokenAge > maxAge) {
                    localStorage.removeItem('invitesqr_token');
                    localStorage.removeItem('invitesqr_token_time');
                    showTokenModal();
                    return;
                }
            }

            if (savedHistory) {
                try {
                    scanHistory = JSON.parse(savedHistory);
                } catch (e) {
                    scanHistory = {};
                }
            }

            if (savedStats) {
                try {
                    scanStats = JSON.parse(savedStats);
                    updateScannerStats();
                } catch (e) {
                    scanStats = { allowed: 0, used: 0, invalid: 0 };
                }
            }

            if (savedToken) {
                validateToken(savedToken, false);
            } else {
                showTokenModal();
            }
        }

        function setupEventListeners() {
            // Token validation
            document.getElementById('validateTokenBtn').addEventListener('click', () => {
                const token = document.getElementById('tokenInput').value.trim();
                if (token) {
                    validateToken(token, true);
                }
            });

            // Enter key for token input
            document.getElementById('tokenInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const token = document.getElementById('tokenInput').value.trim();
                    if (token) {
                        validateToken(token, true);
                    }
                }
            });

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Scanner controls
            document.getElementById('startScanBtn').addEventListener('click', startFullscreenScanner);
            document.getElementById('closeScannerBtn').addEventListener('click', stopScanner);
            document.getElementById('toggleDebugBtn').addEventListener('click', toggleDebugInfo);
            document.getElementById('generateTestQR').addEventListener('click', generateTestQR);

            // Guest filters
            document.getElementById('guestSearch').addEventListener('input', filterGuests);
            document.getElementById('statusFilter').addEventListener('change', filterGuests);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Prevent accidental navigation
            window.addEventListener('beforeunload', (e) => {
                if (isScanning) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        async function validateToken(token, showError = true) {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();

                if (error || !data) {
                    if (showError) {
                        showTokenError('Token inv√°lido ou n√£o encontrado');
                    }
                    return;
                }

                // Check if token is expired
                if (data.validade < Date.now()) {
                    if (showError) {
                        showTokenError('Token expirado');
                    }
                    return;
                }

                // Security: Check scan limit
                if (data.scans_usados >= data.limite_scans) {
                    if (showError) {
                        showTokenError('Limite de scans atingido');
                    }
                    return;
                }

                currentToken = token;
                clientData = data;
                
                // Save token with timestamp for security
                localStorage.setItem('invitesqr_token', token);
                localStorage.setItem('invitesqr_token_time', Date.now().toString());
                
                hideTokenModal();
                showMainApp();
                loadClientData();
                
            } catch (error) {
                console.error('Error validating token:', error);
                if (showError) {
                    showTokenError('Erro ao validar token');
                }
            }
        }

        function showTokenError(message) {
            const errorDiv = document.getElementById('tokenError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function showTokenModal() {
            document.getElementById('tokenModal').classList.remove('hidden');
            document.getElementById('tokenInput').focus();
        }

        function hideTokenModal() {
            document.getElementById('tokenModal').classList.add('hidden');
            document.getElementById('tokenError').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('mainApp').classList.remove('hidden');
        }

        async function loadClientData() {
            try {
                // Update client info
                document.getElementById('clientName').textContent = clientData.nome;
                
                // Load guests
                const { data: guestsData } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentToken)
                    .eq('status', 'ativo');

                guests = guestsData || [];
                updateGuestStats();
                renderGuests();
                updateProgress();
                
            } catch (error) {
                console.error('Error loading client data:', error);
                showNotification('Erro ao carregar dados do cliente', 'error');
            }
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('tab-active');
            activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');
        }

        async function startFullscreenScanner() {
            try {
                console.log('Starting scanner...');
                
                // Request camera permission with better constraints
                scannerStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    }
                });

                console.log('Camera stream obtained');
                
                const video = document.getElementById('scannerVideo');
                video.srcObject = scannerStream;
                
                // Show fullscreen scanner
                document.getElementById('fullscreenScanner').classList.remove('hidden');
                
                // Enter fullscreen mode
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }

                isScanning = true;
                
                // Wait for video to load and start scanning
                video.addEventListener('loadeddata', () => {
                    console.log('Video loaded, starting QR scanning');
                    startQRScanning();
                });
                
                // Fallback if video is already loaded
                if (video.readyState >= 2) {
                    console.log('Video already loaded, starting QR scanning immediately');
                    startQRScanning();
                }
                
            } catch (error) {
                console.error('Error starting scanner:', error);
                showNotification('Erro ao acessar c√¢mera. Verifique as permiss√µes.', 'error');
            }
        }

        let scanCount = 0;
        let qrDetectedCount = 0;
        
        function startQRScanning() {
            const video = document.getElementById('scannerVideo');
            const canvas = document.getElementById('scannerCanvas');
            const context = canvas.getContext('2d');
            let scanInterval;
            scanCount = 0;

            updateDebugInfo('Scanning iniciado', `${video.videoWidth}x${video.videoHeight}`, `${canvas.width}x${canvas.height}`, scanCount);

            function scanFrame() {
                if (!isScanning) {
                    if (scanInterval) clearInterval(scanInterval);
                    return;
                }

                try {
                    scanCount++;
                    
                    if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0 && video.videoHeight > 0) {
                        // Set canvas size to match video dimensions
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        // Clear canvas and draw current video frame
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // Try multiple scanning approaches for better recognition
                        const results = [];
                        
                        // 1. Full image scan
                        let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        let code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth",
                        });
                        if (code && code.data) results.push(code.data);
                        
                        // 2. Center crop scan (focus on QR overlay area)
                        const centerX = canvas.width / 2;
                        const centerY = canvas.height / 2;
                        const cropSize = Math.min(canvas.width, canvas.height) * 0.6;
                        const cropX = centerX - cropSize / 2;
                        const cropY = centerY - cropSize / 2;
                        
                        imageData = context.getImageData(cropX, cropY, cropSize, cropSize);
                        code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth",
                        });
                        if (code && code.data) results.push(code.data);
                        
                        // 3. Enhanced contrast scan
                        context.filter = 'contrast(150%) brightness(110%)';
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth",
                        });
                        if (code && code.data) results.push(code.data);
                        context.filter = 'none'; // Reset filter
                        
                        // Update debug info every 10 scans
                        if (scanCount % 10 === 0) {
                            updateDebugInfo('Scanning ativo', `${video.videoWidth}x${video.videoHeight}`, `${canvas.width}x${canvas.height}`, scanCount);
                        }
                        
                        // Process first valid result
                        for (const result of results) {
                            const cleanResult = result.trim();
                            if (cleanResult && cleanResult.length >= 3) {
                                console.log('QR Code detected:', cleanResult);
                                updateDebugInfo('QR Code encontrado!', `${video.videoWidth}x${video.videoHeight}`, `${canvas.width}x${canvas.height}`, scanCount, cleanResult);
                                if (scanInterval) clearInterval(scanInterval);
                                processQRCode(cleanResult);
                                return;
                            }
                        }
                        
                    } else {
                        updateDebugInfo('Video n√£o pronto', `${video.videoWidth || 0}x${video.videoHeight || 0}`, `${canvas.width}x${canvas.height}`, scanCount);
                    }
                } catch (error) {
                    console.error('Error in scan frame:', error);
                    updateDebugInfo('Erro no scan', 'Erro', 'Erro', scanCount);
                }
            }
            
            // Use interval for consistent scanning
            scanInterval = setInterval(scanFrame, 100); // Faster scanning at 100ms
        }

        function updateDebugInfo(status, video, canvas, scans, lastQR = null) {
            const debugStatus = document.getElementById('debugStatus');
            const debugVideo = document.getElementById('debugVideo');
            const debugCanvas = document.getElementById('debugCanvas');
            const debugScans = document.getElementById('debugScans');
            const debugLastQR = document.getElementById('debugLastQR');
            const debugQRCount = document.getElementById('debugQRCount');
            
            if (debugStatus) debugStatus.textContent = status;
            if (debugVideo) debugVideo.textContent = video;
            if (debugCanvas) debugCanvas.textContent = canvas;
            if (debugScans) debugScans.textContent = scans;
            if (lastQR && debugLastQR) {
                debugLastQR.textContent = lastQR.substring(0, 20) + (lastQR.length > 20 ? '...' : '');
                qrDetectedCount++;
                if (debugQRCount) debugQRCount.textContent = qrDetectedCount;
            }
        }

        function toggleDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
            } else {
                debugInfo.style.display = 'none';
            }
        }

        function generateTestQR() {
            // Generate test QR in your specific format
            const testGuests = [
                { codigo: 'EVT001', nome: 'Maria Jo√£o' },
                { codigo: 'EVT002', nome: 'Carlos Alberto' },
                { codigo: 'EVT003', nome: 'Ana Silva' },
                { codigo: 'TEST001', nome: 'Pedro Santos' }
            ];
            
            // Add real guests if available
            if (guests.length > 0) {
                testGuests.push(...guests.slice(0, 2));
            }
            
            const randomGuest = testGuests[Math.floor(Math.random() * testGuests.length)];
            
            // Create QR data in your format
            const futureDate = new Date();
            futureDate.setFullYear(futureDate.getFullYear() + 1);
            const validadeStr = futureDate.toISOString().split('T')[0]; // YYYY-MM-DD format
            
            const qrData = `#validade:${validadeStr}\n${randomGuest.codigo},${randomGuest.nome}`;
            
            console.log('Generated test QR data:', qrData);
            
            const canvas = document.createElement('canvas');
            QRCode.toCanvas(canvas, qrData, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                },
                errorCorrectionLevel: 'M'
            }, function (error) {
                if (error) {
                    console.error('Error generating QR code:', error);
                    return;
                }
                
                const container = document.getElementById('testQR');
                container.innerHTML = '';
                container.appendChild(canvas);
                
                const codeLabel = document.createElement('p');
                codeLabel.textContent = `C√≥digo: ${randomGuest.codigo}`;
                codeLabel.className = 'text-sm text-yellow-700 mt-2 text-center font-semibold';
                container.appendChild(codeLabel);
                
                const nameLabel = document.createElement('p');
                nameLabel.textContent = `Nome: ${randomGuest.nome}`;
                nameLabel.className = 'text-xs text-yellow-700 text-center';
                container.appendChild(nameLabel);
                
                const validityLabel = document.createElement('p');
                validityLabel.textContent = `V√°lido at√©: ${validadeStr}`;
                validityLabel.className = 'text-xs text-yellow-600 text-center';
                container.appendChild(validityLabel);
                
                // Show if this code exists in guest list
                const guestExists = guests.find(g => g.codigo === randomGuest.codigo);
                const statusLabel = document.createElement('p');
                if (guestExists) {
                    statusLabel.textContent = `‚úÖ Convidado cadastrado no sistema`;
                    statusLabel.className = 'text-xs text-green-700 text-center mt-1';
                } else {
                    statusLabel.textContent = `üÜï Convidado ser√° criado automaticamente`;
                    statusLabel.className = 'text-xs text-blue-700 text-center mt-1';
                }
                container.appendChild(statusLabel);
            });
        }

        async function processQRCode(qrData) {
            try {
                console.log('Processing QR data:', qrData);
                
                // Parse QR code data (handle your specific format)
                const parsedData = parseQRData(qrData);
                
                if (!parsedData) {
                    showScanResult('FORMATO INV√ÅLIDO', 'invalid');
                    scanStats.invalid++;
                    await logScan(qrData, 'invalid_format');
                    return;
                }

                const { validade, codigo, nome } = parsedData;
                
                // Check validity date
                if (validade && new Date(validade) < new Date()) {
                    showScanResult('QR EXPIRADO', 'invalid');
                    scanStats.invalid++;
                    await logScan(codigo, 'expired');
                    return;
                }

                // Find guest by code (either in database or from QR data)
                let guest = guests.find(g => g.codigo === codigo);
                
                // If not found in database but has valid format, create temporary guest
                if (!guest && codigo && nome) {
                    guest = {
                        codigo: codigo,
                        nome: nome,
                        status: 'ativo',
                        source: 'qr' // Mark as coming from QR code
                    };
                    console.log('Created temporary guest from QR:', guest);
                }
                
                if (!guest) {
                    showScanResult('C√ìDIGO INV√ÅLIDO', 'invalid');
                    scanStats.invalid++;
                    await logScan(codigo || qrData, 'invalid');
                    return;
                }

                // Security: Check if guest is active
                if (guest.status !== 'ativo') {
                    showScanResult('CONVIDADO INATIVO', 'invalid');
                    scanStats.invalid++;
                    await logScan(guest.codigo, 'inactive');
                    return;
                }

                // Check if already scanned
                if (scanHistory[guest.codigo]) {
                    showScanResult('J√Å USADO', 'used');
                    scanStats.used++;
                    await logScan(guest.codigo, 'used');
                    return;
                }

                // Security: Check scan limit before processing
                if (clientData.scans_usados >= clientData.limite_scans) {
                    showScanResult('LIMITE ATINGIDO', 'invalid');
                    scanStats.invalid++;
                    await logScan(guest.codigo, 'limit_exceeded');
                    return;
                }

                // Mark as scanned
                scanHistory[guest.codigo] = {
                    nome: guest.nome,
                    timestamp: Date.now(),
                    validated: true,
                    source: guest.source || 'database',
                    validade: validade
                };
                
                showScanResult(`PERMITIDO\n${guest.nome}`, 'allowed');
                scanStats.allowed++;
                
                // Save to localStorage with validation
                localStorage.setItem('invitesqr_scan_history', JSON.stringify(scanHistory));
                localStorage.setItem('invitesqr_scan_stats', JSON.stringify(scanStats));
                
                // Log scan with additional info
                await logScan(guest.codigo, 'scan', {
                    nome: guest.nome,
                    validade: validade,
                    source: guest.source || 'database'
                });
                
                // Update UI
                updateScannerStats();
                updateGuestStats();
                updateProgress();
                
                // Update client scan count
                await updateClientScanCount();
                
            } catch (error) {
                console.error('Error processing QR code:', error);
                showScanResult('ERRO', 'invalid');
                scanStats.invalid++;
            }
        }

        function parseQRData(qrData) {
            try {
                const cleanData = qrData.trim();
                console.log('Parsing QR data:', cleanData);
                
                // Handle different QR formats
                
                // Format 1: Your specific format with validity and guest info
                // Example: "#validade:2025-12-31\nEVT001,Maria Jo√£o"
                if (cleanData.includes('#validade:') || cleanData.includes('validade:')) {
                    const lines = cleanData.split('\n').filter(line => line.trim());
                    let validade = null;
                    let guestInfo = null;
                    
                    for (const line of lines) {
                        if (line.includes('validade:')) {
                            validade = line.split('validade:')[1].trim().replace('#', '');
                        } else if (line.includes(',')) {
                            // Guest line: "EVT001,Maria Jo√£o"
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                guestInfo = {
                                    codigo: parts[0].trim(),
                                    nome: parts.slice(1).join(',').trim()
                                };
                            }
                        }
                    }
                    
                    if (guestInfo) {
                        console.log('Parsed format 1:', { validade, ...guestInfo });
                        return { validade, ...guestInfo };
                    }
                }
                
                // Format 2: JSON format
                if (cleanData.startsWith('{') && cleanData.endsWith('}')) {
                    try {
                        const jsonData = JSON.parse(cleanData);
                        if (jsonData.codigo) {
                            console.log('Parsed JSON format:', jsonData);
                            return {
                                codigo: jsonData.codigo,
                                nome: jsonData.nome || jsonData.name || 'Convidado',
                                validade: jsonData.validade || jsonData.validity
                            };
                        }
                    } catch (e) {
                        console.log('Not valid JSON');
                    }
                }
                
                // Format 3: Simple code format (existing guests)
                if (cleanData.length >= 3 && cleanData.length <= 20 && !cleanData.includes('\n')) {
                    const guest = guests.find(g => g.codigo === cleanData);
                    if (guest) {
                        console.log('Parsed simple format:', { codigo: cleanData, nome: guest.nome });
                        return { codigo: cleanData, nome: guest.nome };
                    }
                }
                
                // Format 4: Code with name "CODE,Name"
                if (cleanData.includes(',') && !cleanData.includes('\n')) {
                    const parts = cleanData.split(',');
                    if (parts.length >= 2) {
                        const result = {
                            codigo: parts[0].trim(),
                            nome: parts.slice(1).join(',').trim()
                        };
                        console.log('Parsed code,name format:', result);
                        return result;
                    }
                }
                
                console.log('No valid format found for:', cleanData);
                return null;
                
            } catch (error) {
                console.error('Error parsing QR data:', error);
                return null;
            }
        }

        function showScanResult(message, type) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.textContent = message;
            resultDiv.className = `scanner-result result-${type}`;
            resultDiv.classList.remove('hidden');
            
            // Hide after 3 seconds and resume scanning
            setTimeout(() => {
                resultDiv.classList.add('hidden');
                if (isScanning) {
                    startQRScanning();
                }
            }, 3000);
        }

        async function logScan(codigo, status, extraData = {}) {
            try {
                await supabase.from('logs').insert([{
                    token: currentToken,
                    status: status,
                    data: new Date().toISOString(),
                    codigo: codigo,
                    extra_info: JSON.stringify(extraData)
                }]);
            } catch (error) {
                console.error('Error logging scan:', error);
            }
        }

        async function updateClientScanCount() {
            try {
                const newScanCount = clientData.scans_usados + 1;
                await supabase
                    .from('clientes')
                    .update({ scans_usados: newScanCount })
                    .eq('token', currentToken);
                
                clientData.scans_usados = newScanCount;
                document.getElementById('scanCount').textContent = newScanCount;
            } catch (error) {
                console.error('Error updating scan count:', error);
            }
        }

        function stopScanner() {
            isScanning = false;
            
            // Stop camera stream
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            // Exit fullscreen
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            // Hide scanner
            document.getElementById('fullscreenScanner').classList.add('hidden');
            document.getElementById('scanResult').classList.add('hidden');
        }

        function updateScannerStats() {
            document.getElementById('allowedCount').textContent = scanStats.allowed;
            document.getElementById('usedCount').textContent = scanStats.used;
            document.getElementById('invalidCount').textContent = scanStats.invalid;
            document.getElementById('scanCount').textContent = scanStats.allowed;
        }

        function updateGuestStats() {
            const total = guests.length;
            const scanned = Object.keys(scanHistory).length;
            const pending = total - scanned;
            
            document.getElementById('totalGuests').textContent = total;
            document.getElementById('scannedGuests').textContent = scanned;
            document.getElementById('pendingGuests').textContent = pending;
        }

        function updateProgress() {
            const total = guests.length;
            const scanned = Object.keys(scanHistory).length;
            const percentage = total > 0 ? Math.round((scanned / total) * 100) : 0;
            
            document.getElementById('progressText').textContent = `${percentage}%`;
            
            // Update progress ring
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 52;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        function renderGuests() {
            const container = document.getElementById('guestsList');
            
            if (guests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <span class="text-4xl">üë•</span>
                        <p class="mt-2">Nenhum convidado encontrado</p>
                    </div>
                `;
                return;
            }

            const guestsHtml = guests.map(guest => {
                const isScanned = scanHistory[guest.codigo];
                const scanTime = isScanned ? new Date(isScanned.timestamp).toLocaleString() : null;
                
                return `
                    <div class="guest-item ${isScanned ? 'guest-scanned' : 'guest-not-scanned'} border rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900">${guest.nome}</h3>
                                <div class="flex items-center space-x-4 mt-1 text-sm text-gray-600">
                                    <span>üé´ ${guest.codigo}</span>
                                    ${isScanned ? `<span class="text-green-600">‚úÖ Escaneado em ${scanTime}</span>` : '<span class="text-orange-600">‚è≥ Pendente</span>'}
                                </div>
                            </div>
                            <div class="flex items-center">
                                ${isScanned ? 
                                    '<span class="text-green-600 text-sm font-medium">‚úÖ Confirmado</span>' : 
                                    '<span class="text-orange-600 text-sm font-medium">‚è≥ Aguardando</span>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = guestsHtml;
        }

        function filterGuests() {
            const searchTerm = document.getElementById('guestSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredGuests = guests;
            
            if (searchTerm) {
                filteredGuests = filteredGuests.filter(g => 
                    g.nome.toLowerCase().includes(searchTerm) ||
                    g.codigo.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter === 'scanned') {
                filteredGuests = filteredGuests.filter(g => scanHistory[g.codigo]);
            } else if (statusFilter === 'not-scanned') {
                filteredGuests = filteredGuests.filter(g => !scanHistory[g.codigo]);
            }
            
            // Temporarily update guests array for rendering
            const originalGuests = guests;
            guests = filteredGuests;
            renderGuests();
            guests = originalGuests;
        }

        // Security: Manual guest management functions removed
        // Only QR scanning is allowed for marking guests

        function logout() {
            if (confirm('Tem certeza que deseja sair? O hist√≥rico de scans ser√° mantido.')) {
                // Stop scanner if running
                if (isScanning) {
                    stopScanner();
                }
                
                // Clear token but keep scan history
                localStorage.removeItem('invitesqr_token');
                
                // Reset app state
                currentToken = null;
                clientData = null;
                guests = [];
                
                // Show token modal
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('tokenInput').value = '';
                showTokenModal();
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Handle fullscreen changes
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isScanning) {
                stopScanner();
            }
        });

        // Security: Disable developer tools and right-click
        function disableDevTools() {
            // Disable right-click
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            document.addEventListener('keydown', e => {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                    showNotification('Acesso negado', 'error');
                }
            });
            
            // Detect developer tools
            let devtools = {open: false, orientation: null};
            const threshold = 160;
            
            setInterval(() => {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        document.body.innerHTML = `
                            <div class="min-h-screen flex items-center justify-center bg-red-100">
                                <div class="text-center p-8">
                                    <div class="text-6xl mb-4">üö´</div>
                                    <h1 class="text-2xl font-bold text-red-900 mb-2">Acesso Negado</h1>
                                    <p class="text-red-700">Ferramentas de desenvolvedor n√£o s√£o permitidas.</p>
                                </div>
                            </div>
                        `;
                    }
                }
            }, 500);
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isScanning) {
                stopScanner();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966ed4eb345577e0',t:'MTc1MzgxNTMzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
