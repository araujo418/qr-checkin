<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>InvitesQR Final</title>
  <script src="https://unpkg.com/html5-qrcode@latest"></script>
function verificarOnline() {
  const offline = !navigator.onLine;
  document.getElementById("offlineOverlay").style.display = offline ? "flex" : "none";
}
window.addEventListener('online', verificarOnline);
window.addEventListener('offline', verificarOnline);




function abrirAba(aba) {
  // Scanner
  document.getElementById("scannerContainer").style.display = (aba === 'scanner') ? 'block' : 'none';

  // Lista
  const listaVisivel = (aba === 'lista');
  document.getElementById("guestList").style.display = listaVisivel ? 'block' : 'none';
  document.getElementById("result").style.display = listaVisivel ? 'block' : 'none';
  document.getElementById("searchInput").style.display = listaVisivel ? 'block' : 'none';
  document.querySelector("button[onclick='carregarConvidados()']").style.display = listaVisivel ? 'inline-block' : 'none';
  document.querySelector("button[onclick='baixarCSV()']").style.display = listaVisivel ? 'inline-block' : 'none';
  document.getElementById("progressBar").style.display = listaVisivel ? 'block' : 'none';

  // Info
  const infoVisivel = (aba === 'info');
  document.getElementById("validadeMsg").style.display = infoVisivel ? 'block' : 'none';
  document.getElementById("doneMsg").style.display = infoVisivel ? 'block' : 'none';
}



const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
document.body.classList.toggle("dark", prefersDark);

function alternarTema() {
  document.body.classList.toggle("dark");
}


window.addEventListener("load", () => {
  setTimeout(() => {
    const splash = document.getElementById("splashScreen");
    if (splash) splash.remove();
  }, 2000);
});



async function verificarConexaoReal() {
  try {
    const res = await fetch("https://rnvunprjvppbjavkaoek.supabase.co/rest/v1/clientes?select=id&limit=1", {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    });
    return res.ok;
  } catch {
    return false;
  }
}

async function atualizarEstadoConexao() {
  const online = await verificarConexaoReal();
  document.getElementById("offlineOverlay").style.display = online ? "none" : "flex";
}

setInterval(atualizarEstadoConexao, 5000);
atualizarEstadoConexao();

atualizarEstadoConexao();

</script>
  <style>
    body { margin: 0; background: #121212; color: white; font-family: sans-serif; text-align: center; }
    input, button { padding: 14px; border-radius: 10px; border: none; margin: 10px 0; width: 90%; max-width: 400px; font-size: 1em; }
    input { background: #1f1f1f; color: white; }
    button { background: #6a5acd; color: white; }
    button:hover { background: #5a4ccf; }
    #qr-reader { width: 100%; max-width: 400px; margin: 10px auto; display: none; }
    ul { list-style: none; padding: 0; max-width: 400px; margin: auto; text-align: left; }
    li { padding: 10px; border-bottom: 1px solid #333; font-size: 1em; }
    #whatsapp { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; padding: 12px 14px; border-radius: 50%; font-size: 20px; text-decoration: none; z-index: 999; }
    #modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); color: white; font-size: 1.5em; justify-content: center; align-items: center; z-index: 9999; text-align: center; padding: 20px; }
    progress { width: 90%; height: 14px; border-radius: 8px; background: #444; overflow: hidden; }
    progress::-webkit-progress-value { background: #6a5acd; }
    #offline { display: none; background: #e53e3e; color: white; padding: 10px; font-weight: bold; }
    #scannerContainer { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:10000; }
    #scanFeedback { height:20%; color:white; font-size:1.5em; display:flex; align-items:center; justify-content:center; }
  </style>

<style>
  body.dark { background: #121212; color: white; }
  body:not(.dark) { background: #f0f0f0; color: black; }
</style>
<button onclick="alternarTema()" style="position:fixed;top:10px;left:10px;z-index:1000;">üåì</button>

</head>
<body>

<div id="splashScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#121212;display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div style="width:160px;height:160px;border-radius:50%;padding:8px;background:conic-gradient(from 0deg, #6a5acd, #00ffff, #6a5acd);animation:spin 2s linear infinite;">
    <div style="width:100%;height:100%;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;">
      <img src="./logo_circular.png" alt="Logo" style="width:90%;height:90%;border-radius:50%;" />
    </div>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<style>
  body.dark { background: #121212; color: white; }
  body:not(.dark) { background: #f0f0f0; color: black; }
  input, button, progress { transition: all 0.3s ease; }
  body.dark input { background: #1f1f1f; color: white; }
  body:not(.dark) input { background: #ffffff; color: black; }
  body.dark button { background: #6a5acd; color: white; }
  body:not(.dark) button { background: #6a5acd; color: white; }
  body.dark #bottomNav { background: #1e1e1e; }
  body:not(.dark) #bottomNav { background: #ddd; }
</style>


  <div id="offline">‚ö†Ô∏è Sem conex√£o com a internet</div>
  <h1 id="clienteNome">InvitesQR</h1>
  <p style="font-size: 1.1em; color: #ccc;">Entre em contacto connosco pelo <strong>959 823 409</strong></p>
  <input id="tokenInput" type="text" placeholder="Digite o token do cliente" />
  <button onclick="iniciar(document.getElementById('tokenInput').value)">Entrar</button>
  <div id="app" style="display:none;">

<div id="bottomNav" style="position:fixed;bottom:0;left:0;width:100%;background:#1e1e1e;display:flex;justify-content:space-around;padding:10px 0;z-index:999;">
  <button onclick="abrirAba('scanner')">üì∑ Scanner</button>
  <button onclick="abrirAba('lista')">üìã Lista</button>
  <button onclick="abrirAba('info')">‚öôÔ∏è Info</button>
</div>

    <div id="validadeMsg"></div>
    <button onclick="startScanner()">üì∑ Escanear QR Code</button>
    <div id="scannerContainer">
      <div id="qr-reader" style="width:100%; height:80%;"></div>
      <div id="scanFeedback"></div>
      <button onclick="fecharScanner()" style="position:absolute;top:10px;right:10px;background:red;color:white;padding:10px;border-radius:8px;">‚ùå Fechar</button>
    </div>
    <div id="result">Nenhum convidado validado ainda</div>
    <input id="searchInput" type="text" placeholder="üîç Pesquisar convidado" oninput="filtrarConvidados()" />
    <button onclick="carregarConvidados()">üîÑ Recarregar Lista</button>
    <button onclick="baixarCSV()">üì• Exportar CSV</button>
    <progress id="progressBar" max="100" value="0"></progress>
    <ul id="guestList"></ul>
    <div id="doneMsg" style="display:none;color:#00e676;margin-top:20px;">üéâ Todos os convidados foram validados!</div>
  </div>
  <div id="modal" onclick="this.style.display='none'"></div>
  

<script>
const SUPABASE_URL = "https://rnvunprjvppbjavkaoek.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8";

let scanner = null;
let permitirSom = false;
let token = localStorage.getItem('token');
let deviceId = localStorage.getItem('device_id') || crypto.randomUUID();
localStorage.setItem('device_id', deviceId);
let client = null, convidados = [];

let tentativasInvalidas = 0;
let bloqueadoAte = 0;


function vibrar() { if (navigator.vibrate) navigator.vibrate(200); }
function exibirFeedbackScanner(texto, cor) {
  const fb = document.getElementById("scanFeedback");
  fb.innerText = texto;
  fb.style.background = cor;
}

function startScanner() {
  document.getElementById("scannerContainer").style.display = "block";
  if (!scanner) scanner = new Html5Qrcode("qr-reader");

  let ultimoId = null;
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async content => {
    const match = convidados.find(c => c.id.toString() === content.trim());
    if (!match) return exibirFeedbackScanner("‚ùå N√£o encontrado", "#a00");

    if (match.status === "usado") {
      exibirFeedbackScanner("‚ö†Ô∏è Usado", "#aa8800");
      vibrar();
      return;
    }

    if (match.id === ultimoId) return;
    ultimoId = match.id;
    await marcarComoUsado(match.id);
    await incrementarScans();
    exibirFeedbackScanner("‚úîÔ∏è Permitido", "#007f00");
    vibrar();
    
  const diasRestantes = Math.floor((client.validade * 1000 - Date.now()) / (1000 * 60 * 60 * 24));
  if (diasRestantes <= 2) {
    alert("‚ö†Ô∏è Sua licen√ßa expira em breve.");
  }

  await carregarConvidados();

    if (client.scans_usados >= client.limite_scans) {
      await scanner.stop(); document.getElementById("scannerContainer").style.display = "none";
      alert("‚ö†Ô∏è Limite atingido.");
    }
  }, console.warn);
}

function fecharScanner() {
  document.getElementById("scannerContainer").style.display = "none";
  if (scanner) scanner.stop();
}

function exibirModal(msg) {
  const m = document.getElementById("modal");
  m.innerText = msg; m.style.display = "flex"; vibrar();
}

window.addEventListener('online', () => document.getElementById("offline").style.display = "none");
window.addEventListener('offline', () => document.getElementById("offline").style.display = "block");
if (!navigator.onLine) document.getElementById("offline").style.display = "block";

async function iniciar(inputToken) {

  const agora = Date.now();
  if (agora < bloqueadoAte) {
    alert("‚õî Muitas tentativas inv√°lidas. Tente novamente em alguns segundos.");
    return;
  }

  document.body.innerHTML += '<div id="loadingOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000a;color:white;font-size:1.5em;display:flex;justify-content:center;align-items:center;z-index:9999;">üîê Validando seu acesso...</div>';
  token = inputToken || token;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
  });
  const data = await res.json();
  client = data[0];
  
  if (!client) {
    tentativasInvalidas++;
    if (tentativasInvalidas >= 3) {
      bloqueadoAte = Date.now() + 60000;
      alert("‚õî Muitas tentativas inv√°lidas. Aguarde 1 minuto.");
    } else {
      alert("‚ùå Token inv√°lido.");
    }
    document.getElementById("loadingOverlay").remove();
    return;
  }

  if (client.dispositivos && client.dispositivos !== deviceId) return alert("‚ùå Token j√° usado em outro dispositivo.");
  if (client.validade * 1000 < Date.now()) return alert("‚è∞ Token expirado.");
  if (client.scans_usados >= client.limite_scans) return alert("‚ö†Ô∏è Limite atingido.");
  if (!client.dispositivos) {
    await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
      method: "PATCH", headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
      
      body: JSON.stringify({ dispositivos: `${deviceId} | ${navigator.userAgent}` })

    });
  }
  localStorage.setItem('token', token);
  
  document.getElementById("loadingOverlay").remove();
  tentativasInvalidas = 0;
  document.getElementById("tokenInput").style.display = "none";

  document.querySelector("button[onclick^='iniciar']").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("clienteNome").innerText = `üéâ Ol√°, ${client.nome}`;
  document.getElementById("validadeMsg").innerText = `‚è≥ V√°lido at√©: ${new Date(client.validade * 1000).toLocaleDateString()}`;
  
  const diasRestantes = Math.floor((client.validade * 1000 - Date.now()) / (1000 * 60 * 60 * 24));
  if (diasRestantes <= 2) {
    alert("‚ö†Ô∏è Sua licen√ßa expira em breve.");
  }

  await carregarConvidados();
}

async function carregarConvidados() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/convidados?token_cliente=eq.${token}`, {
    headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
  });
  convidados = await res.json();
  renderConvidados();
}

function renderConvidados() {
  const list = document.getElementById("guestList");
  const query = document.getElementById("searchInput").value.toLowerCase();
  let usados = 0;
  list.innerHTML = "";
  convidados.filter(c => c.nome.toLowerCase().includes(query)).forEach(c => {
    if (c.status === "usado") usados++;
    const li = document.createElement("li");
    li.innerText = `${c.status === 'usado' ? '‚úÖ' : 'üü¢'} ${c.nome}`;
    list.appendChild(li);
  });
  const pct = convidados.length ? (usados / convidados.length) * 100 : 0;
  document.getElementById("progressBar").value = pct;
  document.getElementById("result").innerText = `${usados}/${convidados.length} validados`;
  if (usados === convidados.length && convidados.length > 0) document.getElementById("doneMsg").style.display = "block";
}

function filtrarConvidados() { renderConvidados(); }

async function marcarComoUsado(id) {
  await fetch(`${SUPABASE_URL}/rest/v1/convidados?id=eq.${id}`, {
    method: "PATCH", headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
    body: JSON.stringify({ status: "usado" })
  });
}

async function incrementarScans() {
  await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    method: "PATCH", headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
    body: JSON.stringify({ scans_usados: client.scans_usados + 1 })
  });
  client.scans_usados++;
}

function baixarCSV() {
  if (!convidados.length) return alert("Nenhum convidado carregado.");
  const linhas = ["Nome,Status", ...convidados.map(c => `"${c.nome}","${c.status}"`)];
  const blob = new Blob([linhas.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "convidados.csv"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

setInterval(() => { if (token) carregarConvidados(); }, 30000);

setInterval(async () => {
  if (!token) return;
  const res = await fetch(`${SUPABASE_URL}/rest/v1/clientes?token=eq.${token}`, {
    headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
  });
  const data = await res.json();
  if (data.length === 0) {
    alert("‚ùå Sua conta foi desativada. Por favor, contacte a Invites.");
    localStorage.clear();
    location.reload();
  }
}, 30000);


function verificarOnline() {
  const offline = !navigator.onLine;
  document.getElementById("offlineOverlay").style.display = offline ? "flex" : "none";
}
window.addEventListener('online', verificarOnline);
window.addEventListener('offline', verificarOnline);




function abrirAba(aba) {
  // Scanner
  document.getElementById("scannerContainer").style.display = (aba === 'scanner') ? 'block' : 'none';

  // Lista
  const listaVisivel = (aba === 'lista');
  document.getElementById("guestList").style.display = listaVisivel ? 'block' : 'none';
  document.getElementById("result").style.display = listaVisivel ? 'block' : 'none';
  document.getElementById("searchInput").style.display = listaVisivel ? 'block' : 'none';
  document.querySelector("button[onclick='carregarConvidados()']").style.display = listaVisivel ? 'inline-block' : 'none';
  document.querySelector("button[onclick='baixarCSV()']").style.display = listaVisivel ? 'inline-block' : 'none';
  document.getElementById("progressBar").style.display = listaVisivel ? 'block' : 'none';

  // Info
  const infoVisivel = (aba === 'info');
  document.getElementById("validadeMsg").style.display = infoVisivel ? 'block' : 'none';
  document.getElementById("doneMsg").style.display = infoVisivel ? 'block' : 'none';
}



const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
document.body.classList.toggle("dark", prefersDark);

function alternarTema() {
  document.body.classList.toggle("dark");
}


window.addEventListener("load", () => {
  setTimeout(() => {
    const splash = document.getElementById("splashScreen");
    if (splash) splash.remove();
  }, 2000);
});



async function verificarConexaoReal() {
  try {
    const res = await fetch("https://rnvunprjvppbjavkaoek.supabase.co/rest/v1/clientes?select=id&limit=1", {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    });
    return res.ok;
  } catch {
    return false;
  }
}

async function atualizarEstadoConexao() {
  const online = await verificarConexaoReal();
  document.getElementById("offlineOverlay").style.display = online ? "none" : "flex";
}

setInterval(atualizarEstadoConexao, 5000);
atualizarEstadoConexao();

atualizarEstadoConexao();

</script>

<div id="offlineOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000e;color:#fff;z-index:10000;font-size:1.2em;display:flex;align-items:center;justify-content:center;">
‚ö†Ô∏è Sem conex√£o. Conecte-se para continuar.
</div>

</body>
</html>
