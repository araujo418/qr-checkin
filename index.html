<!doctype html>
<html lang="pt" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdKira Check-In - Sistema de Controlo de Acesso</title><!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script><!-- HTML5 QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script><!-- jsPDF for reports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><!-- Icons via Heroicons (inline SVG) -->
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    .scan-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }
    
    .scan-error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .scan-duplicate {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
    
    #reader {
      border-radius: 0.75rem;
      overflow: hidden;
    }
    
    #reader video {
      border-radius: 0.75rem;
    }

    /* Dark Mode */
    .dark-mode {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3d3d3d;
      --text-primary: #ffffff;
      --text-secondary: #d1d5db;
      --border-color: #4b5563;
    }

    .dark-mode body {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }

    .dark-mode .bg-white {
      background-color: var(--bg-secondary) !important;
    }

    .dark-mode .text-gray-900 {
      color: var(--text-primary) !important;
    }

    .dark-mode .text-gray-700 {
      color: var(--text-secondary) !important;
    }

    .dark-mode .text-gray-600 {
      color: #9ca3af !important;
    }

    .dark-mode .text-gray-500 {
      color: #6b7280 !important;
    }

    .dark-mode .border-gray-200 {
      border-color: var(--border-color) !important;
    }

    .dark-mode .bg-gray-50 {
      background-color: var(--bg-tertiary) !important;
    }

    .dark-mode .bg-gray-100 {
      background-color: var(--bg-tertiary) !important;
    }

    .dark-mode .hover\:bg-gray-100:hover {
      background-color: var(--bg-tertiary) !important;
    }

    .dark-mode input {
      background-color: var(--bg-tertiary) !important;
      color: var(--text-primary) !important;
      border-color: var(--border-color) !important;
    }

    /* Blocked State */
    .scanner-blocked {
      position: relative;
    }

    .scanner-blocked::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 10;
      pointer-events: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-indigo-50 via-white to-purple-50"><!-- TELA 1: CONFIG/LOGIN -->
  <div id="screen-config" class="h-full w-full flex items-center justify-center p-4 sm:p-6">
   <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md animate-slide-in">
    <div class="text-center mb-6 sm:mb-8">
     <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-[#007f9f] rounded-2xl mb-3 sm:mb-4 shadow-lg">
      <svg class="w-10 h-10 sm:w-12 sm:h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M8 16H6m2 0v4m0 0H6m2 0h2m-6-4h2m6-11h2m-4 0h2m0 4h.01M16 4h2m-6 0v4m0 0H8"></path>
      </svg>
     </div>
     <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-1 sm:mb-2">AdKira Check-In</h1>
     <p class="text-sm sm:text-base text-gray-600 px-2">Sistema profissional de controlo de acesso por QR Code</p>
    </div>
    <form id="config-form" class="space-y-4">
     <div><label class="block text-base sm:text-sm font-semibold text-gray-700 mb-2">Token do Cliente</label>
      <div class="relative"><input type="password" id="client-token" placeholder="Insira o token fornecido" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="w-full px-4 py-4 sm:py-3 pr-12 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#007f9f] focus:border-transparent transition"> <button type="button" id="toggle-token-visibility" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-2 text-gray-500 hover:text-gray-700 active:scale-95 transition" title="Mostrar/Ocultar token">
        <svg id="eye-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        <svg id="eye-off-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
        </svg></button>
      </div>
     </div>
     <div id="config-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
     <div id="config-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm"></div><button type="submit" id="config-submit-btn" class="w-full bg-[#007f9f] text-white font-semibold py-4 sm:py-3 text-base rounded-lg hover:bg-[#006a85] active:scale-95 transition shadow-lg"> Validar e Iniciar </button>
     <div id="config-loading" class="hidden text-center py-4">
      <div class="inline-block animate-spin rounded-full h-10 w-10 sm:h-8 sm:w-8 border-4 border-[#007f9f] border-t-transparent"></div>
      <p class="text-sm text-gray-600 mt-3 sm:mt-2">A validar e descarregar dados...</p>
     </div>
    </form>
    <div class="mt-6 pt-6 border-t border-gray-200">
     <div class="flex items-center justify-center space-x-2 text-xs sm:text-sm text-gray-500 mb-3">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
      </svg><span>Sistema sempre online</span>
     </div>
     <div class="text-center text-xs text-gray-400">
      Created By <span class="font-semibold text-[#007f9f]">AdKira</span> <span id="footer-year">2025</span>
     </div>
    </div>
   </div>
  </div><!-- TELA 2: SCANNER -->
  <div id="screen-scanner" class="hidden h-full w-full flex flex-col"><!-- Header -->
   <header class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4">
     <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2 sm:space-x-3">
       <div class="w-10 h-10 sm:w-12 sm:h-12 bg-[#007f9f] rounded-xl flex items-center justify-center flex-shrink-0 shadow-md">
        <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M8 16H6m2 0v4m0 0H6m2 0h2m-6-4h2m6-11h2m-4 0h2m0 4h.01M16 4h2m-6 0v4m0 0H8"></path>
        </svg>
       </div>
       <div class="min-w-0">
        <h1 class="text-base sm:text-xl font-bold text-gray-900 truncate">AdKira Check-In</h1>
        <p class="text-xs sm:text-sm text-gray-600 truncate" id="client-name">A carregar cliente...</p>
       </div>
      </div>
      <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
       <div id="online-indicator" class="flex items-center space-x-1 px-2 sm:px-3 py-1 rounded-full bg-green-100">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span class="text-xs font-medium text-green-700 hidden sm:inline">Online</span>
       </div><button id="btn-menu" class="p-2 sm:p-2 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition">
        <svg class="w-6 h-6 sm:w-6 sm:h-6 text-gray-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg></button>
      </div>
     </div>
    </div>
   </header><!-- Stats Bar -->
   <div class="bg-[#007f9f] text-white py-4 sm:py-5 shadow-md">
    <div class="max-w-7xl mx-auto px-4">
     <div class="grid grid-cols-3 gap-2 sm:gap-4 text-center">
      <div class="bg-white bg-opacity-15 rounded-lg py-3 sm:py-4 px-2 backdrop-blur-sm">
       <div class="text-2xl sm:text-3xl font-bold" id="stat-total">
        0
       </div>
       <div class="text-xs sm:text-sm opacity-90 mt-1">
        Total
       </div>
      </div>
      <div class="bg-white bg-opacity-15 rounded-lg py-3 sm:py-4 px-2 backdrop-blur-sm">
       <div class="text-2xl sm:text-3xl font-bold" id="stat-checked">
        0
       </div>
       <div class="text-xs sm:text-sm opacity-90 mt-1">
        Verificados
       </div>
      </div>
      <div class="bg-white bg-opacity-15 rounded-lg py-3 sm:py-4 px-2 backdrop-blur-sm">
       <div class="text-2xl sm:text-3xl font-bold" id="stat-pending">
        0
       </div>
       <div class="text-xs sm:text-sm opacity-90 mt-1">
        Pendentes
       </div>
      </div>
     </div>
    </div>
   </div><!-- Scanner Area -->
   <main class="flex-1 overflow-hidden relative" id="scanner-area"><!-- Camera Full Screen -->
    <div id="reader" class="w-full h-full absolute inset-0"></div><!-- Block Overlay -->
    <div id="block-overlay" class="hidden absolute inset-0 z-20 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center">
     <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
      <div class="text-6xl mb-4">
       üîí
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-2" id="block-title">Scanner Bloqueado</h3>
      <p class="text-gray-600 mb-6" id="block-message">Token expirado ou inv√°lido</p><button id="btn-retry-validation" class="bg-[#007f9f] text-white px-6 py-3 rounded-lg hover:bg-[#006a85] active:scale-95 transition font-semibold"> Tentar Novamente </button>
     </div>
    </div><!-- Camera Control Button (Floating) -->
    <div class="absolute bottom-6 left-0 right-0 z-10 px-4"><button id="btn-toggle-camera" class="bg-[#007f9f] text-white px-8 py-4 rounded-full hover:bg-[#006a85] active:scale-95 transition font-semibold shadow-2xl text-base w-full max-w-xs mx-auto block"> Iniciar Scanner </button>
    </div><!-- Feedback Area (Floating Overlay) -->
    <div id="scan-feedback" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 w-11/12 max-w-md rounded-2xl shadow-2xl p-6 sm:p-8 text-white text-center animate-slide-in">
     <div class="text-5xl sm:text-6xl mb-3 sm:mb-4" id="feedback-icon">
      ‚úì
     </div>
     <div class="text-xl sm:text-2xl font-bold mb-2" id="feedback-name">
      Nome do Convidado
     </div>
     <div class="text-base sm:text-lg opacity-90" id="feedback-message">
      Check-in realizado com sucesso!
     </div>
     <div class="text-sm opacity-75 mt-2" id="feedback-time">
      15:30:45
     </div>
    </div><!-- Action Buttons (Floating) -->
    <div class="absolute top-4 right-4 z-10 flex flex-col gap-2"><button id="btn-manual-checkin" class="bg-white bg-opacity-90 backdrop-blur-sm p-3 rounded-full shadow-lg active:scale-95 transition" title="Check-in Manual">
      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg></button> <button id="btn-show-recent" class="bg-white bg-opacity-90 backdrop-blur-sm p-3 rounded-full shadow-lg active:scale-95 transition" title="√öltimos Check-ins">
      <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
      </svg></button>
    </div>
   </main><!-- Recent Scans Modal -->
   <div id="modal-recent" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
     <div class="absolute inset-0 bg-black bg-opacity-50" id="modal-recent-overlay"></div>
     <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] sm:max-h-[80vh] flex flex-col m-2 sm:m-0">
      <div class="p-4 sm:p-6 border-b border-gray-200">
       <div class="flex items-center justify-between">
        <h3 class="text-xl sm:text-2xl font-bold text-gray-900">√öltimos Check-ins</h3><button id="btn-close-recent" class="p-2 rounded-lg hover:bg-gray-100 active:bg-gray-200">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
         </svg></button>
       </div>
      </div>
      <div class="flex-1 overflow-y-auto p-4 sm:p-6">
       <div id="recent-scans" class="space-y-2 sm:space-y-3">
        <div class="text-center text-gray-400 py-8">
         <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
         </svg>
         <p class="text-sm">Nenhum check-in realizado ainda</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Manual Check-in Modal -->
   <div id="modal-manual-checkin" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
     <div class="absolute inset-0 bg-black bg-opacity-50" id="modal-manual-overlay"></div>
     <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] sm:max-h-[80vh] flex flex-col m-2 sm:m-0">
      <div class="p-4 sm:p-6 border-b border-gray-200">
       <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl sm:text-2xl font-bold text-gray-900">Check-in Manual</h3><button id="btn-close-manual" class="p-2 rounded-lg hover:bg-gray-100 active:bg-gray-200">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
         </svg></button>
       </div>
       <div class="relative"><input type="text" id="search-manual-guest" placeholder="Buscar convidado pelo nome..." class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#007f9f] focus:border-transparent">
        <svg class="absolute right-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
       </div>
      </div>
      <div class="flex-1 overflow-y-auto p-4 sm:p-6">
       <div id="manual-guests-list" class="space-y-2">
        <div class="text-center text-gray-400 py-8">
         <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
         </svg>
         <p class="text-sm">Digite para buscar convidados</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- MENU LATERAL -->
  <div id="side-menu" class="hidden fixed inset-0 z-50">
   <div class="absolute inset-0 bg-black bg-opacity-50" id="menu-overlay"></div>
   <div class="absolute right-0 top-0 h-full w-full sm:w-80 bg-white shadow-2xl transform transition-transform overflow-y-auto" id="menu-panel">
    <div class="p-4 sm:p-6">
     <div class="flex items-center justify-between mb-6 sticky top-0 bg-white pb-4 border-b border-gray-200">
      <h2 class="text-xl font-bold text-gray-900">Menu</h2><button id="btn-close-menu" class="p-2 rounded-lg hover:bg-gray-100 active:bg-gray-200">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <div class="space-y-2"><button id="btn-toggle-dark-mode" class="w-full flex items-center space-x-3 px-4 py-4 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition text-left">
       <svg class="w-6 h-6 text-[#007f9f] flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
       </svg><span class="font-medium text-gray-700 text-base" id="dark-mode-text">Modo Escuro</span> </button> <button id="btn-sync" class="w-full flex items-center space-x-3 px-4 py-4 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition text-left">
       <svg class="w-6 h-6 text-[#007f9f] flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
       </svg><span class="font-medium text-gray-700 text-base">Sincronizar Agora</span> </button> <button id="btn-export" class="w-full flex items-center space-x-3 px-4 py-4 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition text-left">
       <svg class="w-6 h-6 text-[#007f9f] flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg><span class="font-medium text-gray-700 text-base">Exportar Relat√≥rio</span> </button> <button id="btn-view-guests" class="w-full flex items-center space-x-3 px-4 py-4 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition text-left">
       <svg class="w-6 h-6 text-[#007f9f] flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
       </svg><span class="font-medium text-gray-700 text-base">Lista de Convidados</span> </button>
      <div class="border-t border-gray-200 my-4"></div><button id="btn-clear-data" class="w-full flex items-center space-x-3 px-4 py-4 rounded-lg hover:bg-red-50 active:bg-red-100 transition text-left">
       <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
       </svg><span class="font-medium text-red-600 text-base">Limpar Dados</span> </button> <button id="btn-logout" class="w-full flex items-center space-x-3 px-4 py-4 rounded-lg hover:bg-gray-100 active:bg-gray-200 transition text-left">
       <svg class="w-6 h-6 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
       </svg><span class="font-medium text-gray-700 text-base">Desconectar</span> </button>
     </div>
     <div class="mt-6 pt-6 border-t border-gray-200">
      <div class="text-xs text-gray-500 space-y-1 mb-4">
       <div>
        Total de convidados: <span id="menu-total-guests" class="font-semibold">0</span>
       </div>
       <div>
        Check-ins realizados: <span id="menu-checked-guests" class="font-semibold">0</span>
       </div>
       <div>
        Scans pendentes sincroniza√ß√£o: <span id="menu-pending-sync" class="font-semibold">0</span>
       </div>
       <div>
        Limite do cliente: <span id="menu-client-limit" class="font-semibold">-</span>
       </div>
       <div id="menu-token-expiry" class="pt-2 border-t border-gray-200 mt-2"></div>
      </div>
      <div class="text-center text-xs text-gray-400 pt-4 border-t border-gray-200">
       Created By <span class="font-semibold text-[#007f9f]">AdKira</span> <span id="footer-year-menu">2025</span>
      </div>
     </div>
    </div>
   </div>
  </div><!-- MODAL LISTA CONVIDADOS -->
  <div id="modal-guests" class="hidden fixed inset-0 z-50 overflow-y-auto">
   <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
    <div class="absolute inset-0 bg-black bg-opacity-50" id="modal-guests-overlay"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] sm:max-h-[80vh] flex flex-col m-2 sm:m-0">
     <div class="p-4 sm:p-6 border-b border-gray-200">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Lista de Convidados</h2><button id="btn-close-guests" class="p-2 rounded-lg hover:bg-gray-100 active:bg-gray-200">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg></button>
      </div>
      <div><input type="text" id="search-guest" placeholder="Pesquisar convidado..." class="w-full px-4 py-3 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
      </div>
     </div>
     <div class="flex-1 overflow-y-auto p-4 sm:p-6">
      <div id="guests-list" class="space-y-2"></div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ============================================
    // CONFIGURA√á√ïES GLOBAIS E ESTADO
    // ============================================
    
    const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
    
    const APP_STATE = {
      tokenCliente: null,
      cliente: null,
      convidados: [],
      scansPendentes: [],
      isOnline: navigator.onLine,
      isScannerActive: false,
      isScannerBlocked: false,
      html5QrCode: null,
      supabase: null,
      deviceId: generateDeviceId(),
      isDarkMode: false,
      validityCheckInterval: null
    };
    
    function generateDeviceId() {
      let deviceId = localStorage.getItem('adkira_device_id');
      if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('adkira_device_id', deviceId);
      }
      return deviceId;
    }

    const DB_NAME = 'AdKiraCheckIn';
    const DB_VERSION = 1;
    let db = null;

    // ============================================
    // DARK MODE
    // ============================================
    
    function loadDarkModePreference() {
      const savedDarkMode = localStorage.getItem('adkira_dark_mode');
      if (savedDarkMode === 'true') {
        enableDarkMode();
      }
    }

    function enableDarkMode() {
      document.documentElement.classList.add('dark-mode');
      APP_STATE.isDarkMode = true;
      localStorage.setItem('adkira_dark_mode', 'true');
      const darkModeText = document.getElementById('dark-mode-text');
      if (darkModeText) {
        darkModeText.textContent = 'Modo Claro';
      }
    }

    function disableDarkMode() {
      document.documentElement.classList.remove('dark-mode');
      APP_STATE.isDarkMode = false;
      localStorage.setItem('adkira_dark_mode', 'false');
      const darkModeText = document.getElementById('dark-mode-text');
      if (darkModeText) {
        darkModeText.textContent = 'Modo Escuro';
      }
    }

    function toggleDarkMode() {
      if (APP_STATE.isDarkMode) {
        disableDarkMode();
      } else {
        enableDarkMode();
      }
    }

    // ============================================
    // VALIDA√á√ÉO DE TOKEN (PRIORIDADE ONLINE)
    // ============================================
    
    async function checkInternetConnectivity() {
      // Verifica√ß√£o tripla de conectividade real
      try {
        // Teste 1: Ping ao Supabase
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          method: 'HEAD',
          headers: { 'apikey': SUPABASE_KEY },
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok || response.status === 404) {
          return true; // Conex√£o OK
        }
        
        // Teste 2: Ping alternativo
        const response2 = await fetch('https://www.google.com/generate_204', {
          method: 'HEAD',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        
        return true;
        
      } catch (error) {
        // Teste 3: Verificar navigator.onLine
        if (navigator.onLine) {
          // Se navigator diz online mas fetch falhou, testar novamente
          try {
            await fetch('https://www.cloudflare.com/cdn-cgi/trace', {
              method: 'HEAD',
              mode: 'no-cors'
            });
            return true;
          } catch {
            return false; // Realmente offline
          }
        }
        
        return false; // Definitivamente offline
      }
    }
    
    async function checkTokenValidityOnline() {
      // SEMPRE tentar online primeiro
      const isOnline = await checkInternetConnectivity();
      
      if (isOnline) {
        APP_STATE.isOnline = true;
        updateOnlineStatus();
        
        // Revalidar token online
        return await revalidateToken();
      }
      
      // S√≥ usar valida√ß√£o offline se REALMENTE n√£o tiver internet
      return checkTokenValidityOffline();
    }
    
    function checkTokenValidityOffline() {
      if (!APP_STATE.cliente) return true;
      
      const agora = Math.floor(Date.now() / 1000);
      
      // Verificar validade offline
      if (APP_STATE.cliente.validade && APP_STATE.cliente.validade < agora) {
        return false;
      }
      
      return true;
    }

    function startValidityCheckInterval() {
      // Atualizar expira√ß√£o imediatamente
      updateTokenExpiryDisplay();
      
      // Verificar validade a cada 60 segundos (PRIORIZANDO ONLINE)
      if (APP_STATE.validityCheckInterval) {
        clearInterval(APP_STATE.validityCheckInterval);
      }
      
      APP_STATE.validityCheckInterval = setInterval(async () => {
        updateTokenExpiryDisplay();
        
        // SEMPRE tentar valida√ß√£o online primeiro
        const tokenValido = await checkTokenValidityOnline();
        
        if (!tokenValido) {
          blockScanner('Token expirado', 'O token expirou. Contacte o administrador para renova√ß√£o.');
          showToast('Token expirado! Scanner bloqueado.', 'error');
        }
      }, 60000); // Verificar a cada 60 segundos
    }
    
    function updateTokenExpiryDisplay() {
      const expiryElement = document.getElementById('menu-token-expiry');
      
      if (!expiryElement || !APP_STATE.cliente || !APP_STATE.cliente.validade) {
        if (expiryElement) {
          expiryElement.innerHTML = '<div class="text-gray-400">Sem data de expira√ß√£o</div>';
        }
        return;
      }
      
      const agora = Math.floor(Date.now() / 1000);
      const validade = APP_STATE.cliente.validade;
      const tempoRestante = validade - agora;
      
      // Token j√° expirado
      if (tempoRestante <= 0) {
        expiryElement.innerHTML = '<div class="text-red-600 font-semibold">‚ö†Ô∏è Token expirado</div>';
        return;
      }
      
      // Calcular dias, horas, minutos restantes
      const dias = Math.floor(tempoRestante / 86400);
      const horas = Math.floor((tempoRestante % 86400) / 3600);
      const minutos = Math.floor((tempoRestante % 3600) / 60);
      
      let textoExpiracao = '';
      let corClasse = '';
      
      if (dias > 7) {
        // Mais de 7 dias - Verde
        textoExpiracao = `Expira em ${dias} dias`;
        corClasse = 'text-green-600';
      } else if (dias > 2) {
        // Entre 3-7 dias - Amarelo
        textoExpiracao = `Expira em ${dias} dias`;
        corClasse = 'text-yellow-600';
      } else if (dias > 0) {
        // 1-2 dias - Laranja
        textoExpiracao = `‚ö†Ô∏è Expira em ${dias} dia${dias > 1 ? 's' : ''} e ${horas}h`;
        corClasse = 'text-orange-600 font-semibold';
      } else if (horas > 2) {
        // Menos de 1 dia mas mais de 2h - Laranja forte
        textoExpiracao = `‚ö†Ô∏è Expira em ${horas} horas`;
        corClasse = 'text-orange-600 font-semibold';
      } else {
        // Menos de 2 horas - Vermelho
        textoExpiracao = `üö® Expira em ${horas}h ${minutos}min`;
        corClasse = 'text-red-600 font-bold animate-pulse';
      }
      
      expiryElement.innerHTML = `
        <div class="${corClasse}">
          ${textoExpiracao}
        </div>
      `;
    }

    function stopValidityCheckInterval() {
      if (APP_STATE.validityCheckInterval) {
        clearInterval(APP_STATE.validityCheckInterval);
        APP_STATE.validityCheckInterval = null;
      }
    }

    function blockScanner(title, message) {
      APP_STATE.isScannerBlocked = true;
      
      if (APP_STATE.isScannerActive) {
        stopScanner();
      }
      
      const blockOverlay = document.getElementById('block-overlay');
      const blockTitle = document.getElementById('block-title');
      const blockMessage = document.getElementById('block-message');
      
      blockTitle.textContent = title;
      blockMessage.textContent = message;
      blockOverlay.classList.remove('hidden');
      
      // Desabilitar bot√µes
      document.getElementById('btn-toggle-camera').disabled = true;
      document.getElementById('btn-toggle-camera').classList.add('opacity-50', 'cursor-not-allowed');
      document.getElementById('btn-manual-checkin').disabled = true;
      document.getElementById('btn-manual-checkin').classList.add('opacity-50');
    }

    function unblockScanner() {
      APP_STATE.isScannerBlocked = false;
      
      const blockOverlay = document.getElementById('block-overlay');
      blockOverlay.classList.add('hidden');
      
      // Reabilitar bot√µes
      document.getElementById('btn-toggle-camera').disabled = false;
      document.getElementById('btn-toggle-camera').classList.remove('opacity-50', 'cursor-not-allowed');
      document.getElementById('btn-manual-checkin').disabled = false;
      document.getElementById('btn-manual-checkin').classList.remove('opacity-50');
      
      showToast('Token revalidado! Scanner desbloqueado.', 'success');
    }

    document.getElementById('btn-retry-validation').addEventListener('click', async () => {
      if (!APP_STATE.isOnline) {
        showToast('Sem conex√£o √† internet. Conecte-se para revalidar.', 'error');
        return;
      }
      
      await revalidateToken();
    });

    async function revalidateToken() {
      if (!APP_STATE.isOnline || !APP_STATE.supabase || !APP_STATE.tokenCliente) {
        showToast('Sem conex√£o para revalidar', 'error');
        return false;
      }

      try {
        const clientes = await APP_STATE.supabase.select('clientes', { eq: { token: APP_STATE.tokenCliente } });
        
        if (!clientes || clientes.length === 0) {
          blockScanner('Token Inv√°lido', 'Token n√£o encontrado. Contacte o administrador.');
          return false;
        }

        const clienteAtualizado = clientes[0];
        const agora = Math.floor(Date.now() / 1000);

        // Verificar validade
        if (clienteAtualizado.validade && clienteAtualizado.validade < agora) {
          blockScanner('Token Expirado', 'O token expirou. Contacte o administrador para renova√ß√£o.');
          return false;
        }

        // Verificar limite
        if (clienteAtualizado.scans_usados >= clienteAtualizado.limite_scans) {
          blockScanner('Limite Atingido', 'Limite de scans atingido. Contacte o administrador.');
          return false;
        }

        // Actualizar dados do cliente localmente
        APP_STATE.cliente = clienteAtualizado;
        await saveToStore('cliente', {
          token: 'saved',
          ...clienteAtualizado
        });

        unblockScanner();
        updateStats();
        return true;

      } catch (error) {
        console.error('Error revalidating token:', error);
        showToast('Erro ao revalidar token', 'error');
        return false;
      }
    }

    // ============================================
    // INDEXEDDB SETUP
    // ============================================
    
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          
          if (!database.objectStoreNames.contains('cliente')) {
            database.createObjectStore('cliente', { keyPath: 'token' });
          }
          
          if (!database.objectStoreNames.contains('convidados')) {
            const guestStore = database.createObjectStore('convidados', { keyPath: 'id' });
            guestStore.createIndex('codigo_qr', 'codigo_qr', { unique: true });
            guestStore.createIndex('status', 'status');
          }
          
          if (!database.objectStoreNames.contains('scans_pendentes')) {
            const scanStore = database.createObjectStore('scans_pendentes', { keyPath: 'id', autoIncrement: true });
            scanStore.createIndex('sincronizado', 'sincronizado');
          }
        };
      });
    }

    function saveToStore(storeName, data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function getFromStore(storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(key);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function getAllFromStore(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    function clearStore(storeName) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    function deleteFromStore(storeName, key) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(key);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    // ============================================
    // SUPABASE CLIENT (SIMPLE FETCH-BASED)
    // ============================================
    
    class SupabaseClient {
      constructor(url, key) {
        this.url = url;
        this.key = key;
        this.headers = {
          'apikey': key,
          'Authorization': `Bearer ${key}`,
          'Content-Type': 'application/json'
        };
      }

      async select(table, options = {}) {
        let url = `${this.url}/rest/v1/${table}?`;
        
        if (options.select) {
          url += `select=${options.select}&`;
        }
        
        if (options.eq) {
          Object.keys(options.eq).forEach(key => {
            url += `${key}=eq.${options.eq[key]}&`;
          });
        }

        const response = await fetch(url, {
          method: 'GET',
          headers: this.headers
        });

        if (!response.ok) {
          throw new Error(`Supabase error: ${response.statusText}`);
        }

        return await response.json();
      }

      async insert(table, data) {
        const url = `${this.url}/rest/v1/${table}`;
        
        const response = await fetch(url, {
          method: 'POST',
          headers: this.headers,
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`Supabase error: ${response.statusText}`);
        }

        return await response.json();
      }

      async update(table, id, data) {
        const url = `${this.url}/rest/v1/${table}?id=eq.${id}`;
        
        const response = await fetch(url, {
          method: 'PATCH',
          headers: this.headers,
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`Supabase error: ${response.statusText}`);
        }

        return await response.json();
      }
    }

    // ============================================
    // CONFIG SCREEN
    // ============================================
    
    async function loadSavedConfig() {
      try {
        APP_STATE.supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_KEY);
        
        const cliente = await getFromStore('cliente', 'saved');
        if (cliente && cliente.token) {
          APP_STATE.tokenCliente = cliente.token;
          APP_STATE.cliente = cliente;
          
          // Verificar validade offline antes de iniciar
          if (!checkTokenValidityOffline()) {
            showConfig();
            showConfigError('Token expirado. Insira um novo token ou contacte o administrador.');
            return;
          }
          
          // CR√çTICO: Carregar apenas convidados deste token espec√≠fico
          const convidados = await getAllFromStore('convidados');
          const convidadosDoToken = convidados.filter(c => c.token_cliente === APP_STATE.tokenCliente);
          
          if (convidadosDoToken.length > 0) {
            APP_STATE.convidados = convidadosDoToken;
            showScanner();
            updateStats();
            loadRecentScans();
            startValidityCheckInterval();
            
            // Auto-iniciar scanner ap√≥s 500ms
            setTimeout(() => {
              startScanner();
            }, 500);
          }
        }
      } catch (error) {
        console.error('Error loading saved config:', error);
      }
    }

    // Toggle Token Visibility
    document.getElementById('toggle-token-visibility').addEventListener('click', () => {
      const tokenInput = document.getElementById('client-token');
      const eyeIcon = document.getElementById('eye-icon');
      const eyeOffIcon = document.getElementById('eye-off-icon');
      
      if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        eyeIcon.classList.add('hidden');
        eyeOffIcon.classList.remove('hidden');
      } else {
        tokenInput.type = 'password';
        eyeIcon.classList.remove('hidden');
        eyeOffIcon.classList.add('hidden');
      }
    });

    document.getElementById('config-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!navigator.onLine) {
        showConfigError('√â necess√°ria conex√£o √† internet no primeiro acesso');
        return;
      }

      const tokenCliente = document.getElementById('client-token').value.trim();

      showConfigLoading(true);
      hideConfigError();

      try {
        APP_STATE.supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_KEY);

        // SEMPRE validar token online primeiro
        const clientes = await APP_STATE.supabase.select('clientes', { eq: { token: tokenCliente } });
        
        if (!clientes || clientes.length === 0) {
          throw new Error('Token inv√°lido ou n√£o encontrado');
        }

        const cliente = clientes[0];

        const agora = Math.floor(Date.now() / 1000);
        if (cliente.validade && cliente.validade < agora) {
          throw new Error('Token expirado. Contacte o administrador.');
        }

        if (cliente.scans_usados >= cliente.limite_scans) {
          throw new Error('Limite de scans atingido. Contacte o administrador.');
        }

        // Verificar se √© o mesmo token que j√° estava guardado
        const clienteSalvo = await getFromStore('cliente', 'saved');
        const mesmToken = clienteSalvo && clienteSalvo.realToken === tokenCliente;
        
        // CR√çTICO: Se for token DIFERENTE, limpar TODOS os dados do token anterior
        if (!mesmToken && clienteSalvo) {
          console.log('üîÑ Mudan√ßa de token detectada - Limpando dados do token anterior');
          
          // Limpar apenas dados do token anterior, manter estrutura do DB
          await clearStore('convidados');
          await clearStore('scans_pendentes');
          await clearStore('cliente');
          
          APP_STATE.convidados = [];
          APP_STATE.scansPendentes = [];
          APP_STATE.cliente = null;
        }
        
        APP_STATE.tokenCliente = tokenCliente;
        APP_STATE.cliente = cliente;

        // SEMPRE buscar dados atualizados online (mesmo se for o mesmo token)
        console.log('üåê Buscando dados atualizados online...');
        const convidados = await APP_STATE.supabase.select('convidados', { eq: { token_cliente: tokenCliente } });
        
        if (!convidados || convidados.length === 0) {
          throw new Error('Nenhum convidado encontrado para este cliente');
        }

        // Limpar convidados antigos deste token e salvar novos
        const convidadosLocais = await getAllFromStore('convidados');
        const convidadosOutrosTokens = convidadosLocais.filter(c => c.token_cliente !== tokenCliente);
        
        // Se h√° convidados de outros tokens no DB, manter separados
        await clearStore('convidados');
        
        // Salvar apenas convidados do token atual
        for (const convidado of convidados) {
          await saveToStore('convidados', convidado);
        }
        
        APP_STATE.convidados = convidados;

        // Salvar cliente com o token real para identifica√ß√£o
        await saveToStore('cliente', {
          token: 'saved',
          realToken: tokenCliente,
          ...cliente
        });

        const mensagem = mesmToken ? 'Bem-vindo de volta! Dados atualizados.' : 'Cliente validado! A iniciar scanner...';
        showConfigSuccess(mensagem);
        
        setTimeout(() => {
          showScanner();
          updateStats();
          startValidityCheckInterval();
        }, 1000);

      } catch (error) {
        showConfigError(`Erro: ${error.message}`);
      } finally {
        showConfigLoading(false);
      }
    });

    function showConfigError(message) {
      const errorDiv = document.getElementById('config-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function hideConfigError() {
      document.getElementById('config-error').classList.add('hidden');
    }

    function showConfigSuccess(message) {
      const successDiv = document.getElementById('config-success');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
    }

    function showConfigLoading(show) {
      const loading = document.getElementById('config-loading');
      const btn = document.getElementById('config-submit-btn');
      
      if (show) {
        loading.classList.remove('hidden');
        btn.classList.add('hidden');
      } else {
        loading.classList.add('hidden');
        btn.classList.remove('hidden');
      }
    }

    // ============================================
    // SCANNER SCREEN
    // ============================================
    
    function showScanner() {
      document.getElementById('screen-config').classList.add('hidden');
      document.getElementById('screen-scanner').classList.remove('hidden');
      
      if (APP_STATE.cliente) {
        document.getElementById('client-name').textContent = APP_STATE.cliente.nome || 'Cliente';
      }
      
      updateOnlineStatus();
      loadRecentScans();
    }

    function showConfig() {
      stopValidityCheckInterval();
      document.getElementById('screen-scanner').classList.add('hidden');
      document.getElementById('screen-config').classList.remove('hidden');
      
      if (APP_STATE.isScannerActive) {
        stopScanner();
      }
    }

    // ============================================
    // QR CODE SCANNER
    // ============================================
    
    document.getElementById('btn-toggle-camera').addEventListener('click', () => {
      if (APP_STATE.isScannerBlocked) {
        showToast('Scanner bloqueado. Revalide o token primeiro.', 'error');
        return;
      }
      
      if (APP_STATE.isScannerActive) {
        stopScanner();
      } else {
        startScanner();
      }
    });

    async function startScanner() {
      if (APP_STATE.isScannerBlocked) {
        showToast('Scanner bloqueado', 'error');
        return;
      }
      
      // PRIORIDADE ONLINE: Verificar validade tentando online primeiro
      const tokenValido = await checkTokenValidityOnline();
      
      if (!tokenValido) {
        blockScanner('Token Expirado', 'O token expirou. Contacte o administrador.');
        return;
      }
      
      try {
        const readerElement = document.getElementById('reader');
        
        if (!APP_STATE.html5QrCode) {
          APP_STATE.html5QrCode = new Html5Qrcode("reader");
        }

        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        };

        await APP_STATE.html5QrCode.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanError
        );

        APP_STATE.isScannerActive = true;
        document.getElementById('btn-toggle-camera').textContent = 'Parar Scanner';
        document.getElementById('btn-toggle-camera').classList.remove('bg-[#007f9f]', 'hover:bg-[#006a85]');
        document.getElementById('btn-toggle-camera').classList.add('bg-red-600', 'hover:bg-red-700');

      } catch (error) {
        console.error('Error starting scanner:', error);
        showScanFeedback('error', '‚ùå', 'Erro', 'N√£o foi poss√≠vel iniciar a c√¢mera');
      }
    }

    async function stopScanner() {
      try {
        if (APP_STATE.html5QrCode && APP_STATE.isScannerActive) {
          await APP_STATE.html5QrCode.stop();
          APP_STATE.isScannerActive = false;
          
          document.getElementById('btn-toggle-camera').textContent = 'Iniciar Scanner';
          document.getElementById('btn-toggle-camera').classList.remove('bg-red-600', 'hover:bg-red-700');
          document.getElementById('btn-toggle-camera').classList.add('bg-[#007f9f]', 'hover:bg-[#006a85]');
        }
      } catch (error) {
        console.error('Error stopping scanner:', error);
      }
    }

    function onScanSuccess(decodedText, decodedResult) {
      processQRCode(decodedText);
    }

    function onScanError(error) {
      // Ignorar erros normais de scan
    }

    async function processQRCode(qrCode) {
      // PRIORIDADE ONLINE: Verificar validade tentando online primeiro
      const tokenValido = await checkTokenValidityOnline();
      
      if (!tokenValido) {
        blockScanner('Token Expirado', 'O token expirou durante a opera√ß√£o.');
        return;
      }
      
      if (APP_STATE.isScannerBlocked) {
        return;
      }
      
      try {
        // PRIORIDADE ONLINE: Tentar buscar do servidor primeiro
        const isOnline = await checkInternetConnectivity();
        
        let convidado;
        
        if (isOnline && APP_STATE.supabase && APP_STATE.tokenCliente) {
          try {
            console.log(`üåê Buscando QR Code online: ${qrCode.substring(0, 20)}...`);
            
            // Buscar convidado online COM FILTRO DE TOKEN
            const convidadosOnline = await APP_STATE.supabase.select('convidados', { 
              eq: { codigo_qr: qrCode, token_cliente: APP_STATE.tokenCliente } 
            });
            
            if (convidadosOnline && convidadosOnline.length > 0) {
              convidado = convidadosOnline[0];
              console.log(`‚úÖ Convidado encontrado online: ${convidado.nome} (Token: ${convidado.token_cliente})`);
              
              // Atualizar cache local
              await saveToStore('convidados', convidado);
              
              const index = APP_STATE.convidados.findIndex(c => c.id === convidado.id);
              if (index >= 0) {
                APP_STATE.convidados[index] = convidado;
              } else {
                APP_STATE.convidados.push(convidado);
              }
            } else {
              console.log('‚ö†Ô∏è QR Code n√£o encontrado online para este token');
            }
          } catch (error) {
            console.error('Error fetching online guest data:', error);
            console.log('üì° Erro online - Tentando buscar localmente...');
          }
        }
        
        // Se n√£o encontrou online OU est√° offline, buscar localmente
        if (!convidado) {
          console.log('üíæ Buscando QR Code localmente...');
          
          // CR√çTICO: Buscar APENAS convidados do token atual
          const convidadoLocal = APP_STATE.convidados.find(c => 
            c.codigo_qr === qrCode && c.token_cliente === APP_STATE.tokenCliente
          );
          
          if (convidadoLocal) {
            convidado = convidadoLocal;
            console.log(`‚úÖ Convidado encontrado localmente: ${convidado.nome} (Token: ${convidado.token_cliente})`);
          } else {
            // Verificar se existe mas √© de outro token
            const convidadosDB = await getAllFromStore('convidados');
            const convidadoOutroToken = convidadosDB.find(c => c.codigo_qr === qrCode);
            
            if (convidadoOutroToken) {
              console.log(`üö´ QR Code pertence a outro token: ${convidadoOutroToken.token_cliente}`);
              playErrorSound();
              vibrate();
              showScanFeedback('error', '‚ùå', 'QR Code Inv√°lido', 'Este c√≥digo pertence a outro cliente');
              return;
            }
            
            console.log('‚ùå QR Code n√£o encontrado');
          }
        }
        
        if (!convidado) {
          playErrorSound();
          vibrate();
          showScanFeedback('error', '‚ùå', 'QR Code Inv√°lido', 'Este c√≥digo n√£o est√° na lista de convidados');
          return;
        }

        // CR√çTICO: Verifica√ß√£o adicional de seguran√ßa
        if (convidado.token_cliente !== APP_STATE.tokenCliente) {
          console.log(`üö´ BLOQUEIO: Token do convidado (${convidado.token_cliente}) n√£o corresponde ao token ativo (${APP_STATE.tokenCliente})`);
          playErrorSound();
          vibrate();
          showScanFeedback('error', '‚ùå', 'Acesso Negado', 'Este convidado pertence a outro cliente');
          return;
        }

        if (convidado.status === 'inativo') {
          playErrorSound();
          vibrate();
          showScanFeedback('error', '‚ùå', convidado.nome, 'Convidado inactivo');
          return;
        }

        if (convidado.status === 'presente') {
          playDuplicateSound();
          vibrate([100, 50, 100]);
          const dataCheckin = new Date(convidado.data_checkin).toLocaleString('pt-PT');
          showScanFeedback('duplicate', '‚ö†Ô∏è', convidado.nome, `Check-in j√° realizado em ${dataCheckin}`);
          return;
        }

        await performCheckin(convidado);

      } catch (error) {
        console.error('Error processing QR:', error);
        showScanFeedback('error', '‚ùå', 'Erro', 'Erro ao processar check-in');
      }
    }

    async function performCheckin(convidado) {
      convidado.status = 'presente';
      convidado.data_checkin = new Date().toISOString();
      await saveToStore('convidados', convidado);

      const scan = {
        token_cliente: APP_STATE.tokenCliente,
        codigo_qr: convidado.codigo_qr,
        data_scan: convidado.data_checkin,
        dispositivo: APP_STATE.deviceId,
        sincronizado: false,
        convidado_id: convidado.id,
        convidado_nome: convidado.nome
      };

      await saveToStore('scans_pendentes', scan);
      APP_STATE.scansPendentes.push(scan);

      playSuccessSound();
      vibrate([200]);
      showScanFeedback('success', '‚úì', convidado.nome, 'Check-in realizado com sucesso!');
      
      updateStats();
      addToRecentScans(scan);

      // PRIORIDADE ONLINE: Verificar conectividade e sincronizar IMEDIATAMENTE
      const isOnline = await checkInternetConnectivity();
      
      if (isOnline && APP_STATE.supabase) {
        APP_STATE.isOnline = true;
        updateOnlineStatus();
        
        // Sincronizar imediatamente (n√£o esperar)
        syncPendingScans();
      }
    }

    function showScanFeedback(type, icon, name, message) {
      const feedback = document.getElementById('scan-feedback');
      const feedbackIcon = document.getElementById('feedback-icon');
      const feedbackName = document.getElementById('feedback-name');
      const feedbackMessage = document.getElementById('feedback-message');
      const feedbackTime = document.getElementById('feedback-time');

      feedback.className = 'rounded-2xl shadow-xl p-6 text-white text-center animate-slide-in';
      
      if (type === 'success') {
        feedback.classList.add('scan-success');
      } else if (type === 'error') {
        feedback.classList.add('scan-error');
      } else if (type === 'duplicate') {
        feedback.classList.add('scan-duplicate');
      }

      feedbackIcon.textContent = icon;
      feedbackName.textContent = name;
      feedbackMessage.textContent = message;
      feedbackTime.textContent = new Date().toLocaleTimeString('pt-PT');

      feedback.classList.remove('hidden');

      setTimeout(() => {
        feedback.classList.add('hidden');
      }, 4000);
    }

    // ============================================
    // MANUAL CHECK-IN
    // ============================================
    
    document.getElementById('btn-manual-checkin').addEventListener('click', () => {
      if (APP_STATE.isScannerBlocked) {
        showToast('Scanner bloqueado. Revalide o token primeiro.', 'error');
        return;
      }
      
      document.getElementById('modal-manual-checkin').classList.remove('hidden');
      document.getElementById('search-manual-guest').value = '';
      renderManualGuestsList();
    });

    document.getElementById('btn-close-manual').addEventListener('click', () => {
      document.getElementById('modal-manual-checkin').classList.add('hidden');
    });

    document.getElementById('modal-manual-overlay').addEventListener('click', () => {
      document.getElementById('modal-manual-checkin').classList.add('hidden');
    });

    document.getElementById('search-manual-guest').addEventListener('input', (e) => {
      renderManualGuestsList(e.target.value);
    });

    async function renderManualGuestsList(searchTerm = '') {
      const convidados = await getAllFromStore('convidados');
      
      let guests = convidados;
      
      if (searchTerm) {
        guests = guests.filter(g => 
          g.nome.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }

      const container = document.getElementById('manual-guests-list');
      
      if (guests.length === 0 && searchTerm) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="text-sm">Nenhum convidado encontrado</p>
          </div>
        `;
        return;
      }

      if (!searchTerm) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p class="text-sm">Digite para buscar convidados</p>
          </div>
        `;
        return;
      }

      container.innerHTML = guests.map(guest => {
        let statusInfo = '';
        let buttonHtml = '';
        
        if (guest.status === 'presente') {
          const dataCheckin = new Date(guest.data_checkin).toLocaleString('pt-PT');
          statusInfo = `<div class="text-xs text-green-600 mt-1">‚úì Check-in: ${dataCheckin}</div>`;
          buttonHtml = '<span class="px-4 py-2 bg-gray-100 text-gray-500 rounded-lg text-sm font-medium">J√° presente</span>';
        } else if (guest.status === 'inativo') {
          statusInfo = '<div class="text-xs text-red-600 mt-1">Convidado inactivo</div>';
          buttonHtml = '<span class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-medium">Inactivo</span>';
        } else {
          buttonHtml = `<button onclick="manualCheckin('${guest.id}')" class="px-4 py-2 bg-[#007f9f] text-white rounded-lg text-sm font-medium hover:bg-[#006a85] active:scale-95 transition">Fazer Check-in</button>`;
        }
        
        return `
          <div class="p-4 bg-white border border-gray-200 rounded-lg">
            <div class="flex items-center justify-between gap-3">
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 text-base truncate">${guest.nome}</div>
                ${statusInfo}
              </div>
              <div class="flex-shrink-0">${buttonHtml}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function manualCheckin(guestId) {
      // PRIORIDADE ONLINE: Verificar validade tentando online primeiro
      const tokenValido = await checkTokenValidityOnline();
      
      if (!tokenValido) {
        blockScanner('Token Expirado', 'O token expirou. N√£o √© poss√≠vel fazer check-in.');
        document.getElementById('modal-manual-checkin').classList.add('hidden');
        return;
      }
      
      if (APP_STATE.isScannerBlocked) {
        showToast('Scanner bloqueado', 'error');
        return;
      }
      
      try {
        // PRIORIDADE ONLINE: Tentar buscar do servidor primeiro
        const isOnline = await checkInternetConnectivity();
        
        let convidado;
        
        if (isOnline && APP_STATE.supabase && APP_STATE.tokenCliente) {
          try {
            console.log(`üåê Buscando convidado online (ID: ${guestId})...`);
            
            // Buscar convidado online COM FILTRO DE TOKEN
            const convidadosOnline = await APP_STATE.supabase.select('convidados', { 
              eq: { id: guestId, token_cliente: APP_STATE.tokenCliente } 
            });
            
            if (convidadosOnline && convidadosOnline.length > 0) {
              convidado = convidadosOnline[0];
              console.log(`‚úÖ Convidado encontrado online: ${convidado.nome} (Token: ${convidado.token_cliente})`);
              
              // Atualizar cache local
              await saveToStore('convidados', convidado);
              
              const index = APP_STATE.convidados.findIndex(c => c.id === convidado.id);
              if (index >= 0) {
                APP_STATE.convidados[index] = convidado;
              } else {
                APP_STATE.convidados.push(convidado);
              }
            } else {
              console.log('‚ö†Ô∏è Convidado n√£o encontrado online para este token');
            }
          } catch (error) {
            console.error('Error fetching guest online:', error);
            console.log('üì° Erro online - Tentando buscar localmente...');
          }
        }
        
        // Se n√£o encontrou online OU est√° offline, buscar localmente
        if (!convidado) {
          console.log('üíæ Buscando convidado localmente...');
          
          // CR√çTICO: Buscar APENAS convidados do token atual
          convidado = APP_STATE.convidados.find(c => 
            c.id == guestId && c.token_cliente === APP_STATE.tokenCliente
          );
          
          if (convidado) {
            console.log(`‚úÖ Convidado encontrado localmente: ${convidado.nome} (Token: ${convidado.token_cliente})`);
          } else {
            // Verificar se existe mas √© de outro token
            const convidadosDB = await getAllFromStore('convidados');
            const convidadoOutroToken = convidadosDB.find(c => c.id == guestId);
            
            if (convidadoOutroToken) {
              console.log(`üö´ Convidado pertence a outro token: ${convidadoOutroToken.token_cliente}`);
              showToast('Este convidado pertence a outro cliente', 'error');
              return;
            }
            
            console.log('‚ùå Convidado n√£o encontrado');
          }
        }
        
        if (!convidado) {
          showToast('Convidado n√£o encontrado', 'error');
          return;
        }

        // CR√çTICO: Verifica√ß√£o adicional de seguran√ßa
        if (convidado.token_cliente !== APP_STATE.tokenCliente) {
          console.log(`üö´ BLOQUEIO: Token do convidado (${convidado.token_cliente}) n√£o corresponde ao token ativo (${APP_STATE.tokenCliente})`);
          showToast('Acesso negado - Convidado de outro cliente', 'error');
          return;
        }

        if (convidado.status === 'inativo') {
          showToast('Convidado inactivo', 'error');
          return;
        }

        if (convidado.status === 'presente') {
          showToast('Check-in j√° realizado', 'warning');
          return;
        }

        await performCheckin(convidado);
        
        document.getElementById('modal-manual-checkin').classList.add('hidden');
        
        showToast(`Check-in de ${convidado.nome} realizado!`, 'success');
        
      } catch (error) {
        console.error('Error in manual checkin:', error);
        showToast('Erro ao realizar check-in', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-auto px-6 py-4 rounded-lg shadow-lg z-50 animate-slide-in text-center sm:text-left`;
      
      if (type === 'success') {
        toast.classList.add('bg-green-500', 'text-white');
      } else if (type === 'error') {
        toast.classList.add('bg-red-500', 'text-white');
      } else if (type === 'warning') {
        toast.classList.add('bg-yellow-500', 'text-white');
      } else {
        toast.classList.add('bg-blue-500', 'text-white');
      }
      
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    window.manualCheckin = manualCheckin;

    // ============================================
    // AUDIO & VIBRATION
    // ============================================
    
    function playSuccessSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    }

    function playErrorSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 300;
      oscillator.type = 'sawtooth';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.4);
    }

    function playDuplicateSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 500;
      oscillator.type = 'triangle';
      
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    }

    function vibrate(pattern = [200]) {
      if ('vibrate' in navigator) {
        navigator.vibrate(pattern);
      }
    }

    // ============================================
    // STATISTICS
    // ============================================
    
    async function updateStats() {
      const convidados = await getAllFromStore('convidados');
      
      // CR√çTICO: Filtrar apenas convidados do token atual
      const convidadosDoToken = convidados.filter(c => c.token_cliente === APP_STATE.tokenCliente);
      const total = convidadosDoToken.length;
      const checked = convidadosDoToken.filter(c => c.status === 'presente').length;
      const pending = total - checked;
      
      const scans = await getAllFromStore('scans_pendentes');
      
      // CR√çTICO: Filtrar apenas scans do token atual
      const scansDoToken = scans.filter(s => s.token_cliente === APP_STATE.tokenCliente);
      const pendingSync = scansDoToken.filter(s => !s.sincronizado).length;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-checked').textContent = checked;
      document.getElementById('stat-pending').textContent = pending;

      document.getElementById('menu-total-guests').textContent = total;
      document.getElementById('menu-checked-guests').textContent = checked;
      document.getElementById('menu-pending-sync').textContent = pendingSync;
      
      if (APP_STATE.cliente) {
        document.getElementById('menu-client-limit').textContent = 
          `${APP_STATE.cliente.scans_usados || 0} / ${APP_STATE.cliente.limite_scans || 0}`;
      }
      
      // Atualizar expira√ß√£o do token
      updateTokenExpiryDisplay();
    }

    // ============================================
    // RECENT SCANS
    // ============================================
    
    async function loadRecentScans() {
      const scans = await getAllFromStore('scans_pendentes');
      
      // CR√çTICO: Filtrar apenas scans do token atual
      const scansDoToken = scans.filter(s => s.token_cliente === APP_STATE.tokenCliente);
      const recentScans = scansDoToken.slice(-10).reverse();
      
      const container = document.getElementById('recent-scans');
      
      if (recentScans.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <p class="text-sm">Nenhum check-in realizado ainda</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recentScans.map(scan => {
        const time = new Date(scan.data_scan).toLocaleTimeString('pt-PT');
        const syncIcon = scan.sincronizado 
          ? '<span class="text-green-500 text-xl">‚úì</span>' 
          : '<span class="text-yellow-500 animate-pulse text-xl">‚è≥</span>';
        
        return `
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg active:bg-gray-100 transition">
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-gray-900 text-base truncate">${scan.convidado_nome}</div>
              <div class="text-sm text-gray-500 mt-1">${time}</div>
            </div>
            <div class="ml-3 flex-shrink-0">${syncIcon}</div>
          </div>
        `;
      }).join('');
    }

    function addToRecentScans(scan) {
      const container = document.getElementById('recent-scans');
      const time = new Date(scan.data_scan).toLocaleTimeString('pt-PT');
      const syncIcon = scan.sincronizado 
        ? '<span class="text-green-500 text-xl">‚úì</span>' 
        : '<span class="text-yellow-500 animate-pulse text-xl">‚è≥</span>';
      
      const scanHtml = `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg active:bg-gray-100 transition animate-slide-in">
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-gray-900 text-base truncate">${scan.convidado_nome}</div>
            <div class="text-sm text-gray-500 mt-1">${time}</div>
          </div>
          <div class="ml-3 flex-shrink-0">${syncIcon}</div>
        </div>
      `;
      
      if (container.querySelector('.text-gray-400')) {
        container.innerHTML = '';
      }
      
      container.insertAdjacentHTML('afterbegin', scanHtml);
      
      const items = container.querySelectorAll('.flex');
      if (items.length > 10) {
        items[items.length - 1].remove();
      }
    }

    // ============================================
    // SYNC
    // ============================================
    
    async function syncPendingScans() {
      if (!APP_STATE.isOnline || !APP_STATE.supabase || !APP_STATE.tokenCliente) {
        return;
      }

      try {
        // Re-validar token antes de sincronizar
        const tokenValido = await revalidateToken();
        
        if (!tokenValido) {
          return; // Token inv√°lido, bloqueado
        }

        const scans = await getAllFromStore('scans_pendentes');
        
        // CR√çTICO: Sincronizar apenas scans do token atual
        const scansDoToken = scans.filter(s => s.token_cliente === APP_STATE.tokenCliente);
        const pending = scansDoToken.filter(s => !s.sincronizado);

        if (pending.length === 0) {
          return;
        }

        for (const scan of pending) {
          try {
            await APP_STATE.supabase.insert('scans_realtime', {
              token_cliente: scan.token_cliente,
              codigo_qr: scan.codigo_qr,
              data_scan: scan.data_scan,
              dispositivo: scan.dispositivo
            });

            await APP_STATE.supabase.update('convidados', scan.convidado_id, {
              status: 'presente',
              data_checkin: scan.data_scan
            });

            const cliente = await APP_STATE.supabase.select('clientes', { eq: { token: APP_STATE.tokenCliente } });
            if (cliente && cliente[0]) {
              const scansUsados = cliente[0].scans_usados + 1;
              await APP_STATE.supabase.update('clientes', cliente[0].id, {
                scans_usados: scansUsados
              });
              
              if (APP_STATE.cliente) {
                APP_STATE.cliente.scans_usados = scansUsados;
                await saveToStore('cliente', {
                  token: 'saved',
                  realToken: APP_STATE.tokenCliente,
                  ...APP_STATE.cliente
                });
              }
            }

            scan.sincronizado = true;
            await saveToStore('scans_pendentes', scan);
          } catch (error) {
            console.error('Error syncing scan:', error);
          }
        }

        updateStats();
        loadRecentScans();

      } catch (error) {
        console.error('Sync error:', error);
      }
    }
    
    async function updateOnlineStatus() {
      // Verificar conectividade real, n√£o apenas navigator.onLine
      const isReallyOnline = await checkInternetConnectivity();
      
      APP_STATE.isOnline = isReallyOnline;
      const indicator = document.getElementById('online-indicator');
      
      if (APP_STATE.isOnline) {
        indicator.innerHTML = `
          <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          <span class="text-xs font-medium text-green-700 hidden sm:inline">Online</span>
        `;
        indicator.classList.remove('bg-gray-100');
        indicator.classList.add('bg-green-100');
        
        if (APP_STATE.supabase && APP_STATE.tokenCliente) {
          syncPendingScans();
        }
      } else {
        indicator.innerHTML = `
          <div class="w-2 h-2 rounded-full bg-gray-400"></div>
          <span class="text-xs font-medium text-gray-600 hidden sm:inline">Offline</span>
        `;
        indicator.classList.remove('bg-green-100');
        indicator.classList.add('bg-gray-100');
      }
    }

    window.addEventListener('online', async () => {
      // Verificar se est√° REALMENTE online antes de atualizar
      await updateOnlineStatus();
    });
    
    window.addEventListener('offline', async () => {
      await updateOnlineStatus();
    });

    // ============================================
    // MENU
    // ============================================
    
    document.getElementById('btn-menu').addEventListener('click', () => {
      document.getElementById('side-menu').classList.remove('hidden');
      updateStats();
    });

    document.getElementById('btn-close-menu').addEventListener('click', () => {
      document.getElementById('side-menu').classList.add('hidden');
    });

    document.getElementById('menu-overlay').addEventListener('click', () => {
      document.getElementById('side-menu').classList.add('hidden');
    });

    document.getElementById('btn-toggle-dark-mode').addEventListener('click', () => {
      toggleDarkMode();
    });

    document.getElementById('btn-sync').addEventListener('click', async () => {
      if (!APP_STATE.isOnline) {
        showToast('Sem conex√£o √† internet', 'error');
        return;
      }

      try {
        await syncPendingScans();
        
        const convidados = await APP_STATE.supabase.select('convidados', { eq: { token_cliente: APP_STATE.tokenCliente } });
        
        await clearStore('convidados');
        for (const convidado of convidados) {
          await saveToStore('convidados', convidado);
        }
        
        APP_STATE.convidados = convidados;
        updateStats();
        
        showToast('Sincroniza√ß√£o conclu√≠da!', 'success');
      } catch (error) {
        showToast('Erro ao sincronizar', 'error');
      }
    });

    document.getElementById('btn-export').addEventListener('click', async () => {
      await exportReport();
    });

    document.getElementById('btn-view-guests').addEventListener('click', () => {
      document.getElementById('side-menu').classList.add('hidden');
      showGuestsModal();
    });

    document.getElementById('btn-clear-data').addEventListener('click', async () => {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-sm mx-4">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Confirmar Limpeza</h3>
          <p class="text-gray-600 mb-6">Tem certeza que deseja limpar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.</p>
          <div class="flex space-x-3">
            <button id="confirm-clear-yes" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Sim, limpar</button>
            <button id="confirm-clear-no" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-clear-yes').addEventListener('click', async () => {
        await clearStore('convidados');
        await clearStore('scans_pendentes');
        await clearStore('cliente');
        
        stopValidityCheckInterval();
        
        document.body.removeChild(confirmDiv);
        document.getElementById('side-menu').classList.add('hidden');
        
        location.reload();
      });
      
      document.getElementById('confirm-clear-no').addEventListener('click', () => {
        document.body.removeChild(confirmDiv);
      });
    });

    document.getElementById('btn-logout').addEventListener('click', async () => {
      stopValidityCheckInterval();
      
      // CR√çTICO: Limpar TODOS os dados ao desconectar
      await clearStore('convidados');
      await clearStore('scans_pendentes');
      await clearStore('cliente');
      
      APP_STATE.tokenCliente = null;
      APP_STATE.cliente = null;
      APP_STATE.convidados = [];
      APP_STATE.scansPendentes = [];
      
      document.getElementById('side-menu').classList.add('hidden');
      document.getElementById('client-token').value = '';
      showConfig();
      
      showToast('Desconectado com sucesso', 'success');
    });

    // ============================================
    // RECENT SCANS MODAL
    // ============================================
    
    document.getElementById('btn-show-recent').addEventListener('click', () => {
      document.getElementById('modal-recent').classList.remove('hidden');
      loadRecentScans();
    });

    document.getElementById('btn-close-recent').addEventListener('click', () => {
      document.getElementById('modal-recent').classList.add('hidden');
    });

    document.getElementById('modal-recent-overlay').addEventListener('click', () => {
      document.getElementById('modal-recent').classList.add('hidden');
    });

    // ============================================
    // GUESTS MODAL
    // ============================================
    
    function showGuestsModal() {
      document.getElementById('modal-guests').classList.remove('hidden');
      renderGuestsList();
    }

    function hideGuestsModal() {
      document.getElementById('modal-guests').classList.add('hidden');
    }

    document.getElementById('btn-close-guests').addEventListener('click', hideGuestsModal);
    document.getElementById('modal-guests-overlay').addEventListener('click', hideGuestsModal);

    document.getElementById('search-guest').addEventListener('input', (e) => {
      renderGuestsList(e.target.value);
    });

    async function renderGuestsList(searchTerm = '') {
      const convidados = await getAllFromStore('convidados');
      
      let guests = convidados;
      
      if (searchTerm) {
        guests = guests.filter(g => 
          g.nome.toLowerCase().includes(searchTerm.toLowerCase())
        );
      }

      const container = document.getElementById('guests-list');
      
      container.innerHTML = guests.map(guest => {
        let statusBadge;
        if (guest.status === 'presente') {
          const dataCheckin = new Date(guest.data_checkin).toLocaleString('pt-PT');
          statusBadge = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold whitespace-nowrap">‚úì Presente</span>`;
        } else if (guest.status === 'inativo') {
          statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold whitespace-nowrap">Inactivo</span>';
        } else {
          statusBadge = '<span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold whitespace-nowrap">Activo</span>';
        }
        
        return `
          <div class="p-4 bg-white border border-gray-200 rounded-lg active:shadow-md transition">
            <div class="flex items-center justify-between gap-3">
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 text-base truncate">${guest.nome}</div>
                ${guest.status === 'presente' ? `<div class="text-xs text-gray-500 mt-1">${new Date(guest.data_checkin).toLocaleString('pt-PT')}</div>` : ''}
              </div>
              <div class="flex-shrink-0">${statusBadge}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ============================================
    // EXPORT REPORT
    // ============================================
    
    async function exportReport() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const scans = await getAllFromStore('scans_pendentes');
        
        // CR√çTICO: Exportar apenas scans do token atual
        const scansDoToken = scans.filter(s => s.token_cliente === APP_STATE.tokenCliente);
        
        doc.setFontSize(20);
        doc.text('AdKira Check-In - Relat√≥rio', 20, 20);
        
        doc.setFontSize(12);
        doc.text(`Cliente: ${APP_STATE.cliente?.nome || 'N/A'}`, 20, 35);
        doc.text(`Data: ${new Date().toLocaleDateString('pt-PT')}`, 20, 42);
        doc.text(`Total de Convidados: ${APP_STATE.convidados.length}`, 20, 49);
        doc.text(`Check-ins Realizados: ${scansDoToken.length}`, 20, 56);
        
        doc.setFontSize(14);
        doc.text('Lista de Check-ins:', 20, 70);
        
        doc.setFontSize(10);
        let y = 80;
        
        for (const scan of scansDoToken.slice(0, 30)) {
          const time = new Date(scan.data_scan).toLocaleString('pt-PT');
          const syncStatus = scan.sincronizado ? '‚úì' : '‚è≥';
          doc.text(`${syncStatus} ${scan.convidado_nome} - ${time}`, 20, y);
          y += 7;
          
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
        }
        
        if (scansDoToken.length > 30) {
          doc.text(`... e mais ${scansDoToken.length - 30} check-ins`, 20, y);
        }
        
        doc.save(`adkira-checkin-${new Date().getTime()}.pdf`);
        
      } catch (error) {
        console.error('Error generating report:', error);
        showToast('Erro ao gerar relat√≥rio', 'error');
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    
    function updateFooterYear() {
      const currentYear = new Date().getFullYear();
      const yearElements = document.querySelectorAll('#footer-year, #footer-year-menu');
      yearElements.forEach(element => {
        if (element) {
          element.textContent = currentYear;
        }
      });
    }
    
    async function init() {
      try {
        await initDB();
        loadDarkModePreference();
        updateFooterYear();
        await loadSavedConfig();
      } catch (error) {
        console.error('Initialization error:', error);
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b00ce401573c13d',t:'MTc2NjA4MzQwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>