<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>InvitesQR - Leitor Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        body { 
            overflow-x: hidden; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 1000;
        }
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid #667eea;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
        }
        .scanner-controls {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            z-index: 1002;
            padding: 0 20px;
        }
        .result-display {
            position: absolute;
            bottom: 100px;
            left: 20px;
            right: 20px;
            text-align: center;
            z-index: 1001;
        }
        .status-permitido { color: #10b981; }
        .status-usado { color: #ef4444; }
        .status-invalido { color: #ef4444; }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center mx-auto mb-3">
                    <span class="text-xl text-white">üì±</span>
                </div>
                <h1 class="text-xl font-bold text-gray-800">InvitesQR</h1>
                <p class="text-sm text-gray-600">Leitor Mobile</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="text" id="token-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center" placeholder="Token do evento" required>
                </div>
                
                <button type="submit" class="w-full gradient-bg text-white py-3 rounded-lg font-medium">
                    Entrar
                </button>
            </form>
            
            <div id="login-status" class="mt-3 text-center text-sm"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white">
            <div class="px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">üì±</span>
                        <div>
                            <h1 class="text-lg font-bold">Leitor QR</h1>
                            <p id="evento-nome" class="text-xs opacity-90">Carregando...</p>
                        </div>
                    </div>
                    <div id="connection-status" class="text-xs">üîÑ</div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white border-b">
            <div class="flex">
                <button class="tab-button flex-1 py-3 text-sm font-medium transition-all duration-200 active" onclick="showTab('scanner')">
                    üì∑ Scanner
                </button>
                <button class="tab-button flex-1 py-3 text-sm font-medium transition-all duration-200" onclick="showTab('gestao')">
                    üìä Estat√≠sticas
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="px-4 py-4">
            <!-- Scanner Tab -->
            <div id="scanner" class="tab-content active">
                <div class="space-y-4">
                    <!-- Progress Bar -->
                    <div class="bg-white rounded-lg p-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Progresso do Evento</span>
                            <span id="progress-text">0/0</span>
                        </div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Scanner Button -->
                    <div class="bg-white rounded-lg p-6 text-center">
                        <div class="text-4xl mb-3">üì∑</div>
                        <h2 class="text-lg font-bold mb-3">Scanner QR</h2>
                        <button id="start-scanner" class="gradient-bg text-white px-6 py-3 rounded-lg font-medium w-full">
                            Iniciar Scanner
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gest√£o Tab -->
            <div id="gestao" class="tab-content">
                <div class="space-y-4">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-white rounded-lg p-4 text-center">
                            <div class="text-2xl mb-1">‚úÖ</div>
                            <p class="text-xl font-bold text-green-600" id="total-permitidos">0</p>
                            <p class="text-xs text-gray-600">Permitidos</p>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center">
                            <div class="text-2xl mb-1">üî¥</div>
                            <p class="text-xl font-bold text-red-600" id="total-usados">0</p>
                            <p class="text-xs text-gray-600">Usados</p>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <p class="text-xl font-bold text-red-600" id="total-invalidos">0</p>
                            <p class="text-xs text-gray-600">Inv√°lidos</p>
                        </div>
                    </div>
                    
                    <!-- Controls -->
                    <div class="bg-white rounded-lg p-4">
                        <button onclick="desmarcarTodos()" class="w-full bg-red-500 text-white py-3 rounded-lg font-medium mb-3">
                            Desmarcar Todos os Scaneados
                        </button>
                        <input type="text" id="search-convidados" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="üîç Pesquisar convidados...">
                    </div>
                    
                    <!-- Guest List -->
                    <div class="bg-white rounded-lg p-4">
                        <h3 class="font-semibold mb-3">üë• Convidados</h3>
                        <div id="lista-convidados-gestao" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="flex items-center justify-center py-8 text-gray-500">
                                <div class="text-center">
                                    <div class="text-3xl mb-2">üë•</div>
                                    <p class="text-sm">Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scanner Overlay -->
    <div id="scanner-overlay" class="scanner-overlay hidden">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display: none;"></canvas>
        
        <!-- Top Controls -->
        <div class="scanner-controls">
            <button id="close-scanner" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium">
                ‚úï Fechar
            </button>
        </div>
        
        <div class="scanner-frame"></div>
        
        <div class="result-display" id="result-display">
            <div class="bg-white rounded-lg p-4 shadow-lg">
                <div id="scan-status" class="text-4xl font-bold mb-2">üì∑</div>
                <div id="scan-message" class="text-sm text-gray-600 mb-3">Posicione o QR code na √°rea destacada</div>
                <div id="guest-name" class="text-lg font-semibold mb-3 hidden"></div>
                <button id="next-scan" class="gradient-bg text-white px-4 py-2 rounded-lg font-medium w-full hidden">
                    Pr√≥ximo Scan
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://rnvunprjvppbjavkaoek.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudnVucHJqdnBwYmphdmthb2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NjYzOTksImV4cCI6MjA2NzI0MjM5OX0.5E37Qm-KMmyGtGKbOINbDqMQlZlfgcQx91RQ01qslT8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Chave secreta para desencripta√ß√£o
        const SECRET_KEY = "Luand@2025!.";
        
        // Vari√°veis globais
        let currentToken = '';
        let currentCliente = null;
        let convidados = [];
        let scannerActive = false;
        let video, canvas, context;
        let scanCounts = { permitidos: 0, usados: 0, invalidos: 0 };

        // Carregar contadores do localStorage
        function loadScanCounts() {
            const saved = localStorage.getItem('invitesqr_scan_counts');
            if (saved) {
                scanCounts = JSON.parse(saved);
            }
        }

        // Salvar contadores no localStorage
        function saveScanCounts() {
            localStorage.setItem('invitesqr_scan_counts', JSON.stringify(scanCounts));
        }

        // Fun√ß√µes de desencripta√ß√£o
        function decrypt(encryptedText) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedText, SECRET_KEY);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error('Erro ao desencriptar:', error);
                return null;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadScanCounts();
            checkAutoLogin();
        });

        // Verificar login autom√°tico
        function checkAutoLogin() {
            const savedToken = localStorage.getItem('invitesqr_token');
            if (savedToken) {
                document.getElementById('token-input').value = savedToken;
                // Auto-login ap√≥s 500ms
                setTimeout(() => {
                    document.getElementById('login-form').dispatchEvent(new Event('submit'));
                }, 500);
            }
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Scanner buttons
            document.getElementById('start-scanner').addEventListener('click', startScanner);
            document.getElementById('close-scanner').addEventListener('click', closeScanner);
            document.getElementById('next-scan').addEventListener('click', nextScan);
            
            // Search
            document.getElementById('search-convidados').addEventListener('input', searchConvidados);
        }

        // Login
        async function handleLogin(e) {
            e.preventDefault();
            
            const token = document.getElementById('token-input').value.trim();
            const statusDiv = document.getElementById('login-status');
            
            if (!token) {
                statusDiv.innerHTML = '<span class="text-red-600">Por favor, digite o token</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span class="text-blue-600">üîÑ Verificando token...</span>';
            
            try {
                // Verificar se o token existe
                const { data: cliente, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('token', token)
                    .single();
                
                if (error || !cliente) {
                    statusDiv.innerHTML = '<span class="text-red-600">‚ùå Token inv√°lido</span>';
                    return;
                }
                
                // Verificar se n√£o expirou
                if (cliente.validade < Date.now()) {
                    statusDiv.innerHTML = '<span class="text-red-600">‚ùå Token expirado</span>';
                    return;
                }
                
                // Login bem-sucedido
                currentToken = token;
                currentCliente = cliente;
                
                // Salvar token no localStorage
                localStorage.setItem('invitesqr_token', token);
                
                // Registrar log de acesso
                await registrarLog(token, 'login', navigator.userAgent);
                
                // Mostrar app principal
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                // Carregar dados
                await initializeApp();
                
            } catch (error) {
                console.error('Erro no login:', error);
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Erro de conex√£o</span>';
            }
        }

        async function initializeApp() {
            try {
                // Atualizar header
                document.getElementById('evento-nome').textContent = currentCliente.nome;
                document.getElementById('connection-status').innerHTML = '‚úÖ Conectado';
                document.getElementById('connection-status').className = 'font-semibold text-green-300';
                
                // Carregar convidados
                await carregarConvidados();
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                document.getElementById('connection-status').innerHTML = '‚ùå Erro';
                document.getElementById('connection-status').className = 'font-semibold text-red-300';
            }
        }

        // Navega√ß√£o entre abas
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'gestao') {
                carregarConvidados();
            }
        }

        // Carregar convidados
        async function carregarConvidados() {
            try {
                const { data, error } = await supabase
                    .from('convidados')
                    .select('*')
                    .eq('token_cliente', currentToken)
                    .order('nome');
                
                if (error) throw error;
                
                convidados = data || [];
                exibirConvidados(convidados);
                atualizarEstatisticas();
                
            } catch (error) {
                console.error('Erro ao carregar convidados:', error);
            }
        }

        function exibirConvidados(lista) {
            const container = document.getElementById('lista-convidados-gestao');
            
            if (!lista || lista.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-500">
                        <div class="text-3xl mb-2">üë•</div>
                        <p class="text-sm">Nenhum convidado encontrado</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = lista.map(convidado => {
                const isUsed = convidado.status === 'usado';
                const statusIcon = isUsed ? 'üî¥' : '‚úÖ';
                const statusColor = isUsed ? 'text-red-600' : 'text-green-600';
                
                return `
                    <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${statusIcon}</span>
                            <div>
                                <p class="font-medium text-sm">${convidado.nome}</p>
                                <p class="text-xs text-gray-500">${convidado.codigo}</p>
                            </div>
                        </div>
                        <span class="text-xs font-medium ${statusColor}">
                            ${isUsed ? 'USADO' : 'OK'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function searchConvidados() {
            const search = document.getElementById('search-convidados').value.toLowerCase();
            const filtered = convidados.filter(convidado => 
                convidado.nome.toLowerCase().includes(search) ||
                convidado.codigo.toLowerCase().includes(search)
            );
            exibirConvidados(filtered);
        }

        function atualizarEstatisticas() {
            const usados = convidados.filter(c => c.status === 'usado').length;
            const disponiveis = convidados.filter(c => c.status === 'ativo').length;
            const total = convidados.length;
            
            // Atualizar contadores
            document.querySelectorAll('#total-permitidos').forEach(el => {
                el.textContent = disponiveis;
            });
            document.querySelectorAll('#total-usados').forEach(el => {
                el.textContent = usados;
            });
            document.querySelectorAll('#total-invalidos').forEach(el => {
                el.textContent = scanCounts.invalidos;
            });
            
            // Atualizar barra de progresso
            const progressPercent = total > 0 ? (usados / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = progressPercent + '%';
            document.getElementById('progress-text').textContent = `${usados}/${total}`;
        }

        // Scanner
        async function startScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                video = document.getElementById('video');
                canvas = document.getElementById('canvas');
                context = canvas.getContext('2d');
                
                video.srcObject = stream;
                video.play();
                
                document.getElementById('scanner-overlay').classList.remove('hidden');
                scannerActive = true;
                
                // Reset display
                document.getElementById('scan-status').textContent = 'üì∑';
                document.getElementById('scan-message').textContent = 'Posicione o QR code na √°rea destacada';
                document.getElementById('guest-name').classList.add('hidden');
                document.getElementById('next-scan').classList.add('hidden');
                
                // Start scanning
                requestAnimationFrame(scanFrame);
                
            } catch (error) {
                console.error('Erro ao acessar c√¢mera:', error);
                alert('Erro ao acessar a c√¢mera. Verifique as permiss√µes.');
            }
        }

        function scanFrame() {
            if (!scannerActive) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    processQRCode(code.data);
                    return;
                }
            }
            
            requestAnimationFrame(scanFrame);
        }

        async function processQRCode(qrData) {
            scannerActive = false;
            
            try {
                console.log('QR Data recebido:', qrData);
                
                // Todos os QR codes s√£o encriptados, ent√£o sempre desencriptar primeiro
                const decryptedData = decrypt(qrData);
                
                if (!decryptedData) {
                    console.log('Falha na desencripta√ß√£o - QR inv√°lido');
                    showScanResult('INV√ÅLIDO', '', 'invalido');
                    scanCounts.invalidos++;
                    saveScanCounts();
                    return;
                }
                
                console.log('QR desencriptado:', decryptedData);
                
                // Parse dos dados desencriptados
                let guestData;
                try {
                    guestData = JSON.parse(decryptedData);
                    console.log('Dados parseados:', guestData);
                } catch (parseError) {
                    console.log('Falha no parse ap√≥s desencripta√ß√£o:', parseError);
                    showScanResult('INV√ÅLIDO', '', 'invalido');
                    scanCounts.invalidos++;
                    saveScanCounts();
                    return;
                }
                
                // Verificar se tem os campos necess√°rios
                if (!guestData.codigo || !guestData.nome) {
                    console.log('Dados incompletos no QR:', guestData);
                    showScanResult('INV√ÅLIDO', '', 'invalido');
                    scanCounts.invalidos++;
                    return;
                }
                
                // Verificar se o convidado existe
                const convidado = convidados.find(c => 
                    c.codigo === guestData.codigo && c.nome === guestData.nome
                );
                
                console.log('Convidado encontrado:', convidado);
                
                if (!convidado) {
                    showScanResult('INV√ÅLIDO', '', 'invalido');
                    scanCounts.invalidos++;
                    return;
                }
                
                // Verificar se j√° foi usado
                if (convidado.status === 'usado') {
                    showScanResult('USADO', convidado.nome, 'usado');
                    scanCounts.usados++;
                    saveScanCounts();
                    return;
                }
                
                // Marcar como usado
                await marcarComoUsado(convidado.id);
                showScanResult('PERMITIDO', convidado.nome, 'permitido');
                scanCounts.permitidos++;
                saveScanCounts();
                
                // Registrar log
                await registrarLog(currentToken, 'scan', `${convidado.codigo}:${convidado.nome}`);
                
                // Atualizar lista
                await carregarConvidados();
                
            } catch (error) {
                console.error('Erro ao processar QR code:', error);
                showScanResult('ERRO', '', 'invalido');
                scanCounts.invalidos++;
            }
        }

        function showScanResult(status, guestName, type) {
            const statusElement = document.getElementById('scan-status');
            const messageElement = document.getElementById('scan-message');
            const nameElement = document.getElementById('guest-name');
            const nextButton = document.getElementById('next-scan');
            
            // Configurar status
            statusElement.textContent = status;
            statusElement.className = `text-6xl font-bold mb-4 status-${type}`;
            
            // Configurar mensagem
            messageElement.textContent = '';
            
            // Mostrar nome se dispon√≠vel
            if (guestName) {
                nameElement.textContent = guestName;
                nameElement.classList.remove('hidden');
            } else {
                nameElement.classList.add('hidden');
            }
            
            // Mostrar bot√£o pr√≥ximo
            nextButton.classList.remove('hidden');
            
            // Atualizar estat√≠sticas
            atualizarEstatisticas();
        }

        function nextScan() {
            // Reset display
            document.getElementById('scan-status').textContent = 'üì∑';
            document.getElementById('scan-message').textContent = 'Posicione o QR code na √°rea destacada';
            document.getElementById('guest-name').classList.add('hidden');
            document.getElementById('next-scan').classList.add('hidden');
            
            // Restart scanning
            scannerActive = true;
            requestAnimationFrame(scanFrame);
        }

        function closeScanner() {
            scannerActive = false;
            
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('scanner-overlay').classList.add('hidden');
        }

        async function marcarComoUsado(convidadoId) {
            try {
                const { error } = await supabase
                    .from('convidados')
                    .update({ status: 'usado' })
                    .eq('id', convidadoId);
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Erro ao marcar como usado:', error);
            }
        }

        async function desmarcarTodos() {
            if (!confirm('Tem certeza que deseja desmarcar todos os convidados scaneados?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('convidados')
                    .update({ status: 'ativo' })
                    .eq('token_cliente', currentToken)
                    .eq('status', 'usado');
                
                if (error) throw error;
                
                alert('Todos os convidados foram desmarcados!');
                await carregarConvidados();
                
            } catch (error) {
                console.error('Erro ao desmarcar convidados:', error);
                alert('Erro ao desmarcar convidados');
            }
        }

        async function registrarLog(token, status, dispositivo) {
            try {
                await supabase.from('logs').insert([{
                    token: token,
                    data: new Date().toISOString(),
                    status: status,
                    dispositivo: dispositivo
                }]);
            } catch (error) {
                console.error('Erro ao registrar log:', error);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966b38b4361477dd',t:'MTc1Mzc3NzQ4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
